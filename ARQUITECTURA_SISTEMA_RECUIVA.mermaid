graph TD
    %% Estilos de Nodos
    classDef client fill:#f9f,stroke:#333,stroke-width:2px,color:black
    classDef frontend fill:#d4e1f5,stroke:#333,stroke-width:2px,color:black
    classDef backend fill:#d5f5e3,stroke:#333,stroke-width:2px,color:black
    classDef db fill:#fcf3cf,stroke:#333,stroke-width:2px,color:black
    classDef external fill:#e8daef,stroke:#333,stroke-width:2px,color:black,stroke-dasharray: 5 5
    classDef infra fill:#eaecee,stroke:#333,stroke-width:2px,color:black

    subgraph User_Side [Cliente]
        Browser[Navegador Web<br/>(HTML5 + JS + Tailwind)]:::client
    end

    subgraph Cloud_Infrastructure [Infraestructura (DigitalOcean Droplet - Dokploy)]
        direction TB
        
        Traefik[Traefik Proxy<br/>(SSL Terminación / Routing)]:::infra
        
        subgraph Docker_Swarm [Contenedores Docker]
            Nginx[Frontend Server<br/>(Nginx Container)]:::frontend
            
            subgraph Backend_App [Backend API (FastAPI)]
                API[API Gateway / Endpoints]:::backend
                Auth[Auth Middleware]:::backend
                
                subgraph Logic_Modules [Lógica de Negocio]
                    PDF_Proc[Procesador PDF<br/>(PyPDF2 + Chunking)]:::backend
                    Embed_Service[Servicio Embeddings<br/>(Sentence-Transformers)]:::backend
                    Hybrid_Val[Validador Híbrido<br/>(BM25 + Cosine + Coverage)]:::backend
                    SM2_Algo[Algoritmo SM-2<br/>(Spaced Repetition)]:::backend
                end
            end
        end
    end

    subgraph External_Services [Servicios Externos & Datos]
        DuckDNS[DuckDNS<br/>(DNS Dinámico)]:::external
        
        subgraph Supabase_Cloud [Supabase Cloud]
            Postgres[(PostgreSQL DB)]:::db
            PgVector[(pgvector Ext)]:::db
            Auth_Service[Supabase Auth]:::external
        end
        
        Groq_API[Groq API<br/>(Llama 3.1 8B - Generación)]:::external
    end

    %% Flujos de Conexión
    Browser -- "1. Request HTTPS (recuiva.duckdns.org)" --> DuckDNS
    DuckDNS -- "2. Resolución IP" --> Traefik
    
    Traefik -- "3. Router (Frontend)" --> Nginx
    Traefik -- "4. Router (API /api/*)" --> API
    
    Nginx -- "Sirve Assets Estáticos" --> Browser
    
    %% Interacciones Backend
    API -- "Valida Sesión" --> Auth_Service
    API -- "Lee/Escribe Datos" --> Postgres
    
    %% Flujos Específicos
    PDF_Proc -- "Chunks de Texto" --> Embed_Service
    Embed_Service -- "Vectores (384d)" --> PgVector
    
    Hybrid_Val -- "Consulta Contexto (Top-k)" --> PgVector
    Hybrid_Val -- "Calcula Score" --> API
    
    API -- "Generar Preguntas" --> Groq_API
    Groq_API -- "Sugerencias JSON" --> API
    
    SM2_Algo -- "Actualiza Intervalos" --> Postgres

    %% Leyenda de Protocolos
    linkStyle 0,2,3,4,5,10,11 stroke-width:2px,fill:none,stroke:blue,color:blue; %% HTTP/HTTPS
    linkStyle 6,7,8,9,12,13 stroke-width:2px,fill:none,stroke:green,color:green; %% Internal/DB
