<!-- =============================================== -->
<!-- COMPONENTE: Gestor de Backup de Datos Locales -->
<!-- =============================================== -->
<!-- Permite exportar e importar datos de localStorage -->
<!-- Para incluir en cualquier página de Recuiva -->

<div class="backup-manager" style="display: inline-flex; gap: 8px;">
  <!-- Botón Exportar -->
  <button onclick="exportRecuivaData()" 
          class="btn-backup" 
          title="Descargar backup de todos tus datos">
    <span class="material-symbols-outlined" style="font-size: 20px;">download</span>
    <span class="hidden md:inline">Exportar Datos</span>
  </button>
  
  <!-- Botón Importar -->
  <button onclick="importRecuivaData()" 
          class="btn-backup" 
          title="Importar backup desde archivo">
    <span class="material-symbols-outlined" style="font-size: 20px;">upload</span>
    <span class="hidden md:inline">Importar Datos</span>
  </button>
  
  <!-- Botón Limpiar (solo en modo avanzado) -->
  <button onclick="clearRecuivaData()" 
          class="btn-backup btn-danger" 
          title="Borrar todos los datos locales"
          style="display: none;" 
          id="btn-clear-data">
    <span class="material-symbols-outlined" style="font-size: 20px;">delete_sweep</span>
    <span class="hidden md:inline">Limpiar Todo</span>
  </button>
</div>

<style>
.btn-backup {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #374151;
  transition: all 0.2s;
}

.btn-backup:hover {
  background: #f3f4f6;
  border-color: #d1d5db;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-backup.btn-danger {
  border-color: #fca5a5;
  color: #dc2626;
}

.btn-backup.btn-danger:hover {
  background: #fee2e2;
  border-color: #f87171;
}
</style>

<script>
/**
 * 📦 EXPORTAR DATOS DE RECUIVA
 * Crea un backup JSON con todos los datos del localStorage
 */
function exportRecuivaData() {
  console.log('📦 Exportando datos de Recuiva...');
  
  // Recopilar todos los datos de Recuiva
  const backupData = {
    version: '1.0',
    exportDate: new Date().toISOString(),
    app: 'Recuiva',
    data: {}
  };
  
  let totalItems = 0;
  
  // Buscar todas las keys que empiecen con 'recuiva_'
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith('recuiva_')) {
      try {
        const value = localStorage.getItem(key);
        backupData.data[key] = value;
        totalItems++;
      } catch (e) {
        console.error(`Error al exportar ${key}:`, e);
      }
    }
  }
  
  if (totalItems === 0) {
    alert('⚠️ No hay datos para exportar.\n\nCrea algunas preguntas primero en Sesión Práctica.');
    return;
  }
  
  // Crear archivo JSON
  const jsonString = JSON.stringify(backupData, null, 2);
  const blob = new Blob([jsonString], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  // Crear nombre de archivo con fecha
  const date = new Date().toISOString().split('T')[0];
  const fileName = `recuiva-backup-${date}.json`;
  
  // Descargar
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  a.click();
  
  // Limpiar
  URL.revokeObjectURL(url);
  
  console.log(`✅ Backup exportado: ${totalItems} elementos`);
  
  // Mostrar notificación
  if (typeof showAdvancedModal === 'function') {
    showAdvancedModal(
      'check_circle',
      '¡Backup Creado!',
      `Se han exportado ${totalItems} elementos.\n\nArchivo: ${fileName}\n\n💡 Guarda este archivo en un lugar seguro.`
    );
  } else {
    alert(`✅ Backup creado exitosamente\n\n${totalItems} elementos exportados\nArchivo: ${fileName}`);
  }
}

/**
 * 📥 IMPORTAR DATOS DE RECUIVA
 * Restaura datos desde un backup JSON
 */
function importRecuivaData() {
  console.log('📥 Iniciando importación de datos...');
  
  // Crear input de archivo
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    try {
      // Leer archivo
      const text = await file.text();
      const backupData = JSON.parse(text);
      
      // Validar estructura
      if (!backupData.app || backupData.app !== 'Recuiva') {
        alert('❌ Archivo inválido.\n\nEste no es un backup de Recuiva.');
        return;
      }
      
      // Confirmar importación
      const itemCount = Object.keys(backupData.data || {}).length;
      
      const confirmMsg = `¿Importar backup?\n\n` +
        `📅 Fecha: ${new Date(backupData.exportDate).toLocaleDateString('es-ES')}\n` +
        `📊 Elementos: ${itemCount}\n\n` +
        `⚠️ ADVERTENCIA: Esto SOBRESCRIBIRÁ tus datos actuales.\n\n` +
        `¿Continuar?`;
      
      if (!confirm(confirmMsg)) {
        console.log('❌ Importación cancelada por el usuario');
        return;
      }
      
      // Importar datos
      let importedCount = 0;
      let errorCount = 0;
      
      for (const [key, value] of Object.entries(backupData.data)) {
        try {
          localStorage.setItem(key, value);
          importedCount++;
        } catch (e) {
          console.error(`Error al importar ${key}:`, e);
          errorCount++;
        }
      }
      
      console.log(`✅ Importación completada: ${importedCount} elementos`);
      
      if (errorCount > 0) {
        console.warn(`⚠️ Errores durante importación: ${errorCount}`);
      }
      
      // Mostrar resultado
      if (typeof showAdvancedModal === 'function') {
        showAdvancedModal(
          'check_circle',
          '¡Datos Importados!',
          `Se han importado ${importedCount} elementos correctamente.\n\n` +
          (errorCount > 0 ? `⚠️ ${errorCount} elementos con errores.\n\n` : '') +
          `La página se recargará para aplicar los cambios.`
        );
      } else {
        alert(
          `✅ Importación exitosa\n\n` +
          `${importedCount} elementos importados\n` +
          (errorCount > 0 ? `⚠️ ${errorCount} errores\n` : '') +
          `\nLa página se recargará...`
        );
      }
      
      // Recargar página después de 2 segundos
      setTimeout(() => {
        location.reload();
      }, 2000);
      
    } catch (e) {
      console.error('❌ Error al importar:', e);
      alert(`❌ Error al importar el archivo:\n\n${e.message}\n\nVerifica que sea un backup válido de Recuiva.`);
    }
  };
  
  // Abrir selector de archivos
  input.click();
}

/**
 * 🗑️ LIMPIAR TODOS LOS DATOS
 * Borra todo el localStorage de Recuiva (con confirmación)
 */
function clearRecuivaData() {
  console.log('🗑️ Solicitando limpieza de datos...');
  
  // Contar elementos
  const keys = Object.keys(localStorage).filter(k => k.startsWith('recuiva_'));
  
  if (keys.length === 0) {
    alert('ℹ️ No hay datos para borrar.');
    return;
  }
  
  // Confirmación múltiple
  const confirmMsg1 = `⚠️ ADVERTENCIA: ACCIÓN IRREVERSIBLE\n\n` +
    `Estás a punto de BORRAR PERMANENTEMENTE:\n` +
    `📊 ${keys.length} elementos de datos\n\n` +
    `Esto incluye:\n` +
    `• Todas tus preguntas\n` +
    `• Historial de repasos\n` +
    `• Datos de progreso\n` +
    `• Configuración\n\n` +
    `¿Estás ABSOLUTAMENTE seguro?`;
  
  if (!confirm(confirmMsg1)) {
    console.log('❌ Limpieza cancelada (paso 1)');
    return;
  }
  
  const confirmMsg2 = `⚠️ ÚLTIMA CONFIRMACIÓN\n\n` +
    `Esta acción NO SE PUEDE DESHACER.\n\n` +
    `💡 Recomendación: Exporta un backup primero.\n\n` +
    `¿Continuar con el borrado?`;
  
  if (!confirm(confirmMsg2)) {
    console.log('❌ Limpieza cancelada (paso 2)');
    return;
  }
  
  // Borrar datos
  let deletedCount = 0;
  keys.forEach(key => {
    try {
      localStorage.removeItem(key);
      deletedCount++;
    } catch (e) {
      console.error(`Error al borrar ${key}:`, e);
    }
  });
  
  console.log(`✅ Datos borrados: ${deletedCount} elementos`);
  
  alert(`✅ Datos borrados correctamente\n\n${deletedCount} elementos eliminados\n\nLa página se recargará...`);
  
  // Recargar
  setTimeout(() => {
    location.reload();
  }, 1000);
}

// Mostrar botón de limpiar solo si hay datos
document.addEventListener('DOMContentLoaded', () => {
  const keys = Object.keys(localStorage).filter(k => k.startsWith('recuiva_'));
  const btnClear = document.getElementById('btn-clear-data');
  
  if (btnClear && keys.length > 0) {
    // Mostrar solo si hay más de 10 elementos (modo avanzado)
    if (keys.length > 10) {
      btnClear.style.display = 'inline-flex';
    }
  }
});

console.log('✅ Gestor de Backup cargado');
</script>
