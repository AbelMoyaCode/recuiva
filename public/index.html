<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Recuiva - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="assets/img/Icon-Recuiva.ico"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
/* Filtro de seguridad: oculta cualquier toast/banner/snackbar por si acaso */
#toast-root, .toast, .notyf, .iziToast, .swal2-container.swal2-top, .banner, .snackbar { display:none !important; }

/* Estilo global para el logo Recuiva */
.recuiva-logo {
  font-family: 'Manrope', sans-serif !important;
  font-weight: 800 !important;
  font-size: 1.5rem !important;
}
      .drag-handle {
        @apply mr-2 text-gray-500 hover:text-gray-700;
        cursor: grab;
      }
      .dragging {
        opacity: .6;
      }
      .drop-line::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: #3b82f6;
      }
      .drop-line-above::after {
        top: 0;
      }
      .drop-line-below::after {
        bottom: 0;
      }
      .drop-inside {
        box-shadow: inset 0 0 0 2px rgba(59,130,246,.35);
        animation: wobble .28s ease-in-out;
      }
      @keyframes wobble {
        0% { transform: translateX(0); }
        25% { transform: translateX(1.5px); }
        50% { transform: translateX(0); }
        75% { transform: translateX(-1.5px); }
        100% { transform: translateX(0); }
      }
      /* Gu√≠a visual para √°rbol */
      .tree-guide {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 18px;
        border-left: 2px dashed #A5CDED;
        z-index: 0;
        pointer-events: none;
      }
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      .menu-btn {
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .menu-btn:hover {
        transform: scale(1.1);
      }
      .mobile-menu {
        transform-origin: top;
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform: scaleY(0);
        opacity: 0;
        pointer-events: none;
        height: 100vh;
        overflow-y: auto;
      }
      .mobile-menu.active {
        transform: scaleY(1);
        opacity: 1;
        pointer-events: auto;
      }
      #menu-btn.active .menu-icon {
        transform: rotate(180deg);
      }
      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        padding: 0.75rem 0;
        min-width: 14rem;
        z-index: 50;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      }
      .profile-dropdown.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .profile-dropdown a, .profile-dropdown button {
        transition: all 0.2s ease;
      }
      .profile-dropdown a:hover, .profile-dropdown button:hover {
        transform: translateX(4px);
      }
      .notification-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: var(--primary-color);
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        min-width: 1.2rem;
        text-align: center;
      }
      
      /* Modal de notificaciones mejorado - Estilo elegante */
      .notification-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      .notification-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .notification-modal-content {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 26rem;
        margin: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.8) translateY(30px);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .notification-modal.show .notification-modal-content {
        transform: scale(1) translateY(0);
      }
      .notification-icon-container {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }
      .notification-modal h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
        text-align: center;
      }
      .notification-modal p {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #6b7280;
        text-align: center;
        margin-bottom: 2rem;
      }
      .modal-button {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        color: white;
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
        width: 100%;
      }
      .modal-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4);
      }
      /* Panel principal (marco azul + sombra sutil) */
      .onb-panel {
        @apply bg-white/90 backdrop-blur border border-blue-200 ring-1 ring-blue-100 rounded-3xl shadow-[0_10px_30px_rgba(0,91,204,0.08)];
      }

      /* Panel del entrenador (celeste) */
      .onb-coach {
        @apply bg-blue-50/70 border border-blue-200 ring-1 ring-blue-100 rounded-3xl shadow-[0_10px_25px_rgba(0,91,204,0.06)];
      }

      /* Chips de modalidad */
      .chip {
        @apply px-4 py-2 rounded-full font-semibold text-[var(--text-primary)] bg-[var(--base-gray)] hover:bg-[var(--accent-color)] focus:outline-none transition;
      }
      .chip.is-active {
        @apply bg-[var(--accent-color)] ring-2 ring-blue-200;
      }

      /* Tarjeta de fila del √°rbol */
      .row-card {
        @apply flex items-center justify-between bg-[var(--base-gray)] rounded-xl px-4 py-3 shadow;
      }
      /* Animaci√≥n tri√°ngulo */
      .triangle-rotate {
        transition: transform 0.3s;
        display: inline-block;
      }
      .triangle-rotate.open {
        transform: rotate(180deg);
      }
      /* Animaci√≥n subcarpetas */
      .subcarpetas-anim {
        transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
        overflow: hidden;
        opacity: 1;
        max-height: 1000px;
      }
      .subcarpetas-anim.closed {
        opacity: 0;
        max-height: 0;
      }
    </style>
</head>
<body class="bg-[var(--base-gray)]" style='font-family: Manrope, "Noto Sans", sans-serif;'>
<!-- Modal bloqueante reutilizable de marca Recuiva -->
<div id="app-modal" class="fixed inset-0 z-[9999] hidden">
  <div class="absolute inset-0 bg-black/40 opacity-0 transition-opacity"></div>
  <div class="relative mx-auto max-w-md w-[92%] top-1/2 -translate-y-1/2
              bg-white rounded-2xl shadow-2xl border border-[var(--accent-color)]
              p-6 opacity-0 scale-95 transition-all">
    <div class="flex flex-col items-center text-center">
      <div class="size-14 rounded-full flex items-center justify-center mb-2
                  ring-1 ring-[var(--accent-color)] text-[var(--primary-color)] bg-[var(--base-white)]">
        <span class="material-symbols-outlined text-4xl" id="app-modal-icon">warning</span>
      </div>
      <h3 id="app-modal-title" class="text-xl font-bold text-[var(--text-primary)] mb-1">T√≠tulo</h3>
      <p id="app-modal-message" class="text-[var(--secondary-color)] mb-5">Mensaje‚Ä¶</p>
      <div class="flex gap-3 w-full justify-center">
        <button id="app-modal-cancel" class="px-5 py-2.5 rounded-lg border border-[var(--accent-color)]
                bg-white text-[var(--secondary-color)] font-semibold hidden">Cancelar</button>
        <button id="app-modal-ok" class="px-5 py-2.5 rounded-lg bg-[var(--primary-color)]
                text-white font-bold">Aceptar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal para agregar carpeta -->
<div id="modal-agregar-carpeta" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-xs flex flex-col gap-4">
    <h2 class="text-lg font-bold text-[var(--secondary-color)]">Agregar carpeta</h2>
    <div class="flex flex-col gap-2" id="modal-form-group">
      <!-- Aqu√≠ se insertan chips solo si es ra√≠z -->
      <div id="modal-modalidad-chips" class="flex flex-wrap gap-2"></div>
      <input id="modal-nombre-input" type="text" class="mt-2 px-3 py-2 rounded-lg border border-[var(--accent-color)] bg-[var(--base-gray)]" placeholder="Nombre" />
    </div>
    <div class="flex gap-2 justify-end mt-4">
      <button id="modal-cancelar-btn" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700 font-semibold">Cancelar</button>
      <button id="modal-agregar-btn" class="px-4 py-2 rounded-full bg-[var(--primary-color)] text-white font-bold">Agregar</button>
    </div>
  </div>
</div>
<div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
<header class="bg-[var(--base-white)] shadow-md sticky top-0 z-50">
<div class="container mx-auto px-4 md:px-6 py-3 flex justify-between items-center">
  <div class="flex items-center gap-3">
    <a href="index.html" class="flex items-center gap-2">
      <img src="assets/img/Icon-Recuiva.png" alt="Logo Recuiva" class="h-10 w-10 object-contain md:h-12 md:w-12" style="max-width:48px; max-height:48px;"/>
      <span class="recuiva-logo text-[var(--text-primary)]">Recuiva</span>
    </a>
  </div>
  <nav class="hidden md:flex items-center gap-4">
  <a class="text-[var(--primary-color)] font-semibold px-2 py-1 rounded-lg" href="#inicio">Inicio</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="app/materiales.html">Materiales</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="app/dashboard.html">Dashboard</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="app/repasos.html">Repasos</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="#" onclick="validarYIrAPractica(event)">Pr√°ctica</a>
  </nav>
  <div class="flex items-center gap-4">
    <!-- Bot√≥n men√∫ m√≥vil (solo m√≥vil) -->
    <button class="menu-btn z-50 p-2 rounded-full hover:bg-gray-100 md:hidden" id="menu-btn">
      <span class="material-symbols-outlined text-3xl text-[var(--text-primary)]">menu</span>
    </button>
  </div>

<!-- Mobile Menu -->
<div class="mobile-menu md:hidden fixed top-[73px] left-0 w-full bg-[var(--base-white)] z-40 shadow-lg" id="mobile-menu">
<div class="flex flex-col h-[calc(100vh-73px)] items-center justify-center gap-8">
  <!-- Perfil y configuraci√≥n arriba de navegaci√≥n -->
  <div class="flex flex-col items-center w-full mb-2 py-2">
    <a href="app/mi-perfil.html" class="flex flex-col items-center w-full px-6 py-2 hover:bg-gray-100 rounded-xl cursor-pointer transition-all">
      <img src="img/profile.jpg" alt="Perfil" class="w-10 h-10 rounded-full border-2 border-blue-700 mx-auto" />
      <span class="text-base font-semibold text-gray-800 mt-2 text-center">Mi perfil</span>
    </a>
  </div>
  <hr class="w-2/3 border-gray-300 my-2" />
  <!-- Navegaci√≥n principal -->
  <nav class="flex flex-col items-center gap-6 w-full">
  <a class="text-xl text-[var(--primary-color)] font-semibold" href="#inicio">Inicio</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="app/materiales.html">Materiales</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="app/dashboard.html">Dashboard</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="app/repasos.html">Repasos</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="#" onclick="validarYIrAPractica(event)">Pr√°ctica</a>
  </nav>
  <hr class="w-2/3 border-gray-300 my-2" />
  <button onclick="limpiarDatos()" class="flex items-center gap-2 text-base text-[var(--primary-color)] font-semibold">
  <span class="material-symbols-outlined">delete_sweep</span>
  Limpiar datos locales
  </button>
</div>
</header>

<main class="flex-grow">
  <!-- Hero / Bienvenida -->
  <section id="inicio" class="bg-[var(--base-white)] py-16 md:py-20 px-4 md:px-6">
    <div class="container mx-auto">
      <h1 id="titulo-bienvenida" class="text-center text-[34px] leading-tight md:text-6xl font-extrabold text-[var(--text-primary)] tracking-tight">
        ¬°<span style="color: #004EAA;">Bienvenido</span> a <span style="color: #ff6600;">Recuiva</span>!
      </h1>
      <!-- Onboarding + Entrenador alineados -->
      <div class="mt-8 md:mt-10 max-w-[1100px] mx-auto grid grid-cols-1 md:grid-cols-[1fr_320px] gap-6 md:gap-8 items-start">
        <!-- Board principal (asistente de organizaci√≥n) -->
        <div class="bg-[var(--base-white)] rounded-2xl shadow-xl border border-[var(--accent-color)] p-6 md:p-8">
          <h3 class="text-center text-xl md:text-2xl font-bold text-[var(--secondary-color)]">
            Organizaci√≥n
          </h3>
          <!-- chips -->
          <div class="mt-5 flex flex-wrap items-center justify-center gap-3" id="modalidad-chips">
            <button type="button" class="chip bg-[var(--base-gray)] text-[var(--text-primary)] px-4 py-2 rounded-full font-semibold hover:bg-[var(--accent-color)]" data-modalidad="Semestre">Semestre</button>
            <button type="button" class="chip bg-[var(--base-gray)] text-[var(--text-primary)] px-4 py-2 rounded-full font-semibold hover:bg-[var(--accent-color)]" data-modalidad="Curso/Materia">Curso/Materia</button>
            <button type="button" class="chip bg-[var(--base-gray)] text-[var(--text-primary)] px-4 py-2 rounded-full font-semibold hover:bg-[var(--accent-color)]" data-modalidad="Tema">Tema</button>
            <button type="button" class="chip bg-[var(--base-gray)] text-[var(--text-primary)] px-4 py-2 rounded-full font-semibold hover:bg-[var(--accent-color)]" data-modalidad="Proyecto">Proyecto</button>
            <button type="button" class="chip bg-[var(--base-gray)] text-[var(--text-primary)] px-4 py-2 rounded-full font-semibold hover:bg-[var(--accent-color)]" data-modalidad="Otro">Otro</button>
          </div>
          <!-- input nombre -->
          <div class="mt-4 flex flex-col items-center">
            <label for="modalidad-input" class="text-sm text-[var(--text-secondary)] mb-1">Nombre</label>
            <input id="modalidad-input" type="text" class="w-64 md:w-72 text-center px-3 py-2 rounded-lg border border-[var(--accent-color)] bg-[var(--base-gray)]" placeholder="Selecciona modalidad" />
          </div>
          <!-- CTA agregar carpeta -->
          <div class="mt-5 flex justify-center">
            <button type="button" id="agregar-carpeta-btn" class="px-5 py-2 rounded-full bg-[var(--primary-color)] text-white font-bold flex items-center gap-2 hover:bg-opacity-90">
                <span class="material-symbols-outlined" style="font-size:20px;">add</span>
                <span class="material-symbols-outlined" style="font-size:20px;">folder</span>
                <span>Agregar carpeta</span>
            </button>
          </div>
          <!-- √Årbol de carpetas -->
          <div id="carpetas-board" class="mt-7">
            <!-- se rellena por JS -->
          </div>
        </div>
        <!-- Panel del entrenador -->
        <aside class="bg-[var(--base-gray)] rounded-2xl p-6 md:p-7 min-h-[420px]">
          <div class="flex items-center gap-3">
            <img src="assets/img/Icon-Recuiva.png" alt="Avatar entrenador" class="w-12 h-12 rounded-full border-2 border-[var(--secondary-color)]" />
            <span class="font-bold text-[var(--secondary-color)]">Entrenador</span>
          </div>
          <p id="entrenador-texto" class="mt-4 text-[var(--text-secondary)] text-sm md:text-[15px]">
            ‚ÄúEmpieza eligiendo la modalidad (Semestre, Curso, Tema‚Ä¶) y n√≥mbrala. Luego agrega tu primera carpeta.‚Äù
          </p>
        </aside>
      </div>
    </div>
  </section>

  <!-- Tarjetas inferiores -->
  <section class="py-16 md:py-20 px-4 md:px-6 bg-[var(--base-gray)]">
    <div class="container mx-auto max-w-[1100px]">
      <div class="grid md:grid-cols-3 gap-6 md:gap-8">
        <!-- √öltima sesi√≥n -->
        <div class="bg-[var(--base-white)] p-6 md:p-8 rounded-xl shadow-md hover-lift">
          <div class="flex items-center mb-4">
            <span class="material-symbols-outlined text-3xl md:text-4xl text-[var(--secondary-color)] mr-3 md:mr-4">history</span>
            <h3 class="text-lg md:text-xl font-bold text-[var(--text-primary)]">√öltima sesi√≥n</h3>
          </div>
          <p id="last-session-text" class="text-[var(--text-secondary)] mb-4">Cargando...</p>
          <a id="last-session-link" class="text-[var(--primary-color)] font-bold hover:underline transition-colors cursor-pointer" href="#" onclick="validarYIrAPractica(event)">Continuar pr√°ctica ‚Üí</a>
        </div>

        <!-- Progreso -->
        <a href="app/dashboard.html" class="bg-[var(--base-white)] p-6 md:p-8 rounded-xl shadow-md hover-lift transition-all cursor-pointer block">
          <div class="flex items-center mb-4">
            <span class="material-symbols-outlined text-3xl md:text-4xl text-[var(--secondary-color)] mr-3 md:mr-4">trending_up</span>
            <h3 class="text-lg md:text-xl font-bold text-[var(--text-primary)]">Tu progreso</h3>
          </div>
          <div class="flex justify-around text-center">
            <div>
              <p id="progress-retention" class="text-2xl md:text-3xl font-bold text-[var(--primary-color)]">--</p>
              <p class="text-[var(--text-secondary)] text-sm">Retenci√≥n</p>
            </div>
            <div>
              <p id="progress-streak" class="text-2xl md:text-3xl font-bold text-[var(--primary-color)]">-- <span class="text-sm md:text-lg">d√≠as</span></p>
              <p class="text-[var(--text-secondary)] text-sm">Racha</p>
            </div>
          </div>
        </a>

        <!-- Temas a repasar -->
        <div class="bg-[var(--base-white)] p-6 md:p-8 rounded-xl shadow-md hover-lift">
          <div class="flex items-center mb-4">
            <span class="material-symbols-outlined text-3xl md:text-4xl text-[var(--secondary-color)] mr-3 md:mr-4">psychology_alt</span>
            <h3 class="text-lg md:text-xl font-bold text-[var(--text-primary)]">Temas a repasar</h3>
          </div>
          <ul id="review-topics-list" class="space-y-2 text-[var(--text-secondary)]">
            <li>Cargando...</li>
          </ul>
          <a class="text-[var(--primary-color)] font-bold hover:underline mt-3 inline-block transition-colors" href="app/repasos.html">Ver sugerencias ‚Üí</a>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="bg-[var(--secondary-color)] text-[var(--base-gray)] py-12 px-6 mt-16">
<div class="container mx-auto text-center">
<div class="flex justify-center items-center gap-2 mb-6">
<img src="assets/img/Icon-Recuiva.png" alt="Logo Recuiva" class="h-10 w-10 object-contain md:h-12 md:w-12" style="max-width:48px; max-height:48px;"/>
<span class="recuiva-logo">Recuiva</span>
</div>
<div class="flex flex-wrap items-center justify-center gap-x-6 gap-y-2 mb-6">
<a class="hover:text-[var(--primary-color)] transition-colors" href="app/institucional/active-recall.html">Active Recall</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="app/institucional/validacion-semantica.html">Validaci√≥n Sem√°ntica</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="app/institucional/diferencias.html">Diferencias</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="#">Contacto</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="#">T√©rminos</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="#">Privacidad</a>
</div>
<p class="text-sm">¬© 2025 Recuiva. Todos los derechos reservados.</p>
</div>
</footer>
<script>
// Modal bloqueante reutilizable de marca Recuiva
window.modal = (() => {
  const root = document.getElementById('app-modal');
  const overlay = root.children[0];
  const panel = root.children[1];
  const iconEl = document.getElementById('app-modal-icon');
  const titleEl = document.getElementById('app-modal-title');
  const msgEl = document.getElementById('app-modal-message');
  const okBtn = document.getElementById('app-modal-ok');
  const cancelBtn = document.getElementById('app-modal-cancel');
  let resolver = null, lastFocus = null;
  function open({title, message, icon, hasCancel, okText, cancelText}) {
    lastFocus = document.activeElement;
    iconEl.textContent = icon || 'warning';
    titleEl.textContent = title || '';
    titleEl.classList.toggle('hidden', !title);
    msgEl.textContent = message || '';
    okBtn.textContent = okText || 'Aceptar';
    cancelBtn.textContent = cancelText || 'Cancelar';
    cancelBtn.classList.toggle('hidden', !hasCancel);
    root.classList.remove('hidden'); document.body.classList.add('overflow-hidden');
    requestAnimationFrame(() => { overlay.classList.add('opacity-100'); panel.classList.add('opacity-100','scale-100'); });
    okBtn.focus();
  }
  function close() {
    overlay.classList.remove('opacity-100'); panel.classList.remove('opacity-100','scale-100');
    setTimeout(() => { root.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); lastFocus?.focus(); }, 150);
  }
  okBtn.onclick = () => { close(); resolver?.(true); };
  cancelBtn.onclick = () => { close(); resolver?.(false); };
  overlay.onclick = (e) => e.stopPropagation();
  window.addEventListener('keydown', e => { if (!root.classList.contains('hidden')) e.preventDefault(); }, true);
  return {
    alert({title='Aviso', message, icon='warning', okText='Aceptar'}={}) {
      return new Promise(res => { resolver = () => res(); open({title, message, icon, hasCancel:false, okText}); });
    },
    confirm({title='Confirmar', message, icon='warning', okText='S√≠', cancelText='Cancelar'}={}) {
      return new Promise(res => { resolver = (v)=>res(!!v); open({title, message, icon, hasCancel:true, okText, cancelText}); });
    }
  };
})();
  // Centrar texto del panel entrenador solo en m√≥vil
  function centrarEntrenadorTexto() {
    const txt = document.getElementById('entrenador-texto');
    if (window.innerWidth < 768) {
      txt.classList.add('text-center');
    } else {
      txt.classList.remove('text-center');
    }
  }
  window.addEventListener('resize', centrarEntrenadorTexto);
  centrarEntrenadorTexto();

// === FUNCIONES MODALES DE MATERIAL (SCOPE GLOBAL) ===
function mostrarModalMaterial(carpetaId, carpetaNombre, modalidad = '') {
  // Actualizar carpeta activa en el header
  if (typeof window.actualizarCarpetaActiva === 'function') {
    window.actualizarCarpetaActiva(carpetaNombre, modalidad);
  }
  
  const modalMaterial = `
    <div id="modal-material" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-carpeta-id="${carpetaId}" data-carpeta-nombre="${carpetaNombre}">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
          Agregar Material - ${carpetaNombre}
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ¬øC√≥mo vas a estudiar este tema?
        </p>
        <div class="space-y-4">
          <button onclick="seleccionarMaterial('pdf')" 
                  class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-[var(--primary-color)]">picture_as_pdf</span>
              <div>
                <div class="font-semibold">Tengo PDF o im√°genes</div>
                <div class="text-sm text-[var(--text-secondary)]">Subir√© material digital</div>
              </div>
            </div>
          </button>
          <button onclick="seleccionarMaterial('fisico')" 
                  class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-[var(--primary-color)]">menu_book</span>
              <div>
                <div class="font-semibold">Solo tengo libro f√≠sico</div>
                <div class="text-sm text-[var(--text-secondary)]">Usar√© mi "espejo de memoria"</div>
              </div>
            </div>
          </button>
          <button onclick="seleccionarMaterial('sin-material')" 
                  class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-[var(--primary-color)]">psychology</span>
              <div>
                <div class="font-semibold">Empezar sin material</div>
                <div class="text-sm text-[var(--text-secondary)]">Solo mis conocimientos previos</div>
              </div>
            </div>
          </button>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="cerrarModalMaterial()" 
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalMaterial);
}

function seleccionarMaterial(tipo) {
  alert('¬°Funcionando! Tipo: ' + tipo); // DEBUG - quitar despu√©s
  
  const modal = document.getElementById('modal-material');
  if (!modal) {
    alert('Modal no encontrado!');
    return;
  }
  
  const carpetaId = modal.dataset.carpetaId;
  const carpetaNombre = modal.dataset.carpetaNombre;
  
  console.log('Seleccionando material:', tipo, carpetaId, carpetaNombre);
  
  cerrarModalMaterial();
  
  if (tipo === 'pdf') {
    // Usuario tiene PDF/im√°genes ‚Üí ir a subir material
    window.location.href = `app/subir-material.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&tipo=pdf`;
  } else if (tipo === 'fisico') {
    // Usuario solo tiene libro f√≠sico ‚Üí modal explicativo y luego a crear pregunta
    mostrarModalLibroFisico(carpetaId, carpetaNombre);
  } else {
    // Usuario no tiene material ‚Üí directo a modal bienvenida
    mostrarModalBienvenida(carpetaId, carpetaNombre);
  }
}

function cerrarModalMaterial() {
  const modal = document.getElementById('modal-material');
  if (modal) modal.remove();
}

// Modal espec√≠fico para libro f√≠sico
function mostrarModalLibroFisico(carpetaId, carpetaNombre) {
  const modalLibro = `
    <div id="modal-libro-fisico" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
        <div class="text-center mb-6">
          <div class="text-6xl mb-4">üìö</div>
          <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-2">
            Perfecto, usar√°s tu libro f√≠sico
          </h3>
          <p class="text-[var(--text-secondary)]">
            ${carpetaNombre} - Modo "Espejo de Memoria"
          </p>
        </div>
        
        <div class="bg-[var(--base-gray)] p-4 rounded-lg mb-6">
          <h4 class="font-bold text-[var(--secondary-color)] mb-2">üß† ¬øC√≥mo funciona el "Espejo de Memoria"?</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-2">
            <li>‚Ä¢ <strong>Crear√°s preguntas</strong> basadas en tu libro</li>
            <li>‚Ä¢ <strong>Escribir√°s lo que recuerdas</strong> sin mirar el libro</li>
            <li>‚Ä¢ <strong>Despu√©s verificar√°s</strong> con tu libro f√≠sico</li>
            <li>‚Ä¢ <strong>Recuiva medir√° tu evoluci√≥n</strong> en cada sesi√≥n</li>
          </ul>
        </div>

        <div class="text-center">
          <p class="text-[var(--text-secondary)] mb-6">
            ¬øListo para crear tu primera pregunta de ${carpetaNombre}?
          </p>
          
          <div class="space-y-3">
            <button onclick="crearPrimeraPreguntaLibro('${carpetaId}', '${carpetaNombre}')"
                    class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
              üìù Crear Primera Pregunta
            </button>
            <button onclick="cerrarModalLibroFisico()"
                    class="w-full text-[var(--text-secondary)] py-2">
              Volver atr√°s
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalLibro);
}

function cerrarModalLibroFisico() {
  const modal = document.getElementById('modal-libro-fisico');
  if (modal) modal.remove();
}

function crearPrimeraPreguntaLibro(carpetaId, carpetaNombre) {
  cerrarModalLibroFisico();
  // Ir directo a crear primera pregunta para libro f√≠sico
  mostrarModalPrimeraPregunta(carpetaId, carpetaNombre, 'fisico');
}

// Modal para crear primera pregunta (scope global)
function mostrarModalPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
  const modalPregunta = `
    <div id="modal-pregunta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
        <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
          Primera Pregunta - ${carpetaNombre}
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${tipoMaterial === 'fisico' ? 
            'üìö Crea una pregunta basada en tu libro f√≠sico:' : 
            'Crea tu primera pregunta para practicar Active Recall:'}
        </p>
        
        <div class="mb-4">
          <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
            Tu pregunta:
          </label>
          <input id="input-pregunta" type="text" 
                 class="w-full p-3 border border-[var(--accent-color)] rounded-lg" 
                 placeholder="Ej: ¬øQu√© es la necrosis pulpar?">
          <div class="text-sm text-[var(--text-secondary)] mt-1">
            üí° Evita preguntas s√≠/no. Usa: ¬øqu√©?, ¬øc√≥mo?, ¬øpor qu√©?
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
            Tu autorrespuesta inicial ("espejo de memoria"):
          </label>
          <textarea id="input-autorrespuesta" 
                    class="w-full p-3 border border-[var(--accent-color)] rounded-lg h-24" 
                    placeholder="${tipoMaterial === 'fisico' ? 
                      'Escribe lo que recuerdas SIN mirar tu libro...' : 
                      'Escribe lo que crees recordar sobre esta pregunta...'}"></textarea>
          <div class="text-sm text-[var(--text-secondary)] mt-1">
            ${tipoMaterial === 'fisico' ? 
              'üìñ Despu√©s podr√°s verificar con tu libro f√≠sico' : 
              'Esto ser√° tu referencia base para medir tu evoluci√≥n'}
          </div>
        </div>

        <div class="flex gap-3">
          <button onclick="cerrarModalPregunta()" 
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancelar
          </button>
          <button onclick="guardarPrimeraPregunta('${carpetaId}', '${carpetaNombre}', '${tipoMaterial}')" 
                  class="flex-1 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
            Crear Pregunta
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalPregunta);
  
  // Focus en el input
  setTimeout(() => {
    document.getElementById('input-pregunta')?.focus();
  }, 100);
}

function cerrarModalPregunta() {
  const modal = document.getElementById('modal-pregunta');
  if (modal) modal.remove();
}

function guardarPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
  const pregunta = document.getElementById('input-pregunta')?.value.trim();
  const autorrespuesta = document.getElementById('input-autorrespuesta')?.value.trim();
  
  if (!pregunta) {
    alert('Por favor, escribe una pregunta');
    return;
  }
  
  if (!autorrespuesta) {
    alert('Por favor, escribe tu autorrespuesta inicial');
    return;
  }
  
  // Guardar en localStorage (simulaci√≥n)
  const preguntaData = {
    id: Date.now(),
    carpetaId: carpetaId,
    carpetaNombre: carpetaNombre,
    pregunta: pregunta,
    autorrespuesta: autorrespuesta,
    tipoMaterial: tipoMaterial,
    fechaCreacion: new Date().toISOString(),
    sesiones: []
  };
  
  // Guardar pregunta
  const preguntas = JSON.parse(localStorage.getItem('recuiva_preguntas') || '[]');
  preguntas.push(preguntaData);
  localStorage.setItem('recuiva_preguntas', JSON.stringify(preguntas));
  
  cerrarModalPregunta();
  
  // Mostrar modal de √©xito espec√≠fico para libro f√≠sico
  if (tipoMaterial === 'fisico') {
    mostrarModalExitoLibro(carpetaId, carpetaNombre);
  } else {
    mostrarModalExito(carpetaId, carpetaNombre);
  }
}

function mostrarModalExitoLibro(carpetaId, carpetaNombre) {
  const modalExito = `
    <div id="mensaje-exito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
          ¬°Primera pregunta creada!
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${carpetaNombre} est√° listo para Active Recall con tu libro f√≠sico. üìö
        </p>
        <div class="bg-[var(--base-gray)] p-4 rounded-lg mb-6 text-left">
          <h4 class="font-bold text-[var(--secondary-color)] mb-2">üìñ Recuerda:</h4>
          <p class="text-sm text-[var(--text-secondary)]">
            En cada sesi√≥n responder√°s primero de memoria, y despu√©s verificar√°s con tu libro.
          </p>
        </div>
        <div class="space-y-3">
          <button onclick="irAPractica()" 
                  class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
            üß† Empezar Primera Sesi√≥n
          </button>
          <button onclick="cerrarModalExito()" 
                  class="w-full text-[var(--text-secondary)] py-2">
            Volver al Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalExito);
}

function mostrarModalExito(carpetaId, carpetaNombre) {
  const modalExito = `
    <div id="mensaje-exito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
          ¬°Primera pregunta creada!
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${carpetaNombre} est√° listo para Active Recall. ¬øEmpezamos a practicar?
        </p>
        <div class="space-y-3">
          <button onclick="irAPractica()" 
                  class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
            üß† Empezar Sesi√≥n de Pr√°ctica
          </button>
          <button onclick="cerrarModalExito()" 
                  class="w-full text-[var(--text-secondary)] py-2">
            Volver al Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalExito);
}

function cerrarModalExito() {
  const modal = document.getElementById('mensaje-exito');
  if (modal) modal.remove();
}

function irAPractica() {
  window.location.href = 'app/sesion-practica.html';
}

function mostrarModalBienvenida(carpetaId, carpetaNombre) {
  const modalBienvenida = `
    <div id="modal-bienvenida" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">üéâ</div>
        <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
          ¬°Perfecto!
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${carpetaNombre} est√° listo. ¬øQu√© quieres hacer ahora?
        </p>
        <div class="space-y-3">
          <button onclick="iniciarSesionPractica('${carpetaId}', '${carpetaNombre}')"
                  class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
            üß† Empezar a Practicar
          </button>
          <button onclick="verMateriales('${carpetaId}')"
                  class="w-full border border-[var(--secondary-color)] text-[var(--secondary-color)] py-3 px-6 rounded-lg font-semibold hover:bg-gray-50 transition-all">
            üìö Ver Mis Materiales
          </button>
          <button onclick="cerrarModalBienvenida()"
                  class="w-full text-[var(--text-secondary)] py-2">
            Volver al Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalBienvenida);
}

function iniciarSesionPractica(carpetaId, carpetaNombre) {
  cerrarModalBienvenida();
  window.location.href = `app/sesion-practica.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&inicio=true`;
}

function verMateriales(carpetaId) {
  cerrarModalBienvenida();
  window.location.href = `app/materiales.html?carpeta=${carpetaId}&vista=carpeta`;
}

function cerrarModalBienvenida() {
  const modal = document.getElementById('modal-bienvenida');
  if (modal) modal.remove();
}

// --- SISTEMA DE VALIDACI√ìN DE CONFIGURACI√ìN (GLOBAL) ---

/**
 * Verifica si el usuario ha configurado carpeta, material y preguntas
 * @returns {object} { valido: boolean, razon: string }
 */
window.validarConfiguracion = function() {
  // 1. Verificar si existe al menos una carpeta configurada
  let tieneCarpetas = false;
  
  // Verificar en localStorage
  const carpetasGuardadas = localStorage.getItem('recuiva_carpetas');
  if (carpetasGuardadas) {
    try {
      const parsed = JSON.parse(carpetasGuardadas);
      tieneCarpetas = parsed && parsed.length > 0;
    } catch(e) {
      tieneCarpetas = false;
    }
  }
  
  if (!tieneCarpetas) {
    return { 
      valido: false, 
      razon: 'carpeta',
      mensaje: 'Primero debes crear una carpeta (Semestre, Curso, Tema, etc.)'
    };
  }
  
  // 2. Verificar si tiene preguntas creadas
  const preguntas = JSON.parse(localStorage.getItem('recuiva_preguntas') || '[]');
  
  if (!preguntas || preguntas.length === 0) {
    return { 
      valido: false, 
      razon: 'preguntas',
      mensaje: 'Necesitas crear al menos una pregunta para practicar'
    };
  }
  
  // Todo est√° listo para practicar
  return { 
    valido: true, 
    razon: 'completo',
    mensaje: 'Configuraci√≥n completa'
  };
};

/**
 * Muestra un modal cuando el usuario intenta acceder a pr√°ctica sin configurar
 */
window.mostrarModalAdvertenciaPractica = function(validacion) {
  const razon = validacion?.razon || 'carpeta';
  
  let pasos = '';
  let titulo = '¬°Espera un momento!';
  let descripcion = 'Antes de practicar, necesitas configurar tu material de estudio';
  
  if (razon === 'carpeta') {
    titulo = 'Configura tu primera carpeta';
    descripcion = 'Para comenzar a practicar, primero debes crear una carpeta de estudio';
    pasos = `
      <ol class="text-sm text-[var(--text-secondary)] space-y-2 ml-1">
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">1.</span>
          <span>Elige una <strong>modalidad</strong> (Semestre, Curso, Tema, etc.)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">2.</span>
          <span>Dale un <strong>nombre</strong> a tu carpeta</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">3.</span>
          <span>Haz clic en <strong>"+ Agregar carpeta"</strong></span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">4.</span>
          <span>Haz clic en <strong>"Entrar"</strong> en la carpeta creada</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">5.</span>
          <span>Selecciona tu tipo de material y crea una pregunta</span>
        </li>
      </ol>
    `;
  } else if (razon === 'preguntas') {
    titulo = 'Crea tu primera pregunta';
    descripcion = 'Ya tienes una carpeta, ahora necesitas crear al menos una pregunta para practicar';
    pasos = `
      <ol class="text-sm text-[var(--text-secondary)] space-y-2 ml-1">
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">1.</span>
          <span>Haz clic en el bot√≥n <strong>"Entrar"</strong> de tu carpeta</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">2.</span>
          <span>Selecciona tu <strong>tipo de material</strong> (PDF, libro f√≠sico, o sin material)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">3.</span>
          <span>Crea tu <strong>primera pregunta</strong> con su respuesta</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">4.</span>
          <span>¬°Listo! Ya podr√°s <strong>empezar a practicar</strong></span>
        </li>
      </ol>
    `;
  }
  
  const modalAdvertencia = `
    <div id="modal-advertencia-practica" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border border-[var(--accent-color)]">
        <div class="text-center mb-6">
          <div class="size-16 rounded-full flex items-center justify-center mx-auto mb-4
                      ring-2 ring-[var(--primary-color)] bg-orange-50">
            <span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">warning</span>
          </div>
          <h3 class="text-2xl font-bold text-[var(--text-primary)] mb-2">
            ${titulo}
          </h3>
          <p class="text-[var(--text-secondary)]">
            ${descripcion}
          </p>
        </div>
        
        <div class="bg-[var(--base-gray)] p-4 rounded-xl mb-6">
          <h4 class="font-bold text-[var(--secondary-color)] mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined">checklist</span>
            Pasos para comenzar:
          </h4>
          ${pasos}
        </div>

        <button onclick="cerrarModalAdvertenciaPractica()" 
                class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-bold 
                       hover:bg-opacity-90 transition-all shadow-lg">
          Entendido, voy a configurar
        </button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalAdvertencia);
};

/**
 * Cierra el modal de advertencia
 */
window.cerrarModalAdvertenciaPractica = function() {
  const modal = document.getElementById('modal-advertencia-practica');
  if (modal) modal.remove();
};

/**
 * Funci√≥n global para validar y redirigir a pr√°ctica
 * √ösala en los enlaces: onclick="validarYIrAPractica(event)"
 */
window.validarYIrAPractica = function(event) {
  if (event) event.preventDefault();
  
  const validacion = window.validarConfiguracion();
  if (!validacion.valido) {
    window.mostrarModalAdvertenciaPractica(validacion);
    return false;
  }
  
  window.location.href = 'app/sesion-practica.html';
  return true;
};

document.addEventListener('DOMContentLoaded', () => {
  
  // === FUNCIONES MODALES BACKEND MEJORADAS ===
  window.showBackendModal = function(icon, title, description) {
    showAdvancedModal(icon, title, description);
  };
  
  // Modal avanzado con mejor UX
  window.showAdvancedModal = function(icon, title, description) {
    // Crear modal si no existe
    let modal = document.getElementById('advanced-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'advanced-modal';
      modal.className = 'notification-modal';
      modal.innerHTML = `
        <div class="notification-modal-content">
          <div class="notification-icon-container">
            <span class="material-symbols-outlined text-2xl text-white" id="modal-icon">notifications</span>
          </div>
          <h3 id="modal-title">ÔøΩ Notificaciones</h3>
          <p id="modal-description">Sistema de notificaciones en tiempo real para repasos, recordatorios y actualizaciones de progreso. Requiere conexi√≥n con servidor. Por ahora puedes explorar la funcionalidad simulada. En la versi√≥n completa con backend, esto funcionar√° en tiempo real.</p>
          <button onclick="closeAdvancedModal()" class="modal-button">
            Aceptar
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Cerrar con escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
          closeAdvancedModal();
        }
      });
      
      // Cerrar clickeando fuera
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeAdvancedModal();
        }
      });
    }
    
    // Actualizar contenido
    const iconMap = {
      'notifications': 'üîî',
      'settings': '‚öôÔ∏è',
      'dashboard': 'üìä',
      'analytics': 'üìà'
    };
    
    document.getElementById('modal-icon').textContent = icon;
    document.getElementById('modal-title').textContent = `${iconMap[icon] || 'üìã'} ${title}`;
    document.getElementById('modal-description').textContent = description;
    
    // Mostrar modal con animaci√≥n
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  };
  
  window.closeAdvancedModal = function() {
    const modal = document.getElementById('advanced-modal');
    if (modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
  };
  
  // === FUNCIONES NAVEGACI√ìN ===
  
  // Funci√≥n para limpiar datos locales (reemplaza logout)
  window.limpiarDatos = function() {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro?\n\nSe borrar√°n todas tus carpetas, preguntas y progreso guardados.\n\nEsta acci√≥n no se puede deshacer.')) {
      localStorage.clear();
      alert('‚úÖ Datos locales eliminados correctamente.');
      window.location.reload();
    }
  };
  
  // Funci√≥n para mostrar configuraci√≥n (placeholder)
  window.mostrarConfiguracion = function() {
    showAdvancedModal('settings', 'Configuraci√≥n', 'Aqu√≠ podr√°s ajustar preferencias del sistema, exportar/importar datos, y personalizar tu experiencia de estudio.');
  };
  
  // Funci√≥n para actualizar carpeta activa en el header
  window.actualizarCarpetaActiva = function(nombre, tipo) {
    const displayDesktop = document.getElementById('carpeta-activa-nombre');
    const displayMobile = document.getElementById('carpeta-activa-nombre-mobile');
    const textoCompleto = tipo ? `${nombre} (${tipo})` : nombre;
    
    if (displayDesktop) displayDesktop.textContent = textoCompleto;
    if (displayMobile) displayMobile.textContent = textoCompleto;
    
    // Guardar en localStorage para persistencia
    localStorage.setItem('recuiva_carpeta_activa', JSON.stringify({ nombre, tipo }));
  };
  
  // Cargar carpeta activa al iniciar
  const carpetaActiva = localStorage.getItem('recuiva_carpeta_activa');
  if (carpetaActiva) {
    try {
      const { nombre, tipo } = JSON.parse(carpetaActiva);
      window.actualizarCarpetaActiva(nombre, tipo);
    } catch(e) {
      console.log('No hay carpeta activa guardada');
    }
  }
  
  // === DRAG & DROP HELPERS ===
  function findNodeById(id, nodes, parent = null) {
    for (let i = 0; i < nodes.length; i++) {
      if (nodes[i].id === id) return { node: nodes[i], parent, index: i };
      if (nodes[i].subcarpetas && nodes[i].subcarpetas.length) {
        const res = findNodeById(id, nodes[i].subcarpetas, nodes[i]);
        if (res) return res;
      }
    }
    return null;
  }
  
  // üî• CONSTRUIR RUTA BREADCRUMB (camino completo desde ra√≠z)
  function construirRutaBreadcrumb(carpetaId) {
    const ruta = [];
    function buscarRuta(id, nodes, camino = []) {
      for (const node of nodes) {
        const nuevoCamino = [...camino, node.nombre];
        if (node.id === id) {
          ruta.push(...nuevoCamino);
          return true;
        }
        if (node.subcarpetas && node.subcarpetas.length > 0) {
          if (buscarRuta(id, node.subcarpetas, nuevoCamino)) {
            return true;
          }
        }
      }
      return false;
    }
    buscarRuta(carpetaId, carpetas);
    return ruta;
  }
  
  function removeNode(id) {
    const found = findNodeById(id, carpetas);
    if (!found) return null;
    const { parent, index } = found;
    let arr = parent ? parent.subcarpetas : carpetas;
    const [node] = arr.splice(index, 1);
    return { node, fromParent: parent };
  }
  function insertNode(node, toParent, atIndex) {
    let arr = toParent ? toParent.subcarpetas : carpetas;
    arr.splice(atIndex, 0, node);
  }
  function moveNode(nodeId, destParentId, destIndex) {
    const removed = removeNode(nodeId);
    if (!removed) return;
    let node = removed.node;
    if (destParentId) {
      const dest = findNodeById(destParentId, carpetas);
      if (dest) {
        node.modalidad = dest.node.modalidad;
        dest.node._expand = true;
        insertNode(node, dest.node, destIndex);
      }
    } else {
      insertNode(node, null, destIndex);
    }
  }
  // --- Modal para agregar carpeta/subcarpeta ---
  function abrirModalAgregar(callback, esRaiz = false) {
    const modal = document.getElementById('modal-agregar-carpeta');
    const nombreInput = document.getElementById('modal-nombre-input');
    const agregarBtn = document.getElementById('modal-agregar-btn');
    const cancelarBtn = document.getElementById('modal-cancelar-btn');
    const chipsDiv = document.getElementById('modal-modalidad-chips');

    // Limpiar input y chips
    nombreInput.value = '';
    chipsDiv.innerHTML = '';

    // Si es ra√≠z, mostrar chips de modalidad
    if (esRaiz) {
      ['Semestre', 'Curso/Materia', 'Tema', 'Proyecto', 'Otro'].forEach(modalidad => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = modalidad;
        chip.onclick = () => {
          chipsDiv.querySelectorAll('button').forEach(b => b.classList.remove('is-active'));
          chip.classList.add('is-active');
        };
        chipsDiv.appendChild(chip);
      });
    }

    modal.classList.remove('hidden');

    function cerrarModal() {
      modal.classList.add('hidden');
      agregarBtn.onclick = null;
      cancelarBtn.onclick = null;
    }

    agregarBtn.onclick = async () => {
      const nombre = nombreInput.value.trim();
      if (!nombre) {
        await modal.alert({ message: 'Escribe el nombre de la carpeta.' });
        return;
      }
      let modalidad = null;
      if (esRaiz) {
        const activeChip = chipsDiv.querySelector('.is-active');
        if (!activeChip) {
          await modal.alert({ message: 'Selecciona una modalidad.' });
          return;
        }
        modalidad = activeChip.textContent;
      }
      cerrarModal();
      callback({ nombre, modalidad });
    };
    cancelarBtn.onclick = cerrarModal;
    // Cerrar con Escape
    modal.onkeydown = (e) => {
      if (e.key === 'Escape') cerrarModal();
    };
    nombreInput.focus();
  }
  // Men√∫ m√≥vil animaci√≥n landing-page
  const menuBtn = document.getElementById('menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = menuBtn.querySelector('.material-symbols-outlined');
  let isMenuOpen = false;
  function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    mobileMenu.classList.toggle('active');
    document.body.classList.toggle('overflow-hidden');
    menuIcon.style.transition = 'transform 0.3s ease, opacity 0.15s ease';
    if (isMenuOpen) {
      menuIcon.style.transform = 'rotate(90deg)';
      menuIcon.style.opacity = '0';
      setTimeout(() => {
        menuIcon.textContent = 'close';
        menuIcon.style.transform = 'rotate(0deg)';
        menuIcon.style.opacity = '1';
      }, 150);
    } else {
      menuIcon.style.transform = 'rotate(90deg)';
      menuIcon.style.opacity = '0';
      setTimeout(() => {
        menuIcon.textContent = 'menu';
        menuIcon.style.transform = 'rotate(0deg)';
        menuIcon.style.opacity = '1';
      }, 150);
    }
  }
  menuBtn.addEventListener('click', toggleMenu);
  const menuLinks = mobileMenu.querySelectorAll('a');
  menuLinks.forEach(link => {
    link.addEventListener('click', () => {
      if (isMenuOpen) {
        toggleMenu();
      }
    });
  });
  // Men√∫ de perfil
  const profileBtn = document.getElementById('profile-btn');
  const profileDropdown = document.getElementById('profile-dropdown');
  function toggleProfileMenu(e) {
    e.stopPropagation();
    profileDropdown.classList.toggle('active');
  }
  if (profileBtn && profileDropdown) {
    profileBtn.addEventListener('click', toggleProfileMenu);
    document.addEventListener('click', (e) => {
      if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
        profileDropdown.classList.remove('active');
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        profileDropdown.classList.remove('active');
      }
    });
  }

  // --- Onboarding jer√°rquico en un solo board CON PERSISTENCIA ---
  let carpetas = [];
  
  // üî• CARGAR CARPETAS DESDE LOCALSTORAGE AL INICIO
  function cargarCarpetasDesdeStorage() {
    console.log('üîç CARGANDO CARPETAS DESDE LOCALSTORAGE...');
    const stored = localStorage.getItem('recuiva_organization');
    console.log('   ‚Ä¢ Datos en storage:', stored ? stored.substring(0, 100) + '...' : 'null');
    
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        carpetas = parsed.carpetas || [];
        console.log('üìÇ Carpetas cargadas desde localStorage:', carpetas.length);
        console.log('   ‚Ä¢ Carpetas:', carpetas);
      } catch(e) {
        console.error('‚ùå Error al cargar carpetas:', e);
        carpetas = [];
      }
    } else {
      console.log('üì≠ Sin carpetas guardadas, iniciando vac√≠o');
      carpetas = [];
    }
  }
  
  // üî• GUARDAR CARPETAS EN LOCALSTORAGE
  function guardarCarpetasEnStorage() {
    try {
      console.log('üíæ GUARDANDO EN LOCALSTORAGE...');
      console.log('   ‚Ä¢ Carpetas a guardar:', carpetas);
      
      const data = { carpetas };
      const jsonString = JSON.stringify(data);
      
      console.log('   ‚Ä¢ JSON generado:', jsonString);
      console.log('   ‚Ä¢ Tama√±o:', jsonString.length, 'caracteres');
      
      localStorage.setItem('recuiva_organization', jsonString);
      
      // Verificar que se guard√≥ correctamente
      const verificacion = localStorage.getItem('recuiva_organization');
      console.log('   ‚Ä¢ Verificaci√≥n lectura:', verificacion ? 'OK' : 'ERROR');
      
      console.log('‚úÖ Carpetas guardadas en localStorage:', carpetas.length);
    } catch(e) {
      console.error('‚ùå Error al guardar carpetas:', e);
    }
  }
  
  // Elementos
  const modalidadChips = document.getElementById('modalidad-chips');
  const modalidadInput = document.getElementById('modalidad-input');
  let modalidadSeleccionada = null;

  // Modalidad chips l√≥gica
  modalidadChips.querySelectorAll('button[data-modalidad]').forEach(btn => {
    btn.addEventListener('click', () => {
      modalidadSeleccionada = btn.getAttribute('data-modalidad');
      modalidadChips.querySelectorAll('button').forEach(b => b.classList.remove('is-active'));
      btn.classList.add('is-active');
      modalidadInput.placeholder = {
        'Semestre': '2025-I',
        'Curso/Materia': 'Anatom√≠a',
        'Tema': 'Sistema Digestivo',
        'Proyecto': 'Proyecto Final',
        'Otro': 'Personalizado'
      }[modalidadSeleccionada] || 'Nombre';
    });
  });

  // Helpers para IDs √∫nicas
  function genId() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'id-' + Math.random().toString(36).substr(2, 9);
  }

  // Renderiza el √°rbol completo estilo Anki
  function renderTree() {
    const root = document.getElementById('carpetas-board');
    root.innerHTML = '';
    root.appendChild(renderLevel(carpetas, 0, null));
  }

  function renderLevel(level, depth, parentRef) {
    const frag = document.createDocumentFragment();
    level.forEach(carpeta => {
      frag.appendChild(buildRow(carpeta, depth, parentRef));
      if (carpeta._expand && carpeta.subcarpetas && carpeta.subcarpetas.length) {
        frag.appendChild(renderLevel(carpeta.subcarpetas, depth+1, carpeta));
      }
    });
    return frag;
  }

  function buildRow(carpeta, depth, parentRef) {
    const fila = document.createElement('div');
    fila.className = 'flex items-center justify-between bg-[var(--base-gray)] rounded-xl px-4 py-3 shadow relative';
    fila.style.marginLeft = `${depth * 32}px`;
    fila.setAttribute('draggable', 'true');
    // Gu√≠a visual
    if (depth > 0) {
      const guia = document.createElement('div');
      guia.className = 'tree-guide';
      guia.style.left = '-18px';
      fila.appendChild(guia);
    }
    // Drag handle
    const handle = document.createElement('span');
    handle.className = 'material-symbols-outlined drag-handle select-none';
    handle.textContent = 'drag_indicator';
    handle.title = 'Arrastrar para reordenar';
    let dragFromHandle = false;
    handle.addEventListener('mousedown', () => dragFromHandle = true);
    // Tri√°ngulo (solo si hay hijos)
    const hasKids = carpeta.subcarpetas && carpeta.subcarpetas.length > 0;
    const nombreSpan = document.createElement('span');
    nombreSpan.className = 'font-bold text-[var(--secondary-color)] flex items-center';
    nombreSpan.prepend(handle);
    if (hasKids) {
      const toggle = document.createElement('button');
      toggle.className = 'px-1 py-1 mr-2 rounded-full bg-white border border-[var(--accent-color)]';
      toggle.title = carpeta._expand ? 'Colapsar' : 'Expandir';
      toggle.innerHTML = `<span class="material-symbols-outlined triangle-rotate${carpeta._expand ? ' open' : ''}" style="font-size:20px;vertical-align:middle;">expand_more</span>`;
      toggle.onclick = (e) => { e.stopPropagation(); carpeta._expand = !carpeta._expand; renderTree(); };
      toggle.onkeydown = (e) => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); toggle.click(); } };
      nombreSpan.appendChild(toggle);
    }
    const folderIcon = document.createElement('span');
    folderIcon.className = 'material-symbols-outlined mr-1';
    folderIcon.style = 'font-size:22px;color:var(--secondary-color);vertical-align:middle;';
    folderIcon.textContent = 'folder';
    nombreSpan.appendChild(folderIcon);
    // etiqueta de modalidad solo en ra√≠z
    const isRoot = !parentRef;
    const label = carpeta.nombre + (isRoot && carpeta.modalidad ? ` <span class="text-xs text-gray-500 ml-2">(${carpeta.modalidad})</span>` : '');
    nombreSpan.insertAdjacentHTML('beforeend', label);
    const acciones = document.createElement('div');
    acciones.className = 'flex gap-2';
    const entrar = document.createElement('button');
    entrar.className = 'px-4 py-2 rounded-full bg-[var(--primary-color)] text-white font-bold hover:bg-opacity-90';
    entrar.title = 'Entrar';
    entrar.textContent = 'Entrar';
    entrar.onclick = () => { 
      // üî• GUARDAR RUTA ACTIVA (breadcrumb trail)
      const rutaCompleta = construirRutaBreadcrumb(carpeta.id);
      const rutaActiva = {
        carpetaId: carpeta.id,
        carpetaNombre: carpeta.nombre,
        carpetas: rutaCompleta,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('recuiva_active_path', JSON.stringify(rutaActiva));
      console.log('üìç Ruta activa guardada:', rutaCompleta.join(' ‚Ä∫ '));
      
      // Si es una carpeta hoja (sin subcarpetas), abrir modal de material
      if (!carpeta.subcarpetas || carpeta.subcarpetas.length === 0) {
        mostrarModalMaterial(carpeta.id, carpeta.nombre);
      } else {
        // Si tiene subcarpetas, expandir normalmente
        carpeta._expand = true; 
        renderTree(); 
      }
    };
    const add = document.createElement('button');
    add.className = 'px-3 py-2 rounded-full bg-blue-100 border border-blue-300 text-[var(--secondary-color)] font-semibold flex items-center';
    add.title = 'Agregar subcarpeta';
    add.innerHTML = `<span class="material-symbols-outlined mr-1" style="font-size:20px;">add</span><span class="material-symbols-outlined" style="font-size:20px;">folder</span>`;
    add.onclick = () => {
      abrirModalAgregar(({ nombre }) => {
        (carpeta.subcarpetas ||= []).push({ id: genId(), nombre, modalidad: carpeta.modalidad, subcarpetas: [], _expand:false });
        carpeta._expand = true;
        guardarCarpetasEnStorage(); // üî• PERSISTENCIA
        renderTree();
      }, false);
    };
    const del = document.createElement('button');
    del.className = 'px-2 py-2 rounded-full bg-red-100 border border-red-300 text-red-600 font-semibold';
    del.title = 'Eliminar';
    del.innerHTML = `<span class="material-symbols-outlined" style="font-size:20px;">delete</span>`;
    del.onclick = async () => {
      if (!await modal.confirm({ title: 'Eliminar', message: '¬øSeguro que quieres eliminar esta carpeta?' })) return;
      if (parentRef) {
        parentRef.subcarpetas = parentRef.subcarpetas.filter(x => x !== carpeta);
      } else {
        carpetas = carpetas.filter(x => x !== carpeta);
      }
      guardarCarpetasEnStorage(); // üî• PERSISTENCIA
      renderTree();
    };
    acciones.append(entrar, add, del);
    fila.append(nombreSpan, acciones);

    // --- Drag & Drop events ---
    fila.addEventListener('dragstart', (e) => {
      if (!dragFromHandle) { e.preventDefault(); return; }
      dragFromHandle = false;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', carpeta.id);
      fila.classList.add('dragging');
      // Ghost
      const ghost = fila.cloneNode(true);
      ghost.style.opacity = '0.7';
      ghost.style.position = 'absolute';
      ghost.style.pointerEvents = 'none';
      document.body.appendChild(ghost);
      e.dataTransfer.setDragImage(ghost, 40, 20);
      setTimeout(() => document.body.removeChild(ghost), 0);
    });
    let dropIntent = null;
    fila.addEventListener('dragover', (e) => {
      e.preventDefault();
      const rect = fila.getBoundingClientRect();
      const y = e.clientY - rect.top;
      const x = e.clientX - rect.left;
      let intent = null;
      if (y < rect.height / 3) intent = 'above';
      else if (y > rect.height * 2 / 3) intent = 'below';
      else if (x > depth * 32 + 24) intent = 'inside';
      else intent = 'below';
      dropIntent = intent;
      fila.classList.remove('drop-line-above', 'drop-line-below', 'drop-inside');
      if (intent === 'above') fila.classList.add('drop-line', 'drop-line-above');
      else if (intent === 'below') fila.classList.add('drop-line', 'drop-line-below');
      else if (intent === 'inside') fila.classList.add('drop-inside');
    });
    fila.addEventListener('dragleave', () => {
      fila.classList.remove('drop-line', 'drop-line-above', 'drop-line-below', 'drop-inside');
    });
    fila.addEventListener('drop', (e) => {
      e.preventDefault();
      fila.classList.remove('drop-line', 'drop-line-above', 'drop-line-below', 'drop-inside');
      const draggedId = e.dataTransfer.getData('text/plain');
      if (!draggedId || draggedId === carpeta.id) return;
      const draggedNode = findNodeById(draggedId, carpetas);
      if (!draggedNode) return;
      if (dropIntent === 'above') {
        const destParent = parentRef;
        const destIdx = destParent ? destParent.subcarpetas.indexOf(carpeta) : carpetas.indexOf(carpeta);
        moveNode(draggedId, destParent ? destParent.id : null, destIdx);
      } else if (dropIntent === 'below') {
        const destParent = parentRef;
        const destIdx = (destParent ? destParent.subcarpetas.indexOf(carpeta) : carpetas.indexOf(carpeta)) + 1;
        moveNode(draggedId, destParent ? destParent.id : null, destIdx);
      } else if (dropIntent === 'inside') {
        moveNode(draggedId, carpeta.id, carpeta.subcarpetas ? carpeta.subcarpetas.length : 0);
      }
      guardarCarpetasEnStorage(); // üî• PERSISTENCIA DESPU√âS DE REORDENAR
      renderTree();
    });
    fila.addEventListener('dragend', () => {
      fila.classList.remove('dragging', 'drop-line', 'drop-line-above', 'drop-line-below', 'drop-inside');
    });

    return fila;
  }

  // Evento para agregar carpeta ra√≠z
  document.getElementById('agregar-carpeta-btn').addEventListener('click', () => {
    console.log('üîµ CLICK EN BOT√ìN AGREGAR CARPETA');
    console.log('   ‚Ä¢ Nombre:', modalidadInput.value.trim());
    console.log('   ‚Ä¢ Modalidad seleccionada:', modalidadSeleccionada);
    
    const nombre = modalidadInput.value.trim();
    if (!modalidadSeleccionada || !nombre) {
      console.log('‚ö†Ô∏è Falta modalidad o nombre');
      modal.alert({ message: 'Selecciona modalidad y escribe el nombre.' });
      return;
    }
    
    const nuevaCarpeta = { id: genId(), nombre, modalidad: modalidadSeleccionada, subcarpetas: [], _expand: false };
    console.log('üìÅ Nueva carpeta creada:', nuevaCarpeta);
    
    carpetas.push(nuevaCarpeta);
    console.log('üì¶ Array carpetas despu√©s de push:', carpetas);
    
    modalidadInput.value = '';
    
    guardarCarpetasEnStorage(); // üî• PERSISTENCIA
    renderTree();
    
    console.log('‚úÖ Proceso completo');
  });

  // üî• INICIALIZAR: Cargar carpetas guardadas
  cargarCarpetasDesdeStorage();
  renderTree();

  // --- MODAL AGREGAR MATERIAL ---
  function mostrarModalMaterial(carpetaId, carpetaNombre) {
    const modalMaterial = `
      <div id="modal-material" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-carpeta-id="${carpetaId}" data-carpeta-nombre="${carpetaNombre}">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
            Agregar Material - ${carpetaNombre}
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            ¬øC√≥mo vas a estudiar este tema?
          </p>
          <div class="space-y-4">
            <button onclick="seleccionarMaterial('pdf')" 
                    class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[var(--primary-color)]">picture_as_pdf</span>
                <div>
                  <div class="font-semibold">Tengo PDF o im√°genes</div>
                  <div class="text-sm text-[var(--text-secondary)]">Subir√© material digital</div>
                </div>
              </div>
            </button>
            <button onclick="seleccionarMaterial('fisico')" 
                    class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[var(--primary-color)]">menu_book</span>
                <div>
                  <div class="font-semibold">Solo tengo libro f√≠sico</div>
                  <div class="text-sm text-[var(--text-secondary)]">Usar√© mi "espejo de memoria"</div>
                </div>
              </div>
            </button>
            <button onclick="seleccionarMaterial('sin-material')" 
                    class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[var(--primary-color)]">psychology</span>
                <div>
                  <div class="font-semibold">Empezar sin material</div>
                  <div class="text-sm text-[var(--text-secondary)]">Solo mis conocimientos previos</div>
                </div>
              </div>
            </button>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="cerrarModalMaterial()" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalMaterial);
  }

  function seleccionarMaterial(tipo) {
    alert('Funcionando! Tipo: ' + tipo); // DEBUG - quitar despu√©s
    
    const modal = document.getElementById('modal-material');
    if (!modal) {
      alert('Modal no encontrado!');
      return;
    }
    
    const carpetaId = modal.dataset.carpetaId;
    const carpetaNombre = modal.dataset.carpetaNombre;
    
    console.log('Seleccionando material:', tipo, carpetaId, carpetaNombre); // Debug
    
    cerrarModalMaterial();
    
    if (tipo === 'pdf') {
      // Ir a p√°gina de subir material con par√°metros
      window.location.href = `app/subir-material.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&tipo=pdf`;
    } else if (tipo === 'fisico') {
      // Ir a p√°gina de subir material para libro f√≠sico
      window.location.href = `app/subir-material.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&tipo=fisico`;
    } else {
      // Mostrar modal de bienvenida y luego ir a sesi√≥n pr√°ctica
      mostrarModalBienvenida(carpetaId, carpetaNombre);
    }
  }

  // Modal de bienvenida mejorado
  function mostrarModalBienvenida(carpetaId, carpetaNombre) {
    const modalBienvenida = `
      <div id="modal-bienvenida" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
          <div class="text-6xl mb-4">üéâ</div>
          <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
            ¬°Perfecto!
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            ${carpetaNombre} est√° listo. ¬øQu√© quieres hacer ahora?
          </p>
          <div class="space-y-3">
            <button onclick="iniciarSesionPractica('${carpetaId}', '${carpetaNombre}')"
                    class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
              üß† Empezar a Practicar
            </button>
            <button onclick="verMateriales('${carpetaId}')"
                    class="w-full border border-[var(--secondary-color)] text-[var(--secondary-color)] py-3 px-6 rounded-lg font-semibold hover:bg-gray-50 transition-all">
              üìö Ver Mis Materiales
            </button>
            <button onclick="cerrarModalBienvenida()"
                    class="w-full text-[var(--text-secondary)] py-2">
              Volver al Dashboard
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalBienvenida);
  }

  function iniciarSesionPractica(carpetaId, carpetaNombre) {
    cerrarModalBienvenida();
    // Ir a p√°gina de sesi√≥n pr√°ctica con par√°metros
    window.location.href = `app/sesion-practica.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&inicio=true`;
  }

  function verMateriales(carpetaId) {
    cerrarModalBienvenida();
    // Ir a p√°gina de materiales filtrada por carpeta
    window.location.href = `app/materiales.html?carpeta=${carpetaId}&vista=carpeta`;
  }

  function cerrarModalBienvenida() {
    const modal = document.getElementById('modal-bienvenida');
    if (modal) modal.remove();
  }

  function cerrarModalMaterial() {
    const modal = document.getElementById('modal-material');
    if (modal) modal.remove();
  }

  // --- MODAL PRIMERA PREGUNTA ---
  function mostrarModalPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
    const modalPregunta = `
      <div id="modal-pregunta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
          <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
            Primera Pregunta - ${carpetaNombre}
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            Crea tu primera pregunta para practicar Active Recall:
          </p>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
              Tu pregunta:
            </label>
            <input id="input-pregunta" type="text" 
                   class="w-full p-3 border border-[var(--accent-color)] rounded-lg" 
                   placeholder="Ej: ¬øQu√© es la necrosis pulpar?">
            <div class="text-sm text-[var(--text-secondary)] mt-1">
              üí° Evita preguntas s√≠/no. Usa: ¬øqu√©?, ¬øc√≥mo?, ¬øpor qu√©?
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
              Tu autorrespuesta inicial ("espejo de memoria"):
            </label>
            <textarea id="input-autorrespuesta" 
                      class="w-full p-3 border border-[var(--accent-color)] rounded-lg h-24" 
                      placeholder="Escribe lo que crees recordar sobre esta pregunta..."></textarea>
            <div class="text-sm text-[var(--text-secondary)] mt-1">
              Esto ser√° tu referencia base para medir tu evoluci√≥n
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="cerrarModalPregunta()" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button onclick="guardarPrimeraPregunta('${carpetaId}', '${carpetaNombre}', '${tipoMaterial}')" 
                    class="flex-1 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
              Crear Pregunta
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalPregunta);
    document.getElementById('input-pregunta').focus();
  }

  function guardarPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
    const pregunta = document.getElementById('input-pregunta').value.trim();
    const autorrespuesta = document.getElementById('input-autorrespuesta').value.trim();
    
    if (!pregunta || !autorrespuesta) {
      alert('Por favor completa ambos campos');
      return;
    }

    // Guardar en localStorage (simulaci√≥n)
    const dataPregunta = {
      carpetaId,
      carpetaNombre,
      pregunta,
      autorrespuesta,
      tipoMaterial,
      fechaCreacion: new Date().toISOString()
    };
    
    const preguntas = JSON.parse(localStorage.getItem('recuiva_preguntas') || '[]');
    preguntas.push(dataPregunta);
    localStorage.setItem('recuiva_preguntas', JSON.stringify(preguntas));

    cerrarModalPregunta();
    
    // Mostrar mensaje de √©xito
    const mensajeExito = `
      <div id="mensaje-exito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
          <span class="material-symbols-outlined text-4xl text-green-500 mb-4">check_circle</span>
          <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
            ¬°Primera pregunta creada!
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            Ya puedes empezar a practicar Active Recall con validaci√≥n sem√°ntica.
          </p>
          <div class="flex gap-3">
            <button onclick="cerrarMensajeExito()" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Quedarme aqu√≠
            </button>
            <button onclick="irAPractica()" 
                    class="flex-1 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
              Ir a Pr√°ctica
            </button>
          </div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', mensajeExito);
  }

  function cerrarModalPregunta() {
    const modal = document.getElementById('modal-pregunta');
    if (modal) modal.remove();
  }

  function cerrarMensajeExito() {
    const modal = document.getElementById('mensaje-exito');
    if (modal) modal.remove();
  }

  function irAPractica() {
    // Validar antes de ir a pr√°ctica usando la funci√≥n global
    const validacion = window.validarConfiguracion();
    if (!validacion.valido) {
      window.mostrarModalAdvertenciaPractica(validacion);
      return;
    }
    window.location.href = 'app/sesion-practica.html';
  }

  // --- INTEGRACI√ìN CON SISTEMA EXISTENTE ---
  // Modificar funci√≥n entrarCarpeta para incluir modal de material
  window.entrarCarpetaConMaterial = function(carpetaId) {
    const carpeta = findNodeById(carpetaId, carpetas);
    if (carpeta) {
      mostrarModalMaterial(carpetaId, carpeta.nombre);
    }
  };
});

// ==========================================
// SINCRONIZAR CARDS CON LOCALSTORAGE
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîÑ Sincronizando cards de index.html con localStorage...');
  
  // 1Ô∏è‚É£ √öLTIMA SESI√ìN
  try {
    const activeMaterialId = localStorage.getItem('active_material_id');
    const lastSessionText = document.getElementById('last-session-text');
    const lastSessionLink = document.getElementById('last-session-link');
    
    if (activeMaterialId && activeMaterialId !== 'null') {
      // Buscar preguntas del material activo
      const storageKey = `recuiva_questions_material_${activeMaterialId}`;
      const questions = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      if (questions.length > 0) {
        // Obtener la √∫ltima pregunta
        const lastQuestion = questions[questions.length - 1];
        const questionText = (lastQuestion.pregunta || lastQuestion.question || '').substring(0, 40);
        
        lastSessionText.textContent = `√öltima pregunta: "${questionText}..."`;
        lastSessionLink.href = `app/sesion-practica.html?material=${activeMaterialId}`;
        console.log('  ‚úì √öltima sesi√≥n: Material ID', activeMaterialId);
      } else {
        lastSessionText.textContent = 'A√∫n no hay preguntas en este material.';
        lastSessionLink.textContent = 'Empezar pr√°ctica ‚Üí';
        lastSessionLink.href = 'app/sesion-practica.html';
        console.log('  ‚ö†Ô∏è Material activo sin preguntas');
      }
    } else {
      lastSessionText.textContent = 'A√∫n no hay sesiones de pr√°ctica.';
      lastSessionLink.textContent = 'Empezar primera sesi√≥n ‚Üí';
      lastSessionLink.href = 'app/sesion-practica.html';
      console.log('  ‚ö†Ô∏è Sin material activo');
    }
  } catch (e) {
    console.error('‚ùå Error en √∫ltima sesi√≥n:', e);
    document.getElementById('last-session-text').textContent = 'Error al cargar.';
  }
  
  // 2Ô∏è‚É£ TU PROGRESO (sincronizar con Dashboard)
  try {
    const activeMaterialId = localStorage.getItem('active_material_id');
    const progressRetention = document.getElementById('progress-retention');
    const progressStreak = document.getElementById('progress-streak');
    
    if (activeMaterialId && activeMaterialId !== 'null') {
      const storageKey = `recuiva_questions_material_${activeMaterialId}`;
      const questions = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      if (questions.length > 0) {
        // Calcular score promedio (retenci√≥n)
        const scores = questions.map(q => q.score || 0).filter(s => s >= 0 && s <= 100);
        if (scores.length > 0) {
          const avgScore = Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length);
          progressRetention.innerHTML = `${avgScore}<span class="text-lg">%</span>`;
          console.log('  ‚úì Retenci√≥n:', avgScore + '%');
        } else {
          progressRetention.innerHTML = '0<span class="text-lg">%</span>';
        }
        
        // Calcular racha de d√≠as
        const streak = calculateStreak(questions);
        progressStreak.innerHTML = `${streak} <span class="text-sm md:text-lg">d√≠as</span>`;
        console.log('  ‚úì Racha:', streak, 'd√≠as');
      } else {
        progressRetention.innerHTML = '0<span class="text-lg">%</span>';
        progressStreak.innerHTML = '0 <span class="text-sm md:text-lg">d√≠as</span>';
        console.log('  ‚ö†Ô∏è Sin datos de progreso');
      }
    } else {
      progressRetention.innerHTML = '0<span class="text-lg">%</span>';
      progressStreak.innerHTML = '0 <span class="text-sm md:text-lg">d√≠as</span>';
      console.log('  ‚ö†Ô∏è Sin material activo para progreso');
    }
  } catch (e) {
    console.error('‚ùå Error en progreso:', e);
    document.getElementById('progress-retention').textContent = '--';
    document.getElementById('progress-streak').textContent = '--';
  }
  
  // 3Ô∏è‚É£ TEMAS A REPASAR (preguntas con score < 70%)
  try {
    const activeMaterialId = localStorage.getItem('active_material_id');
    const reviewTopicsList = document.getElementById('review-topics-list');
    
    if (activeMaterialId && activeMaterialId !== 'null') {
      const storageKey = `recuiva_questions_material_${activeMaterialId}`;
      const questions = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      // Filtrar preguntas con score < 70%
      const weakQuestions = questions.filter(q => (q.score || 0) < 70);
      
      if (weakQuestions.length > 0) {
        // Mostrar hasta 3 preguntas para repasar
        const topicsHTML = weakQuestions.slice(0, 3).map(q => {
          const questionText = (q.pregunta || q.question || 'Sin t√≠tulo').substring(0, 50);
          const score = Math.round(q.score || 0);
          return `<li>üìå ${questionText}... (${score}%)</li>`;
        }).join('');
        
        reviewTopicsList.innerHTML = topicsHTML;
        console.log('  ‚úì Temas a repasar:', weakQuestions.length);
      } else {
        reviewTopicsList.innerHTML = '<li class="text-green-600 font-semibold">‚ú® ¬°Excelente! No hay temas que necesiten repaso.</li>';
        console.log('  ‚úì Sin temas d√©biles');
      }
    } else {
      reviewTopicsList.innerHTML = '<li class="text-gray-400">A√∫n no hay repasos pendientes.</li>';
      console.log('  ‚ö†Ô∏è Sin material activo para repasos');
    }
  } catch (e) {
    console.error('‚ùå Error en temas a repasar:', e);
    document.getElementById('review-topics-list').innerHTML = '<li>Error al cargar.</li>';
  }
  
  console.log('‚úÖ Sincronizaci√≥n de cards completada');
});

// Funci√≥n auxiliar: Calcular racha de d√≠as
function calculateStreak(questions) {
  if (!questions || questions.length === 0) return 0;
  
  const sortedQuestions = [...questions].sort((a, b) => {
    const dateA = new Date(a.timestamp || a.createdAt || 0);
    const dateB = new Date(b.timestamp || b.createdAt || 0);
    return dateB - dateA;
  });
  
  let streak = 0;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  
  let currentDate = new Date(today);
  
  for (const question of sortedQuestions) {
    const questionDate = new Date(question.timestamp || question.createdAt || 0);
    questionDate.setHours(0, 0, 0, 0);
    
    if (questionDate.getTime() === currentDate.getTime()) {
      if (streak === 0) streak = 1;
    } else if (questionDate.getTime() === currentDate.getTime() - 86400000) {
      streak++;
      currentDate.setDate(currentDate.getDate() - 1);
    } else {
      break;
    }
  }
  
  return streak;
}
</script>

<!-- Modales adicionales para el onboarding completo -->

</body></html>
