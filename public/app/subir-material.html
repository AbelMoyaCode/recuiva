<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Subir Material - Recuiva</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/supabase-operations.js"></script>
    <script src="../assets/js/header-footer-components.js"></script>
    <style type="text/tailwindcss">
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      
      /* Estilo global para el logo Recuiva */
      .recuiva-logo {
        font-family: 'Manrope', sans-serif !important;
        font-weight: 800 !important;
        font-size: 1.5rem !important;
      }
      .upload-zone {
        border: 2px dashed var(--accent-color);
        transition: all 0.3s ease;
      }
      .upload-zone.dragover {
        border-color: var(--primary-color);
        background-color: rgba(255, 102, 0, 0.05);
      }
      .menu-btn {
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .menu-btn:hover {
        transform: scale(1.1);
      }
      .mobile-menu {
        transform-origin: top;
        transition: transform 0.3s ease, opacity 0.3s ease;
        transform: scaleY(0);
        opacity: 0;
        pointer-events: none;
        height: 100vh;
        overflow-y: auto;
      }
      .mobile-menu.active {
        transform: scaleY(1);
        opacity: 1;
        pointer-events: auto;
      }
      #menu-btn.active .menu-icon {
        transform: rotate(180deg);
      }
      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        padding: 0.75rem 0;
        min-width: 14rem;
        z-index: 50;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      }
      .profile-dropdown.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .profile-dropdown a, .profile-dropdown button {
        transition: all 0.2s ease;
      }
      .profile-dropdown a:hover, .profile-dropdown button:hover {
        transform: translateX(4px);
      }
      .notification-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: var(--primary-color);
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        min-width: 1.2rem;
        text-align: center;
      }
      
      /* Modal de notificaciones mejorado - Estilo elegante */
      .notification-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      .notification-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .notification-modal-content {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 26rem;
        margin: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.8) translateY(30px);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .notification-modal.show .notification-modal-content {
        transform: scale(1) translateY(0);
      }
      .notification-icon-container {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }
      .notification-modal h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
        text-align: center;
      }
      .notification-modal p {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #6b7280;
        text-align: center;
        margin-bottom: 2rem;
      }
      .modal-button {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        color: white;
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
        width: 100%;
      }
      .modal-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4);
      }
      .processing {
        animation: pulse 2s infinite;
      }
    </style>
</head>
<body class="bg-[var(--base-gray)] min-h-screen">

<!-- Header Container - Managed by header-footer-components.js -->
<div id="header-container"></div>

<main class="container mx-auto px-4 py-8 max-w-4xl">
  
  <!-- Breadcrumb -->
  <div class="mb-6">
    <nav class="text-sm text-[var(--text-secondary)]">
      <span id="carpeta-nombre" class="text-[var(--text-primary)] font-semibold"></span>
      <span class="mx-2">></span>
      <span>Subir Material</span>
    </nav>
  </div>

  <div class="bg-white rounded-xl shadow-lg p-8">
    
    <!-- Header -->
    <div class="text-center mb-8">
      <span class="material-symbols-outlined text-4xl text-[var(--primary-color)] mb-4">upload_file</span>
      <h1 class="text-2xl font-bold text-[var(--secondary-color)] mb-2">
        Subir Material de Estudio
      </h1>
      <p class="text-[var(--text-secondary)]">
        Sube tu PDF o im√°genes para generar el √≠ndice vectorial y habilitar la validaci√≥n sem√°ntica
      </p>
    </div>

    <!-- Secci√≥n de Materiales Existentes -->
    <div id="existing-materials-section" class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-bold text-[var(--secondary-color)]">
          üìö Materiales Disponibles
        </h2>
        <button onclick="refreshMaterials()" class="text-sm text-[var(--primary-color)] hover:underline flex items-center gap-1">
          <span class="material-symbols-outlined text-lg">refresh</span>
          Actualizar
        </button>
      </div>
      
      <!-- Tabla de materiales -->
      <div id="materials-list" class="bg-[var(--base-gray)] rounded-lg p-4 mb-6">
        <p class="text-center text-[var(--text-secondary)]">
          <span class="material-symbols-outlined animate-spin">progress_activity</span>
          Cargando materiales...
        </p>
      </div>
    </div>

    <!-- Zona de Upload -->
    <div id="upload-zone" class="upload-zone rounded-xl p-12 text-center mb-6">
      <span class="material-symbols-outlined text-6xl text-[var(--accent-color)] mb-4">cloud_upload</span>
      <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-2">
        Arrastra y suelta tu archivo aqu√≠
      </h3>
      <p class="text-[var(--text-secondary)] mb-4">
        o haz clic para seleccionar
      </p>
      <p class="text-sm text-[var(--text-secondary)]">
        Formatos soportados: PDF, JPG, PNG (max 50MB)
      </p>
      <input type="file" id="file-input" accept=".pdf,.jpg,.jpeg,.png" class="hidden" />
      <button onclick="document.getElementById('file-input').click()" 
              class="mt-4 px-6 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
        Seleccionar Archivo
      </button>
    </div>

    <!-- Progress -->
    <div id="progress-section" class="hidden mb-6">
      <div class="bg-[var(--base-gray)] rounded-lg p-4">
        <div class="flex items-center gap-3 mb-3">
          <span class="material-symbols-outlined text-[var(--primary-color)] processing">settings</span>
          <span class="font-semibold text-[var(--text-primary)]">Procesando material...</span>
          <span id="progress-percentage" class="ml-auto font-bold text-[var(--primary-color)]">0%</span>
        </div>
        
        <!-- Barra de progreso con animaci√≥n suave -->
        <div class="w-full bg-gray-200 rounded-full h-3 mb-3 overflow-hidden">
          <div id="progress-bar" 
               class="bg-gradient-to-r from-[var(--primary-color)] to-orange-500 h-3 rounded-full transition-all ease-out"
               style="width: 0%; transition-duration: 1.2s;"></div>
        </div>
        
        <!-- Descripci√≥n detallada con borde lateral -->
        <div class="border-l-4 border-[var(--secondary-color)] bg-blue-50 rounded-r-lg p-3">
          <p id="progress-text" class="text-sm text-[var(--secondary-color)] font-medium leading-relaxed">
            üöÄ Iniciando procesamiento...
          </p>
        </div>
      </div>
    </div>

    <!-- File Info -->
    <div id="file-info" class="hidden mb-6">
      <div class="bg-[var(--base-gray)] rounded-lg p-4">
        <div class="flex items-center gap-3">
          <span id="file-icon" class="material-symbols-outlined text-2xl text-[var(--primary-color)]"></span>
          <div class="flex-1">
            <div id="file-name" class="font-semibold text-[var(--text-primary)]"></div>
            <div id="file-size" class="text-sm text-[var(--text-secondary)]"></div>
          </div>
          <button onclick="removerArchivo()" class="text-red-500 hover:text-red-700">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Success -->
    <div id="success-section" class="hidden text-center">
      <span class="material-symbols-outlined text-4xl text-green-500 mb-4">check_circle</span>
      <h3 class="text-lg font-bold text-[var(--secondary-color)] mb-2">
        ¬°Material procesado exitosamente!
      </h3>
      <p class="text-[var(--text-secondary)] mb-6">
        Se ha generado el √≠ndice vectorial. Ahora puedes crear tu primera pregunta.
      </p>
      <div class="flex gap-4 justify-center">
        <button onclick="volverDashboard()" 
                class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Volver al Dashboard
        </button>
        <button onclick="crearPrimeraPregunta()" 
                class="px-6 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
          Crear Primera Pregunta
        </button>
      </div>
    </div>

  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // === FUNCIONES MODALES BACKEND MEJORADAS ===
  window.showBackendModal = function(icon, title, description) {
    showAdvancedModal(icon, title, description);
  };
  
  // Modal avanzado con mejor UX
  window.showAdvancedModal = function(icon, title, description) {
    // Crear modal si no existe
    let modal = document.getElementById('advanced-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'advanced-modal';
      modal.className = 'notification-modal';
      modal.innerHTML = `
        <div class="notification-modal-content">
          <div class="notification-icon-container">
            <span class="material-symbols-outlined text-2xl text-white" id="modal-icon">notifications</span>
          </div>
          <h3 id="modal-title">üîî Notificaciones</h3>
          <p id="modal-description">Sistema de notificaciones en tiempo real para repasos, recordatorios y actualizaciones de progreso. Requiere conexi√≥n con servidor. Por ahora puedes explorar la funcionalidad simulada. En la versi√≥n completa con backend, esto funcionar√° en tiempo real.</p>
          <button onclick="closeAdvancedModal()" class="modal-button">
            Aceptar
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Cerrar con escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
          closeAdvancedModal();
        }
      });
      
      // Cerrar clickeando fuera
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeAdvancedModal();
        }
      });
    }
    
    // Actualizar contenido
    const iconMap = {
      'notifications': 'üîî',
      'settings': '‚öôÔ∏è',
      'dashboard': 'üìä',
      'analytics': 'üìà'
    };
    
    document.getElementById('modal-icon').textContent = icon;
    document.getElementById('modal-title').textContent = `${iconMap[icon] || 'üìã'} ${title}`;
    document.getElementById('modal-description').textContent = description;
    
    // Mostrar modal con animaci√≥n
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  };
  
  window.closeAdvancedModal = function() {
    const modal = document.getElementById('advanced-modal');
    if (modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
  };
  
  // === FUNCIONES NAVEGACI√ìN ===
  window.logout = function() {
    if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
      localStorage.removeItem('recuiva_user');
      window.location.href = '../auth/iniciar-sesion.html';
    }
  };

  // Men√∫ m√≥vil animaci√≥n
  const menuBtn = document.getElementById('menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = menuBtn?.querySelector('.material-symbols-outlined');
  let isMenuOpen = false;

  function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    mobileMenu.classList.toggle('active');
    document.body.classList.toggle('overflow-hidden');
    if (!menuIcon) return;
    menuIcon.style.transition = 'transform 0.3s ease, opacity 0.15s ease';
    menuIcon.style.transform = 'rotate(90deg)';
    menuIcon.style.opacity = '0';
    setTimeout(() => {
      menuIcon.textContent = isMenuOpen ? 'close' : 'menu';
      menuIcon.style.transform = 'rotate(0deg)';
      menuIcon.style.opacity = '1';
    }, 150);
  }

  menuBtn?.addEventListener('click', toggleMenu);
  mobileMenu?.querySelectorAll('a, button').forEach(el => {
    el.addEventListener('click', () => { if (isMenuOpen) toggleMenu(); });
  });
  window.addEventListener('keydown', (e) => { if (isMenuOpen && e.key === 'Escape') toggleMenu(); });

  // Men√∫ de perfil
  const profileBtn = document.getElementById('profile-btn');
  const profileDropdown = document.getElementById('profile-dropdown');
  function toggleProfileMenu(e) {
    e.stopPropagation();
    profileDropdown.classList.toggle('active');
  }
  if (profileBtn && profileDropdown) {
    profileBtn.addEventListener('click', toggleProfileMenu);
    document.addEventListener('click', (e) => {
      if (!profileDropdown.contains(e.target) && !profileBtn.contains(e.target)) {
        profileDropdown.classList.remove('active');
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        profileDropdown.classList.remove('active');
      }
    });
  }

  // Obtener par√°metros URL
  const urlParams = new URLSearchParams(window.location.search);
  const carpetaId = urlParams.get('carpeta');
  const carpetaNombre = urlParams.get('nombre');
  
  // üî• SINCRONIZAR CON LA RUTA ACTIVA GUARDADA EN HOME.HTML
  const rutaActiva = JSON.parse(localStorage.getItem('recuiva_active_path') || '{}');
  
  if (rutaActiva.carpetas && rutaActiva.carpetas.length > 0) {
    // Mostrar la ruta completa (ejemplo: "El collar de la reina ‚Ä∫ Cap√≠tulo I")
    document.getElementById('carpeta-nombre').innerHTML = rutaActiva.carpetas.join(' <span class="mx-2">‚Ä∫</span> ');
  } else if (carpetaNombre) {
    // Fallback: usar solo el nombre del par√°metro URL
    document.getElementById('carpeta-nombre').textContent = decodeURIComponent(carpetaNombre);
  } else {
    // Fallback final
    document.getElementById('carpeta-nombre').textContent = 'Material';
  }

  const uploadZone = document.getElementById('upload-zone');
  const fileInput = document.getElementById('file-input');
  const progressSection = document.getElementById('progress-section');
  const fileInfo = document.getElementById('file-info');
  const successSection = document.getElementById('success-section');

  // Drag and drop
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
  });

  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
  });

  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });

  function handleFile(file) {
    // Validar tipo de archivo
    const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    if (!validTypes.includes(file.type)) {
      alert('Formato no soportado. Solo PDF, JPG o PNG.');
      return;
    }

    // Validar tama√±o (50MB)
    if (file.size > 50 * 1024 * 1024) {
      alert('Archivo demasiado grande. M√°ximo 50MB.');
      return;
    }

    mostrarInfoArchivo(file);
    procesarArchivo(file);
  }

  function mostrarInfoArchivo(file) {
    uploadZone.style.display = 'none';
    fileInfo.classList.remove('hidden');
    
    const icon = file.type === 'application/pdf' ? 'picture_as_pdf' : 'image';
    document.getElementById('file-icon').textContent = icon;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
  }

  async function procesarArchivo(file) {
    progressSection.classList.remove('hidden');
    
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const progressPercentage = document.getElementById('progress-percentage');
    
    try {
      // üîó GENERAR SESSION ID √öNICO PARA SSE
      const sessionId = `upload_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
      console.log('üîó Session ID para SSE:', sessionId);
      
      // üéØ CONECTAR A SSE ANTES DE INICIAR UPLOAD
      let eventSource = null;
      let lastPercentage = 0; // Controlar √∫ltima actualizaci√≥n
      
      try {
        eventSource = new EventSource(`${API_CONFIG.BASE_URL}/api/upload-progress/${sessionId}`);
        
        eventSource.onopen = () => {
          console.log('‚úÖ Conexi√≥n SSE establecida');
          // Inicializar en 0%
          progressBar.style.width = '0%';
          progressPercentage.textContent = '0%';
          progressText.textContent = 'üîå Conexi√≥n establecida, esperando eventos...';
        };
        
        eventSource.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log('üì© Evento SSE recibido:', data);
          
          // ‚ö° FORZAR ANIMACI√ìN: Solo actualizar si el porcentaje aument√≥
          if (data.progress !== undefined && data.progress > lastPercentage) {
            // Forzar reflow para que la animaci√≥n CSS se active
            progressBar.style.transition = 'none';
            void progressBar.offsetWidth; // Trigger reflow
            progressBar.style.transition = 'width 1.2s ease-out';
            
            // Actualizar valores
            progressBar.style.width = `${data.progress}%`;
            progressPercentage.textContent = `${data.progress}%`;
            lastPercentage = data.progress;
            
            console.log(`üéØ Progreso actualizado: ${data.progress}%`);
          }
          
          // Actualizar descripci√≥n con emoji y texto educativo
          if (data.message) {
            progressText.textContent = data.message;
          }
          
          // Cerrar conexi√≥n si est√° completo
          if (data.step === 'complete') {
            eventSource.close();
            console.log('‚úÖ SSE completado al 100%');
          }
        };
        
        eventSource.onerror = (error) => {
          console.error('‚ùå Error en SSE:', error);
          eventSource.close();
        };
        
      } catch (error) {
        console.error('‚ùå No se pudo conectar a SSE:', error);
      }
      
      // üì§ SUBIR AL BACKEND CON SESSION ID (sin inicializar progreso aqu√≠)
      
      const formData = new FormData();
      formData.append('file', file);
      
      // Obtener user_id del usuario autenticado
      const user = await SupabaseOperations.getCurrentUser();
      if (!user) {
        if (eventSource) eventSource.close();
        throw new Error('Usuario no autenticado');
      }
      
      const response = await fetch(`${API_CONFIG.BASE_URL}/api/materials/upload`, {
        method: 'POST',
        headers: {
          'X-User-ID': user.id,
          'X-Session-ID': sessionId  // üîë ENVIAR SESSION ID AL BACKEND
        },
        body: formData
      });
      
      if (!response.ok) {
        if (eventSource) eventSource.close();
        const errorData = await response.json().catch(() => ({ detail: 'Error desconocido' }));
        throw new Error(errorData.detail || `Error ${response.status}`);
      }
      
      const data = await response.json();
      
      // ‚úÖ Material ya guardado en Supabase por el backend
      const supabaseMaterialId = data.material_id;
      console.log('‚úÖ Material guardado en Supabase con UUID:', supabaseMaterialId);
      
      try {
        // Asociar a carpeta si existe
        const carpetaActiva = JSON.parse(localStorage.getItem('recuiva_carpeta_activa') || '{}');
        if (carpetaActiva.id && supabaseMaterialId) {
          await SupabaseOperations.linkMaterialToFolder(supabaseMaterialId, carpetaActiva.id);
          console.log(`üìÇ Material asociado a carpeta en Supabase:`, carpetaActiva);
          
          // SPRINT 2: Asignar t√≥pico autom√°ticamente
          const topicId = localStorage.getItem(`folder_topic_${carpetaActiva.id}`);
          if (topicId) {
            try {
              const token = localStorage.getItem('sb-access-token');
              const topicResponse = await fetch(`${API_BASE_URL}/api/materials/${supabaseMaterialId}/assign-topic?topic_id=${topicId}`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (topicResponse.ok) {
                console.log('‚úÖ Material asignado al t√≥pico de la carpeta:', topicId);
              }
            } catch (topicError) {
              console.warn('‚ö†Ô∏è Error asignando t√≥pico (no cr√≠tico):', topicError);
            }
          }
        }
        
      } catch (supabaseError) {
        console.error('‚ö†Ô∏è Error guardando en Supabase:', supabaseError);
        // No bloqueamos el flujo, el material ya est√° en el backend
      }
      
      // Guardar el ID del material de Supabase para navegaci√≥n
      if (supabaseMaterialId) {
        localStorage.setItem('recuiva_last_uploaded_material_id', supabaseMaterialId);
      } else if (data.material_id) {
        // Fallback al ID del backend
        localStorage.setItem('recuiva_last_uploaded_material_id', data.material_id);
      }
      
      // Cerrar conexi√≥n SSE si a√∫n est√° abierta
      if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
        eventSource.close();
        console.log('üîå Conexi√≥n SSE cerrada manualmente');
      }
      
      // Finalizar procesamiento
      progressSection.classList.add('hidden');
      fileInfo.classList.add('hidden');
      successSection.classList.remove('hidden');
      
      // ‚úÖ ACTUALIZAR LA TABLA DE MATERIALES AUTOM√ÅTICAMENTE
      setTimeout(() => {
        refreshMaterials();
      }, 500);
      
      console.log('‚úÖ Material subido:', data);
      
    } catch (error) {
      console.error('‚ùå Error subiendo material:', error);
      
      // Cerrar SSE en caso de error
      if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
        eventSource.close();
        console.log('üîå Conexi√≥n SSE cerrada por error');
      }
      
      progressBar.style.width = '0%';
      progressText.textContent = '';
      progressSection.classList.add('hidden');
      alert(`Error al subir el archivo:\n\n${error.message}\n\nVerifica que el backend est√© ejecut√°ndose en puerto 8000.`);
      
      // Resetear
      fileInfo.classList.add('hidden');
      uploadZone.style.display = 'block';
      fileInput.value = '';
    }
  }
  
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  window.removerArchivo = function() {
    fileInfo.classList.add('hidden');
    uploadZone.style.display = 'block';
    fileInput.value = '';
  };

  window.volverDashboard = function() {
    window.location.href = 'home.html';
  };

  window.crearPrimeraPregunta = function() {
    // Ir a la sesi√≥n de pr√°ctica con el material reci√©n cargado
    // Usar el ID del √∫ltimo material subido desde localStorage
    const lastMaterialId = localStorage.getItem('recuiva_last_uploaded_material_id');
    if (lastMaterialId) {
      window.location.href = `sesion-practica.html?material=${lastMaterialId}`;
    } else {
      // Fallback: ir sin par√°metros
      window.location.href = 'sesion-practica.html';
    }
  };

  // ===== FUNCIONES PARA GESTI√ìN DE MATERIALES =====
  
  window.refreshMaterials = async function() {
    const materialsListDiv = document.getElementById('materials-list');
    
    try {
      materialsListDiv.innerHTML = `
        <p class="text-center text-[var(--text-secondary)]">
          <span class="material-symbols-outlined animate-spin">progress_activity</span>
          Cargando materiales...
        </p>
      `;
      
      // ‚úÖ CORRECCI√ìN PROFESOR: Enviar token de autenticaci√≥n para filtrar por usuario
      const user = await SupabaseOperations.getCurrentUser();
      const session = await supabaseClient.auth.getSession();
      const token = session?.data?.session?.access_token;
      
      const headers = {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      
      const response = await fetch(`${API_CONFIG.BASE_URL}/api/materials`, { headers });
      const data = await response.json();
      
      if (!data.success || data.materials.length === 0) {
        materialsListDiv.innerHTML = `
          <div class="text-center py-6">
            <span class="material-symbols-outlined text-4xl text-[var(--accent-color)] mb-2">folder_open</span>
            <p class="text-[var(--text-secondary)]">
              No hay materiales subidos a√∫n.<br>
              Sube tu primer PDF para empezar.
            </p>
          </div>
        `;
        return;
      }
      
      // Crear tabla de materiales
      let tableHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="border-b border-gray-300">
                <th class="text-left py-2 px-3 font-semibold text-[var(--text-primary)]">ID</th>
                <th class="text-left py-2 px-3 font-semibold text-[var(--text-primary)]">Archivo</th>
                <th class="text-left py-2 px-3 font-semibold text-[var(--text-primary)]">Chunks</th>
                <th class="text-left py-2 px-3 font-semibold text-[var(--text-primary)]">P√°ginas (est.)</th>
                <th class="text-left py-2 px-3 font-semibold text-[var(--text-primary)]">Fecha</th>
                <th class="text-left py-2 px-3 font-semibold text-[var(--text-primary)]">Estado</th>
                <th class="text-center py-2 px-3 font-semibold text-[var(--text-primary)]">Acciones</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      data.materials.forEach(material => {
        // Formatear fecha desde Supabase (ISO 8601)
        let uploadDate = 'N/A';
        try {
          if (material.created_at) {
            uploadDate = new Date(material.created_at).toLocaleDateString('es-ES');
          } else if (material.uploaded_at) {
            // Fallback para formato antiguo YYYYMMDD
            uploadDate = new Date(
              material.uploaded_at.slice(0,4), 
              parseInt(material.uploaded_at.slice(4,6))-1, 
              material.uploaded_at.slice(6,8)
            ).toLocaleDateString('es-ES');
          }
        } catch (e) {
          console.warn('Error parseando fecha:', e);
          uploadDate = 'N/A';
        }
        
        const fileStatus = material.processing_status === 'completed' ? 
          '<span class="text-green-600">‚úì Procesado</span>' :
          '<span class="text-yellow-600">‚ö† Procesando</span>';
        
        tableHTML += `
          <tr class="border-b border-gray-200 hover:bg-white transition-colors">
            <td class="py-2 px-3 font-mono text-xs">${material.id.substring(0, 8)}...</td>
            <td class="py-2 px-3">
              <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-lg text-[var(--primary-color)]">picture_as_pdf</span>
                <span class="font-medium">${material.title || material.file_name}</span>
              </div>
            </td>
            <td class="py-2 px-3 text-center">${material.total_chunks}</td>
            <td class="py-2 px-3 text-center">${material.estimated_pages || 'N/A'}</td>
            <td class="py-2 px-3">${uploadDate}</td>
            <td class="py-2 px-3">${fileStatus}</td>
            <td class="py-2 px-3 text-center">
              <div class="flex items-center justify-center gap-2">
                <button 
                  onclick="useMaterial('${material.id}')" 
                  class="text-[var(--primary-color)] hover:text-[var(--secondary-color)] font-semibold text-xs px-2 py-1 rounded hover:bg-gray-100"
                  title="Usar este material">
                  Usar
                </button>
                <button 
                  onclick="eliminarMaterial('${material.id}', '${material.title || material.file_name}')" 
                  class="text-red-500 hover:text-red-700 p-1 rounded hover:bg-red-50"
                  title="Eliminar material">
                  <span class="material-symbols-outlined text-lg">delete</span>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      
      materialsListDiv.innerHTML = tableHTML;
      
    } catch (error) {
      console.error('Error cargando materiales:', error);
      materialsListDiv.innerHTML = `
        <div class="text-center py-4">
          <span class="material-symbols-outlined text-3xl text-red-500 mb-2">error</span>
          <p class="text-red-600 font-semibold">Error al cargar materiales</p>
          <p class="text-sm text-[var(--text-secondary)] mt-1">
            ${error.message || 'Verifica que el backend est√© ejecut√°ndose en puerto 8000'}
          </p>
          <button 
            onclick="refreshMaterials()" 
            class="mt-3 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 text-sm">
            Reintentar
          </button>
        </div>
      `;
    }
  };
  
  window.useMaterial = function(materialId) {
    // Redirigir a sesi√≥n de pr√°ctica con este material
    window.location.href = `sesion-practica.html?material_id=${materialId}`;
  };
  
  // ‚úÖ FUNCI√ìN PARA ELIMINAR MATERIAL
  window.eliminarMaterial = async function(materialId, filename) {
    if (!confirm(`¬øEst√°s seguro de eliminar "${filename}"?\n\nEsto eliminar√°:\n- El material del backend\n- Todos los embeddings asociados\n- El archivo PDF si existe`)) {
      return;
    }
    
    try {
  const response = await fetch(`${API_CONFIG.BASE_URL}/api/materials/${materialId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Error al eliminar material');
      }
      
      const result = await response.json();
      console.log('Material eliminado:', result);
      
      // Mostrar confirmaci√≥n
      alert(`‚úÖ Material "${filename}" eliminado exitosamente\n\n${result.message || 'Eliminaci√≥n completada'}`);
      
      // Refrescar la lista de materiales
      refreshMaterials();
      
    } catch (error) {
      console.error('Error eliminando material:', error);
      alert(`‚ùå Error al eliminar material:\n\n${error.message}`);
    }
  };
  
  // Cargar materiales al iniciar la p√°gina
  refreshMaterials();
});
</script>

<!-- Scripts del Backend API -->
<script src="../assets/js/api.js"></script>
<script src="../assets/js/upload-material.js"></script>

<!-- Footer Container - Managed by header-footer-components.js -->
<div id="footer-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeHeaderFooter('materiales');
});
</script>

</body>
</html>
