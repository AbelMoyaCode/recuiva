<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<title>Recuiva - Sesi√≥n Pr√°ctica</title>
<link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico"/>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase Auth -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../assets/js/api.js"></script>
<script src="../assets/js/supabase-config.js"></script>
<script src="../assets/js/supabase-operations.js"></script>
<script src="../assets/js/header-footer-components.js"></script>
<!-- Funciones cr√≠ticas que deben cargar ANTES del HTML -->
<script src="../assets/js/sesion-practica-helpers.js"></script>
<!-- Sistema de Repaso Espaciado -->
<script src="../assets/js/spaced-repetition.js"></script>
<script src="../assets/js/repetition-data.js"></script>
<style type="text/tailwindcss">
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      
      /* Estilo global para el logo Recuiva */
      .recuiva-logo {
        font-family: 'Manrope', sans-serif !important;
        font-weight: 800 !important;
        font-size: 1.5rem !important;
      }
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      .menu-btn {
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .menu-btn:hover {
        transform: scale(1.1);
      }
      /* ESTILOS DE MEN√ö M√ìVIL MOVIDOS A header-footer-components.js */
      /* Ya no se definen aqu√≠ para evitar conflictos */
      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        padding: 0.75rem 0;
        min-width: 14rem;
        z-index: 50;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      }
      .profile-dropdown.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .profile-dropdown a, .profile-dropdown button {
        transition: all 0.2s ease;
      }
      .profile-dropdown a:hover, .profile-dropdown button:hover {
        transform: translateX(4px);
      }
      .notification-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: var(--primary-color);
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        min-width: 1.2rem;
        text-align: center;
      }
      
      /* Modal de notificaciones mejorado - Estilo elegante */
      .notification-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      .notification-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .notification-modal-content {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 26rem;
        margin: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.8) translateY(30px);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .notification-modal.show .notification-modal-content {
        transform: scale(1) translateY(0);
      }
      .notification-icon-container {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }
      .notification-modal h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
        text-align: center;
      }
      .notification-modal p {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #6b7280;
        text-align: center;
        margin-bottom: 2rem;
      }
      .modal-button {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        color: white;
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
        width: 100%;
      }
      .modal-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4);
      }
      
      /* Scrollbar personalizado para lista de preguntas */
      #questions-list::-webkit-scrollbar {
        width: 6px;
      }
      #questions-list::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      #questions-list::-webkit-scrollbar-thumb {
        background: #FF6600;
        border-radius: 10px;
      }
      #questions-list::-webkit-scrollbar-thumb:hover {
        background: #FF8533;
      }
    </style>
</head>
<body class="bg-[var(--base-gray)]" style='font-family: Manrope, "Noto Sans", sans-serif;'>
<div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
<!-- Header Container - Managed by header-footer-components.js -->
<div id="header-container"></div>

<main class="flex-grow">
<div class="flex-grow w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
<div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-gray-200/80 flex flex-col">
<div class="p-6 pb-4 border-b border-gray-200">
<h2 class="text-xl font-bold text-gray-900 mb-3">Preguntas</h2>
</div>
<div class="p-6 flex-1 overflow-y-auto" style="max-height: calc(100vh - 250px);">
<nav class="space-y-2" id="questions-list">
  <!-- Se llenar√° din√°micamente con las preguntas guardadas -->
  <div class="text-center py-8 text-gray-400">
    <span class="material-symbols-outlined text-4xl mb-2">quiz</span>
    <p class="text-sm">A√∫n no hay preguntas</p>
    <p class="text-xs mt-1">Crea tu primera pregunta ‚Üí</p>
  </div>
</nav>
</div>
</div>
      <!-- PANEL PRINCIPAL DE PR√ÅCTICA (ESTILO PYTHON GUI) -->
      <div class="lg:col-span-6 bg-white rounded-xl shadow-sm border border-gray-200/80 p-6 md:p-8 space-y-6">
        
        <!-- üìÑ MATERIAL DE ESTUDIO ACTUAL -->
        <div id="current-material-banner" class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-300 rounded-xl p-4 mb-4" style="display: none;">
          <!-- BREADCRUMB DE RUTA (ARRIBA DEL TODO) -->
          <div id="breadcrumb-carpeta" class="flex items-center gap-2 mb-3 pb-3 border-b border-orange-200">
            <span class="material-symbols-outlined text-blue-600">folder_open</span>
            <span id="breadcrumb-nombre" class="text-sm font-semibold text-gray-700">Sin carpeta</span>
          </div>
          
          <div class="flex items-center gap-3">
            <span class="material-symbols-outlined text-3xl text-orange-600">picture_as_pdf</span>
            <div class="flex-1">
              <div class="text-xs font-semibold text-orange-800 uppercase tracking-wide mb-1">Material de Estudio</div>
              <div id="material-filename" class="text-base font-bold text-gray-900">Cargando...</div>
              <div id="material-stats" class="text-xs text-gray-600 mt-1">0 chunks disponibles</div>
              <div id="material-location" class="text-xs text-blue-600 font-semibold mt-1 flex items-center gap-1">
                <span class="material-symbols-outlined text-sm">arrow_forward</span>
                <span>Chunk: Cargando...</span>
              </div>
            </div>
            <span class="text-green-600 font-bold text-sm">‚úì Activo</span>
          </div>
        </div>
        
        <!-- ÔøΩüìù TU PREGUNTA (EL USUARIO LA ESCRIBE) -->
        <div class="space-y-3">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-3xl text-blue-600">help</span>
            <h3 class="text-lg font-bold text-gray-900">ESCRIBE TU PREGUNTA</h3>
          </div>
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4">
            <p class="text-sm text-gray-700 mb-3">
              <span class="font-semibold">üí° Active Recall:</span> Escribe una pregunta sobre el material que acabas de estudiar. Luego resp√≥ndela SIN mirar el material.
            </p>
            <textarea 
              id="user-question" 
              class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200 text-base font-medium resize-none"
              placeholder="Ejemplo: ¬øPor qu√© inicialmente se sospech√≥ de Henriette?"
              rows="3"
              oninput='window.checkValidateButton()'
            ></textarea>
            
            <!-- üÜï SPRINT 2: Bot√≥n para generar preguntas autom√°ticamente del material -->
            <div class="mt-4 pt-4 border-t-2 border-blue-200">
              <button 
                id="btn-generate-questions"
                onclick="generateQuestionsAuto()"
                class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-200 flex items-center justify-center gap-2 text-base font-bold shadow-lg hover:shadow-xl transform hover:scale-105">
                <span class="material-symbols-outlined text-xl">auto_awesome</span>
                Generar Preguntas Autom√°ticamente
              </button>
              <p class="text-xs text-gray-600 mt-2 text-center">
                ‚ú® El sistema generar√° preguntas inteligentes basadas en el contenido de tu material
              </p>
            </div>
          </div>
        </div>

        <!-- ‚úçÔ∏è √ÅREA DE RESPUESTA DEL USUARIO -->
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="material-symbols-outlined text-2xl text-green-600">edit_note</span>
              <h3 class="text-lg font-bold text-gray-900">TU RESPUESTA (sin mirar el material)</h3>
            </div>
            <span id="char-count" class="text-sm text-gray-500">0 caracteres</span>
          </div>
          <textarea 
            id="user-answer" 
            class="form-textarea w-full resize-none rounded-lg border-2 border-gray-300 focus:border-green-500 focus:ring-2 focus:ring-green-200 transition duration-200 p-4 font-sans text-base leading-relaxed bg-white" 
            placeholder="Escribe tu respuesta aqu√≠ con TUS propias palabras...

Ejemplo: Porque viv√≠a en el mismo edificio, ten√≠a acceso visual al patio y a la ventana del gabinete, y conoc√≠a que el collar se guardaba all√≠, aunque no se hall√≥ evidencia directa."
            rows="10"
            oninput='window.updateCharCount(this);'
          ></textarea>
          
          <!-- BOTONES DE ACCI√ìN -->
          <div class="flex items-center justify-between gap-4">
            <div class="flex gap-3">
              <span class="text-sm text-gray-600 italic">üí° Tip: Explica el "por qu√©" y el "c√≥mo", no solo memorices</span>
            </div>
            <div class="flex gap-3">
              <button 
                id="btn-validate-answer" 
                onclick='window.validateWithBackend()' 
                class="flex items-center gap-2 rounded-lg bg-green-600 text-white font-bold px-6 py-3 text-base transition-all duration-200 shadow-lg opacity-50 cursor-not-allowed"
                disabled
              >
                <span class="material-symbols-outlined text-xl">psychology</span>
                <span>VALIDAR RESPUESTA</span>
              </button>
            </div>
          </div>

          <!-- üéØ ESTADO DEL BOT√ìN (DEBUG) - OCULTO POR INDICACI√ìN DEL PROFESOR SEMANA 15 -->
          <div id="button-status" class="hidden mt-3 px-4 py-2 rounded-lg border-2 bg-red-50 border-red-200 text-red-700 font-semibold text-sm flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">block</span>
            <span>‚ùå Bot√≥n DESHABILITADO (esperando 1+1 car√°cter)</span>
          </div>

          <!-- üìã LOG DE EVENTOS (DEBUG) - OCULTO POR INDICACI√ìN DEL PROFESOR SEMANA 15 -->
          <details class="hidden mt-4">
            <summary class="cursor-pointer px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200 transition font-semibold text-sm text-gray-700 flex items-center gap-2">
              <span class="material-symbols-outlined">receipt_long</span>
              üìã Ver Log de Eventos (Debug)
            </summary>
            <div class="mt-2 border-2 border-gray-200 rounded-lg overflow-hidden">
              <div class="bg-gray-700 px-3 py-2 flex items-center justify-between">
                <span class="text-white font-semibold text-xs">Log de Eventos en Tiempo Real</span>
                <div class="flex gap-2">
                  <button onclick='window.runAutoTest()' class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition">
                    üß™ Auto Test
                  </button>
                  <button onclick='window.clearValidationLog()' class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded transition">
                    Limpiar
                  </button>
                </div>
              </div>
              <div id="validation-log" class="bg-gray-50 p-3 max-h-60 overflow-y-auto font-mono text-xs">
                <div class="text-gray-500 italic">Esperando eventos...</div>
              </div>
            </div>
          </details>

          <!-- üß™ PANEL DE DIAGN√ìSTICO AUTOM√ÅTICO - OCULTO POR INDICACI√ìN DEL PROFESOR SEMANA 15 -->
          <details class="hidden mt-4">
            <summary class="cursor-pointer px-4 py-2 bg-blue-100 rounded-lg hover:bg-blue-200 transition font-semibold text-sm text-blue-700 flex items-center gap-2">
              <span class="material-symbols-outlined">bug_report</span>
              üîç Diagn√≥stico Autom√°tico del Bot√≥n
            </summary>
            <div class="mt-2 border-2 border-blue-200 rounded-lg overflow-hidden">
              <div class="bg-blue-700 px-3 py-2">
                <span class="text-white font-semibold text-xs">Pruebas Automatizadas - Haz clic en "Ejecutar Diagn√≥stico"</span>
              </div>
              <div class="p-4 bg-blue-50">
                <button onclick='window.runFullDiagnosis()' class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition mb-3">
                  üöÄ EJECUTAR DIAGN√ìSTICO COMPLETO
                </button>
                <div id="diagnosis-results" class="bg-white p-3 rounded border text-sm font-mono">
                  <div class="text-gray-500 italic">Presiona el bot√≥n para iniciar el diagn√≥stico...</div>
                </div>
              </div>
            </div>
          </details>

        <!-- üìä √ÅREA DE RESULTADO/VALIDACI√ìN -->
        <div id="validation-result" class="hidden space-y-4">
          <div class="border-t-2 border-gray-200 pt-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
              <span class="material-symbols-outlined text-2xl">analytics</span>
              Resultado de Validaci√≥n Sem√°ntica
            </h3>
            
            <!-- Pregunta validada -->
            <div id="validated-question" class="mb-4 p-4 rounded-xl bg-blue-50 border border-blue-200">
              <!-- Se llenar√° din√°micamente -->
            </div>

            <!-- Score de Similaridad -->
            <div id="similarity-score" class="mb-4 p-5 rounded-xl border-2 bg-gradient-to-r">
              <!-- Se llenar√° din√°micamente -->
            </div>

            <!-- Feedback Conceptual -->
            <div id="feedback-message" class="mb-4 p-5 rounded-xl border-2">
              <!-- Se llenar√° din√°micamente -->
            </div>

            <!-- Chunks relevantes encontrados -->
            <div id="relevant-chunks" class="mb-4">
              <!-- Se llenar√° din√°micamente -->
            </div>

            <!-- Botones de acci√≥n -->
            <div class="flex gap-3 mb-4">
              <!-- Bot√≥n GUARDAR PREGUNTA (nuevo) -->
              <button 
                id="btn-save-question"
                onclick='saveCurrentQuestion()' 
                class="flex-1 flex items-center justify-center gap-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 text-base transition-all duration-200 shadow-lg hover:shadow-xl"
              >
                <span class="material-symbols-outlined text-xl">bookmark_add</span>
                <span>GUARDAR PREGUNTA</span>
              </button>

              <!-- Bot√≥n Nueva Pregunta -->
              <button 
                onclick='newQuestion()' 
                class="flex-1 flex items-center justify-center gap-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 text-base transition-all duration-200 shadow-lg hover:shadow-xl"
              >
                <span class="material-symbols-outlined text-xl">add_circle</span>
                <span>NUEVA PREGUNTA</span>
              </button>
            </div>

            <!-- Mensaje de guardado exitoso -->
            <div id="save-success-message" class="hidden mb-4 p-4 rounded-lg bg-green-50 border-2 border-green-300">
              <div class="flex items-center gap-2 text-green-700">
                <span class="material-symbols-outlined">check_circle</span>
                <span class="font-semibold">¬°Pregunta guardada exitosamente en "Mis Preguntas"!</span>
              </div>
            </div>
          </div>
        </div>

        <!-- üìà INFO ACTIVE RECALL -->
        <div class="border-t-2 border-gray-200 pt-6">
          <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
            <h4 class="font-bold text-gray-700 mb-2 flex items-center gap-2">
              <span class="material-symbols-outlined">info</span>
              Sobre Active Recall
            </h4>
            <p class="text-sm text-gray-600 leading-relaxed">
              <strong>Active Recall</strong> es intentar recordar informaci√≥n activamente sin mirar el material. 
              La validaci√≥n sem√°ntica compara tu respuesta con el material usando IA (Sentence Transformers), no requiere palabras exactas.
              <br><br>
              <span class="text-blue-600 font-semibold">üí° Tip:</span> Cuanto m√°s practiques, mejor ser√° tu retenci√≥n a largo plazo.
            </p>
          </div>
        </div>
      </div>
<div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-gray-200/80">
<div class="p-6">
<h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
  <span class="material-symbols-outlined">folder_open</span>
  Mis Preguntas
</h2>

<!-- Lista de preguntas guardadas -->
<div id="questions-list" class="space-y-3">
  <!-- Estado vac√≠o -->
  <div id="empty-state" class="text-center py-12 text-gray-400">
    <span class="material-symbols-outlined text-5xl mb-3">quiz</span>
    <p class="text-sm font-medium">A√∫n no hay preguntas</p>
    <p class="text-xs mt-1">Crea tu primera pregunta ‚Üí</p>
  </div>
</div>
  </div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</main>

<script>
// ===================================================================
// NOTA: Las funciones checkValidateButton y updateCharCount est√°n 
// ahora en sesion-practica-helpers.js para que se carguen ANTES del HTML
// ===================================================================

// ===================================================================
// FUNCIONES GLOBALES PARA ACTIVE RECALL (FUERA DEL DOM READY)
// ===================================================================

console.log('üöÄ Cargando funciones globales de Active Recall...');

// Variables globales
window.questionsHistory = [];
let questionsHistory = window.questionsHistory;

// ===================================================================
// FUNCIONES DE MODAL DE ERROR
// ===================================================================
function showErrorModal(title, message) {
  const modal = document.getElementById('error-modal');
  const titleEl = document.getElementById('error-modal-title');
  const messageEl = document.getElementById('error-modal-message');
  
  if (titleEl) titleEl.textContent = title;
  if (messageEl) messageEl.textContent = message;
  
  if (modal) {
    modal.classList.add('show');
  }
}

function closeErrorModal() {
  const modal = document.getElementById('error-modal');
  if (modal) {
    modal.classList.remove('show');
  }
}

// ===================================================================
// ‚úÖ FUNCI√ìN PARA LIMPIAR TEXTO OCR (solo visualizaci√≥n, NO afecta validaci√≥n)
// ===================================================================

// Detectar tipo de contenido
function detectContentType(text) {
  if (!text || typeof text !== 'string') return { type: 'texto', icon: 'üìÑ', label: 'Texto' };
  
  const lower = text.toLowerCase();
  
  // Detectar si hay referencia a imagen/gr√°fico/tabla
  const imagePatterns = [
    /\[?figura\s*\d*\]?/i, /\[?imagen\s*\d*\]?/i, /\[?gr√°fico\s*\d*\]?/i,
    /\[?tabla\s*\d*\]?/i, /\[?cuadro\s*\d*\]?/i, /\[?ilustraci√≥n\s*\d*\]?/i,
    /ver\s+imagen/i, /ver\s+figura/i, /ver\s+gr√°fico/i,
    /como\s+se\s+muestra/i, /como\s+se\s+observa/i,
    /seg√∫n\s+el\s+gr√°fico/i, /seg√∫n\s+la\s+tabla/i,
    /\[img\]/i, /\[graph\]/i, /\[chart\]/i
  ];
  
  const hasImageReference = imagePatterns.some(p => p.test(text));
  
  // Detectar di√°logo (guiones de di√°logo)
  const dialogueLines = (text.match(/^[\s]*[‚Äî‚Äì-]\s*.+/gm) || []).length;
  const hasDialogue = dialogueLines >= 2 || /^[\s]*[‚Äî‚Äì-]\s*["¬´¬ø¬°]/.test(text);
  
  // Detectar verso/poes√≠a (l√≠neas cortas con may√∫sculas al inicio)
  const lines = text.split('\n').filter(l => l.trim().length > 0);
  const shortLines = lines.filter(l => l.trim().length < 60 && l.trim().length > 5);
  const isVerse = lines.length >= 3 && shortLines.length / lines.length > 0.7;
  
  // Detectar lista/enumeraci√≥n
  const hasList = /^\s*[\d]+[.)]\s+/m.test(text) || /^\s*[‚Ä¢‚óè‚óã‚ñ™-]\s+/m.test(text) || /^\s*[a-z]\)\s+/im.test(text);
  
  // Detectar cita textual
  const hasQuote = /^["¬´"].*["¬ª"]$/m.test(text.trim()) || /cita:|citando:|seg√∫n\s+\w+:/i.test(text);
  
  // Detectar art√≠culo/acad√©mico
  const isAcademic = /abstract|resumen|introducci√≥n|conclusi√≥n|bibliograf√≠a|referencias/i.test(text) ||
                     /\(\d{4}\)|et\s+al\.|pp?\.\s*\d+/i.test(text);
  
  // Detectar t√≠tulo/encabezado
  const isTitle = text.length < 100 && /^[A-Z√Å√â√ç√ì√ö√ë\d]/.test(text.trim()) && 
                  !text.includes('.') && lines.length <= 2;
  
  // Priorizar detecci√≥n
  if (hasImageReference) return { type: 'imagen', icon: 'üñºÔ∏è', label: 'Contiene referencia a imagen/gr√°fico', hasImage: true };
  if (hasDialogue) return { type: 'dialogo', icon: 'üí¨', label: 'Di√°logo/Guion' };
  if (isVerse) return { type: 'verso', icon: 'üìú', label: 'Verso/Poes√≠a' };
  if (hasList) return { type: 'lista', icon: 'üìã', label: 'Lista/Enumeraci√≥n' };
  if (hasQuote) return { type: 'cita', icon: 'üí≠', label: 'Cita textual' };
  if (isAcademic) return { type: 'academico', icon: 'üéì', label: 'Texto acad√©mico' };
  if (isTitle) return { type: 'titulo', icon: 'üìå', label: 'T√≠tulo/Encabezado' };
  
  return { type: 'prosa', icon: 'üìñ', label: 'Prosa narrativa' };
}

function cleanTextForDisplay(text) {
  if (!text || typeof text !== 'string') return text;
  
  let cleaned = text;
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FASE 1: PATRONES ESPEC√çFICOS DE ERRORES OCR DETECTADOS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Patr√≥n: "Henriet te" ‚Üí "Henriette" (palabra + fragmento corto)
  cleaned = cleaned.replace(/(\w{4,})\s+([a-z√°√©√≠√≥√∫√±]{1,3})\b/gi, '$1$2');
  
  // Patr√≥n: "consuf amilia" ‚Üí "consufamilia" (fragmento + palabra larga)
  cleaned = cleaned.replace(/\b([a-z√°√©√≠√≥√∫√±]{3,6})\s+([a-z√°√©√≠√≥√∫√±]{4,})/gi, '$1$2');
  
  // Patr√≥n: "interr og√≥" ‚Üí "interrog√≥" (palabra cortada al azar)
  cleaned = cleaned.replace(/(\w{3,})\s+([a-z√°√©√≠√≥√∫√±]{2,4})\b/gi, '$1$2');
  
  // Patr√≥n: "V alorbe" ‚Üí "Valorbe" (may√∫scula + espacio + resto)
  cleaned = cleaned.replace(/\b([A-Z√Å√â√ç√ì√ö√ë])\s+([a-z√°√©√≠√≥√∫√±]{3,})/g, '$1$2');
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FASE 2: PALABRAS PEGADAS (sin espacio donde deber√≠a haber)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Patr√≥n: "Esteesun" ‚Üí "Este es un" (may√∫scula en medio indica nueva palabra)
  cleaned = cleaned.replace(/([a-z√°√©√≠√≥√∫√±])([A-Z√Å√â√ç√ì√ö√ë])/g, '$1 $2');
  
  // Art√≠culos pegados: "losdem√°s" ‚Üí "los dem√°s"
  const articles = ['el', 'la', 'los', 'las', 'un', 'una', 'unos', 'unas', 'al', 'del'];
  articles.forEach(art => {
    const regex1 = new RegExp(`\\b(${art})([a-z√°√©√≠√≥√∫√±]{3,})`, 'gi');
    const regex2 = new RegExp(`([a-z√°√©√≠√≥√∫√±]{3,})(${art})\\b`, 'gi');
    cleaned = cleaned.replace(regex1, '$1 $2');
    cleaned = cleaned.replace(regex2, '$1 $2');
  });
  
  // Preposiciones pegadas: "conlas" ‚Üí "con las"
  const preps = ['con', 'en', 'de', 'a', 'por', 'para', 'sin', 'sobre', 'entre', 'hasta', 'desde'];
  preps.forEach(prep => {
    const regex1 = new RegExp(`\\b(${prep})([a-z√°√©√≠√≥√∫√±]{3,})`, 'gi');
    const regex2 = new RegExp(`([a-z√°√©√≠√≥√∫√±]{3,})(${prep})\\b`, 'gi');
    cleaned = cleaned.replace(regex1, '$1 $2');
    cleaned = cleaned.replace(regex2, '$1 $2');
  });
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FASE 3: FRAGMENTACI√ìN TRADICIONAL (s√≠labas sueltas)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // Fragmentos muy cortos (1-2 letras) - repetir varias veces
  for (let i = 0; i < 5; i++) {
    cleaned = cleaned.replace(/\b(\w{1,2})\s+(\w{1,2})\b/g, '$1$2');
  }
  
  // Fragmentos medianos
  for (let i = 0; i < 3; i++) {
    cleaned = cleaned.replace(/\b(\w{2,4})\s+(\w{3,6})\b/g, '$1$2');
  }
  
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // FASE 4: LIMPIEZA GENERAL
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  cleaned = cleaned
    // N√∫meros que parecen letras (errores OCR)
    .replace(/(\w)1(\w)/g, '$1l$2')     // 1 ‚Üí l (ej: "co1lar" ‚Üí "collar")
    .replace(/(\w)0(\w)/g, '$1o$2')     // 0 ‚Üí o (ej: "c0mo" ‚Üí "como")
    .replace(/(\w)5(\w)/g, '$1s$2')     // 5 ‚Üí s (ej: "ca5a" ‚Üí "casa")
    
    // Guiones de separaci√≥n de l√≠nea
    .replace(/(\w)-\s+(\w)/g, '$1$2')
    
    // M√∫ltiples espacios a uno solo
    .replace(/[ \t]+/g, ' ')
    
    // Espacios antes de puntuaci√≥n (quitar)
    .replace(/\s+([.,;:!?)\]}¬ª"])/g, '$1')
    
    // Espacio despu√©s de puntuaci√≥n si falta
    .replace(/([.,;:!?])([a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë¬ø¬°])/g, '$1 $2')
    
    // Espacio despu√©s de abrir par√©ntesis/comillas (quitar)
    .replace(/([(\[{¬´"'¬ø¬°])\s+/g, '$1')
    
    // Puntos suspensivos
    .replace(/\.{2,}/g, '‚Ä¶')
    .replace(/‚Ä¶+/g, '‚Ä¶')
    
    // Guiones de di√°logo
    .replace(/^[\s]*[-‚Äì]\s*/gm, '‚Äî ')
    .replace(/‚Äî\s*‚Äî/g, '‚Äî')
    
    // Comillas
    .replace(/[""]/g, '"')
    .replace(/['']/g, "'")
    
    // M√∫ltiples saltos de l√≠nea
    .replace(/\n{3,}/g, '\n\n')
    
    // Palabra cortada al final de l√≠nea
    .replace(/-\s*\n\s*/g, '')
    
    // Espacios al final de l√≠nea
    .replace(/\s+$/gm, '')
    .trim();
  
  return cleaned;
}

// Funci√≥n para formatear el chunk seg√∫n su tipo
function formatChunkForDisplay(text) {
  if (!text || typeof text !== 'string') return { html: text, contentType: detectContentType(text) };
  
  const contentType = detectContentType(text);
  let cleaned = cleanTextForDisplay(text);
  let html = cleaned;
  
  // Formatear seg√∫n tipo de contenido
  switch(contentType.type) {
    case 'dialogo':
      // Resaltar l√≠neas de di√°logo
      html = cleaned.replace(/^(‚Äî\s*.+)$/gm, '<span class="text-indigo-700 font-medium">$1</span>');
      break;
      
    case 'verso':
      // Preservar saltos de l√≠nea y centrar
      html = cleaned.split('\n').map(l => `<span class="block text-center">${l}</span>`).join('');
      break;
      
    case 'lista':
      // Formatear como lista
      html = cleaned.replace(/^(\s*[\d]+[.)]\s+)/gm, '<span class="font-bold text-blue-600">$1</span>');
      html = html.replace(/^(\s*[‚Ä¢‚óè‚óã‚ñ™-]\s+)/gm, '<span class="text-blue-600">$1</span>');
      break;
      
    case 'cita':
      // Estilo de cita
      html = `<span class="italic border-l-2 border-gray-400 pl-3 block">${cleaned}</span>`;
      break;
      
    case 'imagen':
      // Agregar advertencia de imagen
      html = `<div class="bg-yellow-50 border border-yellow-200 rounded p-2 mb-2 text-xs text-yellow-700">
        ‚ö†Ô∏è Este fragmento hace referencia a una imagen o gr√°fico que no se puede mostrar aqu√≠.
      </div>${cleaned}`;
      break;
      
    default:
      // Prosa normal - solo limpieza
      html = cleaned;
  }
  
  return { html, contentType, cleaned };
}

// ===================================================================
// ‚úÖ CORRECCI√ìN PROFESOR: Funci√≥n para generar acorde√≥n con porcentajes detallados
// "col√≥calo el porcentaje... como un acorde√≥n, para ver si quieres el an√°lisis detallado"
// ===================================================================
function generateDetailsAccordion(result) {
  // Extraer detalles del bestMatchChunk si est√°n disponibles
  const chunk = result.bestMatchChunk || {};
  const fullResult = result.fullResult || {};
  
  // ‚úÖ CORRECCI√ìN PROFESOR: Obtener scores REALES del backend
  const scoreDetails = chunk.score_details || {};
  
  // Scores individuales (0-1) - usar valores reales del backend
  const bm25Score = scoreDetails.bm25 || 0;
  const cosineScore = scoreDetails.cosine || 0;
  const coverageScore = scoreDetails.coverage || 0;
  
  // Pesos de la f√≥rmula
  const weights = scoreDetails.weights || {
    bm25: 0.05,
    cosine: 0.80,
    coverage: 0.15
  };
  
  // Calcular contribuci√≥n de cada componente al score final
  const bm25Contribution = bm25Score * weights.bm25;
  const cosineContribution = cosineScore * weights.cosine;
  const coverageContribution = coverageScore * weights.coverage;
  
  // Score final calculado
  const calculatedScore = bm25Contribution + cosineContribution + coverageContribution;
  const finalScore = result.score * 100;
  
  // Extraer keywords si est√°n disponibles
  const keywords = chunk.keywords_found || [];
  const keywordsHtml = keywords.length > 0 
    ? `<div class="flex flex-wrap gap-1.5 mt-2">
        ${keywords.slice(0, 8).map(kw => `<span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">${kw}</span>`).join('')}
       </div>`
    : '';
  
  // Obtener nivel de lectura/categor√≠a
  const readingLevel = chunk.reading_level || 'N/A';
  const levelColors = {
    'excelente': 'bg-green-100 text-green-800',
    'bueno': 'bg-blue-100 text-blue-800',
    'aceptable': 'bg-yellow-100 text-yellow-800',
    'necesita_mejorar': 'bg-red-100 text-red-800'
  };
  const levelColor = levelColors[readingLevel] || 'bg-gray-100 text-gray-800';
  const levelEmoji = {
    'excelente': 'üåü',
    'bueno': 'üëç',
    'aceptable': 'üìñ',
    'necesita_mejorar': 'üìö'
  };
  
  return `
    <details class="mt-4 border-t border-gray-200 pt-3">
      <summary class="cursor-pointer text-sm font-semibold text-indigo-600 hover:text-indigo-800 flex items-center gap-2 select-none">
        <span class="material-symbols-outlined text-lg transition-transform">expand_more</span>
        üìä Ver an√°lisis detallado (desglose de porcentajes)
      </summary>
      
      <div class="mt-4 space-y-4 animate-fadeIn">
        <!-- T√≠tulo del desglose -->
        <div class="text-sm font-bold text-gray-700 flex items-center gap-2">
          <span class="material-symbols-outlined text-indigo-600">analytics</span>
          Desglose del Score H√≠brido
        </div>
        
        <!-- F√≥rmula usada -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-3">
          <p class="text-xs text-indigo-700 font-medium mb-2">üìê F√≥rmula de Validaci√≥n H√≠brida:</p>
          <code class="text-sm bg-white px-2 py-1 rounded border border-indigo-200 block text-center">
            Score = (BM25 √ó <strong>5%</strong>) + (Cosine √ó <strong>80%</strong>) + (Coverage √ó <strong>15%</strong>)
          </code>
        </div>
        
        <!-- ‚úÖ CORRECCI√ìN: Mostrar scores REALES del backend -->
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
          <p class="text-xs font-semibold text-gray-700 mb-2">üìä Scores individuales de tu respuesta:</p>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-amber-50 rounded p-2">
              <div class="text-lg font-bold text-amber-700">${(bm25Score * 100).toFixed(1)}%</div>
              <div class="text-xs text-amber-600">BM25</div>
            </div>
            <div class="bg-blue-50 rounded p-2">
              <div class="text-lg font-bold text-blue-700">${(cosineScore * 100).toFixed(1)}%</div>
              <div class="text-xs text-blue-600">Coseno</div>
            </div>
            <div class="bg-green-50 rounded p-2">
              <div class="text-lg font-bold text-green-700">${(coverageScore * 100).toFixed(1)}%</div>
              <div class="text-xs text-green-600">Cobertura</div>
            </div>
          </div>
        </div>
        
        <!-- Barras de progreso para cada componente -->
        <div class="space-y-3">
          <!-- BM25 (L√©xico) -->
          <div>
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs font-semibold text-gray-600 flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-amber-600">text_fields</span>
                BM25 (Coincidencias l√©xicas)
              </span>
              <span class="text-xs font-bold text-amber-700">${(bm25Score * 100).toFixed(1)}% √ó 5% = ${(bm25Contribution * 100).toFixed(2)}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-amber-500 h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(bm25Score * 100, 100)}%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Busca palabras exactas o similares en el material.</p>
          </div>
          
          <!-- Cosine (Sem√°ntico) -->
          <div>
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs font-semibold text-gray-600 flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-blue-600">psychology</span>
                Cosine Similarity (Sem√°ntico)
              </span>
              <span class="text-xs font-bold text-blue-700">${(cosineScore * 100).toFixed(1)}% √ó 80% = ${(cosineContribution * 100).toFixed(2)}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(cosineScore * 100, 100)}%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Mide similitud de significado usando embeddings de Sentence Transformers.</p>
          </div>
          
          <!-- Coverage (Cobertura) -->
          <div>
            <div class="flex justify-between items-center mb-1">
              <span class="text-xs font-semibold text-gray-600 flex items-center gap-1">
                <span class="material-symbols-outlined text-sm text-green-600">check_circle</span>
                Coverage (Cobertura de keywords)
              </span>
              <span class="text-xs font-bold text-green-700">${(coverageScore * 100).toFixed(1)}% √ó 15% = ${(coverageContribution * 100).toFixed(2)}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: ${Math.min(coverageScore * 100, 100)}%"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1">Verifica cu√°ntas palabras clave del material incluiste.</p>
          </div>
        </div>
        
        <!-- Suma total -->
        <div class="bg-indigo-100 border border-indigo-300 rounded-lg p-3">
          <div class="flex justify-between items-center">
            <span class="text-sm font-bold text-indigo-800">Score Final Calculado:</span>
            <span class="text-lg font-bold text-indigo-900">
              ${(bm25Contribution * 100).toFixed(2)}% + ${(cosineContribution * 100).toFixed(2)}% + ${(coverageContribution * 100).toFixed(2)}% = 
              <span class="text-xl">${finalScore.toFixed(1)}%</span>
            </span>
          </div>
        </div>
        
        <!-- Keywords encontradas -->
        ${keywords.length > 0 ? `
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
          <p class="text-xs font-semibold text-purple-700 mb-2">
            <span class="material-symbols-outlined text-sm align-middle">label</span>
            Palabras clave detectadas en tu respuesta:
          </p>
          ${keywordsHtml}
        </div>
        ` : ''}
        
        <!-- Categor√≠a de respuesta -->
        <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 border border-gray-200">
          <span class="text-xs font-semibold text-gray-600">Categor√≠a de tu respuesta:</span>
          <span class="px-3 py-1 rounded-full text-xs font-bold ${levelColor}">
            ${levelEmoji[readingLevel] || 'üìù'} ${readingLevel ? readingLevel.toUpperCase().replace('_', ' ') : 'EVALUADA'}
          </span>
        </div>
        
        <!-- Nota t√©cnica -->
        <div class="text-xs text-gray-400 italic border-t border-gray-200 pt-3">
          üí° <strong>Nota:</strong> El modelo prioriza la sem√°ntica (80%) sobre la coincidencia literal porque 
          el Active Recall busca <em>comprensi√≥n</em>, no memorizaci√≥n exacta. Los PDFs pueden tener errores 
          OCR que reducir√≠an artificialmente el puntaje l√©xico.
        </div>
      </div>
    </details>
  `;
}

// ===================================================================
// FUNCI√ìN SHOWVALIDATIONRESULT (DEBE IR ANTES DE VALIDATEWITHBACKEND)
// ===================================================================
window.showValidationResult = function(result) {
  const scoreEl = document.getElementById('similarity-score');
  const feedbackEl = document.getElementById('feedback-message');
  const chunksEl = document.getElementById('relevant-chunks');
  const questionEl = document.getElementById('validated-question');
  
  // Mostrar la pregunta que se valid√≥
  if (questionEl) {
    questionEl.innerHTML = `
      <div class="flex items-start gap-3">
        <span class="material-symbols-outlined text-2xl text-blue-600">help_outline</span>
        <div>
          <span class="text-sm font-semibold text-blue-600">TU PREGUNTA:</span>
          <p class="text-base font-medium text-gray-900 mt-1">${result.question || 'Sin pregunta'}</p>
        </div>
      </div>
    `;
  }
  
  // Determinar color seg√∫n score
  let bgColor, borderColor, textColor, emoji, interpretation;
  
  if (result.score >= 0.80) {
    bgColor = 'from-green-50 to-emerald-50';
    borderColor = 'border-green-400';
    textColor = 'text-green-800';
    emoji = '‚úÖ';
    interpretation = 'EXCELENTE - Has demostrado comprensi√≥n profunda del concepto';
  } else if (result.score >= 0.60) {
    bgColor = 'from-blue-50 to-cyan-50';
    borderColor = 'border-blue-400';
    textColor = 'text-blue-800';
    emoji = 'üëç';
    interpretation = 'BUENO - Entiendes el concepto, pero podr√≠as profundizar m√°s';
  } else if (result.score >= 0.40) {
    bgColor = 'from-yellow-50 to-amber-50';
    borderColor = 'border-yellow-400';
    textColor = 'text-yellow-800';
    emoji = '‚ö†Ô∏è';
    interpretation = 'REGULAR - Tu respuesta tiene relaci√≥n, pero falta m√°s detalle';
  } else {
    bgColor = 'from-red-50 to-rose-50';
    borderColor = 'border-red-400';
    textColor = 'text-red-800';
    emoji = '‚ùå';
    interpretation = 'NECESITA MEJORAR - Revisa el material y vuelve a intentarlo';
  }

  // Mostrar score
  if (scoreEl) {
    scoreEl.className = `mb-4 p-5 rounded-xl border-2 bg-gradient-to-r ${bgColor} ${borderColor}`;
    scoreEl.innerHTML = `
      <div class="flex items-center justify-between mb-2">
        <span class="text-lg font-bold ${textColor}">SCORE DE SIMILARIDAD SEM√ÅNTICA</span>
        <span class="text-4xl">${emoji}</span>
      </div>
      <div class="text-5xl font-black ${textColor} mb-2">${(result.score * 100).toFixed(1)}%</div>
      <div class="text-sm font-medium ${textColor}">${interpretation}</div>
      <div class="mt-3 text-xs ${textColor} opacity-75">
        ü§ñ Validado con Sentence Transformers (all-MiniLM-L6-v2)
      </div>
    `;
  }

  // Mostrar feedback
  if (feedbackEl) {
    // ‚úÖ CORRECCI√ìN PROFESOR: Agregar acorde√≥n con porcentajes detallados
    // "col√≥calo el porcentaje... como un acorde√≥n, para ver si quieres el an√°lisis detallado"
    const detailsHtml = generateDetailsAccordion(result);
    
    feedbackEl.className = `mb-4 p-5 rounded-xl border-2 ${borderColor} bg-white`;
    feedbackEl.innerHTML = `
      <div class="flex items-start gap-3">
        <span class="material-symbols-outlined ${textColor} text-2xl">psychology</span>
        <div class="flex-1">
          <h4 class="font-bold ${textColor} mb-2">An√°lisis Sem√°ntico IA</h4>
          <div class="text-gray-700 leading-relaxed whitespace-pre-line">${result.feedback || 'Tu respuesta ha sido procesada correctamente.'}</div>
          ${detailsHtml}
        </div>
      </div>
    `;
  }

  // Mostrar chunk REAL del libro (VERSI√ìN MEJORADA CON INFO COMPLETA)
  if (chunksEl && result.bestMatchChunk) {
    const chunk = result.bestMatchChunk;
    const chunkTextRaw = chunk.text || chunk.text_full || chunk;
    
    // ‚úÖ LIMPIEZA VISUAL INTELIGENTE: Detectar tipo de contenido y formatear
    const formatted = typeof chunkTextRaw === 'string' 
      ? formatChunkForDisplay(chunkTextRaw) 
      : { html: chunkTextRaw, contentType: detectContentType(''), cleaned: chunkTextRaw };
    
    const chunkText = formatted.cleaned;
    const contentType = formatted.contentType;
    const formattedHtml = formatted.html;
    
    const similarity = chunk.similarity ? (chunk.similarity * 100).toFixed(1) : (result.score * 100).toFixed(1);
    const chunkId = chunk.chunk_id !== undefined ? chunk.chunk_id : 0;
    const totalChunks = chunk.total_chunks || 0;
    const estimatedPage = chunk.estimated_page || Math.floor((chunkId * 500) / 2500);
    
    // Determinar estilo seg√∫n tipo de contenido
    const typeStyles = {
      'imagen': 'from-yellow-50 to-amber-50 border-yellow-300',
      'dialogo': 'from-indigo-50 to-purple-50 border-indigo-300',
      'verso': 'from-pink-50 to-rose-50 border-pink-300',
      'lista': 'from-cyan-50 to-sky-50 border-cyan-300',
      'cita': 'from-gray-50 to-slate-50 border-gray-300',
      'academico': 'from-emerald-50 to-teal-50 border-emerald-300',
      'titulo': 'from-orange-50 to-amber-50 border-orange-300',
      'prosa': 'from-blue-50 to-indigo-50 border-blue-300'
    };
    const gradientStyle = typeStyles[contentType.type] || typeStyles['prosa'];
    
    chunksEl.innerHTML = `
      <div class="bg-gradient-to-br ${gradientStyle} border-2 rounded-xl p-5 shadow-md">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-bold text-blue-900 text-lg flex items-center gap-2">
            <span class="material-symbols-outlined text-2xl">auto_stories</span>
            üìñ Fragmento Relacionado del Material
          </h4>
          <div class="flex items-center gap-2">
            <span class="text-xs bg-blue-200 text-blue-800 px-3 py-1 rounded-full font-semibold" title="Similitud sem√°ntica entre TU RESPUESTA y este fragmento del material">
              ${similarity}% con tu respuesta
            </span>
          </div>
        </div>
        
        <!-- ‚úÖ NUEVO: Tipo de contenido detectado -->
        <div class="mb-3 flex items-center gap-2">
          <span class="inline-flex items-center gap-1.5 px-3 py-1 bg-white border border-gray-200 rounded-full text-sm font-medium text-gray-700 shadow-sm">
            <span class="text-lg">${contentType.icon}</span>
            <span>${contentType.label}</span>
          </span>
          ${contentType.hasImage ? `
            <span class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 border border-yellow-300 rounded-full text-xs font-medium text-yellow-800">
              ‚ö†Ô∏è Contiene imagen/gr√°fico (no visible)
            </span>
          ` : ''}
        </div>
        
        <!-- Informaci√≥n de ubicaci√≥n del chunk -->
        <div class="mb-3 flex flex-wrap items-center gap-2 text-sm">
          <div class="flex items-center gap-1 bg-white px-3 py-1.5 rounded-lg border border-blue-200">
            <span class="material-symbols-outlined text-sm text-blue-600">widgets</span>
            <span class="font-semibold text-gray-700">Chunk ${chunkId + 1} de ${totalChunks}</span>
          </div>
          <div class="flex items-center gap-1 bg-white px-3 py-1.5 rounded-lg border border-blue-200">
            <span class="material-symbols-outlined text-sm text-blue-600">description</span>
            <span class="font-semibold text-gray-700">~P√°gina ${estimatedPage + 1}</span>
          </div>
          <div class="flex items-center gap-1 bg-white px-3 py-1.5 rounded-lg border border-blue-200">
            <span class="material-symbols-outlined text-sm text-blue-600">analytics</span>
            <span class="font-semibold text-gray-700">${(typeof chunkText === 'string' ? chunkText.length : 0)} caracteres</span>
          </div>
        </div>
        
        <!-- Contenido del chunk con formato seg√∫n tipo -->
        <div class="bg-white rounded-lg p-4 border-l-4 border-blue-500 shadow-sm">
          <p class="text-sm text-gray-500 font-semibold mb-2 uppercase tracking-wide flex items-center gap-2">
            <span class="material-symbols-outlined text-lg">bookmark</span>
            üéØ Fragmento del material (${contentType.label}):
          </p>
          <div class="text-base text-gray-800 leading-relaxed max-h-60 overflow-y-auto ${contentType.type === 'verso' ? 'text-center' : ''} ${contentType.type === 'cita' ? 'italic' : ''}">
            ${formattedHtml}
          </div>
        </div>
        
        <!-- Explicaci√≥n contextual -->
        <div class="mt-3 text-sm text-blue-700 bg-blue-100 rounded-lg p-3">
          <p class="font-semibold mb-1 flex items-center gap-1">
            <span class="material-symbols-outlined text-lg">lightbulb</span>
            üí° ¬øQu√© significa esto?
          </p>
          <p class="text-blue-900">
            Este es el fragmento <strong>LITERAL del libro que subiste</strong> (ubicado en el <strong>chunk ${chunkId + 1} de ${totalChunks}</strong>, aproximadamente en la <strong>p√°gina ${estimatedPage + 1}</strong>) que tiene mayor relaci√≥n sem√°ntica con tu respuesta. 
            ${similarity >= 70 
              ? '‚úÖ Tu respuesta captura muy bien la esencia de este extracto. ¬°Excelente comprensi√≥n!' 
              : similarity >= 50 
                ? 'üìö Tu respuesta tiene relaci√≥n, pero podr√≠as profundizar m√°s en estos conceptos clave.'
                : 'üîç Compara tu respuesta con este extracto. ¬øIncluiste los conceptos principales?'
            }
          </p>
        </div>
        
        ${result.relevantChunks && result.relevantChunks.length > 1 ? `
          <details class="mt-4">
            <summary class="cursor-pointer text-sm font-semibold text-blue-700 hover:text-blue-900 flex items-center gap-2">
              <span class="material-symbols-outlined text-lg">expand_more</span>
              Ver otros ${result.relevantChunks.length - 1} fragmentos relacionados
            </summary>
            <div class="mt-3 space-y-2">
              ${result.relevantChunks.slice(1, 3).map((relChunk, idx) => {
                const relTextRaw = relChunk.text || relChunk.text_full || '';
                const relFormatted = formatChunkForDisplay(relTextRaw);
                const relContentType = relFormatted.contentType;
                return `
                <div class="bg-white rounded-lg p-3 border border-blue-200 text-sm">
                  <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold text-gray-600 flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">layers</span>
                        Chunk ${(relChunk.position || 0) + 1} / ${relChunk.total_chunks || totalChunks}
                      </span>
                      <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full">${relContentType.icon} ${relContentType.label}</span>
                    </div>
                    <span class="text-xs text-blue-600 font-mono" title="Similitud entre TU RESPUESTA y este chunk">
                      ${(relChunk.similarity * 100).toFixed(1)}% con tu respuesta
                    </span>
                  </div>
                  <div class="text-gray-700 leading-relaxed ${relContentType.type === 'cita' ? 'italic' : ''}">
                    ${relFormatted.cleaned.substring(0, 300)}${relFormatted.cleaned.length > 300 ? '...' : ''}
                  </div>
                </div>
              `}).join('')}
            </div>
          </details>
        ` : ''}
      </div>
    `;
  } else if (chunksEl) {
    // Si no hay chunks, mostrar mensaje
    chunksEl.innerHTML = `
      <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 text-center">
        <span class="material-symbols-outlined text-yellow-600 text-3xl">warning</span>
        <p class="text-sm text-yellow-800 mt-2">No se encontraron fragmentos relacionados en el material</p>
      </div>
    `;
  }
  
  // Restaurar bot√≥n validar
  const btnValidate = document.getElementById('btn-validate-answer');
  if (btnValidate) {
    btnValidate.disabled = false;
    btnValidate.innerHTML = `
      <span class="material-symbols-outlined text-xl">psychology</span>
      <span>VALIDAR RESPUESTA</span>
    `;
  }
};

// ===================================================================
// FUNCI√ìN checkValidateButton - COMENTADA (duplicada)
// La versi√≥n activa est√° en l√≠nea ~1703 dentro de DOMContentLoaded
// ===================================================================
/*
function checkValidateButton() {
  console.log('üîç checkValidateButton ejecutada');
  
  const questionInput = document.getElementById('user-question');
  const userAnswer = document.getElementById('user-answer');
  const btnValidate = document.getElementById('btn-validate-answer');
  
  if (!questionInput || !userAnswer || !btnValidate) {
    console.warn('‚ùå Elementos no encontrados');
    return;
  }
  
  const questionText = questionInput.value.trim();
  const answerText = userAnswer.value.trim();
  
  console.log('üìù Textos:', {
    pregunta: questionText.length + ' chars',
    respuesta: answerText.length + ' chars'
  });
  
  // L√≥gica: 1 car√°cter m√≠nimo en cada campo
  const hasQuestion = questionText.length >= 1;
  const hasAnswer = answerText.length >= 1;
  
  if (hasQuestion && hasAnswer) {
    console.log('‚úÖ HABILITANDO BOT√ìN');
    btnValidate.disabled = false;
    btnValidate.classList.remove('opacity-50', 'cursor-not-allowed');
    btnValidate.classList.add('hover:bg-green-700', 'hover:shadow-xl', 'hover:-translate-y-0.5');
  } else {
    console.log('‚ùå DESHABILITANDO BOT√ìN');
    btnValidate.disabled = true;
    btnValidate.classList.add('opacity-50', 'cursor-not-allowed');
    btnValidate.classList.remove('hover:bg-green-700', 'hover:shadow-xl', 'hover:-translate-y-0.5');
  }
}
*/

// Funci√≥n de validaci√≥n con backend (GLOBAL)
async function validateWithBackend() {
  console.log('üöÄ validateWithBackend ejecutada');
  window.addValidationLog('üöÄ Bot√≥n VALIDAR clickeado!', 'success');
  
  const questionInput = document.getElementById('user-question');
  const userAnswer = document.getElementById('user-answer');
  const btnValidate = document.getElementById('btn-validate-answer');
  const validationResult = document.getElementById('validation-result');
  
  if (!questionInput || !questionInput.value.trim()) {
    window.addValidationLog('‚ùå ERROR: Pregunta vac√≠a', 'error');
    showErrorModal('Campo vac√≠o', 'Por favor escribe una pregunta primero');
    return;
  }
  
  if (!userAnswer || !userAnswer.value.trim()) {
    window.addValidationLog('‚ùå ERROR: Respuesta vac√≠a', 'error');
    showErrorModal('Campo vac√≠o', 'Por favor escribe una respuesta primero');
    return;
  }

  // Deshabilitar bot√≥n mientras se procesa
  btnValidate.disabled = true;
  btnValidate.innerHTML = `
    <span class="material-symbols-outlined text-xl animate-spin">progress_activity</span>
    <span>VALIDANDO...</span>
  `;
  
  window.addValidationLog('‚è≥ Enviando petici√≥n al backend...', 'info');

  try {
    // ‚úÖ Obtener material_id REAL desde Supabase
    const urlParams = new URLSearchParams(window.location.search);
    let materialId = urlParams.get('material') || urlParams.get('material_id');
    
    // üîÑ Si no hay en URL, obtener el primer material del usuario
    if (!materialId) {
      console.log('üîÑ No hay material_id en URL, obteniendo desde Supabase...');
      const materials = await SupabaseOperations.getMaterials();
      
      if (materials && materials.length > 0) {
        materialId = materials[0].id;  // ‚úÖ UUID real del primer material
        console.log('‚úÖ Usando material UUID:', materialId);
      } else {
        showErrorModal('Error', 'No tienes materiales cargados. Por favor, sube un PDF primero.');
        btnValidate.disabled = false;
        btnValidate.innerHTML = `
          <span class="material-symbols-outlined">check_circle</span>
          <span>VALIDAR RESPUESTA</span>
        `;
        return;
      }
    }
    
    console.log('üöÄ Llamando al backend REAL con Sentence Transformers...');
    console.log('Material ID:', materialId);
    console.log('Pregunta:', questionInput.value.trim());
    console.log('Respuesta:', userAnswer.value.trim().substring(0, 100) + '...');
    
    window.addValidationLog(`üìÅ Material ID: ${materialId}`, 'info');
    window.addValidationLog(`Pregunta: ${questionInput.value.trim().substring(0, 50)}...`, 'info');
    
    // LLAMADA REAL AL BACKEND con timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos timeout
    
    window.addValidationLog(`üåê Conectando con servidor ${API_CONFIG.BASE_URL} ...`, 'info');

    const response = await fetch(`${API_CONFIG.BASE_URL}/api/validate-answer`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        question_text: questionInput.value.trim(),
        material_id: materialId,
        user_answer: userAnswer.value.trim()
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('‚ùå Error completo del servidor:', errorText);
      
      // Manejar errores espec√≠ficos
      if (response.status === 422) {
        throw new Error(`Error 422: El material no est√° disponible o el formato de datos es incorrecto.\nPor favor verifica que el material est√© cargado correctamente.`);
      } else if (response.status === 404) {
        throw new Error(`Error 404: No se encontr√≥ el material "${materialId}".\nVerifica que el material est√© cargado en el sistema.`);
      } else {
        throw new Error(`Error del servidor (${response.status}): ${errorText}`);
      }
    }

    const result = await response.json();
    
    console.log('‚úÖ Resultado REAL del backend:', result);
    console.log('Score:', result.score);
    console.log('Feedback:', result.feedback);
    
    window.addValidationLog('‚úÖ Respuesta recibida del backend', 'success');
    window.addValidationLog(`üìä Score obtenido: ${result.score}%`, result.score >= 70 ? 'success' : result.score >= 50 ? 'warning' : 'error');
    
    // ‚úÖ NORMALIZAR SCORE: Asegurar que siempre est√© en escala 0-100
    const normalizedScore = result.score >= 0 && result.score <= 1 
      ? Math.round(result.score * 100) // Si viene como decimal (0.69) ‚Üí convertir a porcentaje (69)
      : Math.round(result.score);      // Si ya es porcentaje (69) ‚Üí mantener
    
    console.log(`üî¢ Score normalizado: ${result.score} ‚Üí ${normalizedScore}%`);
    
    // GUARDAR TEMPORALMENTE CON TODA LA INFORMACI√ìN DEL CHUNK
    window.currentValidatedQuestion = {
      id: Date.now(),
      carpeta_id: materialId,
      pregunta: questionInput.value.trim(),
      respuesta: userAnswer.value.trim(),
      score: normalizedScore, // ‚úÖ SIEMPRE 0-100
      feedback: result.feedback,
      timestamp: new Date().toISOString(),
      
      // INFORMACI√ìN COMPLETA DE CHUNKS Y FRAGMENTOS
      chunks_relevantes: result.relevant_chunks || [],
      best_match_chunk: result.best_match_chunk || null,
      
      // M√âTRICAS DETALLADAS
      similarity: result.similarity || 0,
      is_correct: result.is_correct || false,
      
      // METADATOS
      material_id: materialId,
      saved: false // Indicador de que NO est√° guardada a√∫n
    };
    
    console.log('üíæ Pregunta validada (pendiente de guardar):', window.currentValidatedQuestion);
    console.log('üìç Chunk principal:', result.best_match_chunk);
    
    // NO actualizar m√©tricas ni lista todav√≠a (solo cuando se guarde)
    
    // Mostrar resultados REALES (si existe la funci√≥n)
    console.log('üîç Verificando window.showValidationResult...', typeof window.showValidationResult);
    console.log('üîç Datos para showValidationResult:', {
      score: result.score / 100,
      feedback: result.feedback,
      question: questionInput.value.trim()
    });
    
    if (typeof window.showValidationResult === 'function') {
      console.log('‚úÖ Llamando a window.showValidationResult...');
      window.showValidationResult({
        score: normalizedScore / 100, // ‚úÖ Convertir a decimal para visualizaci√≥n (0.0-1.0)
        feedback: result.feedback,
        relevantChunks: result.relevant_chunks || [],
        bestMatchChunk: result.best_match_chunk,
        question: questionInput.value.trim(),
        // ‚úÖ CORRECCI√ìN PROFESOR: Pasar detalles para acorde√≥n de porcentajes
        fullResult: result  // Contiene best_match_chunk con keywords_found, etc.
      });
      console.log('‚úÖ showValidationResult ejecutado');
    } else {
      console.error('‚ùå window.showValidationResult NO es una funci√≥n!');
      showErrorModal('Error de funci√≥n', 'La funci√≥n showValidationResult no est√° disponible');
    }
    
    // Mostrar panel de resultados
    const validationResult = document.getElementById('validation-result');
    console.log('üîç validation-result element:', validationResult);
    if (validationResult) {
      console.log('‚úÖ Mostrando panel de resultados...');
      validationResult.classList.remove('hidden');
      console.log('‚úÖ Panel mostrado, classes:', validationResult.className);
    } else {
      console.error('‚ùå No se encontr√≥ el elemento validation-result!');
    }
    
    // Scroll suave hacia resultados
    if (validationResult) {
      validationResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    // RESTAURAR BOT√ìN DESPU√âS DE VALIDACI√ìN EXITOSA
    btnValidate.innerHTML = `
      <span class="material-symbols-outlined text-xl">psychology</span>
      <span>VALIDAR RESPUESTA</span>
    `;
    
    // Re-verificar si debe estar habilitado seg√∫n contenido actual
    window.checkValidateButton();

  } catch (error) {
    console.error('‚ùå Error validando respuesta:', error);
    alert(`Error al validar la respuesta: ${error.message}\n\nAseg√∫rate de que:\n1. El servidor backend est√© corriendo (puerto 8000)\n2. Hayas subido material primero\n3. El modelo Sentence Transformers est√© disponible`);
    
    // Restaurar bot√≥n
    btnValidate.innerHTML = `
      <span class="material-symbols-outlined text-xl">psychology</span>
      <span>VALIDAR RESPUESTA</span>
    `;
    
    // Re-verificar si debe estar habilitado seg√∫n contenido actual
    window.checkValidateButton();
  }
}

// ===================================================================
// FUNCI√ìN DE LOG DE EVENTOS (GLOBAL - para debugging)
// ===================================================================
window.addValidationLog = function(message, type = 'info') {
  const logDiv = document.getElementById('validation-log');
  if (!logDiv) {
    // Si el log a√∫n no existe, guardarlo temporalmente
    if (!window._pendingLogs) window._pendingLogs = [];
    window._pendingLogs.push({message, type});
    return;
  }
  
  // Si es el primer log real, limpiar el placeholder
  if (logDiv.textContent.includes('Esperando eventos')) {
    logDiv.innerHTML = '';
  }
  
  const entry = document.createElement('div');
  entry.className = 'py-1 border-b border-gray-200';
  
  const timestamp = new Date().toLocaleTimeString();
  const icons = {
    'info': 'üîç',
    'success': '‚úÖ',
    'error': '‚ùå',
    'warning': '‚ö†Ô∏è'
  };
  const colors = {
    'info': 'text-blue-600',
    'success': 'text-green-600',
    'error': 'text-red-600',
    'warning': 'text-yellow-600'
  };
  
  entry.innerHTML = `
    <span class="text-gray-500">[${timestamp}]</span>
    <span class="${colors[type] || 'text-gray-600'}">${icons[type] || '‚Ä¢'} ${message}</span>
  `;
  
  logDiv.appendChild(entry);
  logDiv.scrollTop = logDiv.scrollHeight;
};

window.clearValidationLog = function() {
  const logDiv = document.getElementById('validation-log');
  if (logDiv) {
    logDiv.innerHTML = '<div class="text-gray-500 italic">Log limpiado</div>';
    addValidationLog('Sistema reiniciado', 'info');
  }
};

// üß™ FUNCIONES DE PRUEBA AUTOM√ÅTICA - NUEVAS
window.runAutoTest = function() {
  addValidationLog("üß™ INICIANDO PRUEBA AUTOM√ÅTICA", "info");
  
  const questionInput = document.getElementById('user-question');
  const answerInput = document.getElementById('user-answer');
  const validateBtn = document.getElementById('btn-validate-answer');
  
  if (!questionInput || !answerInput || !validateBtn) {
    addValidationLog("‚ùå ERROR: No se encontraron los elementos necesarios", "error");
    return;
  }
  
  // Paso 1: Limpiar campos
  addValidationLog("üîÑ Paso 1: Limpiando campos...", "info");
  questionInput.value = '';
  answerInput.value = '';
  questionInput.dispatchEvent(new Event('input'));
  answerInput.dispatchEvent(new Event('input'));
  
  setTimeout(() => {
    // Paso 2: Escribir en pregunta
    addValidationLog("üìù Paso 2: Escribiendo '1' en pregunta...", "info");
    questionInput.value = '1';
    questionInput.dispatchEvent(new Event('input'));
    
    setTimeout(() => {
      // Paso 3: Escribir en respuesta
      addValidationLog("üìù Paso 3: Escribiendo '1' en respuesta...", "info");
      answerInput.value = '1';
      answerInput.dispatchEvent(new Event('input'));
      
      setTimeout(() => {
        // Verificar resultado
        const isEnabled = !validateBtn.disabled;
        if (isEnabled) {
          addValidationLog("‚úÖ √âXITO: El bot√≥n se habilit√≥ correctamente", "success");
        } else {
          addValidationLog("‚ùå FALLO: El bot√≥n NO se habilit√≥", "error");
        }
      }, 100);
    }, 500);
  }, 500);
};

window.runFullDiagnosis = function() {
  const resultsDiv = document.getElementById('diagnosis-results');
  resultsDiv.innerHTML = '<div class="text-blue-600">üîÑ Ejecutando diagn√≥stico...</div>';
  
  let results = [];
  
  // 1. Verificar elementos DOM
  const questionInput = document.getElementById('user-question');
  const answerInput = document.getElementById('user-answer');
  const validateBtn = document.getElementById('btn-validate-answer');
  
  results.push('<div class="font-bold text-lg mb-2">üìä RESULTADOS DEL DIAGN√ìSTICO</div>');
  results.push('<div class="border-b pb-2 mb-2">');
  results.push('<div class="font-semibold">1. Verificaci√≥n de Elementos DOM:</div>');
  results.push(`‚Ä¢ Campo Pregunta: ${questionInput ? '‚úÖ Encontrado' : '‚ùå NO encontrado'}`);
  results.push(`‚Ä¢ Campo Respuesta: ${answerInput ? '‚úÖ Encontrado' : '‚ùå NO encontrado'}`);
  results.push(`‚Ä¢ Bot√≥n Validar: ${validateBtn ? '‚úÖ Encontrado' : '‚ùå NO encontrado'}`);
  results.push('</div>');
  
  if (!questionInput || !answerInput || !validateBtn) {
    results.push('<div class="text-red-600 font-bold">‚ùå ERROR CR√çTICO: Faltan elementos esenciales</div>');
    resultsDiv.innerHTML = results.join('<br>');
    return;
  }
  
  // 2. Verificar funciones
  results.push('<div class="border-b pb-2 mb-2">');
  results.push('<div class="font-semibold">2. Verificaci√≥n de Funciones:</div>');
  results.push(`‚Ä¢ checkValidateButton: ${typeof window.checkValidateButton === 'function' ? '‚úÖ Disponible' : '‚ùå NO disponible'}`);
  results.push(`‚Ä¢ addValidationLog: ${typeof window.addValidationLog === 'function' ? '‚úÖ Disponible' : '‚ùå NO disponible'}`);
  results.push('</div>');
  
  // 3. Verificar event listeners
  results.push('<div class="border-b pb-2 mb-2">');
  results.push('<div class="font-semibold">3. Verificaci√≥n de Event Listeners:</div>');
  results.push(`‚Ä¢ oninput en pregunta: ${questionInput.oninput ? '‚úÖ Configurado' : '‚ùå NO configurado'}`);
  results.push(`‚Ä¢ oninput en respuesta: ${answerInput.oninput ? '‚úÖ Configurado' : '‚ùå NO configurado'}`);
  results.push('</div>');
  
  // 4. Prueba en vivo
  results.push('<div class="border-b pb-2 mb-2">');
  results.push('<div class="font-semibold">4. Prueba en Vivo:</div>');
  
  // Guardar valores actuales
  const originalQuestion = questionInput.value;
  const originalAnswer = answerInput.value;
  
  // Prueba 1: Campos vac√≠os
  questionInput.value = '';
  answerInput.value = '';
  if (typeof window.checkValidateButton === 'function') {
    window.checkValidateButton();
  }
  const emptyResult = validateBtn.disabled;
  results.push(`‚Ä¢ Campos vac√≠os ‚Üí Bot√≥n ${emptyResult ? 'DESHABILITADO ‚úÖ' : 'HABILITADO ‚ùå'}`);
  
  // Prueba 2: Solo pregunta
  questionInput.value = '1';
  answerInput.value = '';
  if (typeof window.checkValidateButton === 'function') {
    window.checkValidateButton();
  }
  const onlyQuestionResult = validateBtn.disabled;
  results.push(`‚Ä¢ Solo pregunta ‚Üí Bot√≥n ${onlyQuestionResult ? 'DESHABILITADO ‚úÖ' : 'HABILITADO ‚ùå'}`);
  
  // Prueba 3: Solo respuesta
  questionInput.value = '';
  answerInput.value = '1';
  if (typeof window.checkValidateButton === 'function') {
    window.checkValidateButton();
  }
  const onlyAnswerResult = validateBtn.disabled;
  results.push(`‚Ä¢ Solo respuesta ‚Üí Bot√≥n ${onlyAnswerResult ? 'DESHABILITADO ‚úÖ' : 'HABILITADO ‚ùå'}`);
  
  // Prueba 4: Ambos campos
  questionInput.value = '1';
  answerInput.value = '1';
  if (typeof window.checkValidateButton === 'function') {
    window.checkValidateButton();
  }
  const bothFieldsResult = !validateBtn.disabled;
  results.push(`‚Ä¢ Ambos campos (1+1) ‚Üí Bot√≥n ${bothFieldsResult ? 'HABILITADO ‚úÖ' : 'DESHABILITADO ‚ùå'}`);
  
  // Restaurar valores originales
  questionInput.value = originalQuestion;
  answerInput.value = originalAnswer;
  if (typeof window.checkValidateButton === 'function') {
    window.checkValidateButton();
  }
  
  results.push('</div>');
  
  // 5. Conclusi√≥n
  const allTestsPassed = emptyResult && onlyQuestionResult && onlyAnswerResult && bothFieldsResult;
  results.push('<div class="mt-4 p-3 rounded ' + (allTestsPassed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + '">');
  results.push(`<div class="font-bold">${allTestsPassed ? 'üéâ DIAGN√ìSTICO EXITOSO' : '‚ö†Ô∏è PROBLEMAS DETECTADOS'}</div>`);
  if (allTestsPassed) {
    results.push('El bot√≥n funciona correctamente seg√∫n las especificaciones.');
  } else {
    results.push('Se detectaron problemas en el funcionamiento del bot√≥n.');
  }
  results.push('</div>');
  
  results.push('<div class="mt-2 text-xs text-gray-500">Diagn√≥stico completado en ' + new Date().toLocaleTimeString() + '</div>');
  
  resultsDiv.innerHTML = results.join('<br>');
};

// Funci√≥n para actualizar m√©tricas (PLACEHOLDER - se implementar√° cuando haya sistema de m√©tricas)
function updateRealMetrics() {
  console.log('üìä updateRealMetrics placeholder - se implementar√° m√°s adelante');
}

// Hacer las funciones accesibles globalmente
// window.checkValidateButton = checkValidateButton; // COMENTADO - Se define m√°s abajo (l√≠nea ~1703)
window.validateWithBackend = validateWithBackend;
window.updateRealMetrics = updateRealMetrics;

console.log('‚úÖ Funciones globales cargadas (validateWithBackend + updateRealMetrics)');

// ===================================================================
// FUNCI√ìN MOSTRAR NOTIFICACI√ìN DE √âXITO (GLOBAL)
// ===================================================================
function showSuccessNotification(message) {
  // Crear elemento de notificaci√≥n
  const notification = document.createElement('div');
  notification.className = 'fixed top-20 right-6 bg-green-600 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50 animate-slide-in';
  notification.innerHTML = `
    <span class="material-symbols-outlined">check_circle</span>
    <span class="font-semibold">${message}</span>
  `;
  
  document.body.appendChild(notification);
  
  // Eliminar despu√©s de 3 segundos
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(400px)';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// ===================================================================
// FUNCIONES GLOBALES PARA BOTONES (DEBEN ESTAR FUERA DE DOMCONTENTLOADED)
// ===================================================================
window.saveCurrentQuestion = async function() {
  console.log('üî•üíæ FUNCI√ìN saveCurrentQuestion LLAMADA');
  
  // Verificar que hay una pregunta validada
  if (!window.currentValidatedQuestion) {
    showErrorModal('Sin pregunta', 'No hay ninguna pregunta validada para guardar.\\nPrimero valida una respuesta.');
    return;
  }
  
  // Verificar que no est√© ya guardada
  if (window.currentValidatedQuestion.saved) {
    showErrorModal('Ya guardada', 'Esta pregunta ya fue guardada anteriormente.');
    return;
  }
  
  // Obtener material ID de la URL o desde Supabase
  const urlParams = new URLSearchParams(window.location.search);
  let materialIdFromUrl = urlParams.get('material') || urlParams.get('material_id');
  const folderName = urlParams.get('folder') || null;
  
  // üîÑ Si no hay en URL, obtener el primer material autom√°ticamente
  if (!materialIdFromUrl) {
    console.log('üîÑ No hay material_id en URL, obteniendo desde Supabase...');
    const materials = await SupabaseOperations.getMaterials();
    
    if (materials && materials.length > 0) {
      materialIdFromUrl = materials[0].id;  // ‚úÖ UUID del primer material
      console.log('‚úÖ Usando material UUID:', materialIdFromUrl);
    } else {
      showErrorModal('Error', 'No tienes materiales cargados. Por favor, sube un PDF primero.');
      return;
    }
  }
  
  try {
    console.log('üíæ Guardando pregunta en Supabase...');
    console.log('   ‚Ä¢ Material ID de URL:', materialIdFromUrl);
    
    // ‚úÖ CONVERTIR ID de URL a UUID de Supabase
    // Si el ID es num√©rico, buscar el material correspondiente
    let materialId = materialIdFromUrl;
    
    // Si no es UUID (formato: 8-4-4-4-12 caracteres hexadecimales)
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(materialIdFromUrl)) {
      console.log('üîÑ ID no es UUID, buscando material en Supabase...');
      const materials = await SupabaseOperations.getMaterials();
      
      if (materials && materials.length > 0) {
        // Tomar el primer material (o buscar por alg√∫n criterio)
        // Por ahora, asumimos que el usuario tiene solo un material
        materialId = materials[0].id;
        console.log('‚úÖ UUID del material encontrado:', materialId);
      } else {
        showErrorModal('Error', 'No se encontr√≥ el material en la base de datos.');
        return;
      }
    }
    
    console.log('   ‚Ä¢ Material UUID:', materialId);
    console.log('   ‚Ä¢ Pregunta:', window.currentValidatedQuestion.pregunta);
    console.log('   ‚Ä¢ Score:', window.currentValidatedQuestion.score);
    
    // 1. Crear pregunta en Supabase
    const question = await SupabaseOperations.createQuestion(
      materialId,
      window.currentValidatedQuestion.pregunta,
      {
        topic: folderName,
        difficulty: 'medium'
      }
    );
    
    console.log('‚úÖ Pregunta creada en Supabase:', question);
    
    // 2. Guardar respuesta con validaci√≥n
    const answer = await SupabaseOperations.createAnswer(
      question.id,
      window.currentValidatedQuestion.respuesta,
      window.currentValidatedQuestion.score,
      {
        similarity: window.currentValidatedQuestion.similarity || 0,
        is_correct: window.currentValidatedQuestion.score >= 55,
        classification: window.currentValidatedQuestion.classification,
        feedback: window.currentValidatedQuestion.feedback,
        best_match_chunk: window.currentValidatedQuestion.best_match_chunk,
        relevant_chunks: window.currentValidatedQuestion.relevant_chunks
      }
    );
    
    console.log('‚úÖ Respuesta guardada en Supabase:', answer);
    
    // 3. Inicializar repetici√≥n espaciada
    const nextReviewDate = new Date();
    nextReviewDate.setDate(nextReviewDate.getDate() + 1); // Ma√±ana
    
    const reviewData = await SupabaseOperations.upsertSpacedRepetition(
      question.id,
      nextReviewDate,
      1, // Intervalo inicial: 1 d√≠a
      2.5, // Ease factor inicial (SM-2)
      {
        repetitions: 0,
        lastScore: window.currentValidatedQuestion.score,
        lastReview: new Date()
      }
    );
    
    console.log('‚úÖ Repetici√≥n espaciada inicializada:', reviewData);
    console.log('üìÖ Pr√≥ximo repaso:', nextReviewDate.toLocaleDateString('es-ES'));
    
    // Marcar como guardada
    window.currentValidatedQuestion.saved = true;
    window.currentValidatedQuestion.supabase_id = question.id;
    
    // Agregar al historial local (solo para UI)
    questionsHistory.push(window.currentValidatedQuestion);
    
    // Actualizar lista de preguntas en sidebar
    if (typeof window.updateQuestionsList === 'function') {
      window.updateQuestionsList();
    }
    
    // Mostrar notificaci√≥n de √©xito
    showSuccessNotification('‚úÖ Pregunta guardada en Supabase correctamente');
    
    // Deshabilitar bot√≥n de guardar
    const btnSave = document.getElementById('btn-save-question');
    if (btnSave) {
      btnSave.disabled = true;
      btnSave.classList.add('opacity-50', 'cursor-not-allowed');
      btnSave.innerHTML = `
        <span class="material-symbols-outlined text-xl">check</span>
        <span>YA GUARDADA</span>
      `;
    }
    
    console.log('‚úÖ Pregunta guardada exitosamente en Supabase');
    console.log('üìä Total preguntas guardadas:', questionsHistory.length);
    
  } catch (error) {
    console.error('‚ùå Error guardando pregunta en Supabase:', error);
    showErrorModal('Error', 'No se pudo guardar la pregunta en Supabase: ' + error.message);
  }
};

// ===================================================================
// FUNCIONES DE EDICI√ìN Y ELIMINACI√ìN DE PREGUNTAS
// ===================================================================

window.editQuestion = async function(index) {
  console.log('‚úèÔ∏è Editando pregunta', index);
  const q = questionsHistory[index];
  if (!q) return;
  
  const newText = prompt('Editar pregunta:', q.pregunta);
  if (newText && newText.trim() !== '') {
    try {
      if (q.supabase_id) {
        // Actualizar en Supabase
        await SupabaseOperations.updateQuestion(q.supabase_id, {
          question_text: newText.trim()
        });
        console.log('‚úÖ Pregunta actualizada en Supabase');
      }
      
      // Actualizar en local
      questionsHistory[index].pregunta = newText.trim();
      window.updateQuestionsList();
      showSuccessNotification('‚úèÔ∏è Pregunta editada correctamente');
    } catch (error) {
      console.error('‚ùå Error editando pregunta:', error);
      showErrorModal('Error', 'No se pudo editar la pregunta: ' + error.message);
    }
  }
};

window.deleteQuestion = async function(index) {
  console.log('üóëÔ∏è Eliminando pregunta', index);
  const q = questionsHistory[index];
  if (!q) return;
  
  const questionPreview = q.pregunta?.substring(0, 50) || 'Sin t√≠tulo';
  
  if (confirm(`¬øEst√°s seguro de eliminar la pregunta "${questionPreview}..."?`)) {
    try {
      if (q.supabase_id) {
        // Eliminar de Supabase
        await SupabaseOperations.deleteQuestion(q.supabase_id);
        console.log('‚úÖ Pregunta eliminada de Supabase');
      }
      
      // Eliminar del array local
      questionsHistory.splice(index, 1);
      
      // Actualizar UI
      window.updateQuestionsList();
      
      // Mensaje de confirmaci√≥n
      if (questionsHistory.length === 0) {
        console.log('üì≠ Material sin preguntas');
        showSuccessNotification('üóëÔ∏è Pregunta eliminada. No quedan preguntas en este material.');
      } else {
        console.log(`üìä Quedan ${questionsHistory.length} preguntas en el material`);
        showSuccessNotification(`üóëÔ∏è Pregunta eliminada. Quedan ${questionsHistory.length} preguntas.`);
      }
    } catch (error) {
      console.error('‚ùå Error eliminando pregunta:', error);
      showErrorModal('Error', 'No se pudo eliminar la pregunta: ' + error.message);
    }
  }
};

// Guardar preguntas en localStorage con metadata de carpeta
function saveQuestionsToStorage() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const materialId = urlParams.get('material') || urlParams.get('material_id') || '1';
    
    // ‚ùå YA NO USAMOS localStorage - Solo Supabase
    console.log(`üíæ ${questionsHistory.length} preguntas ya guardadas en Supabase`);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    console.log('‚úÖ DATOS EN SUPABASE:');
    console.log(`   ‚Ä¢ Material: ${materialId}`);
    console.log(`   ‚Ä¢ Total Preguntas: ${questionsHistory.length}`);
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  } catch (e) {
    console.error('‚ùå Error sincronizando:', e);
  }
}

// Cargar preguntas desde Supabase
async function loadQuestionsFromSupabase() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    let materialIdFromUrl = urlParams.get('material') || urlParams.get('material_id');
    
    // üîÑ SI NO HAY EN URL, intentar desde localStorage
    if (!materialIdFromUrl) {
      const lastMaterial = localStorage.getItem('last_active_material');
      if (lastMaterial) {
        console.log('üîÑ Usando √∫ltimo material activo desde localStorage:', lastMaterial);
        materialIdFromUrl = lastMaterial;
      }
    }
    
    // üîÑ SI TODAV√çA NO HAY, cargar TODAS las preguntas del usuario
    if (!materialIdFromUrl) {
      console.log('üìö No hay material espec√≠fico, cargando TODAS las preguntas del usuario...');
      
      // Obtener TODOS los materiales del usuario
      const allMaterials = await SupabaseOperations.getMaterials();
      console.log(`üì¶ ${allMaterials.length} materiales encontrados`);
      
      questionsHistory = [];
      
      // Cargar preguntas de TODOS los materiales
      for (const material of allMaterials) {
        const questions = await SupabaseOperations.getQuestionsByMaterial(material.id);
        
        for (const question of questions) {
          const answers = await SupabaseOperations.getAnswersByQuestion(question.id);
          const lastAnswer = answers.length > 0 ? answers[0] : null;
          
          if (lastAnswer) {
            let bestMatchChunk = null;
            try {
              if (lastAnswer.best_match_chunk && typeof lastAnswer.best_match_chunk === 'string') {
                bestMatchChunk = JSON.parse(lastAnswer.best_match_chunk);
              } else if (lastAnswer.best_match_chunk && typeof lastAnswer.best_match_chunk === 'object') {
                bestMatchChunk = lastAnswer.best_match_chunk;
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è Error parseando best_match_chunk:', e);
            }
            
            const questionData = {
              id: Date.now() + Math.random(),
              supabase_id: question.id,
              carpeta_id: question.material_id,
              material_name: material.title, // ‚úÖ Agregar nombre del material
              pregunta: question.question_text,
              respuesta: lastAnswer.answer_text,
              score: parseFloat(lastAnswer.score),
              similarity: parseFloat(lastAnswer.similarity || 0),
              classification: lastAnswer.classification,
              feedback: lastAnswer.feedback,
              best_match_chunk: bestMatchChunk,
              relevant_chunks: lastAnswer.relevant_chunks || [],
              saved: true,
              timestamp: new Date(question.created_at).getTime()
            };
            
            questionsHistory.push(questionData);
          }
        }
      }
      
      console.log(`‚úÖ ${questionsHistory.length} preguntas cargadas (TODOS los materiales)`);
      
      // Actualizar UI
      if (typeof window.updateQuestionsList === 'function') {
        window.updateQuestionsList();
      }
      
      return; // ‚úÖ Salir aqu√≠
    }
    
    // ‚úÖ CONVERTIR ID de URL a UUID de Supabase
    let materialId = materialIdFromUrl;
    
    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
    if (!uuidRegex.test(materialIdFromUrl)) {
      console.log('üîÑ ID no es UUID, buscando material en Supabase...');
      const materials = await SupabaseOperations.getMaterials();
      
      if (materials && materials.length > 0) {
        materialId = materials[0].id; // Tomar el primer material
        console.log('‚úÖ UUID del material encontrado:', materialId);
      } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ material en Supabase');
        questionsHistory = [];
        return;
      }
    }
    
    console.log(`üîç Cargando preguntas desde Supabase para material UUID: ${materialId}`);
    
    // ‚úÖ Obtener informaci√≥n del material
    const materials = await SupabaseOperations.getMaterials();
    const currentMaterial = materials.find(m => m.id === materialId);
    const materialName = currentMaterial ? currentMaterial.title : 'Material desconocido';
    
    console.log(`üìö Material: ${materialName}`);
    
    // Cargar preguntas con sus respuestas
    const questions = await SupabaseOperations.getQuestionsByMaterial(materialId);
    
    // Convertir a formato del frontend
    questionsHistory = [];
    
    for (const question of questions) {
      // Obtener la √∫ltima respuesta de esta pregunta
      const answers = await SupabaseOperations.getAnswersByQuestion(question.id);
      const lastAnswer = answers.length > 0 ? answers[0] : null;
      
      if (lastAnswer) {
        // Convertir a formato local para UI
        let bestMatchChunk = null;
        try {
          if (lastAnswer.best_match_chunk && typeof lastAnswer.best_match_chunk === 'string') {
            bestMatchChunk = JSON.parse(lastAnswer.best_match_chunk);
          } else if (lastAnswer.best_match_chunk && typeof lastAnswer.best_match_chunk === 'object') {
            bestMatchChunk = lastAnswer.best_match_chunk;
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error parseando best_match_chunk:', e);
        }
        
        const questionData = {
          id: Date.now() + Math.random(), // ID temporal para UI
          supabase_id: question.id,
          carpeta_id: question.material_id,
          material_name: materialName, // ‚úÖ Agregar nombre del material
          pregunta: question.question_text,
          respuesta: lastAnswer.answer_text,
          score: parseFloat(lastAnswer.score),
          similarity: parseFloat(lastAnswer.similarity || 0),
          classification: lastAnswer.classification,
          feedback: lastAnswer.feedback,
          best_match_chunk: bestMatchChunk,
          relevant_chunks: lastAnswer.relevant_chunks || [],
          saved: true,
          timestamp: new Date(question.created_at).getTime()
        };
        
        questionsHistory.push(questionData);
      }
    }
    
    console.log(`‚úÖ ${questionsHistory.length} preguntas cargadas desde Supabase`);
    
    // Actualizar UI
    if (typeof window.updateQuestionsList === 'function') {
      window.updateQuestionsList();
    }
    
    // üÜï SPRINT 2: Mostrar bot√≥n de generaci√≥n autom√°tica
    if (typeof updateGenerateButton === 'function') {
      updateGenerateButton();
    }
    
  } catch (error) {
    console.error('‚ùå Error cargando preguntas desde Supabase:', error);
    questionsHistory = [];
  }
}

// DEPRECATED: Funci√≥n antigua de localStorage - AHORA SOLO CARGA DESDE SUPABASE
async function loadQuestionsFromStorage() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const materialId = urlParams.get('material') || urlParams.get('material_id') || '1';
    
    console.log(`üîë Material activo: ${materialId}`);
    
    // ‚ùå YA NO USAMOS localStorage - Solo Supabase
    console.log('‚è≥ Cargando preguntas desde Supabase...');
    await loadQuestionsFromSupabase();  // ‚úÖ Ahora funci√≥n es async
  } catch (e) {
    console.error('‚ùå Error cargando preguntas:', e);
    questionsHistory = [];
  }
}

window.newQuestion = function() {
  console.log('üî•üÜï FUNCI√ìN newQuestion LLAMADA');
  
  // Limpiar inputs
  const questionInput = document.getElementById('user-question');
  const userAnswer = document.getElementById('user-answer');
  const validationResult = document.getElementById('validation-result');
  const btnValidate = document.getElementById('btn-validate-answer');
  const btnSave = document.getElementById('btn-save-question');
  const generatedIndicator = document.getElementById('generated-indicator');
  
  // ‚úÖ CORRECCI√ìN PROFESOR: Limpiar estado del textarea de pregunta
  if (questionInput) {
    questionInput.value = '';
    questionInput.readOnly = false; // Desbloquear para nueva pregunta
    questionInput.classList.remove('bg-green-50', 'border-green-300', 'cursor-not-allowed');
    questionInput.classList.add('focus:border-blue-500');
  }
  
  // ‚úÖ Ocultar indicador de pregunta generada
  if (generatedIndicator) {
    generatedIndicator.style.display = 'none';
  }
  
  // ‚úÖ Resetear flag de pregunta generada
  window.questionWasGenerated = false;
  
  if (userAnswer) {
    userAnswer.value = '';
    userAnswer.disabled = true; // ‚úÖ Deshabilitado hasta que se escriba una pregunta
    userAnswer.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-100');
    userAnswer.classList.remove('bg-white');
    userAnswer.dispatchEvent(new Event('input'));
  }
  
  if (validationResult) validationResult.classList.add('hidden');
  
  if (btnValidate) {
    btnValidate.disabled = true;
    btnValidate.innerHTML = `
      <span class="material-symbols-outlined text-xl">psychology</span>
      <span>VALIDAR RESPUESTA</span>
    `;
  }
  
  if (btnSave) {
    btnSave.disabled = false;
    btnSave.classList.remove('opacity-50', 'cursor-not-allowed');
    btnSave.innerHTML = `
      <span class="material-symbols-outlined text-xl">bookmark_add</span>
      <span>GUARDAR PREGUNTA</span>
    `;
  }
  
  window.currentValidatedQuestion = null;
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

window.updateQuestionsList = function() {
  console.log('üìã updateQuestionsList llamada, preguntas:', questionsHistory.length);
  const questionsList = document.getElementById('questions-list');
  if (!questionsList) return;
  
  if (questionsHistory.length === 0) {
    questionsList.innerHTML = `
      <div class="text-center py-12 text-gray-400">
        <span class="material-symbols-outlined text-5xl mb-3">quiz</span>
        <p class="text-sm font-medium">A√∫n no hay preguntas</p>
        <p class="text-xs mt-1">Crea tu primera pregunta ‚Üí</p>
      </div>
    `;
    return;
  }
  
  // ‚úÖ Detectar si se necesita normalizaci√≥n
  let needsNormalization = false;
  
  const questionsHTML = questionsHistory.map((q, idx) => {
    // ‚úÖ ASEGURAR que el score est√© normalizado 0-100
    let displayScore = q.score;
    if (displayScore !== undefined && displayScore > 0 && displayScore <= 1) {
      displayScore = Math.round(displayScore * 100);
      // Actualizar en el array tambi√©n
      q.score = displayScore;
      needsNormalization = true; // ‚úÖ Marcar que se normaliz√≥
    }
    
    const scoreColor = displayScore >= 80 ? 'bg-green-50 border-green-200' : 
                       displayScore >= 60 ? 'bg-blue-50 border-blue-200' : 
                       displayScore >= 40 ? 'bg-yellow-50 border-yellow-200' : 
                       'bg-red-50 border-red-200';
    
    // ‚úÖ Mostrar nombre del material si est√° disponible
    const materialTag = q.material_name ? `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full mb-1 inline-block">üìö ${q.material_name}</span>` : '';
    const folderTag = q.folder ? `<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">${q.folder}</span>` : '';
    
    // Informaci√≥n del chunk si existe
    const chunkInfo = q.best_match_chunk ? `
      <div class="mt-2 text-xs text-gray-600 bg-white bg-opacity-50 rounded px-2 py-1">
        <span class="material-symbols-outlined text-xs align-middle">widgets</span>
        Chunk ${(q.best_match_chunk.chunk_id || 0) + 1}/${q.best_match_chunk.total_chunks || 0} 
        ¬∑ P√°g ~${(q.best_match_chunk.estimated_page || 0) + 1}
      </div>
    ` : '';
    
    return `
      <div class="rounded-lg border-2 hover:shadow-md transition-all p-3 ${scoreColor} group relative">
        <div class="flex items-start justify-between mb-1">
          <p class="text-sm font-bold flex-1">PREGUNTA #${idx + 1}</p>
          <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
            <button onclick="window.viewQuestionDetails(${idx})" 
                    class="p-1 hover:bg-blue-100 rounded-md transition-colors" 
                    title="Ver detalles completos">
              <span class="material-symbols-outlined text-blue-600" style="font-size: 18px;">visibility</span>
            </button>
            <button onclick="window.editQuestion(${idx})" 
                    class="p-1 hover:bg-amber-100 rounded-md transition-colors" 
                    title="Editar pregunta">
              <span class="material-symbols-outlined text-amber-600" style="font-size: 18px;">edit</span>
            </button>
            <button onclick="window.deleteQuestion(${idx})" 
                    class="p-1 hover:bg-red-100 rounded-md transition-colors" 
                    title="Eliminar pregunta">
              <span class="material-symbols-outlined text-red-600" style="font-size: 18px;">delete</span>
            </button>
          </div>
        </div>
        ${materialTag}
        ${folderTag}
        <p class="text-sm text-gray-700 line-clamp-2 mb-2 cursor-pointer" onclick="window.loadQuestion(${idx})">${q.pregunta}</p>
        ${folderTag}
        <p class="text-sm text-gray-700 line-clamp-2 mb-2 cursor-pointer" onclick="window.loadQuestion(${idx})">${q.pregunta}</p>
        <div class="flex justify-between items-center text-xs text-gray-500">
          <span>${new Date(q.timestamp || Date.now()).toLocaleDateString('es-ES')}</span>
          <span class="font-bold text-base">${displayScore}%</span>
        </div>
        ${chunkInfo}
      </div>
    `;
  }).join('');
  
  // Agregar bot√≥n "+" al final
  const addButtonHTML = `
    <button onclick="window.newQuestion()" 
            class="w-full rounded-lg border-2 border-dashed border-gray-300 hover:border-blue-400 hover:bg-blue-50 transition-all p-4 flex items-center justify-center gap-2 text-gray-500 hover:text-blue-600">
      <span class="material-symbols-outlined" style="font-size: 24px;">add_circle</span>
      <span class="text-sm font-semibold">Nueva Pregunta</span>
    </button>
  `;
  
  questionsList.innerHTML = questionsHTML + addButtonHTML;
  
  // ‚úÖ GUARDAR solo si se normalizaron scores
  if (needsNormalization) {
    console.log('üíæ Guardando preguntas normalizadas...');
    saveQuestionsToStorage();
  }
};

window.loadQuestion = function(index) {
  console.log('üìñ Cargando pregunta', index);
  const q = questionsHistory[index];
  if (!q) return;
  
  const questionInput = document.getElementById('user-question');
  const userAnswer = document.getElementById('user-answer');
  
  if (questionInput) {
    questionInput.value = q.pregunta;
    // ‚úÖ Disparar evento input para habilitar el textarea de respuesta
    questionInput.dispatchEvent(new Event('input'));
  }
  
  if (userAnswer) {
    userAnswer.value = q.respuesta;
    // ‚úÖ Asegurar que el textarea est√© habilitado
    userAnswer.disabled = false;
    userAnswer.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100');
    userAnswer.classList.add('bg-white');
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Nueva funci√≥n para ver detalles completos de una pregunta
window.viewQuestionDetails = function(index) {
  console.log('üîç Viendo detalles de pregunta', index);
  const q = questionsHistory[index];
  if (!q) return;
  
  const chunk = q.best_match_chunk || {};
  const chunkText = chunk.text || chunk.text_full || 'No disponible';
  const chunkId = (chunk.chunk_id || 0) + 1;
  const totalChunks = chunk.total_chunks || 0;
  const estimatedPage = (chunk.estimated_page || 0) + 1;
  const similarity = chunk.similarity ? (chunk.similarity * 100).toFixed(1) : q.score;
  
  // Crear modal con informaci√≥n completa
  const modalHTML = `
    <div id="question-details-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="this.remove()">
      <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 rounded-t-2xl">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-2xl font-bold mb-2 flex items-center gap-2">
                <span class="material-symbols-outlined text-3xl">quiz</span>
                Pregunta #${index + 1}
              </h2>
              <p class="text-blue-100 text-sm">
                ${new Date(q.timestamp).toLocaleDateString('es-ES', { 
                  weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', 
                  hour: '2-digit', minute: '2-digit' 
                })}
              </p>
            </div>
            <button onclick="this.closest('#question-details-modal').remove()" 
                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
              <span class="material-symbols-outlined text-3xl">close</span>
            </button>
          </div>
        </div>
        
        <!-- Content -->
        <div class="p-6 space-y-6">
          
          <!-- Pregunta -->
          <div class="bg-blue-50 border-2 border-blue-200 rounded-xl p-5">
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-blue-600 text-2xl">help_outline</span>
              <h3 class="text-lg font-bold text-blue-900">Tu Pregunta</h3>
            </div>
            <p class="text-gray-800 text-base leading-relaxed">${q.pregunta}</p>
          </div>
          
          <!-- Respuesta -->
          <div class="bg-green-50 border-2 border-green-200 rounded-xl p-5">
            <div class="flex items-center gap-2 mb-3">
              <span class="material-symbols-outlined text-green-600 text-2xl">edit_note</span>
              <h3 class="text-lg font-bold text-green-900">Tu Respuesta</h3>
            </div>
            <p class="text-gray-800 text-base leading-relaxed whitespace-pre-line">${q.respuesta}</p>
          </div>
          
          <!-- Score y M√©tricas -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-xl p-4 text-center">
              <div class="text-4xl font-black text-purple-700">${q.score}%</div>
              <div class="text-sm font-semibold text-purple-600 mt-1">Score</div>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-200 rounded-xl p-4 text-center">
              <div class="text-4xl font-black text-blue-700">${similarity}%</div>
              <div class="text-sm font-semibold text-blue-600 mt-1">Similitud</div>
            </div>
            <div class="bg-gradient-to-br from-amber-50 to-amber-100 border-2 border-amber-200 rounded-xl p-4 text-center">
              <div class="text-2xl font-black text-amber-700">${q.is_correct ? '‚úÖ Correcta' : '‚ùå Revisar'}</div>
              <div class="text-sm font-semibold text-amber-600 mt-1">Estado</div>
            </div>
          </div>
          
          <!-- Fragmento del Material -->
          ${chunk.text || chunk.text_full ? `
            <div class="bg-gradient-to-br from-indigo-50 to-blue-50 border-2 border-indigo-300 rounded-xl p-5">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-indigo-900 flex items-center gap-2">
                  <span class="material-symbols-outlined text-2xl">auto_stories</span>
                  üìñ Fragmento del Material
                </h3>
                <div class="flex gap-2">
                  <span class="text-xs bg-indigo-200 text-indigo-800 px-3 py-1 rounded-full font-semibold">
                    ${similarity}% coincidencia
                  </span>
                </div>
              </div>
              
              <!-- Info del chunk -->
              <div class="mb-3 flex flex-wrap gap-2 text-sm">
                <div class="flex items-center gap-1 bg-white px-3 py-1.5 rounded-lg border border-indigo-200">
                  <span class="material-symbols-outlined text-sm text-indigo-600">widgets</span>
                  <span class="font-semibold text-gray-700">Chunk ${chunkId}/${totalChunks}</span>
                </div>
                <div class="flex items-center gap-1 bg-white px-3 py-1.5 rounded-lg border border-indigo-200">
                  <span class="material-symbols-outlined text-sm text-indigo-600">description</span>
                  <span class="font-semibold text-gray-700">~P√°gina ${estimatedPage}</span>
                </div>
              </div>
              
              <!-- Texto del chunk -->
              <div class="bg-white rounded-lg p-4 border-l-4 border-indigo-500 max-h-60 overflow-y-auto">
                <blockquote class="text-base text-gray-800 leading-relaxed font-serif italic">
                  "${chunkText}"
                </blockquote>
              </div>
            </div>
          ` : ''}
          
          <!-- Feedback de la IA -->
          ${q.feedback ? `
            <div class="bg-gray-50 border-2 border-gray-200 rounded-xl p-5">
              <div class="flex items-center gap-2 mb-3">
                <span class="material-symbols-outlined text-gray-600 text-2xl">psychology</span>
                <h3 class="text-lg font-bold text-gray-900">An√°lisis de la IA</h3>
              </div>
              <div class="text-gray-700 text-sm leading-relaxed whitespace-pre-line">${q.feedback}</div>
            </div>
          ` : ''}
          
          <!-- Botones de acci√≥n -->
          <div class="flex gap-3 pt-4 border-t-2 border-gray-200">
            <button onclick="window.loadQuestion(${index}); this.closest('#question-details-modal').remove();" 
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
              <span class="material-symbols-outlined">edit</span>
              Editar Pregunta
            </button>
            <button onclick="this.closest('#question-details-modal').remove()" 
                    class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition flex items-center justify-center gap-2">
              <span class="material-symbols-outlined">close</span>
              Cerrar
            </button>
          </div>
          
        </div>
      </div>
    </div>
  `;
  
  // Insertar modal en el DOM
  document.body.insertAdjacentHTML('beforeend', modalHTML);
};

// ===================================================================
// INICIALIZACI√ìN DEL DOM
// ===================================================================

// Funci√≥n para cargar informaci√≥n del material actual
async function loadMaterialInfo(materialId) {
  const banner = document.getElementById('current-material-banner');
  const filenameEl = document.getElementById('material-filename');
  const statsEl = document.getElementById('material-stats');
  const locationEl = document.getElementById('material-location');
  
  try {
    // ‚úÖ OBTENER MATERIALES DESDE SUPABASE
    const materials = await SupabaseOperations.getMaterials();
    
    if (materials && materials.length > 0) {
      // Buscar el material por UUID (comparaci√≥n estricta)
      const material = materials.find(m => m.id === materialId);
      
      if (material) {
        console.log('‚úÖ Material encontrado:', material.title);
        
        // üÜï GUARDAR MATERIAL ID EN LOCALSTORAGE PARA QUE EL BOT√ìN GENERAR LO DETECTE
        localStorage.setItem('last_active_material', material.id);
        console.log('üíæ Material guardado en localStorage:', material.id);
        
        // Mostrar banner
        if (banner) banner.style.display = 'block';
        
        // Obtener nombre del archivo
        const materialFileName = material.title || material.file_name || material.filename || 'Material sin nombre';
        
        // Actualizar informaci√≥n b√°sica
        if (filenameEl) filenameEl.textContent = materialFileName;
        if (statsEl) {
          const chunks = material.total_chunks || material.chunk_count || 0;
          const pages = material.total_pages || material.estimated_pages || 'N/A';
          statsEl.textContent = `${chunks} chunks ‚Ä¢ ${pages} p√°ginas`;
        }
        
        // ‚ú® OBTENER RUTA COMPLETA DESDE LOCALSTORAGE (SISTEMA JER√ÅRQUICO)
        const urlParams = new URLSearchParams(window.location.search);
        const currentChunk = urlParams.get('chunk') || '1';
        const totalChunks = material.total_chunks || 153;
        const estimatedPage = Math.ceil(parseInt(currentChunk) / 3);
        
        // üî• LEER RUTA JER√ÅRQUICA DESDE recuiva_active_path
        let rutaCarpetas = '';
        
        try {
          const rutaActivaRaw = localStorage.getItem('recuiva_active_path');
          if (rutaActivaRaw) {
            const rutaActiva = JSON.parse(rutaActivaRaw);
            const { carpetas } = rutaActiva;
            
            if (carpetas && carpetas.length > 0) {
              // Construir ruta: "Odontolog√≠a ‚Ä∫ Anatom√≠a ‚Ä∫ Sistema Digestivo"
              rutaCarpetas = carpetas.join(' ‚Ä∫ ');
              console.log('üìç Ruta de carpetas cargada:', rutaCarpetas);
            }
          } else {
            // Fallback: intentar desde recuiva_carpeta_activa (compatibilidad)
            const carpetaActiva = localStorage.getItem('recuiva_carpeta_activa');
            if (carpetaActiva) {
              const { nombre, tipo } = JSON.parse(carpetaActiva);
              rutaCarpetas = tipo ? `${nombre} (${tipo})` : nombre;
            }
          }
        } catch (e) {
          console.warn('‚ö†Ô∏è Error al cargar ruta de carpetas:', e);
          // Fallback final: usar URL params
          const carpetaNombre = urlParams.get('carpeta') || urlParams.get('nombre');
          const carpetaTipo = urlParams.get('tipo');
          if (carpetaNombre) {
            rutaCarpetas = carpetaTipo ? `${carpetaNombre} (${carpetaTipo})` : carpetaNombre;
          }
        }
        
        // Construir ruta completa: Material name
        const materialBaseName = materialFileName.replace('.pdf', '').replace('.txt', '');
        let rutaCompleta = materialBaseName;
        
        // ‚úÖ Si hay carpetas, agregar al breadcrumb
        if (rutaCarpetas) {
          rutaCompleta = `${rutaCarpetas} ‚Ä∫ ${materialBaseName}`;
        }
        
        // Actualizar BREADCRUMB (arriba del cuadro)
        const breadcrumbNombre = document.getElementById('breadcrumb-nombre');
        if (breadcrumbNombre) {
          breadcrumbNombre.textContent = rutaCompleta;
          breadcrumbNombre.title = rutaCompleta;
          console.log('üìç Breadcrumb cargado:', rutaCompleta);
        }
        
        // Actualizar LOCATION (info adicional del material)
        const chunks = material.total_chunks || material.chunk_count || 0;
        const pages = material.total_pages || material.estimated_pages || 'N/A';
        if (locationEl) {
          locationEl.innerHTML = `
            <span class="material-symbols-outlined text-sm">description</span>
            <span>${chunks} chunks ‚Ä¢ ${pages} p√°ginas</span>
          `;
        }
        
        console.log('‚úÖ Material cargado:', materialFileName);
        console.log('üìç Ruta completa:', rutaCompleta);
        if (typeof window.addValidationLog === 'function') {
          window.addValidationLog(`üìö Material activo: ${materialFileName}`, 'success');
          window.addValidationLog(`üìç ${rutaCompleta}`, 'info');
        }
        
        // üÜï SPRINT 2: Mostrar bot√≥n de generaci√≥n autom√°tica
        if (typeof updateGenerateButton === 'function') {
          updateGenerateButton();
        }
      } else {
        console.warn(`‚ö†Ô∏è Material UUID ${materialId} no encontrado en Supabase`);
        if (banner) banner.style.display = 'none';
      }
    } else {
      console.warn('‚ö†Ô∏è No hay materiales disponibles en Supabase');
      if (banner) banner.style.display = 'none';
    }
  } catch (error) {
    console.error('‚ùå Error cargando informaci√≥n del material:', error);
    if (banner) banner.style.display = 'none';
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  // Procesar logs pendientes que se generaron antes de que el DOM estuviera listo
  if (window._pendingLogs && window._pendingLogs.length > 0) {
    console.log(`üìã Procesando ${window._pendingLogs.length} logs pendientes...`);
    window._pendingLogs.forEach(log => {
      addValidationLog(log.message, log.type);
    });
    window._pendingLogs = [];
  }
  
  // === üîÑ AUTO-MIGRACI√ìN DE PREGUNTAS ANTIGUAS ===
  (() => {
    console.log('üîç Buscando preguntas en formato antiguo...');
    let migrated = 0;
    
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      
      // Detectar formato antiguo: questions_X (sin prefijo recuiva)
      if (key && key.startsWith('questions_') && !key.startsWith('recuiva_questions')) {
        const materialId = key.replace('questions_', '');
        const newKey = `recuiva_questions_material_${materialId}`;
        const oldData = localStorage.getItem(key);
        
        try {
          // Solo migrar si la nueva clave NO existe
          if (!localStorage.getItem(newKey) && oldData) {
            localStorage.setItem(newKey, oldData);
            console.log(`‚úÖ Migrado: ${key} ‚Üí ${newKey}`);
            migrated++;
          }
          // Eliminar clave antigua
          localStorage.removeItem(key);
          console.log(`üóëÔ∏è  Eliminada clave antigua: ${key}`);
        } catch (e) {
          console.error(`‚ùå Error migrando ${key}:`, e);
        }
      }
    }
    
    if (migrated > 0) {
      console.log(`‚úÖ Migradas ${migrated} preguntas al formato nuevo`);
    } else {
      console.log('‚úÖ No hay preguntas antiguas que migrar');
    }
  })();
  
  // Log inicial del sistema
  addValidationLog('üéØ Sistema inicializado correctamente', 'success');
  addValidationLog('‚è≥ Esperando input del usuario...', 'info');
  
  // === CARGAR INFORMACI√ìN DEL MATERIAL ACTUAL ===
  // üîÑ Obtener material_id REAL (UUID desde Supabase)
  const urlParams = new URLSearchParams(window.location.search);
  let materialId = urlParams.get('material') || urlParams.get('material_id');
  
  // Si no hay en URL, obtener el primer material del usuario
  if (!materialId) {
    const materials = await SupabaseOperations.getMaterials();
    if (materials && materials.length > 0) {
      materialId = materials[0].id;  // ‚úÖ UUID real
      console.log('‚úÖ Material UUID para breadcrumb:', materialId);
    } else {
      materialId = null;  // No hay materiales
    }
  }
  
  // Cargar preguntas guardadas del material actual
  // Cargar preguntas desde Supabase
  loadQuestionsFromSupabase();
  
  // Cargar y mostrar informaci√≥n del material
  if (materialId) {
    loadMaterialInfo(materialId);
  } else {
    console.warn('‚ö†Ô∏è No hay material para cargar breadcrumb');
  }
  
  // === MOSTRAR RUTA COMPLETA EN EL BREADCRUMB (CON CARPETAS JER√ÅRQUICAS) ===
  const breadcrumbNombre = document.getElementById('breadcrumb-nombre');
  
  // üî• LEER RUTA ACTIVA DESDE LOCALSTORAGE (guardada en index.html)
  const rutaActivaRaw = localStorage.getItem('recuiva_active_path');
  
  if (rutaActivaRaw) {
    try {
      const rutaActiva = JSON.parse(rutaActivaRaw);
      const { carpetas } = rutaActiva;
      
      if (carpetas && carpetas.length > 0) {
        // Construir breadcrumb: "Carpeta 1 ‚Ä∫ Carpeta 2 ‚Ä∫ Carpeta 3"
        const rutaCompleta = carpetas.join(' ‚Ä∫ ');
        
        if (breadcrumbNombre) {
          breadcrumbNombre.textContent = rutaCompleta;
          breadcrumbNombre.title = rutaCompleta; // Tooltip con ruta completa
          console.log('üìç Breadcrumb cargado:', rutaCompleta);
        }
      } else {
        if (breadcrumbNombre) breadcrumbNombre.textContent = 'Sin carpeta';
      }
    } catch(e) {
      console.error('‚ùå Error al cargar ruta activa:', e);
      if (breadcrumbNombre) breadcrumbNombre.textContent = 'Sin carpeta';
    }
  } else {
    // Fallback: intentar cargar desde URL params (compatibilidad)
    const carpetaNombre = urlParams.get('carpeta') || urlParams.get('nombre');
    const carpetaTipo = urlParams.get('tipo');
    const materialNombre = urlParams.get('material_nombre');
    
    if (carpetaNombre || materialNombre) {
      let rutaCompleta = '';
      
      if (carpetaNombre) {
        if (carpetaTipo) {
          rutaCompleta = `${decodeURIComponent(carpetaNombre)} (${decodeURIComponent(carpetaTipo)})`;
        } else {
          rutaCompleta = decodeURIComponent(carpetaNombre);
        }
      }
      
      if (materialNombre) {
        const materialDecoded = decodeURIComponent(materialNombre);
        rutaCompleta += carpetaNombre ? ` ‚Ä∫ ${materialDecoded}` : materialDecoded;
      }
      
      if (breadcrumbNombre && rutaCompleta) {
        breadcrumbNombre.textContent = rutaCompleta;
        breadcrumbNombre.title = rutaCompleta;
        console.log(`üìÇ Ruta desde URL: ${rutaCompleta}`);
      }
    } else {
      if (breadcrumbNombre) breadcrumbNombre.textContent = 'Sin carpeta';
    }
  }
  
  // === CARGAR HISTORIAL DE PREGUNTAS ===
  // NOTA: Las preguntas se cargan desde loadQuestionsFromStorage() 
  // usando el formato: recuiva_questions_material_${materialId}
  // NO cargar desde el formato antiguo questions_${materialId}
  
  console.log('üìã Historial de preguntas cargado desde localStorage con formato nuevo');
  
  // === FUNCIONES MODALES BACKEND MEJORADAS ===
  window.showBackendModal = function(icon, title, description) {
    showAdvancedModal(icon, title, description);
  };
  
  // Modal avanzado con mejor UX
  window.showAdvancedModal = function(icon, title, description) {
    // Crear modal si no existe
    let modal = document.getElementById('advanced-modal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'advanced-modal';
      modal.className = 'notification-modal';
      modal.innerHTML = `
        <div class="notification-modal-content">
          <div class="notification-icon-container">
            <span class="material-symbols-outlined text-2xl text-white" id="modal-icon">notifications</span>
          </div>
          <h3 id="modal-title">üîî Notificaciones</h3>
          <p id="modal-description">Sistema de notificaciones en tiempo real para repasos, recordatorios y actualizaciones de progreso. Requiere conexi√≥n con servidor. Por ahora puedes explorar la funcionalidad simulada. En la versi√≥n completa con backend, esto funcionar√° en tiempo real.</p>
          <button onclick="closeAdvancedModal()" class="modal-button">
            Aceptar
          </button>
        </div>
      `;
      document.body.appendChild(modal);
      
      // Cerrar con escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.classList.contains('show')) {
          closeAdvancedModal();
        }
      });
      
      // Cerrar clickeando fuera
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeAdvancedModal();
        }
      });
    }
    
    // Actualizar contenido
    const iconMap = {
      'notifications': 'üîî',
      'settings': '‚öôÔ∏è',
      'dashboard': 'üìä',
      'analytics': 'üìà'
    };
    
    document.getElementById('modal-icon').textContent = icon;
    document.getElementById('modal-title').textContent = `${iconMap[icon] || 'üìã'} ${title}`;
    document.getElementById('modal-description').textContent = description;
    
    // Mostrar modal con animaci√≥n
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
  };
  
  window.closeAdvancedModal = function() {
    const modal = document.getElementById('advanced-modal');
    if (modal) {
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
  };
  
  // === FUNCIONES NAVEGACI√ìN ===
  
  // Funci√≥n para limpiar datos locales
  window.limpiarDatos = function() {
    if (confirm('‚ö†Ô∏è ¬øEst√°s seguro?\n\nSe borrar√°n todas tus carpetas, preguntas y progreso guardados.')) {
      localStorage.clear();
      alert('‚úÖ Datos locales eliminados correctamente.');
      window.location.href = '/index.html';
    }
  };
  
  // Funci√≥n para mostrar configuraci√≥n
  window.mostrarConfiguracion = function() {
    showAdvancedModal('settings', 'Configuraci√≥n', 'Aqu√≠ podr√°s ajustar preferencias del sistema.');
  };

  // ===================================================================
  // MEN√ö M√ìVIL Y PERFIL - MANEJADO POR header-footer-components.js
  // El c√≥digo duplicado fue eliminado para evitar conflictos
  // ===================================================================

  // === AUTENTICACI√ìN DEMO (Ya no se usa mockAPI) ===
  
  // Auto-login con usuario demo para pruebas
  const demoUser = {
    id: 'u1',
    email: 'demo@recuiva.com',
    name: 'Usuario Demo',
    token: 'demo_token_' + Date.now()
  };
  
  if (!localStorage.getItem('recuiva_current_user')) {
    localStorage.setItem('recuiva_current_user', JSON.stringify(demoUser));
    console.log('üîê Auto-login como usuario demo');
  }

  // Variables de sesi√≥n
  let currentQuestions = [];
  let currentIndex = 0;
  let sessionResults = [];
  let sessionStartTime = Date.now();

  // Inicializar sesi√≥n de pr√°ctica
  initializePracticeSession();

  async function initializePracticeSession() {
    // Cargar set actual o usar datos por defecto
    const currentSet = JSON.parse(localStorage.getItem('recuiva_current_study_set') || 'null');
    
    if (currentSet && currentSet.questions && currentSet.questions.length > 0) {
      currentQuestions = currentSet.questions;
    } else {
      // Sistema vac√≠o - sin preguntas predeterminadas
      currentQuestions = [];
    }

    // Limitar a 5 preguntas por sesi√≥n
    currentQuestions = currentQuestions.slice(0, 5);
    
    // Si no hay preguntas, no hacer nada (la UI muestra el mensaje)
    if (currentQuestions.length === 0) {
      console.log('No hay preguntas disponibles');
      return;
    }
    
    // Iniciar primera pregunta
    showCurrentQuestion();
  }

  function showCurrentQuestion() {
    if (currentIndex >= currentQuestions.length) {
      finishSession();
      return;
    }

    const question = currentQuestions[currentIndex];
    
    // Actualizar UI (si existen los elementos)
    const questionText = document.getElementById('question-text') || document.querySelector('h2');
    const answerText = document.getElementById('answer-text') || document.querySelector('.answer-content');
    const progressText = document.getElementById('progress-text') || document.querySelector('.progress-info');

    if (questionText) questionText.textContent = question.question;
    if (answerText) answerText.textContent = question.answer;
    if (progressText) progressText.textContent = `Pregunta ${currentIndex + 1} de ${currentQuestions.length}`;

    // Mostrar bot√≥n de revelar
    showRevealButton();
  }

  function showRevealButton() {
    // Crear bot√≥n de revelar si no existe
    let revealBtn = document.getElementById('reveal-btn');
    if (!revealBtn) {
      revealBtn = document.createElement('button');
      revealBtn.id = 'reveal-btn';
      revealBtn.className = 'px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 font-medium';
      revealBtn.textContent = 'üëÅÔ∏è Mostrar Respuesta';
      
      const container = document.querySelector('main') || document.body;
      container.appendChild(revealBtn);
    }

    revealBtn.style.display = 'block';
    revealBtn.onclick = showAnswer;
  }

  function showAnswer() {
    // Ocultar bot√≥n revelar
    const revealBtn = document.getElementById('reveal-btn');
    if (revealBtn) revealBtn.style.display = 'none';

    // Mostrar respuesta y botones de puntuaci√≥n
    showScoreButtons();
  }

  function showScoreButtons() {
    // Crear botones de puntuaci√≥n si no existen
    let scoreContainer = document.getElementById('score-container');
    if (!scoreContainer) {
      scoreContainer = document.createElement('div');
      scoreContainer.id = 'score-container';
      scoreContainer.className = 'mt-6 space-y-3';
      scoreContainer.innerHTML = `
        <h3 class="text-lg font-semibold text-center mb-4">¬øC√≥mo respondiste?</h3>
        <div class="grid grid-cols-2 gap-3">
          <button onclick="scoreAnswer(1)" class="p-3 bg-red-500 text-white rounded-lg hover:bg-red-600 font-medium">
            üòî Mala (1)
          </button>
          <button onclick="scoreAnswer(2)" class="p-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-medium">
            üòê Regular (2)
          </button>
          <button onclick="scoreAnswer(3)" class="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-medium">
            üòä Buena (3)
          </button>
          <button onclick="scoreAnswer(4)" class="p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">
            üéâ Excelente (4)
          </button>
        </div>
      `;
      
      const container = document.querySelector('main') || document.body;
      container.appendChild(scoreContainer);
    }

    scoreContainer.style.display = 'block';
  }

  // Funci√≥n global para puntuar respuesta
  window.scoreAnswer = async function(score) {
    const question = currentQuestions[currentIndex];
    
    // Registrar resultado
    const result = {
      questionId: question.id,
      score: score,
      currentInterval: 1, // Mock interval
      timestamp: new Date().toISOString()
    };
    
    sessionResults.push(result);
    
    // Guardar resultado en localStorage (sin mockAPI)
    console.log('üíæ Resultado guardado:', result);
    
    // Mostrar feedback
    const intervalText = getIntervalText(score);
    alert(`Puntuaci√≥n: ${score}/4\nPr√≥ximo repaso: ${intervalText}`);
    
    // Siguiente pregunta
    currentIndex++;
    showCurrentQuestion();
  };

  function getIntervalText(score) {
    switch(score) {
      case 1: return '1 d√≠a (resetear)';
      case 2: return 'Reducido 50%';
      case 3: return 'Mantener intervalo';
      case 4: return 'Aumentar 30%';
      default: return 'Sin cambios';
    }
  }

  function finishSession() {
    // Si no hay resultados, no mostrar nada
    if (sessionResults.length === 0) {
      window.location.href = 'repasos.html';
      return;
    }
    
    const avgScore = sessionResults.reduce((sum, r) => sum + r.score, 0) / sessionResults.length;
    
    // SIN ALERT - Silenciosamente redirigir
    console.log(`Sesi√≥n completada - Preguntas: ${sessionResults.length}, Score promedio: ${avgScore.toFixed(2)}/4`);
    
    // Regresar a repasos
    window.location.href = 'repasos.html';
  }

  // ===================================================================
  // FUNCIONES PARA ACTIVE RECALL - SIMPLE Y FUNCIONAL
  // ===================================================================
  
  // NOTA: questionsHistory ya est√° definida globalmente (l√≠nea ~651)
  // NOTA: addValidationLog y clearValidationLog ya est√°n definidas globalmente (l√≠nea ~874)
  // NOTA: checkValidateButton ya est√° definida globalmente (l√≠nea ~509) ‚ö°
  // No redefinir aqu√≠ para evitar conflictos
  
  // NOTA: checkValidateButton ya est√° definida globalmente en l√≠nea ~514
  // NOTA: updateCharCount ya est√° definida globalmente en l√≠nea ~589
  // NOTA: validateWithBackend ya est√° definida globalmente en l√≠nea ~681
  // No redefinir aqu√≠ para evitar conflictos
  
  // ===================================================================
  // CARGAR PREGUNTAS AL INICIAR
  // ===================================================================
  // NOTA: Las preguntas ya se cargan desde loadQuestionsFromStorage()
  // No cargar duplicadamente aqu√≠
});
</script>

<!-- Animaci√≥n para notificaciones -->
<style>
@keyframes slide-in {
  from {
    opacity: 0;
    transform: translateX(400px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
.animate-slide-in {
  animation: slide-in 0.3s ease-out;
  transition: all 0.3s ease-out;
}

/* ‚úÖ CORRECCI√ìN PROFESOR: Animaci√≥n para acorde√≥n de porcentajes */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-fadeIn {
  animation: fadeIn 0.3s ease-out;
}

/* Rotar flecha del acorde√≥n cuando est√° abierto */
details[open] summary .material-symbols-outlined {
  transform: rotate(180deg);
}
details summary .material-symbols-outlined {
  transition: transform 0.2s ease-in-out;
}
</style>

<!-- MODAL DE ERROR -->
<div id="error-modal" class="notification-modal">
  <div class="notification-modal-content">
    <div class="notification-icon-container">
      <span class="material-symbols-outlined text-white text-3xl">error</span>
    </div>
    <h3 id="error-modal-title">Error</h3>
    <p id="error-modal-message">Ha ocurrido un error inesperado.</p>
    <button class="modal-button" onclick="closeErrorModal()">Aceptar</button>
  </div>
</div>

<!-- Footer Container - Managed by header-footer-components.js -->
<div id="footer-container"></div>

</div>

<!-- ==========================================
     SPRINT 2: GENERACI√ìN AUTOM√ÅTICA DE PREGUNTAS
     ========================================== -->
<script>
// Mostrar bot√≥n de generaci√≥n autom√°tica cuando hay un material activo
function updateGenerateButton() {
  console.log('üîß updateGenerateButton llamada - Sprint 2');
  
  // ‚úÖ OBTENER MATERIAL ID DESDE M√öLTIPLES FUENTES
  const urlParams = new URLSearchParams(window.location.search);
  let materialId = urlParams.get('material') || urlParams.get('material_id');
  
  // üÜï Tambi√©n verificar localStorage si no est√° en URL
  if (!materialId) {
    materialId = localStorage.getItem('last_active_material') || localStorage.getItem('currentMaterialId');
  }
  
  // üÜï Tambi√©n verificar si hay un banner de material activo visible
  const materialBanner = document.getElementById('material-active-banner');
  const hasMaterialBanner = materialBanner && materialBanner.style.display !== 'none' && materialBanner.textContent.trim().length > 0;
  
  const btn = document.getElementById('btn-generate-questions');
  
  console.log('üì¶ Material ID:', materialId);
  console.log('üì¶ Banner visible:', hasMaterialBanner);
  console.log('üîò Bot√≥n encontrado:', !!btn);
  
  // ‚úÖ Mostrar bot√≥n si hay material (por cualquier fuente)
  if ((materialId || hasMaterialBanner) && btn) {
    btn.style.display = 'flex';
    console.log('‚úÖ Bot√≥n mostrado');
  } else if (btn) {
    btn.style.display = 'none';
    console.log('‚ùå Bot√≥n ocultado (sin material)');
  }
}

async function generateQuestionsAuto() {
  // ‚úÖ OBTENER MATERIAL ID DESDE M√öLTIPLES FUENTES
  const urlParams = new URLSearchParams(window.location.search);
  let materialId = urlParams.get('material') || urlParams.get('material_id');
  
  // üÜï Tambi√©n verificar localStorage si no est√° en URL
  if (!materialId) {
    materialId = localStorage.getItem('last_active_material') || localStorage.getItem('currentMaterialId');
  }
  
  if (!materialId) {
    alert('‚ö†Ô∏è Selecciona un material primero');
    return;
  }

  // ‚úÖ DIRECTO: Sin preguntar cantidad ni estrategia
  // El backend genera autom√°ticamente seg√∫n el contenido
  const btn = document.getElementById('btn-generate-questions');
  const textarea = document.getElementById('user-question');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> Generando...';
  
  // ‚úÖ LIMPIAR ESTADO PREVIO SI HAB√çA PREGUNTA MANUAL
  if (textarea) {
    textarea.value = '';
    textarea.readOnly = false;
    textarea.classList.remove('bg-green-50', 'border-green-300');
  }

  try {
    const token = localStorage.getItem('sb-access-token');
    const backendUrl = api.baseUrl; // ‚úÖ Usar la URL del cliente API
    
    // ‚úÖ Generar 1 pregunta a la vez (iterativo como "Nueva Pregunta")
    const response = await fetch(`${backendUrl}/api/materials/${materialId}/generate-questions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({
        num_questions: 1,  // ‚úÖ 1 pregunta a la vez
        strategy: 'diverse'  // Estrategia diversa
      })
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.detail || 'Error generando preguntas');
    }

    const result = await response.json();
    
    console.log(`‚úÖ Pregunta generada autom√°ticamente`);
    console.log('Pregunta recibida:', result.questions);
    
    // ‚úÖ COLOCAR LA PREGUNTA EN EL TEXTAREA CORRECTO
    if (result.questions && result.questions.length > 0) {
      const preguntaObj = result.questions[0];  // Objeto completo con question y question_type
      const preguntaGenerada = preguntaObj.question;
      const questionType = preguntaObj.question_type || 'other';  // üëà NUEVO: tipo de pregunta
      
      const textarea = document.getElementById('user-question'); // ‚úÖ ID CORRECTO
      if (textarea) {
        textarea.value = preguntaGenerada;
        
        // ‚úÖ CORRECCI√ìN PROFESOR: Bloquear textarea en modo solo lectura
        textarea.readOnly = true;
        textarea.classList.add('bg-green-50', 'border-green-300', 'cursor-not-allowed');
        textarea.classList.remove('focus:border-blue-500');
        
        // ‚úÖ Marcar que fue generada autom√°ticamente
        window.questionWasGenerated = true;
        
        // ‚úÖ Habilitar el textarea de respuesta
        const answerTextarea = document.getElementById('user-answer');
        if (answerTextarea) {
          answerTextarea.disabled = false;
          answerTextarea.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-100');
          answerTextarea.classList.add('bg-white');
          answerTextarea.focus(); // ‚úÖ Dar foco al textarea de RESPUESTA
        }
        
        // ‚úÖ Disparar eventos para activar validaciones
        textarea.dispatchEvent(new Event('input', { bubbles: true }));
        textarea.dispatchEvent(new Event('change', { bubbles: true }));
        
        // ‚úÖ CR√çTICO: Llamar expl√≠citamente a checkValidateButton()
        if (typeof window.checkValidateButton === 'function') {
          window.checkValidateButton();
          console.log('‚úÖ checkValidateButton() llamado manualmente');
        }
        
        console.log('‚úÖ Pregunta colocada en textarea:', preguntaGenerada);
        console.log('üìù Longitud de pregunta:', preguntaGenerada.length, 'caracteres');
        console.log('üè∑Ô∏è Tipo de pregunta:', questionType);
        console.log('üîí Textarea bloqueado en modo solo lectura');
        
        // ‚úÖ NUEVO: Badge de tipo de pregunta (literal/inferential)
        let typeBadge = document.getElementById('question-type-badge');
        if (!typeBadge) {
          typeBadge = document.createElement('div');
          typeBadge.id = 'question-type-badge';
          typeBadge.className = 'mb-2 inline-flex items-center gap-2 text-sm font-semibold px-3 py-1 rounded-full';
          textarea.parentNode.insertBefore(typeBadge, textarea);
        }
        
        // Configurar badge seg√∫n tipo
        if (questionType === 'inferential') {
          typeBadge.className = 'mb-2 inline-flex items-center gap-2 text-sm font-semibold px-3 py-1 rounded-full bg-purple-100 text-purple-700 border border-purple-300';
          typeBadge.innerHTML = `
            <span class="material-symbols-outlined text-base">psychology</span>
            <span>Pregunta Inferencial</span>
            <span class="text-xs font-normal opacity-75">(razonamiento)</span>
          `;
        } else if (questionType === 'literal') {
          typeBadge.className = 'mb-2 inline-flex items-center gap-2 text-sm font-semibold px-3 py-1 rounded-full bg-blue-100 text-blue-700 border border-blue-300';
          typeBadge.innerHTML = `
            <span class="material-symbols-outlined text-base">format_quote</span>
            <span>Pregunta Literal</span>
            <span class="text-xs font-normal opacity-75">(datos del texto)</span>
          `;
        } else {
          typeBadge.className = 'mb-2 inline-flex items-center gap-2 text-sm font-semibold px-3 py-1 rounded-full bg-gray-100 text-gray-700 border border-gray-300';
          typeBadge.innerHTML = `
            <span class="material-symbols-outlined text-base">help_outline</span>
            <span>Pregunta Mixta</span>
          `;
        }
        typeBadge.style.display = 'inline-flex';
        
        // ‚úÖ Mostrar indicador de pregunta generada autom√°ticamente
        let generatedIndicator = document.getElementById('generated-indicator');
        if (!generatedIndicator) {
          generatedIndicator = document.createElement('div');
          generatedIndicator.id = 'generated-indicator';
          generatedIndicator.className = 'mt-2 flex items-center justify-between gap-2 text-sm bg-green-100 border border-green-300 rounded-lg px-3 py-2';
          textarea.parentNode.appendChild(generatedIndicator);
        }
        generatedIndicator.innerHTML = `
          <div class="flex items-center gap-2 text-green-700">
            <span class="material-symbols-outlined text-lg">auto_awesome</span>
            <span class="font-semibold">Pregunta generada autom√°ticamente</span>
          </div>
          <button onclick="unlockQuestionTextarea()" class="text-xs bg-white hover:bg-gray-100 text-gray-700 px-3 py-1 rounded border border-gray-300 transition">
            ‚úèÔ∏è Editar manualmente
          </button>
        `;
        generatedIndicator.style.display = 'flex';
        
        // ‚úÖ Mostrar notificaci√≥n visual
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
        notification.innerHTML = `
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined">check_circle</span>
            <span class="font-semibold">‚úÖ Pregunta generada - Ahora escribe tu respuesta</span>
          </div>
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
      } else {
        console.error('‚ùå No se encontr√≥ el textarea user-question');
      }
    }
    
  } catch (error) {
    console.error('Error generando preguntas:', error);
    alert(`‚ùå Error al generar preguntas:\n\n${error.message}`);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ‚úÖ FUNCI√ìN ELIMINADA: loadQuestionsFromGeneratedTable
// Las preguntas NO se guardan autom√°ticamente, solo se colocan en el textarea
// El usuario decide si las guarda con el bot√≥n "Guardar Pregunta"

// ‚úÖ CORRECCI√ìN PROFESOR: Funci√≥n para desbloquear textarea si el usuario quiere editar
window.unlockQuestionTextarea = function() {
  const textarea = document.getElementById('user-question');
  const generatedIndicator = document.getElementById('generated-indicator');
  const typeBadge = document.getElementById('question-type-badge');  // üëà NUEVO
  
  if (textarea) {
    // Desbloquear textarea
    textarea.readOnly = false;
    textarea.classList.remove('bg-green-50', 'border-green-300', 'cursor-not-allowed');
    textarea.classList.add('focus:border-blue-500');
    textarea.focus();
    
    // Marcar que ya no es pregunta generada
    window.questionWasGenerated = false;
    
    console.log('üîì Textarea desbloqueado para edici√≥n manual');
  }
  
  // Ocultar indicador de generaci√≥n
  if (generatedIndicator) {
    generatedIndicator.style.display = 'none';
  }
  
  // Ocultar badge de tipo de pregunta
  if (typeBadge) {
    typeBadge.style.display = 'none';
  }
  
  // Mostrar notificaci√≥n
  const notification = document.createElement('div');
  notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
  notification.innerHTML = `
    <div class="flex items-center gap-2">
      <span class="material-symbols-outlined">edit</span>
      <span class="font-semibold">‚úèÔ∏è Modo edici√≥n manual activado</span>
    </div>
  `;
  document.body.appendChild(notification);
  setTimeout(() => notification.remove(), 2000);
};

// Actualizar bot√≥n cuando cambie el material activo
document.addEventListener('DOMContentLoaded', () => {
  updateGenerateButton();
  
  // Observar cambios en localStorage
  window.addEventListener('storage', updateGenerateButton);
  
  // Tambi√©n actualizar al cargar un material
  const originalLoadMaterial = window.loadMaterialQuestions;
  if (originalLoadMaterial) {
    window.loadMaterialQuestions = async function(...args) {
      await originalLoadMaterial.apply(this, args);
      updateGenerateButton();
    };
  }
});
</script>

<!-- ==========================================
     INICIALIZAR COMPONENTES HEADER/FOOTER
     ========================================== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeHeaderFooter('practica');
});
</script>

</body></html>

