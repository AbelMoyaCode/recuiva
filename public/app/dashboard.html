
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin/>
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Recuiva - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/supabase-operations.js"></script>
    <script src="../assets/js/header-footer-components.js"></script>
    
    <style type="text/tailwindcss">
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      
      .recuiva-logo {
        font-family: Manrope, 'Noto Sans', sans-serif;
        font-size: 28px;
        font-weight: 800;
        letter-spacing: -0.5px;
      }
      
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      
      .metric-card {
        background: linear-gradient(135deg, var(--base-white) 0%, var(--base-gray) 100%);
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
      }
      
      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px rgba(0,0,0,0.1);
      }
      
      .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--primary-color);
        line-height: 1;
      }
      
      .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: 0.5rem;
      }
      
      .mobile-menu {
        transition: all 0.3s ease;
      }
    </style>
</head>

<body class="bg-[var(--base-gray)]" style='font-family: Manrope, "Noto Sans", sans-serif;'>
<div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
<!-- Header Container - Managed by header-footer-components.js -->
<div id="header-container"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- TÃ­tulo -->
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h2 class="text-3xl font-bold text-gray-900">Panel de Control</h2>
                <p class="text-gray-600 mt-2">Seguimiento de tu progreso y estadÃ­sticas</p>
            </div>
            <!-- BotÃ³n de recarga manual -->
            <button onclick="window.reloadDashboard()" 
                    class="flex items-center gap-2 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors shadow-sm">
                <span class="material-symbols-outlined">refresh</span>
                <span class="hidden sm:inline">Actualizar</span>
            </button>
        </div>

        <!-- MÃ©tricas Principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Materiales - NARANJA COMPLETO -->
            <div class="bg-orange-50 border-2 border-orange-200 rounded-2xl p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold text-orange-600 uppercase mb-1">Total Materiales</p>
                        <div class="text-5xl font-bold text-orange-600" id="total-materials">0</div>
                    </div>
                    <div class="bg-orange-200 p-3 rounded-lg">
                        <span class="material-symbols-outlined text-orange-700" style="font-size: 2.5rem;">folder</span>
                    </div>
                </div>
            </div>

            <!-- Total Preguntas - AZUL COMPLETO -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-2xl p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold text-blue-600 uppercase mb-1">Total Preguntas</p>
                        <div class="text-5xl font-bold text-blue-600" id="total-questions">0</div>
                    </div>
                    <div class="bg-blue-200 p-3 rounded-lg">
                        <span class="material-symbols-outlined text-blue-700" style="font-size: 2.5rem;">help</span>
                    </div>
                </div>
            </div>

            <!-- Score Promedio - VERDE COMPLETO -->
            <div class="bg-green-50 border-2 border-green-200 rounded-2xl p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold text-green-600 uppercase mb-1">Score Promedio</p>
                        <div class="text-5xl font-bold text-green-600" id="avg-score">0%</div>
                    </div>
                    <div class="bg-green-200 p-3 rounded-lg">
                        <span class="material-symbols-outlined text-green-700" style="font-size: 2.5rem;">bar_chart</span>
                    </div>
                </div>
            </div>

            <!-- Racha Actual - MORADO COMPLETO -->
            <div class="bg-purple-50 border-2 border-purple-200 rounded-2xl p-6 hover-lift">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold text-purple-600 uppercase mb-1">DÃ­as de Racha</p>
                        <div class="text-5xl font-bold text-purple-600" id="current-streak">0</div>
                    </div>
                    <div class="bg-purple-200 p-3 rounded-lg">
                        <span class="material-symbols-outlined text-purple-700" style="font-size: 2.5rem;">local_fire_department</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- GrÃ¡fica de EvoluciÃ³n -->
        <div class="bg-white rounded-2xl shadow-sm p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-900 mb-4">EvoluciÃ³n del Score</h3>
            <div class="relative" style="height: 300px;">
                <canvas id="score-chart"></canvas>
            </div>
        </div>

        <!-- Grid de Contenido -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Materiales Recientes -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Materiales Recientes</h3>
                    <button onclick="window.openMaterialsModal()" class="text-orange-600 hover:text-orange-700 font-semibold text-sm transition-colors cursor-pointer">
                        Ver todos â†’
                    </button>
                </div>
                <div id="recent-materials">
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                        <p class="text-sm">Cargando materiales...</p>
                    </div>
                </div>
            </div>

            <!-- Preguntas Recientes -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Preguntas Recientes</h3>
                    <button onclick="window.openQuestionsModal()" class="text-orange-600 hover:text-orange-700 font-semibold text-sm transition-colors cursor-pointer">
                        Ver todas â†’
                    </button>
                </div>
                <div id="recent-questions">
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                        <p class="text-sm">Cargando preguntas...</p>
                    </div>
                </div>
            </div>

            <!-- Temas DÃ©biles -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Temas para Reforzar</h3>
                    <span class="material-symbols-outlined text-orange-500">priority_high</span>
                </div>
                <div id="weak-topics">
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                        <p class="text-sm">Analizando temas...</p>
                    </div>
                </div>
            </div>

            <!-- Plan de Estudio -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Plan de Refuerzo</h3>
                    <span class="material-symbols-outlined text-blue-500">school</span>
                </div>
                <div id="study-plan">
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">hourglass_empty</span>
                        <p class="text-sm">Generando plan...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

<!-- Footer Container - Managed by header-footer-components.js -->
<div id="footer-container"></div>

<!-- ========================================== -->
<!-- MODALES -->
<!-- ========================================== -->

<!-- Modal: Ver Todos los Materiales -->
<div id="materials-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900">ğŸ“š Todos los Materiales</h2>
            <button onclick="window.closeMaterialsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>
        
        <!-- Content (scrollable) -->
        <div id="materials-modal-content" class="flex-1 overflow-y-auto p-6">
            <div class="text-center py-12 text-gray-400">
                <span class="material-symbols-outlined text-5xl mb-3">hourglass_empty</span>
                <p>Cargando materiales...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Ver Todas las Preguntas -->
<div id="questions-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[80vh] flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-gray-900">â“ Todas las Preguntas</h2>
            <button onclick="window.closeQuestionsModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <span class="material-symbols-outlined text-3xl">close</span>
            </button>
        </div>
        
        <!-- Content (scrollable) -->
        <div id="questions-modal-content" class="flex-1 overflow-y-auto p-6">
            <div class="text-center py-12 text-gray-400">
                <span class="material-symbols-outlined text-5xl mb-3">hourglass_empty</span>
                <p>Cargando preguntas...</p>
            </div>
        </div>
    </div>
</div>

</div>

    <script>
        // ConfiguraciÃ³n de API
    const API_URL = API_CONFIG.BASE_URL;

        // ==========================================
        // FUNCIÃ“N PRINCIPAL DE INICIALIZACIÃ“N
        // ==========================================
        async function initDashboard() {
            console.log('ğŸ“Š INICIALIZANDO DASHBOARD');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            try {
                // ğŸ”¥ CARGAR DATOS DESDE SUPABASE
                console.log('ğŸ” Cargando datos desde Supabase...');
                
                // Obtener materiales
                const materials = await SupabaseOperations.getMaterials();
                console.log(`ğŸ“¦ Materiales encontrados: ${materials.length}`);
                
                // âœ… USAR LA FUNCIÃ“N getAllQuestions() QUE YA NORMALIZA TODO CORRECTAMENTE
                const allQuestions = await getAllQuestions();
                
                console.log(`ğŸ“‹ Preguntas totales encontradas: ${allQuestions.length}`);
                
                if (allQuestions.length === 0) {
                    console.warn('âš ï¸ No hay preguntas guardadas en Supabase');
                    console.log('ğŸ’¡ Para ver datos en el dashboard:');
                    console.log('   1. Ve a SesiÃ³n PrÃ¡ctica');
                    console.log('   2. Crea y valida algunas preguntas');
                    console.log('   3. Vuelve al dashboard para ver las mÃ©tricas');
                }
                
                // Renderizar todos los componentes
                console.log('\nğŸ¨ Renderizando componentes del dashboard...');
                renderMetrics(allQuestions, materials);
                renderScoreChart(allQuestions);
                renderRecentMaterials(materials);
                renderRecentQuestions(allQuestions);
                renderWeakTopics(allQuestions, materials);
                renderStudyPlan(allQuestions, materials);
                
                console.log('\nâœ… DASHBOARD CARGADO CORRECTAMENTE DESDE SUPABASE');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            } catch (error) {
                console.error('âŒ Error al cargar dashboard:', error);
                alert('Error al cargar datos del dashboard');
            }
        }

        // ==========================================
        // OBTENER PREGUNTAS DE TODOS LOS MATERIALES (DESDE SUPABASE)
        // ==========================================
        async function getAllQuestions() {
            console.log('ğŸ” CARGANDO PREGUNTAS DESDE SUPABASE...');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            
            // ğŸ“¦ PASO 1: CARGAR TODOS LOS MATERIALES DEL USUARIO DESDE SUPABASE
            console.log('ğŸ“¦ Cargando materiales desde Supabase...');
            const materials = await SupabaseOperations.getMaterials();
            
            if (!materials || materials.length === 0) {
                console.warn('  âš ï¸ NO HAY MATERIALES en Supabase');
                console.log('  ğŸ’¡ Sube materiales primero');
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                return [];
            }
            
            console.log(`  âœ“ ${materials.length} material(es) encontrado(s)`);
            
            // ğŸ“ PASO 2: CARGAR PREGUNTAS Y RESPUESTAS DE TODOS LOS MATERIALES DESDE SUPABASE
            let allQuestions = [];
            const seenQuestions = new Set();
            
            try {
                for (const material of materials) {
                    console.log(`\nğŸ“ Cargando preguntas del material: ${material.title}`);
                    
                    // Cargar preguntas del material desde Supabase
                    const questions = await SupabaseOperations.getQuestionsByMaterial(material.id);
                    
                    if (!questions || questions.length === 0) {
                        console.log(`  âš ï¸ Sin preguntas para ${material.title}`);
                        continue; // Continuar con el siguiente material
                    }
                    
                    console.log(`  âœ“ ${questions.length} pregunta(s) encontradas`);
                    
                    // Para cada pregunta, obtener su Ãºltima respuesta
                    for (const question of questions) {
                        console.log(`      ğŸ” Pregunta obtenida (RAW):`, JSON.stringify(question, null, 2));
                        console.log(`      ğŸ” Pregunta obtenida (OBJECT):`, question);
                        const answers = await SupabaseOperations.getAnswersByQuestion(question.id);
                        console.log(`      ğŸ“ Respuestas obtenidas (${answers.length}):`, answers);
                        
                        if (answers && answers.length > 0) {
                            const lastAnswer = answers[0]; // La mÃ¡s reciente
                            console.log(`      âœ… Ãšltima respuesta:`, lastAnswer);
                            
                            // Normalizar score
                            let score = parseFloat(lastAnswer.score) || 0;
                            if (score > 100) score = 100;
                            if (score < 0) score = 0;
                            
                            // Crear objeto normalizado para el dashboard
                            const normalizedQ = {
                                id: question.id,
                                pregunta: question.question_text,
                                respuesta: lastAnswer.answer_text,
                                score: Math.round(score),
                                classification: lastAnswer.classification,
                                feedback: lastAnswer.feedback,
                                similarity: lastAnswer.similarity,
                                timestamp: new Date(question.created_at).getTime(),
                                material_id: material.id,
                                material_title: material.title
                            };
                            
                            console.log(`      ğŸ“Š Pregunta normalizada:`, normalizedQ);
                            console.log(`      ğŸ” VALORES CRÃTICOS:`);
                            console.log(`         â€¢ question.question_text = "${question.question_text}"`);
                            console.log(`         â€¢ lastAnswer.answer_text = "${lastAnswer.answer_text}"`);
                            console.log(`         â€¢ normalizedQ.pregunta = "${normalizedQ.pregunta}"`);
                            console.log(`         â€¢ normalizedQ.respuesta = "${normalizedQ.respuesta}"`);
                            
                            // Detectar duplicados
                            const questionText = question.question_text.toLowerCase().trim();
                            const uniqueId = `${questionText}_${material.id}`;
                            
                            if (!seenQuestions.has(uniqueId)) {
                                seenQuestions.add(uniqueId);
                                allQuestions.push(normalizedQ);
                            }
                        }
                    }
                }
                
                console.log(`\nğŸ“Š RESULTADO FINAL:`);
                console.log(`  â€¢ Total ÃšNICO: ${allQuestions.length} pregunta(s)`);
                if (allQuestions.length > 0) {
                    console.log(`  â€¢ Scores: [${allQuestions.map(q => q.score + '%').join(', ')}]`);
                }
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                
            } catch (e) {
                console.error(`âŒ Error al cargar preguntas desde Supabase:`, e);
                console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                return [];
            }
            
            return allQuestions;
        }

        // ==========================================
        // OBTENER MATERIALES DEL BACKEND (ROBUSTO)
        // ==========================================
        async function getMaterials() {
            try {
                console.log('ğŸŒ Solicitando materiales del backend...');
                const response = await fetch(`${API_URL}/api/materials`);
                
                if (!response.ok) {
                    console.warn(`âš ï¸ Backend respondiÃ³ con status ${response.status}`);
                    return [];
                }
                
                const data = await response.json();
                console.log('ğŸ“¦ Respuesta del backend:', data);
                
                // Asegurarse de que retornamos un array
                let materialsArray = [];
                
                if (Array.isArray(data)) {
                    materialsArray = data;
                    console.log(`âœ“ Backend devolviÃ³ array directo con ${data.length} materiales`);
                } else if (data && Array.isArray(data.materials)) {
                    materialsArray = data.materials;
                    console.log(`âœ“ Backend devolviÃ³ objeto con propiedad 'materials': ${data.materials.length} materiales`);
                } else if (data && typeof data === 'object') {
                    // Si es un objeto, intentar extraer el array
                    const keys = Object.keys(data);
                    console.log('ğŸ” Backend devolviÃ³ objeto con keys:', keys);
                    
                    if (keys.length > 0 && Array.isArray(data[keys[0]])) {
                        materialsArray = data[keys[0]];
                        console.log(`âœ“ Extrayendo array de key '${keys[0]}': ${materialsArray.length} materiales`);
                    }
                }
                
                if (materialsArray.length === 0) {
                    console.warn('âš ï¸ Backend no devolviÃ³ materiales:', data);
                } else {
                    console.log('ğŸ“š Materiales cargados:');
                    materialsArray.forEach((m, i) => {
                        console.log(`  ${i + 1}. ${m.title || m.file_name || m.filename || m.name || 'Sin nombre'} (ID: ${m.id})`);
                    });
                }
                
                return materialsArray;
                
            } catch (error) {
                console.error('âŒ Error al cargar materiales:', error);
                console.log(`ğŸ’¡ Verifica que el backend estÃ© corriendo en ${API_CONFIG.BASE_URL}`);
                return [];
            }
        }

        // ==========================================
        // RENDERIZAR MÃ‰TRICAS PRINCIPALES
        // ==========================================
        function renderMetrics(questions, materials) {
            console.log('ğŸ“Š Renderizando mÃ©tricas...');
            
            // Validar que materials sea un array
            if (!Array.isArray(materials)) {
                materials = [];
            }
            
            // Total de materiales
            const totalMaterials = materials.length;
            document.getElementById('total-materials').textContent = totalMaterials;
            console.log(`  ğŸŸ  Total Materiales: ${totalMaterials}`);
            
            // Total de preguntas (SOLO LAS QUE EXISTEN)
            const totalQuestions = questions.length;
            document.getElementById('total-questions').textContent = totalQuestions;
            console.log(`  ğŸ”µ Total Preguntas REALES: ${totalQuestions}`);
            
            // Score promedio (BASADO EN PREGUNTAS EXISTENTES)
            if (totalQuestions > 0) {
                const scores = questions.map(q => q.score || 0).filter(s => s >= 0 && s <= 100);
                console.log(`  ğŸ“ˆ Scores vÃ¡lidos encontrados:`, scores);
                
                if (scores.length > 0) {
                    const totalScore = scores.reduce((sum, score) => sum + score, 0);
                    const avgScore = Math.round(totalScore / scores.length);
                    
                    document.getElementById('avg-score').textContent = `${avgScore}%`;
                    console.log(`  ğŸŸ¢ Score Promedio REAL: ${avgScore}% (${scores.length} preguntas)`);
                } else {
                    document.getElementById('avg-score').textContent = '0%';
                    console.log(`  ğŸŸ¢ Score Promedio: 0% (sin scores vÃ¡lidos)`);
                }
            } else {
                document.getElementById('avg-score').textContent = '0%';
                console.log(`  ğŸŸ¢ Score Promedio: 0% (NO HAY PREGUNTAS)`);
            }
            
            // Racha actual (calcular dÃ­as consecutivos)
            const streak = calculateStreak(questions);
            document.getElementById('current-streak').textContent = streak;
            console.log(`  ğŸŸ£ DÃ­as de Racha: ${streak}`);
        }

        // ==========================================
        // CALCULAR RACHA DE DÃAS CONSECUTIVOS
        // ==========================================
        function calculateStreak(questions) {
            if (questions.length === 0) return 0;
            
            // Ordenar preguntas por fecha (mÃ¡s reciente primero)
            const sortedQuestions = [...questions].sort((a, b) => {
                const dateA = new Date(a.timestamp || a.createdAt || 0);
                const dateB = new Date(b.timestamp || b.createdAt || 0);
                return dateB - dateA;
            });
            
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            let currentDate = new Date(today);
            
            for (const question of sortedQuestions) {
                const questionDate = new Date(question.timestamp || question.createdAt || 0);
                questionDate.setHours(0, 0, 0, 0);
                
                if (questionDate.getTime() === currentDate.getTime()) {
                    if (streak === 0) streak = 1;
                } else if (questionDate.getTime() === currentDate.getTime() - 86400000) {
                    // DÃ­a anterior
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // ==========================================
        // RENDERIZAR GRÃFICA DE EVOLUCIÃ“N - COMPLETA Y DINÃMICA
        // ==========================================
        let scoreChartInstance = null; // Variable global para almacenar la instancia
        
        function renderScoreChart(questions) {
            try {
                const ctx = document.getElementById('score-chart');
                
                if (!ctx) {
                    console.error('âŒ No se encontrÃ³ el canvas score-chart');
                    return;
                }
                
                const context = ctx.getContext('2d');
                
                // âœ… PASO 1: Destruir grÃ¡fica anterior si existe (para actualizaciÃ³n dinÃ¡mica)
                if (scoreChartInstance) {
                    scoreChartInstance.destroy();
                    console.log('ğŸ—‘ï¸ GrÃ¡fica anterior destruida');
                }
                
                // âœ… PASO 2: Preparar datos de los Ãºltimos 7 dÃ­as
                console.log('\nğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('ğŸ“Š GENERANDO GRÃFICA DE EVOLUCIÃ“N');
                console.log('ğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                const last7Days = [];
                const last7DaysFormatted = [];
                const scoresByDay = {};
                const questionCountByDay = {};
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    date.setHours(0, 0, 0, 0);
                    
                    // Formato corto para la grÃ¡fica (ej: "14 oct")
                    const dateStr = date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    
                    // Formato completo para logs
                    const fullDateStr = date.toLocaleDateString('es-ES', { 
                        weekday: 'short', 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    
                    last7Days.push(dateStr);
                    last7DaysFormatted.push(fullDateStr);
                    scoresByDay[dateStr] = [];
                    questionCountByDay[dateStr] = 0;
                }
                
                console.log('ğŸ“… PerÃ­odo: Ãºltimos 7 dÃ­as');
                console.log(`   ${last7DaysFormatted[0]} â†’ ${last7DaysFormatted[6]}`);
                
                // âœ… PASO 3: Agrupar preguntas por dÃ­a (con timestamp actual)
                console.log('\nğŸ“ DistribuciÃ³n de preguntas por dÃ­a:');
                
                questions.forEach(q => {
                    // Usar timestamp actual (fecha y hora de creaciÃ³n)
                    const questionDate = new Date(q.timestamp || q.createdAt || Date.now());
                    questionDate.setHours(0, 0, 0, 0);
                    const dateStr = questionDate.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    
                    if (scoresByDay[dateStr] !== undefined) {
                        scoresByDay[dateStr].push(q.score || 0);
                        questionCountByDay[dateStr]++;
                    }
                });
                
                // Log detallado por dÃ­a
                last7Days.forEach((day, idx) => {
                    const count = questionCountByDay[day];
                    const scores = scoresByDay[day];
                    
                    if (count > 0) {
                        const avg = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                        console.log(`   ${last7DaysFormatted[idx]}: ${count} pregunta(s) â†’ Scores: [${scores.join(', ')}] â†’ Promedio: ${avg}%`);
                    } else {
                        console.log(`   ${last7DaysFormatted[idx]}: Sin preguntas`);
                    }
                });
                
                // âœ… PASO 4: Calcular promedio por dÃ­a
                const avgScores = last7Days.map(day => {
                    const scores = scoresByDay[day];
                    if (scores.length === 0) return null;
                    return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                });
                
                console.log('\nğŸ“ˆ Datos para grÃ¡fica:', avgScores);
                
                // âœ… PASO 5: Analizar tendencia (subida, bajada, lineal)
                const validScores = avgScores.filter(s => s !== null);
                let tendencia = 'Sin datos';
                let tendenciaIcon = 'ğŸ“Š';
                let tendenciaColor = '#6B7280';
                
                if (validScores.length >= 2) {
                    const firstScore = validScores[0];
                    const lastScore = validScores[validScores.length - 1];
                    const diff = lastScore - firstScore;
                    
                    if (diff > 5) {
                        tendencia = `ğŸ“ˆ SUBIDA (+${diff}%)`;
                        tendenciaIcon = 'ğŸ“ˆ';
                        tendenciaColor = '#10B981'; // Verde
                    } else if (diff < -5) {
                        tendencia = `ğŸ“‰ BAJADA (${diff}%)`;
                        tendenciaIcon = 'ğŸ“‰';
                        tendenciaColor = '#EF4444'; // Rojo
                    } else {
                        tendencia = `ğŸ“Š ESTABLE (${diff >= 0 ? '+' : ''}${diff}%)`;
                        tendenciaIcon = 'ğŸ“Š';
                        tendenciaColor = '#3B82F6'; // Azul
                    }
                    
                    console.log(`\n${tendencia}`);
                    console.log(`   Primer valor: ${firstScore}% â†’ Ãšltimo valor: ${lastScore}%`);
                }
                
                // âœ… PASO 6: Crear grÃ¡fica con animaciones y colores dinÃ¡micos
                scoreChartInstance = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: last7Days,
                        datasets: [{
                            label: 'Score Promedio Diario',
                            data: avgScores,
                            
                            // ğŸ¨ ESTILOS VISUALES
                            borderColor: '#FF6600',                    // LÃ­nea naranja
                            backgroundColor: 'rgba(255, 102, 0, 0.15)', // Ãrea sombreada
                            borderWidth: 3,                            // LÃ­nea gruesa
                            
                            // ğŸ“ PUNTOS
                            pointRadius: 6,                            // Puntos visibles
                            pointHoverRadius: 10,                      // MÃ¡s grandes al hover
                            pointBackgroundColor: '#FF6600',           // Puntos naranjas
                            pointBorderColor: '#fff',                  // Borde blanco
                            pointBorderWidth: 3,                       // Borde grueso
                            pointHoverBackgroundColor: '#FF8C00',      // Naranja mÃ¡s claro al hover
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 4,
                            
                            // ğŸ¯ LÃNEA Y RELLENO
                            tension: 0.3,                              // Curva suave (no muy curva)
                            fill: true,                                // Ãrea bajo la curva
                            spanGaps: true,                            // Conectar puntos saltando dÃ­as vacÃ­os
                            
                            // ğŸ“Š SEGMENTOS (para mostrar subidas/bajadas con colores)
                            segment: {
                                borderColor: ctx => {
                                    const prev = ctx.p0.parsed.y;
                                    const curr = ctx.p1.parsed.y;
                                    
                                    if (prev === null || curr === null) return '#FF6600';
                                    
                                    if (curr > prev) return '#10B981';  // Verde (subida)
                                    if (curr < prev) return '#EF4444';  // Rojo (bajada)
                                    return '#3B82F6';                   // Azul (igual)
                                },
                                borderWidth: ctx => {
                                    const prev = ctx.p0.parsed.y;
                                    const curr = ctx.p1.parsed.y;
                                    return (prev !== null && curr !== null) ? 4 : 3;
                                }
                            }
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        
                        // ğŸ¬ ANIMACIONES
                        animation: {
                            duration: 1000,
                            easing: 'easeInOutQuart'
                        },
                        
                        plugins: {
                            legend: {
                                display: false
                            },
                            
                            // ğŸ’¬ TOOLTIP MEJORADO
                            tooltip: {
                                enabled: true,
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                padding: 16,
                                cornerRadius: 12,
                                titleFont: {
                                    size: 15,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 14
                                },
                                displayColors: false,
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        if (context.parsed.y === null) {
                                            return 'ğŸ“­ Sin preguntas este dÃ­a';
                                        }
                                        
                                        const day = context.label;
                                        const count = questionCountByDay[day] || 0;
                                        const score = context.parsed.y;
                                        
                                        return [
                                            `ğŸ“Š Score: ${score}%`,
                                            `ğŸ“ Preguntas: ${count}`,
                                            `ğŸ“ˆ Promedio del dÃ­a`
                                        ];
                                    },
                                    afterLabel: function(context) {
                                        if (context.parsed.y === null) return '';
                                        
                                        const score = context.parsed.y;
                                        if (score >= 85) return '\nâœ¨ Â¡Excelente dominio!';
                                        if (score >= 70) return '\nğŸ‘ Buen nivel';
                                        if (score >= 50) return '\nğŸ“š Sigue practicando';
                                        return '\nâš ï¸ Necesita refuerzo';
                                    }
                                }
                            }
                        },
                        
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    },
                                    font: {
                                        size: 13,
                                        weight: '500'
                                    },
                                    color: '#6B7280',
                                    stepSize: 20
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.06)',
                                    lineWidth: 1
                                },
                                border: {
                                    display: false
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    },
                                    color: '#374151',
                                    maxRotation: 0,
                                    autoSkip: false
                                },
                                grid: {
                                    display: false
                                },
                                border: {
                                    display: false
                                }
                            }
                        },
                        
                        // ğŸ–±ï¸ INTERACCIÃ“N
                        interaction: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                });
                
                // âœ… PASO 7: Resumen final
                const hasData = avgScores.some(score => score !== null);
                const totalDaysWithData = avgScores.filter(s => s !== null).length;
                
                console.log('\nğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                console.log('âœ… GRÃFICA RENDERIZADA EXITOSAMENTE');
                console.log('ğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                if (hasData) {
                    console.log(`âœ“ DÃ­as con datos: ${totalDaysWithData} de 7`);
                    console.log(`âœ“ Tendencia: ${tendencia}`);
                    console.log(`âœ“ Puntos visibles en grÃ¡fica: ${totalDaysWithData}`);
                    console.log('âœ“ Colores de lÃ­neas:');
                    console.log('  ğŸ“ˆ Verde = Subida entre dÃ­as');
                    console.log('  ğŸ“‰ Rojo = Bajada entre dÃ­as');
                    console.log('  ğŸ“Š Azul = Igual score entre dÃ­as');
                } else {
                    console.log('âš ï¸ GrÃ¡fica SIN DATOS (Ãºltimos 7 dÃ­as vacÃ­os)');
                    console.log('ğŸ’¡ Acciones:');
                    console.log('  1. Ve a SesiÃ³n PrÃ¡ctica');
                    console.log('  2. Crea y valida preguntas');
                    console.log('  3. Vuelve aquÃ­ y clickea "Actualizar"');
                    console.log('  4. VerÃ¡s puntos naranjas en la grÃ¡fica');
                }
                
                console.log('ğŸ“Š â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
                
            } catch (error) {
                console.error('âŒ Error al renderizar grÃ¡fica:', error);
                const container = document.getElementById('score-chart')?.parentElement;
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-400">
                            <span class="material-symbols-outlined text-4xl mb-2">error</span>
                            <p class="text-sm">Error al cargar grÃ¡fica</p>
                            <p class="text-xs mt-2">${error.message}</p>
                        </div>
                    `;
                }
            }
        }

        // ==========================================
        // RENDERIZAR MATERIALES RECIENTES
        // ==========================================
        function renderRecentMaterials(materials) {
            const container = document.getElementById('recent-materials');
            
            console.log('ğŸ“š Renderizando materiales recientes...');
            console.log('  Materiales recibidos:', materials);
            
            // Verificar que materials sea un array vÃ¡lido
            if (!materials || !Array.isArray(materials) || materials.length === 0) {
                console.warn('  âš ï¸ No hay materiales para mostrar');
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">folder_off</span>
                        <p class="text-sm">No hay materiales</p>
                        <a href="subir-material.html" class="mt-3 inline-block text-sm font-semibold text-orange-600 hover:text-orange-700">
                            Subir material â†’
                        </a>
                    </div>
                `;
                return;
            }

            const recent = materials.slice(0, 5);
            console.log(`  âœ“ Mostrando ${recent.length} materiales mÃ¡s recientes`);
            
            recent.forEach((m, i) => {
                console.log(`    ${i + 1}. ${m.title || m.file_name || m.filename || m.name || 'Sin nombre'} (ID: ${m.id})`);
            });
            
            container.innerHTML = recent.map(material => {
                const materialName = material.title || material.file_name || material.filename || material.name || 'Material sin nombre';
                const uploadDate = material.created_at || material.createdAt || material.uploaded_at || material.uploadedAt || Date.now();
                
                return `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center">
                            <span class="material-symbols-outlined text-orange-600">description</span>
                        </div>
                        <div>
                            <p class="font-semibold text-gray-900 text-sm">${materialName}</p>
                            <p class="text-xs text-gray-500">${new Date(uploadDate).toLocaleDateString('es-ES')}</p>
                        </div>
                    </div>
                    <a href="sesion-practica.html?material=${material.id}" class="text-orange-600 hover:text-orange-700">
                        <span class="material-symbols-outlined">arrow_forward</span>
                    </a>
                </div>
                `;
            }).join('');
            
            console.log('  âœ… Materiales renderizados correctamente');
        }

        // ==========================================
        // RENDERIZAR PREGUNTAS RECIENTES
        // ==========================================
        function renderRecentQuestions(questions) {
            const container = document.getElementById('recent-questions');
            
            console.log('â“ Renderizando preguntas recientes...');
            
            if (!Array.isArray(questions) || questions.length === 0) {
                console.warn('  âš ï¸ No hay preguntas para mostrar');
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">quiz</span>
                        <p class="text-sm">No hay preguntas</p>
                        <a href="sesion-practica.html" class="mt-3 inline-block text-sm font-semibold text-orange-600 hover:text-orange-700">
                            Crear preguntas â†’
                        </a>
                    </div>
                `;
                return;
            }

            const recent = [...questions]
                .sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.createdAt || 0);
                    const dateB = new Date(b.timestamp || b.createdAt || 0);
                    return dateB - dateA;
                })
                .slice(0, 10);
            
            console.log(`  âœ“ Mostrando ${recent.length} preguntas mÃ¡s recientes`);
            recent.forEach((q, i) => {
                const questionText = q.pregunta || q.question || q.userQuestion || 'Sin pregunta';
                console.log(`    ${i + 1}. "${questionText.substring(0, 50)}..." - Score: ${q.score}%`);
            });
            
            container.innerHTML = recent.map(q => {
                const score = Math.round(q.score || 0);
                const scoreColor = score >= 70 ? 'text-green-600 bg-green-100' : 
                                   score >= 50 ? 'text-yellow-600 bg-yellow-100' : 
                                   'text-red-600 bg-red-100';
                
                // âœ… PRIORIZAR PROPIEDADES EN ESPAÃ‘OL (pregunta, respuesta)
                const questionText = q.pregunta || q.question || q.userQuestion || q.text || 'Sin pregunta';
                const answerText = q.respuesta || q.answer || q.userAnswer || q.response || 'Sin respuesta';
                
                console.log(`    - Pregunta: "${questionText.substring(0, 30)}..." | Respuesta: "${answerText.substring(0, 30)}..."`);
                
                return `
                    <div class="py-3 border-b border-gray-100 last:border-0">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900 text-sm mb-1">${questionText}</p>
                                <p class="text-xs text-gray-500 line-clamp-2">${answerText}</p>
                            </div>
                            <div class="ml-3">
                                <span class="${scoreColor} px-2 py-1 rounded-full text-xs font-bold">
                                    ${score}%
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('  âœ… Preguntas renderizadas correctamente');
        }

        // ==========================================
        // RENDERIZAR TEMAS DÃ‰BILES
        // ==========================================
        function renderWeakTopics(questions, materials) {
            const container = document.getElementById('weak-topics');
            
            // Validar que materials sea un array
            if (!Array.isArray(materials)) {
                materials = [];
            }
            
            if (!Array.isArray(questions) || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">sentiment_satisfied</span>
                        <p class="text-sm">Sin datos suficientes</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar preguntas por material y calcular promedio
            const scoresByMaterial = {};
            
            questions.forEach(q => {
                const materialId = q.materialId || 'unknown';
                if (!scoresByMaterial[materialId]) {
                    scoresByMaterial[materialId] = [];
                }
                scoresByMaterial[materialId].push(q.score || 0);
            });
            
            // Calcular promedios y filtrar los que estÃ©n por debajo de 60%
            const weakTopics = Object.entries(scoresByMaterial)
                .map(([materialId, scores]) => {
                    const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                    const material = materials.find(m => m.id == materialId);
                    return {
                        materialId,
                        name: material?.name || `Material ${materialId}`,
                        avgScore: Math.round(avg),
                        questionCount: scores.length
                    };
                })
                .filter(topic => topic.avgScore < 60)
                .sort((a, b) => a.avgScore - b.avgScore)
                .slice(0, 5);
            
            if (weakTopics.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-green-400">
                        <span class="material-symbols-outlined text-4xl mb-2">check_circle</span>
                        <p class="text-sm font-semibold text-gray-700">Â¡Excelente!</p>
                        <p class="text-xs text-gray-500">No hay temas dÃ©biles</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = weakTopics.map(topic => `
                <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900 text-sm">${topic.name}</p>
                        <p class="text-xs text-gray-500">${topic.questionCount} preguntas</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-red-600 bg-red-100 px-2 py-1 rounded-full text-xs font-bold">
                            ${topic.avgScore}%
                        </span>
                        <a href="sesion-practica.html?material=${topic.materialId}" class="text-orange-600 hover:text-orange-700">
                            <span class="material-symbols-outlined text-sm">refresh</span>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // RENDERIZAR PLAN DE ESTUDIO
        // ==========================================
        function renderStudyPlan(questions, materials) {
            const container = document.getElementById('study-plan');
            
            // Validar que materials sea un array
            if (!Array.isArray(materials)) {
                materials = [];
            }
            
            if (!Array.isArray(questions) || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <span class="material-symbols-outlined text-4xl mb-2">pending_actions</span>
                        <p class="text-sm">Comienza a estudiar para generar un plan</p>
                    </div>
                `;
                return;
            }
            
            // âœ¨ CÃLCULO CON REGLAS DE VALIDACIÃ“N SEMÃNTICA RAG
            // Score â‰¥ 85% = Excelente (â‰¥0.85 en RAG)
            // Score 70-84% = Buena (0.70-0.84 en RAG)
            // Score 50-69% = Regular (0.50-0.69 en RAG)
            // Score < 50% = Malo (< 0.50 en RAG)
            
            const distribution = {
                excelente: questions.filter(q => (q.score || 0) >= 85).length,
                buena: questions.filter(q => (q.score || 0) >= 70 && (q.score || 0) < 85).length,
                regular: questions.filter(q => (q.score || 0) >= 50 && (q.score || 0) < 70).length,
                malo: questions.filter(q => (q.score || 0) < 50).length
            };
            
            const avgScore = Math.round(questions.reduce((sum, q) => sum + (q.score || 0), 0) / questions.length);
            
            console.log(`ğŸ“Š DistribuciÃ³n RAG:`, distribution);
            console.log(`ğŸ“Š Score Promedio: ${avgScore}%`);
            
            // Generar recomendaciones basadas en mÃ©tricas RAG
            let recommendations = [];
            
            if (distribution.malo > 0) {
                recommendations.push({
                    icon: 'priority_high',
                    color: 'text-red-600 bg-red-100',
                    title: 'Requiere estudio adicional',
                    description: `${distribution.malo} pregunta(s) con score < 50%. Dedica 30-45 min diarios a reforzar estos temas.`
                });
            }
            
            if (distribution.regular > 0) {
                recommendations.push({
                    icon: 'trending_up',
                    color: 'text-yellow-600 bg-yellow-100',
                    title: 'Conceptos en desarrollo',
                    description: `${distribution.regular} pregunta(s) en nivel regular (50-69%). PrÃ¡ctica adicional recomendada.`
                });
            }
            
            if (distribution.buena > 0) {
                recommendations.push({
                    icon: 'check_circle',
                    color: 'text-blue-600 bg-blue-100',
                    title: 'Buen dominio',
                    description: `${distribution.buena} pregunta(s) con buena comprensiÃ³n (70-84%). Â¡Sigue asÃ­!`
                });
            }
            
            if (distribution.excelente > 0) {
                recommendations.push({
                    icon: 'celebration',
                    color: 'text-green-600 bg-green-100',
                    title: 'Â¡Excelente dominio!',
                    description: `${distribution.excelente} pregunta(s) con score â‰¥85%. Dominio sobresaliente del material.`
                });
            }
            
            // RecomendaciÃ³n general basada en promedio
            if (avgScore >= 85) {
                recommendations.unshift({
                    icon: 'stars',
                    color: 'text-purple-600 bg-purple-100',
                    title: 'Â¡Rendimiento Excelente!',
                    description: `Score promedio: ${avgScore}%. MantÃ©n este nivel y continÃºa con nuevo material.`
                });
            } else if (avgScore < 70) {
                recommendations.unshift({
                    icon: 'school',
                    color: 'text-orange-600 bg-orange-100',
                    title: 'Necesitas reforzar',
                    description: `Score promedio: ${avgScore}%. Revisa el material y practica mÃ¡s preguntas.`
                });
            }
            
            if (recommendations.length === 0) {
                recommendations.push({
                    icon: 'lightbulb',
                    color: 'text-blue-600 bg-blue-100',
                    title: 'ContinÃºa estudiando',
                    description: 'Sigue creando preguntas para generar un plan personalizado.'
                });
            }
            
            container.innerHTML = recommendations.map(rec => `
                <div class="flex items-start space-x-3 py-3 border-b border-gray-100 last:border-0">
                    <div class="${rec.color} w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0">
                        <span class="material-symbols-outlined">${rec.icon}</span>
                    </div>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-900 text-sm">${rec.title}</p>
                        <p class="text-xs text-gray-600 mt-1">${rec.description}</p>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // INICIALIZAR AL CARGAR LA PÃGINA
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar componentes de header y footer
            initializeHeaderFooter('dashboard');
            // Inicializar dashboard
            initDashboard();
        });
        
        // ==========================================
        // AUTO-ACTUALIZACIÃ“N: Detectar cambios en localStorage
        // ==========================================
        window.addEventListener('storage', function(e) {
            // Se dispara cuando OTRA pestaÃ±a modifica localStorage
            if (e.key && (e.key.startsWith('recuiva_questions_material_') || e.key === 'active_material_id')) {
                console.log('ğŸ”„ Cambios detectados en localStorage desde otra pestaÃ±a');
                console.log(`   Key modificada: ${e.key}`);
                console.log(`   Valor anterior: ${e.oldValue?.substring(0, 50)}...`);
                console.log(`   Valor nuevo: ${e.newValue?.substring(0, 50)}...`);
                
                // Recargar dashboard automÃ¡ticamente
                console.log('â™»ï¸ Recargando Dashboard...');
                initDashboard();
            }
        });
        
        // ==========================================
        // RECARGAR MANUAL: BotÃ³n para forzar actualizaciÃ³n
        // ==========================================
        window.reloadDashboard = function() {
            console.log('ğŸ”„ Recarga manual del Dashboard solicitada');
            initDashboard();
        };
        
        // ==========================================
        // MODALES: Ver Todos los Materiales/Preguntas
        // ==========================================
        
        // Abrir modal de materiales
        window.openMaterialsModal = async function() {
            const modal = document.getElementById('materials-modal');
            const content = document.getElementById('materials-modal-content');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Cargar materiales
            const materials = await getMaterials();
            
            if (!materials || materials.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">folder_off</span>
                        <p class="text-gray-500 text-lg font-semibold mb-2">No hay materiales</p>
                        <p class="text-gray-400 text-sm mb-4">Sube tu primer material para comenzar</p>
                        <a href="subir-material.html" class="inline-block px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors">
                            Subir Material
                        </a>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <div class="space-y-3">
                    ${materials.map(material => {
                        const materialName = material.title || material.file_name || material.filename || material.name || 'Material sin nombre';
                        const uploadDate = material.created_at || material.createdAt || material.uploaded_at || material.uploadedAt || Date.now();
                        const totalChunks = material.total_chunks || material.totalChunks || 0;
                        const totalPages = material.real_pages || material.realPages || material.estimated_pages || 0;
                        
                        return `
                        <div class="flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors border border-gray-200">
                            <div class="flex items-center space-x-4 flex-1">
                                <div class="w-12 h-12 rounded-lg bg-orange-100 flex items-center justify-center flex-shrink-0">
                                    <span class="material-symbols-outlined text-orange-600 text-2xl">description</span>
                                </div>
                                <div class="flex-1">
                                    <p class="font-bold text-gray-900 text-base mb-1">${materialName}</p>
                                    <div class="flex items-center gap-3 text-xs text-gray-500">
                                        <span>ğŸ“… ${new Date(uploadDate).toLocaleDateString('es-ES')}</span>
                                        <span>ğŸ“„ ${totalPages} pÃ¡ginas</span>
                                        <span>ğŸ“¦ ${totalChunks} chunks</span>
                                    </div>
                                </div>
                            </div>
                            <a href="sesion-practica.html?material=${material.id}" 
                               class="ml-4 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold text-sm transition-colors flex items-center gap-2">
                                <span>Practicar</span>
                                <span class="material-symbols-outlined text-lg">arrow_forward</span>
                            </a>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        };
        
        // Cerrar modal de materiales
        window.closeMaterialsModal = function() {
            const modal = document.getElementById('materials-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
        
        // Abrir modal de preguntas
        window.openQuestionsModal = async function() {
            const modal = document.getElementById('questions-modal');
            const content = document.getElementById('questions-modal-content');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Cargar todas las preguntas
            const questions = await getAllQuestions();
            
            if (!questions || questions.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">quiz</span>
                        <p class="text-gray-500 text-lg font-semibold mb-2">No hay preguntas</p>
                        <p class="text-gray-400 text-sm mb-4">Crea preguntas en SesiÃ³n PrÃ¡ctica para verlas aquÃ­</p>
                        <a href="sesion-practica.html" class="inline-block px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors">
                            Ir a PrÃ¡ctica
                        </a>
                    </div>
                `;
                return;
            }
            
            // Ordenar por fecha (mÃ¡s recientes primero)
            const sortedQuestions = [...questions].sort((a, b) => {
                const dateA = new Date(a.timestamp || a.createdAt || 0);
                const dateB = new Date(b.timestamp || b.createdAt || 0);
                return dateB - dateA;
            });
            
            content.innerHTML = `
                <div class="space-y-4">
                    ${sortedQuestions.map((q, idx) => {
                        const score = Math.round(q.score || 0);
                        const scoreColor = score >= 85 ? 'bg-green-100 text-green-700' : 
                                          score >= 70 ? 'bg-blue-100 text-blue-700' : 
                                          score >= 50 ? 'bg-yellow-100 text-yellow-700' : 
                                          'bg-red-100 text-red-700';
                        
                        const questionText = q.pregunta || q.question || q.userQuestion || 'Sin pregunta';
                        const answerText = q.respuesta || q.answer || q.userAnswer || 'Sin respuesta';
                        const timestamp = q.timestamp || q.createdAt || Date.now();
                        const dateStr = new Date(timestamp).toLocaleDateString('es-ES', { 
                            day: 'numeric', 
                            month: 'short',
                            year: 'numeric'
                        });
                        
                        return `
                        <div class="p-5 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors border border-gray-200">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-gray-400 text-sm">#${idx + 1}</span>
                                    <span class="text-xs text-gray-500">ğŸ“… ${dateStr}</span>
                                </div>
                                <span class="${scoreColor} px-3 py-1 rounded-full text-sm font-bold">
                                    ${score}%
                                </span>
                            </div>
                            <p class="font-bold text-gray-900 text-base mb-2">â“ ${questionText}</p>
                            <p class="text-sm text-gray-600 line-clamp-2">âœ… ${answerText}</p>
                        </div>
                        `;
                    }).join('')}
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                    <p class="text-gray-600 text-sm mb-3">
                        ğŸ“Š Total: <span class="font-bold text-gray-900">${questions.length}</span> pregunta(s)
                    </p>
                    <a href="sesion-practica.html" class="inline-block px-6 py-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg font-semibold transition-colors">
                        Crear mÃ¡s preguntas
                    </a>
                </div>
            `;
        };
        
        // Cerrar modal de preguntas
        window.closeQuestionsModal = function() {
            const modal = document.getElementById('questions-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };
        
        // Cerrar modal al hacer click fuera
        document.addEventListener('click', function(e) {
            const materialsModal = document.getElementById('materials-modal');
            const questionsModal = document.getElementById('questions-modal');
            
            if (e.target === materialsModal) {
                window.closeMaterialsModal();
            }
            if (e.target === questionsModal) {
                window.closeQuestionsModal();
            }
        });
        
        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                window.closeMaterialsModal();
                window.closeQuestionsModal();
            }
        });
        
        // ==========================================
        // MENÃš MÃ“VIL
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.getElementById('menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = menuBtn.querySelector('.menu-icon');
            
            menuBtn.addEventListener('click', function() {
                const isOpen = mobileMenu.style.display !== 'none';
                
                if (isOpen) {
                    mobileMenu.style.display = 'none';
                    menuIcon.textContent = 'menu';
                } else {
                    mobileMenu.style.display = 'block';
                    menuIcon.textContent = 'close';
                }
            });
        });
    </script>
</body>
</html>
iona 
