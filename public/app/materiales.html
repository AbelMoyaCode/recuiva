<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Gestión de Materiales - Recuiva</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/js/mockApi.js"></script>
    <style type="text/tailwindcss">
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      
      /* Estilo global para el logo Recuiva */
      .recuiva-logo {
        font-family: 'Manrope', sans-serif !important;
        font-weight: 800 !important;
        font-size: 1.5rem !important;
      }
      .material-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -1px rgba(0, 0, 0, 0.15);
      }
      .progress-bar {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
      }
      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-activo { background: #dcfce7; color: #166534; }
      .status-pausado { background: #fef3c7; color: #92400e; }
      .status-completado { background: #dbeafe; color: #1e40af; }
      
      /* Estilos heredados del index.html */
      .menu-btn {
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .menu-btn:hover {
        transform: scale(1.1);
      }
      .mobile-menu {
        transform-origin: top;
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease;
        transform: scaleY(0);
        opacity: 0;
        pointer-events: none;
        height: 100vh;
        overflow-y: auto;
      }
      .mobile-menu.active {
        transform: scaleY(1);
        opacity: 1;
        pointer-events: auto;
      }
      #menu-btn.active .menu-icon {
        transform: rotate(180deg);
      }
      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        padding: 0.75rem 0;
        min-width: 14rem;
        z-index: 50;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      }
      .profile-dropdown.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .profile-dropdown a, .profile-dropdown button {
        transition: all 0.2s ease;
      }
      .profile-dropdown a:hover, .profile-dropdown button:hover {
        transform: translateX(4px);
      }
      .notification-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: var(--primary-color);
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        min-width: 1.2rem;
        text-align: center;
      }
      
      /* Modal de notificaciones mejorado - Estilo elegante */
      .notification-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      .notification-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .notification-modal-content {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 26rem;
        margin: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.8) translateY(30px);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .notification-modal.show .notification-modal-content {
        transform: scale(1) translateY(0);
      }
      .notification-icon-container {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }
      .notification-modal h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
        text-align: center;
      }
      .notification-modal p {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #6b7280;
        text-align: center;
        margin-bottom: 2rem;
      }
      .modal-button {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        color: white;
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
        width: 100%;
      }
      .modal-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4);
      }
    </style>
</head>
<body class="bg-[var(--base-gray)] min-h-screen">

<div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
<header class="bg-[var(--base-white)] shadow-md sticky top-0 z-50">
<div class="container mx-auto px-4 md:px-6 py-3 flex justify-between items-center">
  <div class="flex items-center gap-3">
    <a href="../index.html" class="flex items-center gap-2">
      <img src="../assets/img/Icon-Recuiva.png" alt="Logo Recuiva" class="h-10 w-10 object-contain md:h-12 md:w-12" style="max-width:48px; max-height:48px;"/>
      <span class="recuiva-logo text-[var(--text-primary)]">Recuiva</span>
    </a>
  </div>
  <nav class="hidden md:flex items-center gap-4">
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="../index.html">Inicio</a>
  <a class="text-[var(--primary-color)] font-semibold px-2 py-1 rounded-lg" href="materiales.html">Materiales</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="../dashboard.html">Dashboard</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="repasos.html">Repasos</a>
  <a class="text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors px-2 py-1 rounded-lg" href="sesion-practica.html">Práctica</a>
  </nav>
  <div class="flex items-center gap-4">
    <!-- Botón menú móvil (solo móvil) -->
    <button class="menu-btn z-50 p-2 rounded-full hover:bg-gray-100 md:hidden" id="menu-btn">
      <span class="material-symbols-outlined text-3xl text-[var(--text-primary)]">menu</span>
    </button>
  </div>
</div>

<!-- Mobile Menu -->
<div class="mobile-menu md:hidden fixed top-[73px] left-0 w-full bg-[var(--base-white)] z-40 shadow-lg" id="mobile-menu">
<div class="flex flex-col h-[calc(100vh-73px)] items-center justify-center gap-8">
  <!-- Perfil y configuración arriba de navegación -->
  <div class="flex flex-col items-center w-full mb-2 py-2">
    <a href="mi-perfil.html" class="flex flex-col items-center w-full px-6 py-2 hover:bg-gray-100 rounded-xl cursor-pointer transition-all">
      <img src="../img/profile.jpg" alt="Perfil" class="w-10 h-10 rounded-full border-2 border-blue-700 mx-auto" />
      <span class="text-base font-semibold text-gray-800 mt-2 text-center">Mi perfil</span>
    </a>
    <div class="flex flex-col items-center w-full px-6 py-2 hover:bg-gray-100 rounded-xl cursor-pointer transition-all">
      <span class="material-symbols-outlined mx-auto">settings</span>
    </div>
  </div>
  <hr class="w-2/3 border-gray-300 my-2" />
  <!-- Navegación principal -->
  <nav class="flex flex-col items-center gap-6 w-full">
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="../index.html">Inicio</a>
  <a class="text-xl text-[var(--primary-color)] font-semibold" href="materiales.html">Materiales</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="../dashboard.html">Dashboard</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="repasos.html">Repasos</a>
  <a class="text-xl text-[var(--text-secondary)] hover:text-[var(--primary-color)] transition-colors" href="sesion-practica.html">Práctica</a>
  </nav>
  <hr class="w-2/3 border-gray-300 my-2" />
  <button onclick="logout()" class="flex items-center gap-2 text-base text-red-600 font-semibold">
  <span class="material-symbols-outlined">logout</span>
  Cerrar sesión
  </button>
</div>
</div>
</header>

<main class="container mx-auto px-4 py-8 max-w-6xl">

  <!-- Header Section -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-[var(--secondary-color)] mb-2">Gestión de Materiales</h1>
      <p class="text-[var(--text-secondary)]">Administra tus PDFs, libros y materiales de estudio</p>
    </div>
    <a href="subir-material.html" 
       class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold flex items-center gap-2">
      <span class="material-symbols-outlined">add</span>
      Subir Material
    </a>
  </div>

  <!-- Filtros y búsqueda -->
  <div class="bg-white rounded-xl p-6 mb-8">
    <div class="flex flex-wrap gap-4 items-center">
      
      <div class="flex-1 min-w-64">
        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--text-secondary)]">search</span>
          <input type="text" placeholder="Buscar materiales..." 
                 class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent">
        </div>
      </div>

      <select class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)]">
        <option>Todos los materiales</option>
        <option>PDFs</option>
        <option>Libros físicos</option>
        <option>Sin material</option>
      </select>

      <select class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)]">
        <option>Todos los estados</option>
        <option>Activo</option>
        <option>Pausado</option>
        <option>Completado</option>
      </select>

      <button class="px-4 py-3 bg-gray-100 text-[var(--text-secondary)] rounded-lg hover:bg-gray-200 flex items-center gap-2">
        <span class="material-symbols-outlined">filter_list</span>
        Filtros
      </button>

    </div>
  </div>

  <!-- Estadísticas reales desde backend -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    
    <div class="bg-white rounded-xl p-6 text-center">
      <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
        <span class="material-symbols-outlined text-blue-600">description</span>
      </div>
      <div id="total-materiales-count" class="text-3xl font-bold text-[var(--secondary-color)] mb-1">
        <span class="material-symbols-outlined animate-spin">progress_activity</span>
      </div>
      <div class="text-sm text-[var(--text-secondary)]">Total Materiales Subidos</div>
    </div>

    <div class="bg-white rounded-xl p-6 text-center">
      <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
        <span class="material-symbols-outlined text-green-600">folder_open</span>
      </div>
      <div id="total-chunks-count" class="text-3xl font-bold text-[var(--secondary-color)] mb-1">
        <span class="material-symbols-outlined animate-spin">progress_activity</span>
      </div>
      <div class="text-sm text-[var(--text-secondary)]">Total Chunks Procesados</div>
    </div>

  </div>

  <!-- Lista de materiales -->
  <div id="materials-container" class="space-y-4">
    <!-- Los materiales se cargarán dinámicamente aquí -->
    <div class="text-center py-12">
      <span class="material-symbols-outlined text-4xl text-[var(--accent-color)] animate-spin mb-4">progress_activity</span>
      <p class="text-[var(--text-secondary)]">Cargando materiales...</p>
    </div>
  </div>

  <!-- Paginación (oculta inicialmente) -->
  <div id="pagination" class="hidden flex justify-center items-center gap-4 mt-12">
  </div>

</main>

<footer class="bg-[var(--secondary-color)] text-[var(--base-gray)] py-12 px-6 mt-8">
<div class="container mx-auto text-center">
<div class="flex justify-center items-center gap-2 mb-6">
<img src="../assets/img/Icon-Recuiva.png" alt="Logo Recuiva" class="h-10 w-10 object-contain md:h-12 md:w-12" style="max-width:48px; max-height:48px;"/>
<span class="recuiva-logo">Recuiva</span>
</div>
<div class="flex flex-wrap items-center justify-center gap-x-6 gap-y-2 mb-6">
<a class="hover:text-[var(--primary-color)] transition-colors" href="../institucional/active-recall.html">Active Recall</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="../institucional/validacion-semantica.html">Validación Semántica</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="../institucional/diferencias.html">Diferencias</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="#">Contacto</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="#">Términos</a>
<a class="hover:text-[var(--primary-color)] transition-colors" href="#">Privacidad</a>
</div>
<p class="text-sm">© 2025 Recuiva. Todos los derechos reservados.</p>
</div>
</footer>

<script>
// Toggle mobile menu
function toggleMobileMenu() {
  const mobileMenu = document.getElementById('mobile-menu');
  const menuBtn = document.getElementById('mobile-menu-btn');
  
  mobileMenu.classList.toggle('show');
  menuBtn.classList.toggle('active');
}

// Toggle profile dropdown
function toggleProfileDropdown() {
  const dropdown = document.getElementById('profile-dropdown');
  dropdown.classList.toggle('show');
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
  const profileBtn = document.getElementById('profile-btn');
  const profileDropdown = document.getElementById('profile-dropdown');
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  
  if (profileBtn && !profileBtn.contains(e.target)) {
    profileDropdown.classList.remove('show');
  }
  
  if (mobileMenuBtn && !mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
    mobileMenu.classList.remove('show');
    mobileMenuBtn.classList.remove('active');
  }
});

// Modal functions
function showNotificationModal() {
  showModal('notifications', 'Notificaciones', 'Esta funcionalidad requiere conexión con el backend. Por ahora puedes explorar las notificaciones simuladas en el perfil.');
}

function showLogoutModal() {
  if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
    // Simulate logout
    localStorage.removeItem('recuiva_user');
    window.location.href = '../auth/iniciar-sesion.html';
  }
}

function showModal(icon, title, message) {
  // Create modal if it doesn't exist
  let modal = document.getElementById('header-modal');
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'header-modal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300';
    modal.innerHTML = `
      <div class="bg-white rounded-xl p-6 max-w-md mx-4 transform scale-95 transition-transform duration-300">
        <div class="text-center">
          <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <span class="material-symbols-outlined text-2xl text-orange-600" id="modal-icon">info</span>
          </div>
          <h3 class="text-lg font-bold text-gray-900 mb-2" id="modal-title">Título</h3>
          <p class="text-gray-600 mb-6" id="modal-message">Mensaje</p>
          <button onclick="closeModal()" class="px-6 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 transition-all">
            Entendido
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Update modal content
  document.getElementById('modal-icon').textContent = icon;
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-message').textContent = message;
  
  // Show modal
  modal.classList.remove('opacity-0', 'invisible');
  modal.querySelector('.bg-white').classList.remove('scale-95');
}

function closeModal() {
  const modal = document.getElementById('header-modal');
  if (modal) {
    modal.classList.add('opacity-0', 'invisible');
    modal.querySelector('.bg-white').classList.add('scale-95');
  }
}

document.addEventListener('DOMContentLoaded', function() {
    // === FUNCIONES MODALES BACKEND MEJORADAS ===
    window.showBackendModal = function(icon, title, description) {
      showAdvancedModal(icon, title, description);
    };
    
    // Modal avanzado con mejor UX
    window.showAdvancedModal = function(icon, title, description) {
      // Crear modal si no existe
      let modal = document.getElementById('advanced-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'advanced-modal';
        modal.className = 'notification-modal';
        modal.innerHTML = `
          <div class="notification-modal-content">
            <div class="notification-icon-container">
              <span class="material-symbols-outlined text-2xl text-white" id="modal-icon">notifications</span>
            </div>
            <h3 id="modal-title">🔔 Notificaciones</h3>
            <p id="modal-description">Sistema de notificaciones en tiempo real para repasos, recordatorios y actualizaciones de progreso. Requiere conexión con servidor. Por ahora puedes explorar la funcionalidad simulada. En la versión completa con backend, esto funcionará en tiempo real.</p>
            <button onclick="closeAdvancedModal()" class="modal-button">
              Aceptar
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Cerrar con escape
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.classList.contains('show')) {
            closeAdvancedModal();
          }
        });
        
        // Cerrar clickeando fuera
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeAdvancedModal();
          }
        });
      }
      
      // Actualizar contenido
      const iconMap = {
        'notifications': '🔔',
        'settings': '⚙️',
        'dashboard': '📊',
        'analytics': '📈'
      };
      
      document.getElementById('modal-icon').textContent = icon;
      document.getElementById('modal-title').textContent = `${iconMap[icon] || '📋'} ${title}`;
      document.getElementById('modal-description').textContent = description;
      
      // Mostrar modal con animación
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    };
    
    window.closeAdvancedModal = function() {
      const modal = document.getElementById('advanced-modal');
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }
    };
    
    // === FUNCIONES NAVEGACIÓN ===
    window.logout = function() {
      if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        localStorage.removeItem('recuiva_user');
        window.location.href = '../auth/iniciar-sesion.html';
      }
    };

    // Simulación de datos de materiales desde localStorage
    const materiales = JSON.parse(localStorage.getItem('recuiva_materiales') || '[]');
    
    console.log('Materiales cargados:', materiales);
    
    // Funcionalidad de búsqueda
    const searchInput = document.querySelector('input[placeholder="Buscar materiales..."]');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            console.log('Buscando:', query);
            // Aquí iría la lógica de filtrado
        });
    }
    
    // Eventos de botones de acción
    document.querySelectorAll('.material-card button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Acción en material:', this.textContent.trim());
        });
    });
});
</script>

<style>
.profile-dropdown.show {
  opacity: 1 !important;
  visibility: visible !important;
}

#mobile-menu.show {
  transform: translateX(0) !important;
}

/* Animación del botón hamburger */
#mobile-menu-btn.active span {
  transform: rotate(180deg);
}
</style>

<script>
// JavaScript para menú móvil - Heredado del index.html
document.addEventListener('DOMContentLoaded', function() {
  // Menú móvil animación
  const menuBtn = document.getElementById('menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const menuIcon = menuBtn?.querySelector('.material-symbols-outlined');
  let isMenuOpen = false;
  
  function toggleMenu() {
    isMenuOpen = !isMenuOpen;
    
    if (isMenuOpen) {
      // Abrir menú suavemente
      mobileMenu.style.display = 'block';
      setTimeout(() => {
        mobileMenu.classList.add('active');
      }, 10);
      document.body.classList.add('overflow-hidden');
    } else {
      // Cerrar menú suavemente
      mobileMenu.classList.remove('active');
      setTimeout(() => {
        if (!isMenuOpen) {
          mobileMenu.style.display = 'none';
        }
      }, 400);
      document.body.classList.remove('overflow-hidden');
    }
    
    if (menuIcon) {
      menuIcon.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.2s ease';
      if (isMenuOpen) {
        menuIcon.style.transform = 'rotate(90deg)';
        menuIcon.style.opacity = '0';
        setTimeout(() => {
          menuIcon.textContent = 'close';
          menuIcon.style.transform = 'rotate(0deg)';
          menuIcon.style.opacity = '1';
        }, 200);
      } else {
        menuIcon.style.transform = 'rotate(90deg)';
        menuIcon.style.opacity = '0';
        setTimeout(() => {
          menuIcon.textContent = 'menu';
          menuIcon.style.transform = 'rotate(0deg)';
          menuIcon.style.opacity = '1';
        }, 200);
      }
    }
  }
  
  if (menuBtn) {
    menuBtn.addEventListener('click', toggleMenu);
  }
  
  const menuLinks = mobileMenu?.querySelectorAll('a');
  menuLinks?.forEach(link => {
    link.addEventListener('click', () => {
      if (isMenuOpen) {
        toggleMenu();
      }
    });
  });

  // Profile dropdown
  const profileBtn = document.getElementById('profile-btn');
  const profileDropdown = document.getElementById('profile-dropdown');
  
  if (profileBtn && profileDropdown) {
    profileBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      profileDropdown.classList.toggle('show');
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
      profileDropdown.classList.remove('show');
    });
    
    profileDropdown.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  }

  // === INTEGRACIÓN MOCKAPI PARA MATERIALES ===
  
  // Verificar autenticación
  if (!mockAPI.isAuthenticated()) {
    window.location.href = '../auth/iniciar-sesion.html';
    return;
  }

  // Referencias de elementos clave
  const createMaterialBtn = document.querySelector('button[onclick*="showBackendModal"]');
  const uploadBtn = document.querySelector('input[type="file"]');
  
  // === CREAR SET DESDE TEXTO ===
  function createStudySetFromText() {
    const title = prompt('Título del set de estudio:');
    if (!title) return;
    
    const content = prompt('Contenido del material (texto):');
    if (!content || content.length < 50) {
      alert('El contenido debe tener al menos 50 caracteres');
      return;
    }
    
    createStudySet(title, content);
  }
  
  async function createStudySet(title, content) {
    try {
      const result = await mockAPI.apiCreateSetMock({ title, content });
      
      if (result.ok) {
        alert(`✅ Set "${result.set.title}" creado con ${result.set.questions.length} preguntas`);
        
        // Redirigir a repasos
        setTimeout(() => {
          window.location.href = 'repasos.html';
        }, 1000);
      } else {
        alert('❌ Error al crear el set: ' + result.error);
      }
    } catch (error) {
      alert('🔌 Error de conexión');
    }
  }

  // === PROCESAMIENTO PDF ===
  async function processPDF(file) {
    if (!file || file.type !== 'application/pdf') {
      alert('❌ Solo se permiten archivos PDF');
      return;
    }
    
    try {
      const result = await mockAPI.apiProcessPdfMock(file);
      
      if (result.ok) {
        alert(`✅ PDF procesado: ${result.chunks.length} chunks creados`);
        
        // Generar embeddings automáticamente
        const embResult = await mockAPI.apiGenerateEmbeddingsMock(result.chunks);
        if (embResult.ok) {
          alert(`🧠 Embeddings generados: ${embResult.vectors.length} vectores`);
        }
      } else {
        alert('❌ Error al procesar PDF');
      }
    } catch (error) {
      alert('🔌 Error de conexión al procesar PDF');
    }
  }

  // === CARGAR MATERIALES EXISTENTES ===
  async function loadUserMaterials() {
    const currentUser = mockAPI.getCurrentUser();
    if (!currentUser) return;

    try {
      const result = await mockAPI.apiListSetsMock(currentUser.id);
      if (result.ok && result.sets.length > 0) {
        displayMaterialsInUI(result.sets);
      }
    } catch (error) {
      console.error('Error cargando materiales:', error);
    }
  }

  function displayMaterialsInUI(sets) {
    // Buscar contenedor de materiales y agregar sets
    const materialsContainer = document.querySelector('.grid') || document.querySelector('.space-y-6');
    if (!materialsContainer) return;

    const materialsHTML = sets.map(set => `
      <div class="material-card p-6">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-lg font-semibold text-gray-800">${set.title}</h3>
          <span class="status-badge bg-green-100 text-green-800">Activo</span>
        </div>
        <p class="text-sm text-gray-600 mb-3">${set.questions.length} preguntas generadas</p>
        <div class="flex gap-2">
          <button onclick="practiceSet('${set.id}')" class="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">
            Practicar
          </button>
          <button onclick="deleteSet('${set.id}')" class="px-3 py-1 border border-red-300 text-red-600 rounded text-sm hover:bg-red-50">
            Eliminar
          </button>
        </div>
      </div>
    `).join('');

    // Insertar al principio del contenedor
    materialsContainer.insertAdjacentHTML('afterbegin', materialsHTML);
  }

  // === FUNCIONES GLOBALES ===
  window.practiceSet = function(setId) {
    localStorage.setItem('recuiva_selected_set_id', setId);
    window.location.href = 'repasos.html';
  };

  window.deleteSet = function(setId) {
    if (confirm('¿Eliminar este set de estudio?')) {
      const sets = JSON.parse(localStorage.getItem('recuiva_study_sets') || '[]');
      const filteredSets = sets.filter(set => set.id !== setId);
      localStorage.setItem('recuiva_study_sets', JSON.stringify(filteredSets));
      location.reload(); // Recargar para actualizar UI
    }
  };

  // === FUNCIÓN PARA CARGAR MATERIALES DESDE BACKEND ===
  async function loadMaterialsFromBackend() {
    const container = document.getElementById('materials-container');
    
    try {
      const response = await fetch('http://localhost:8000/api/materials');
      if (!response.ok) throw new Error('Backend no disponible');
      
      const data = await response.json();
      const materials = data.materials || [];
      
      // Actualizar contadores
      const totalCount = materials.length;
      const totalChunks = materials.reduce((sum, m) => sum + (m.total_chunks || 0), 0);
      
      document.getElementById('total-materiales-count').textContent = totalCount;
      document.getElementById('total-chunks-count').textContent = totalChunks.toLocaleString();
      
      if (materials.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 bg-[var(--base-gray)] rounded-lg">
            <span class="material-symbols-outlined text-5xl text-[var(--accent-color)] mb-4">inbox</span>
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-2">No hay materiales aún</h3>
            <p class="text-[var(--text-secondary)] mb-6">
              Sube tu primer PDF para empezar a estudiar con Active Recall
            </p>
            <a href="subir-material.html" 
               class="inline-block px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold">
              <span class="material-symbols-outlined align-middle mr-2">upload_file</span>
              Subir Material
            </a>
          </div>
        `;
        return;
      }
      
      // Renderizar materiales
      let html = '';
      materials.forEach(material => {
        const uploadDate = new Date(
          material.uploaded_at.slice(0,4), 
          parseInt(material.uploaded_at.slice(4,6))-1, 
          material.uploaded_at.slice(6,8)
        ).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
        
        const fileStatus = material.file_exists ? 'ACTIVO' : 'PAUSADO';
        const statusClass = material.file_exists ? 'status-activo' : 'status-pausado';
        
        // Mostrar páginas reales si están disponibles, si no usar estimación
        const pageCount = material.real_pages 
          ? `${material.real_pages} páginas` 
          : `${material.estimated_pages || 'N/A'} páginas (est.)`;
        
        html += `
          <div class="material-card p-6">
            <div class="flex items-start gap-4">
              
              <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <span class="material-symbols-outlined text-red-600">picture_as_pdf</span>
              </div>

              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h3 class="font-bold text-[var(--text-primary)] text-lg">${material.filename}</h3>
                    <p class="text-sm text-[var(--text-secondary)]">
                      PDF • <span title="Un chunk es un fragmento de texto de ~500 caracteres. El sistema divide tu material en chunks para analizar semánticamente cada sección. ${material.total_chunks} chunks = ${material.total_chunks * 500} caracteres aprox." class="cursor-help underline decoration-dotted">${material.total_chunks} chunks</span> • ${pageCount} • Subido el ${uploadDate}
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="status-badge ${statusClass}">${fileStatus}</span>
                    <button 
                      onclick="eliminarMaterialCompleto(${material.id}, '${material.filename}')" 
                      class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50"
                      title="Eliminar material">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>

                <div class="mb-4">
                  <div class="flex justify-between text-sm mb-2">
                    <span class="text-[var(--text-secondary)]">Embeddings generados</span>
                    <span class="font-semibold text-[var(--secondary-color)]">${material.total_chunks} chunks</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar" style="width: 100%"></div>
                  </div>
                </div>

                <div class="flex items-center gap-6 text-sm text-[var(--text-secondary)] mb-4">
                  <div class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">description</span>
                    <span>ID: ${material.id}</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">
                      ${material.file_exists ? 'check_circle' : 'warning'}
                    </span>
                    <span>${material.file_exists ? 'Archivo disponible' : 'Solo embeddings'}</span>
                  </div>
                </div>

                <div class="flex gap-3">
                  <button 
                    onclick="irAPracticaConMaterial(${material.id}, '${material.filename}')"
                    class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold text-sm">
                    Practicar
                  </button>
                  <button 
                    onclick="verDetallesMaterial(${material.id})"
                    class="px-4 py-2 border border-[var(--secondary-color)] text-[var(--secondary-color)] rounded-lg hover:bg-[var(--base-gray)] font-semibold text-sm">
                    Ver Detalles
                  </button>
                  <button 
                    onclick="eliminarMaterialCompleto(${material.id}, '${material.filename}')" 
                    class="px-3 py-2 text-red-500 hover:text-red-700 rounded hover:bg-red-50"
                    title="Eliminar material">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </div>

            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
    } catch (error) {
      console.error('Error cargando materiales:', error);
      container.innerHTML = `
        <div class="text-center py-12 bg-red-50 rounded-lg border-2 border-red-200">
          <span class="material-symbols-outlined text-5xl text-red-500 mb-4">error</span>
          <h3 class="text-lg font-bold text-red-700 mb-2">Error al cargar materiales</h3>
          <p class="text-red-600 mb-6">
            ${error.message || 'Verifica que el backend esté ejecutándose en puerto 8000'}
          </p>
          <button 
            onclick="loadMaterialsFromBackend()" 
            class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold">
            Reintentar
          </button>
        </div>
      `;
    }
  }
  
  // Función para eliminar material (ventana global)
  window.eliminarMaterialCompleto = async function(materialId, filename) {
    if (!confirm(`¿Estás seguro de eliminar "${filename}"?\n\nEsto eliminará:\n- El material del backend\n- Todos los embeddings asociados\n- El archivo PDF si existe`)) {
      return;
    }
    
    try {
      const response = await fetch(`http://localhost:8000/api/materials/${materialId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Error al eliminar material');
      }
      
      const result = await response.json();
      alert(`✅ Material "${filename}" eliminado exitosamente`);
      loadMaterialsFromBackend(); // Recargar lista
      
    } catch (error) {
      console.error('Error eliminando material:', error);
      alert(`❌ Error al eliminar material:\n\n${error.message}`);
    }
  };
  
  window.verDetallesMaterial = function(materialId) {
    alert(`Ver detalles del material ID: ${materialId}\n\nFuncionalidad próximamente...`);
  };
  
  window.irAPracticaConMaterial = function(materialId, materialNombre) {
    // Leer carpeta asociada al material
    const asociaciones = JSON.parse(localStorage.getItem('recuiva_material_carpetas') || '{}');
    const asociacion = asociaciones[materialId];
    
    // Construir URL simple con solo el ID del material
    // sesion-practica.html obtendrá los detalles del backend automáticamente
    let url = `sesion-practica.html?material=${materialId}`;
    
    console.log(`🎯 Redirigiendo a práctica con material ID: ${materialId}`);
    
    // Redirigir
    window.location.href = url;
  };

  // === OVERRIDE FUNCIONES EXISTENTES ===
  
  // Reemplazar la función showBackendModal para crear sets
  window.showBackendModal = function(feature, title, description) {
    if (feature === 'create-material' || title.includes('material')) {
      createStudySetFromText();
    } else {
      alert(`${title}\n\n${description}\n\nFuncionalidad disponible en Sprint 1 como demo.`);
    }
  };

  // Mejorar función de logout
  window.logout = function() {
    if (confirm('¿Cerrar sesión?')) {
      mockAPI.logout();
      window.location.href = '../auth/iniciar-sesion.html';
    }
  };

  // === INICIALIZACIÓN ===
  loadMaterialsFromBackend(); // Cargar materiales reales desde backend
  // ELIMINADO: loadUserMaterials() - solo cargamos desde backend
  
  // Configurar upload de PDF
  if (uploadBtn) {
    uploadBtn.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) processPDF(file);
    });
  }
});

// Backend modal function - ACTUALIZADA CON MOCKAPI
function showBackendModal(feature, title, description) {
  // Esta función se sobrescribe arriba en el DOMContentLoaded
}

// Logout function - ACTUALIZADA CON MOCKAPI  
function logout() {
  // Esta función se sobrescribe arriba en el DOMContentLoaded
}
</script>

</body>
</html>
