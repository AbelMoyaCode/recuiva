<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <title>Gesti√≥n de Materiales - Recuiva</title>
    <link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/supabase-operations.js"></script>
    <script src="../assets/js/header-footer-components.js"></script>
    <!-- MockAPI deshabilitado - usando Supabase -->
    <!-- <script src="../assets/js/mockApi.js"></script> -->
    <style type="text/tailwindcss">
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      
      .material-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -1px rgba(0, 0, 0, 0.15);
      }
      .progress-bar {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
      }
      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-activo { background: #dcfce7; color: #166534; }
      .status-pausado { background: #fef3c7; color: #92400e; }
      .status-completado { background: #dbeafe; color: #1e40af; }
    </style>
</head>
<body class="bg-[var(--base-gray)] min-h-screen">

<div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
<!-- Header Container - Managed by header-footer-components.js -->
<div id="header-container"></div>

<main class="container mx-auto px-4 py-8 max-w-6xl">

  <!-- Header Section -->
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-[var(--secondary-color)] mb-2">Gesti√≥n de Materiales</h1>
      <p class="text-[var(--text-secondary)]">Administra tus PDFs, libros y materiales de estudio</p>
    </div>
    <a href="subir-material.html" 
       class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold flex items-center gap-2">
      <span class="material-symbols-outlined">add</span>
      Subir Material
    </a>
  </div>

  <!-- Filtros y b√∫squeda -->
  <div class="bg-white rounded-xl p-6 mb-8">
    <div class="flex flex-wrap gap-4 items-center">
      
      <div class="flex-1 min-w-64">
        <div class="relative">
          <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--text-secondary)]">search</span>
          <input type="text" placeholder="Buscar materiales..." 
                 class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent">
        </div>
      </div>

      <select class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)]">
        <option>Todos los materiales</option>
        <option>PDFs</option>
        <option>Libros f√≠sicos</option>
        <option>Sin material</option>
      </select>

      <select class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)]">
        <option>Todos los estados</option>
        <option>Activo</option>
        <option>Pausado</option>
        <option>Completado</option>
      </select>

      <button class="px-4 py-3 bg-gray-100 text-[var(--text-secondary)] rounded-lg hover:bg-gray-200 flex items-center gap-2">
        <span class="material-symbols-outlined">filter_list</span>
        Filtros
      </button>

    </div>
  </div>

  <!-- Estad√≠sticas reales desde backend -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    
    <div class="bg-white rounded-xl p-6 text-center">
      <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
        <span class="material-symbols-outlined text-blue-600">description</span>
      </div>
      <div id="total-materiales-count" class="text-3xl font-bold text-[var(--secondary-color)] mb-1">
        <span class="material-symbols-outlined animate-spin">progress_activity</span>
      </div>
      <div class="text-sm text-[var(--text-secondary)]">Total Materiales Subidos</div>
    </div>

    <div class="bg-white rounded-xl p-6 text-center">
      <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
        <span class="material-symbols-outlined text-green-600">folder_open</span>
      </div>
      <div id="total-chunks-count" class="text-3xl font-bold text-[var(--secondary-color)] mb-1">
        <span class="material-symbols-outlined animate-spin">progress_activity</span>
      </div>
      <div class="text-sm text-[var(--text-secondary)]">Total Chunks Procesados</div>
    </div>

  </div>

  <!-- Lista de materiales -->
  <div id="materials-container" class="space-y-4">
    <!-- Los materiales se cargar√°n din√°micamente aqu√≠ -->
    <div class="text-center py-12">
      <span class="material-symbols-outlined text-4xl text-[var(--accent-color)] animate-spin mb-4">progress_activity</span>
      <p class="text-[var(--text-secondary)]">Cargando materiales...</p>
    </div>
  </div>

  <!-- Paginaci√≥n (oculta inicialmente) -->
  <div id="pagination" class="hidden flex justify-center items-center gap-4 mt-12">
  </div>

</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // === FUNCIONES MODALES BACKEND MEJORADAS ===
    window.showBackendModal = function(icon, title, description) {
      showAdvancedModal(icon, title, description);
    };
    
    // Modal avanzado con mejor UX
    window.showAdvancedModal = function(icon, title, description) {
      // Crear modal si no existe
      let modal = document.getElementById('advanced-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'advanced-modal';
        modal.className = 'notification-modal';
        modal.innerHTML = `
          <div class="notification-modal-content">
            <div class="notification-icon-container">
              <span class="material-symbols-outlined text-2xl text-white" id="modal-icon">notifications</span>
            </div>
            <h3 id="modal-title">üîî Notificaciones</h3>
            <p id="modal-description">Sistema de notificaciones en tiempo real para repasos, recordatorios y actualizaciones de progreso. Requiere conexi√≥n con servidor. Por ahora puedes explorar la funcionalidad simulada. En la versi√≥n completa con backend, esto funcionar√° en tiempo real.</p>
            <button onclick="closeAdvancedModal()" class="modal-button">
              Aceptar
            </button>
          </div>
        `;
        document.body.appendChild(modal);
        
        // Cerrar con escape
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && modal.classList.contains('show')) {
            closeAdvancedModal();
          }
        });
        
        // Cerrar clickeando fuera
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeAdvancedModal();
          }
        });
      }
      
      // Actualizar contenido
      const iconMap = {
        'notifications': 'üîî',
        'settings': '‚öôÔ∏è',
        'dashboard': 'üìä',
        'analytics': 'üìà'
      };
      
      document.getElementById('modal-icon').textContent = icon;
      document.getElementById('modal-title').textContent = `${iconMap[icon] || 'üìã'} ${title}`;
      document.getElementById('modal-description').textContent = description;
      
      // Mostrar modal con animaci√≥n
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    };
    
    window.closeAdvancedModal = function() {
      const modal = document.getElementById('advanced-modal');
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }
    };
    
    // === FUNCIONES NAVEGACI√ìN ===
    window.logout = function() {
      if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
        localStorage.removeItem('recuiva_user');
        window.location.href = '../auth/iniciar-sesion.html';
      }
    };

    // ‚úÖ Cargar materiales desde Supabase (NO localStorage)
    async function cargarMateriales() {
        try {
            const materiales = await SupabaseOperations.getMaterials();
            console.log('‚úÖ Materiales cargados desde Supabase:', materiales);
            renderizarMateriales(materiales);
        } catch (error) {
            console.error('‚ùå Error cargando materiales:', error);
        }
    }
    
    function renderizarMateriales(materials) {
        console.log(`üìÑ Total materiales: ${materials.length}`);
        
        const container = document.getElementById('materials-container');
        if (!container) {
            console.error('‚ùå Contenedor de materiales no encontrado');
            return;
        }
        
        // Actualizar contadores
        const totalCount = materials.length;
        const totalChunks = materials.reduce((sum, m) => sum + (m.total_chunks || 0), 0);
        
        const totalMaterialesEl = document.getElementById('total-materiales-count');
        const totalChunksEl = document.getElementById('total-chunks-count');
        
        if (totalMaterialesEl) totalMaterialesEl.textContent = totalCount;
        if (totalChunksEl) totalChunksEl.textContent = totalChunks.toLocaleString();
        
        // Si no hay materiales, mostrar mensaje
        if (materials.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <span class="material-symbols-outlined text-5xl text-orange-500 mb-4">inbox</span>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">No hay materiales a√∫n</h3>
                    <p class="text-gray-600 mb-6">
                        Sube tu primer PDF para empezar a estudiar con Active Recall
                    </p>
                    <a href="subir-material.html" 
                       class="inline-block px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold">
                        <span class="material-symbols-outlined align-middle mr-2">upload_file</span>
                        Subir Material
                    </a>
                </div>
            `;
            return;
        }
        
        // Renderizar materiales
        let html = '';
        materials.forEach(material => {
            // Parsear fecha desde Supabase (ISO 8601 format)
            let uploadDate = 'Fecha desconocida';
            try {
                if (material.created_at) {
                    uploadDate = new Date(material.created_at).toLocaleDateString('es-ES', { 
                        day: 'numeric', 
                        month: 'long', 
                        year: 'numeric' 
                    });
                }
            } catch (e) {
                console.warn('Error parseando fecha:', e);
            }
            
            // Nombre del archivo con fallbacks
            const materialFileName = material.title || material.file_name || material.filename || 'Material sin nombre';
            
            const fileStatus = material.processing_status === 'completed' ? 'ACTIVO' : 'PAUSADO';
            const statusClass = material.processing_status === 'completed' ? 'status-activo' : 'status-pausado';
            
            // Mostrar p√°ginas reales si est√°n disponibles
            const pageCount = material.estimated_pages 
                ? `${material.estimated_pages} p√°ginas` 
                : 'N/A p√°ginas';
            
            html += `
                <div class="material-card p-6 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-red-600">picture_as_pdf</span>
                        </div>
                        
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <h3 class="font-bold text-gray-900 text-lg">${materialFileName}</h3>
                                    <p class="text-sm text-gray-600">
                                        PDF ‚Ä¢ ${material.total_chunks || 0} chunks ‚Ä¢ ${pageCount} ‚Ä¢ Subido el ${uploadDate}
                                    </p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">${fileStatus}</span>
                            </div>
                            
                            <div class="flex gap-3 mt-4">
                                <a href="sesion-practica.html?material=${material.id}" 
                                   class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                    <span class="material-symbols-outlined align-middle mr-1 text-sm">play_arrow</span>
                                    Iniciar Sesi√≥n
                                </a>
                                <button onclick="eliminarMaterial('${material.id}')" 
                                        class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                                    <span class="material-symbols-outlined align-middle mr-1 text-sm">delete</span>
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Cargar materiales al iniciar
    cargarMateriales();
    
    // Funci√≥n para eliminar material
    window.eliminarMaterial = async function(materialId) {
        if (!confirm('¬øEst√°s seguro de eliminar este material? Esta acci√≥n no se puede deshacer.')) {
            return;
        }
        
        try {
            // Eliminar de Supabase
            const response = await fetch(`http://localhost:8000/api/materials/${materialId}`, {
                method: 'DELETE'
            });
            
            if (!response.ok) {
                throw new Error('Error eliminando material del backend');
            }
            
            console.log('‚úÖ Material eliminado');
            
            // Recargar lista
            await cargarMateriales();
        } catch (error) {
            console.error('‚ùå Error eliminando material:', error);
            alert('Error eliminando material. Verifica la consola.');
        }
    };
    
    // Funcionalidad de b√∫squeda
    const searchInput = document.querySelector('input[placeholder="Buscar materiales..."]');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            console.log('Buscando:', query);
            // Aqu√≠ ir√≠a la l√≥gica de filtrado
        });
    }
    
    // Eventos de botones de acci√≥n
    document.querySelectorAll('.material-card button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Acci√≥n en material:', this.textContent.trim());
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // === INTEGRACI√ìN MOCKAPI PARA MATERIALES ===
  
  // Verificar autenticaci√≥n
  if (!mockAPI.isAuthenticated()) {
    window.location.href = '../auth/iniciar-sesion.html';
    return;
  }

  // Referencias de elementos clave
  const createMaterialBtn = document.querySelector('button[onclick*="showBackendModal"]');
  const uploadBtn = document.querySelector('input[type="file"]');
  
  // === CREAR SET DESDE TEXTO ===
  function createStudySetFromText() {
    const title = prompt('T√≠tulo del set de estudio:');
    if (!title) return;
    
    const content = prompt('Contenido del material (texto):');
    if (!content || content.length < 50) {
      alert('El contenido debe tener al menos 50 caracteres');
      return;
    }
    
    createStudySet(title, content);
  }
  
  async function createStudySet(title, content) {
    try {
      const result = await mockAPI.apiCreateSetMock({ title, content });
      
      if (result.ok) {
        alert(`‚úÖ Set "${result.set.title}" creado con ${result.set.questions.length} preguntas`);
        
        // Redirigir a repasos
        setTimeout(() => {
          window.location.href = 'repasos.html';
        }, 1000);
      } else {
        alert('‚ùå Error al crear el set: ' + result.error);
      }
    } catch (error) {
      alert('üîå Error de conexi√≥n');
    }
  }

  // === PROCESAMIENTO PDF ===
  async function processPDF(file) {
    if (!file || file.type !== 'application/pdf') {
      alert('‚ùå Solo se permiten archivos PDF');
      return;
    }
    
    try {
      const result = await mockAPI.apiProcessPdfMock(file);
      
      if (result.ok) {
        alert(`‚úÖ PDF procesado: ${result.chunks.length} chunks creados`);
        
        // Generar embeddings autom√°ticamente
        const embResult = await mockAPI.apiGenerateEmbeddingsMock(result.chunks);
        if (embResult.ok) {
          alert(`üß† Embeddings generados: ${embResult.vectors.length} vectores`);
        }
      } else {
        alert('‚ùå Error al procesar PDF');
      }
    } catch (error) {
      alert('üîå Error de conexi√≥n al procesar PDF');
    }
  }

  // === CARGAR MATERIALES EXISTENTES ===
  async function loadUserMaterials() {
    const currentUser = mockAPI.getCurrentUser();
    if (!currentUser) return;

    try {
      const result = await mockAPI.apiListSetsMock(currentUser.id);
      if (result.ok && result.sets.length > 0) {
        displayMaterialsInUI(result.sets);
      }
    } catch (error) {
      console.error('Error cargando materiales:', error);
    }
  }

  function displayMaterialsInUI(sets) {
    // Buscar contenedor de materiales y agregar sets
    const materialsContainer = document.querySelector('.grid') || document.querySelector('.space-y-6');
    if (!materialsContainer) return;

    const materialsHTML = sets.map(set => `
      <div class="material-card p-6">
        <div class="flex justify-between items-start mb-4">
          <h3 class="text-lg font-semibold text-gray-800">${set.title}</h3>
          <span class="status-badge bg-green-100 text-green-800">Activo</span>
        </div>
        <p class="text-sm text-gray-600 mb-3">${set.questions.length} preguntas generadas</p>
        <div class="flex gap-2">
          <button onclick="practiceSet('${set.id}')" class="px-3 py-1 bg-orange-500 text-white rounded text-sm hover:bg-orange-600">
            Practicar
          </button>
          <button onclick="deleteSet('${set.id}')" class="px-3 py-1 border border-red-300 text-red-600 rounded text-sm hover:bg-red-50">
            Eliminar
          </button>
        </div>
      </div>
    `).join('');

    // Insertar al principio del contenedor
    materialsContainer.insertAdjacentHTML('afterbegin', materialsHTML);
  }

  // === FUNCIONES GLOBALES ===
  window.practiceSet = function(setId) {
    localStorage.setItem('recuiva_selected_set_id', setId);
    window.location.href = 'repasos.html';
  };

  window.deleteSet = function(setId) {
    if (confirm('¬øEliminar este set de estudio?')) {
      const sets = JSON.parse(localStorage.getItem('recuiva_study_sets') || '[]');
      const filteredSets = sets.filter(set => set.id !== setId);
      localStorage.setItem('recuiva_study_sets', JSON.stringify(filteredSets));
      location.reload(); // Recargar para actualizar UI
    }
  };

  // === FUNCI√ìN PARA CARGAR MATERIALES DESDE BACKEND ===
  async function loadMaterialsFromBackend() {
    const container = document.getElementById('materials-container');
    
    try {
  const response = await fetch('http://localhost:8000/api/materials');
      if (!response.ok) throw new Error('Backend no disponible');
      
      const data = await response.json();
      const materials = data.materials || [];
      
      // Actualizar contadores
      const totalCount = materials.length;
      const totalChunks = materials.reduce((sum, m) => sum + (m.total_chunks || 0), 0);
      
      document.getElementById('total-materiales-count').textContent = totalCount;
      document.getElementById('total-chunks-count').textContent = totalChunks.toLocaleString();
      
      if (materials.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 bg-[var(--base-gray)] rounded-lg">
            <span class="material-symbols-outlined text-5xl text-[var(--accent-color)] mb-4">inbox</span>
            <h3 class="text-lg font-bold text-[var(--text-primary)] mb-2">No hay materiales a√∫n</h3>
            <p class="text-[var(--text-secondary)] mb-6">
              Sube tu primer PDF para empezar a estudiar con Active Recall
            </p>
            <a href="subir-material.html" 
               class="inline-block px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold">
              <span class="material-symbols-outlined align-middle mr-2">upload_file</span>
              Subir Material
            </a>
          </div>
        `;
        return;
      }
      
      // Renderizar materiales
      let html = '';
      materials.forEach(material => {
        // Parsear fecha desde Supabase (ISO 8601 format)
        let uploadDate = 'Fecha desconocida';
        try {
          if (material.created_at) {
            uploadDate = new Date(material.created_at).toLocaleDateString('es-ES', { 
              day: 'numeric', 
              month: 'long', 
              year: 'numeric' 
            });
          }
        } catch (e) {
          console.warn('Error parseando fecha:', e);
        }
        
        // Nombre del archivo con fallbacks
        const materialFileName = material.title || material.file_name || material.filename || 'Material sin nombre';
        
        const fileStatus = material.processing_status === 'completed' ? 'ACTIVO' : 'PAUSADO';
        const statusClass = material.processing_status === 'completed' ? 'status-activo' : 'status-pausado';
        
        // Mostrar p√°ginas reales si est√°n disponibles, si no usar estimaci√≥n
        const pageCount = material.real_pages 
          ? `${material.real_pages} p√°ginas` 
          : `${material.estimated_pages || 'N/A'} p√°ginas (est.)`;
        
        html += `
          <div class="material-card p-6">
            <div class="flex items-start gap-4">
              
              <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <span class="material-symbols-outlined text-red-600">picture_as_pdf</span>
              </div>

              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h3 class="font-bold text-[var(--text-primary)] text-lg">${materialFileName}</h3>
                    <p class="text-sm text-[var(--text-secondary)]">
                      PDF ‚Ä¢ <span title="Un chunk es un fragmento de texto de ~500 caracteres. El sistema divide tu material en chunks para analizar sem√°nticamente cada secci√≥n. ${material.total_chunks} chunks = ${material.total_chunks * 500} caracteres aprox." class="cursor-help underline decoration-dotted">${material.total_chunks} chunks</span> ‚Ä¢ ${pageCount} ‚Ä¢ Subido el ${uploadDate}
                    </p>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="status-badge ${statusClass}">${fileStatus}</span>
                    <button 
                      onclick="eliminarMaterialCompleto('${material.id}', '${materialFileName}')" 
                      class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-50"
                      title="Eliminar material">
                      <span class="material-symbols-outlined">delete</span>
                    </button>
                  </div>
                </div>

                <div class="mb-4">
                  <div class="flex justify-between text-sm mb-2">
                    <span class="text-[var(--text-secondary)]">Embeddings generados</span>
                    <span class="font-semibold text-[var(--secondary-color)]">${material.total_chunks} chunks</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="progress-bar" style="width: 100%"></div>
                  </div>
                </div>

                <div class="flex items-center gap-6 text-sm text-[var(--text-secondary)] mb-4">
                  <div class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">description</span>
                    <span>ID: ${material.id}</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <span class="material-symbols-outlined text-xs">
                      ${material.file_exists ? 'check_circle' : 'warning'}
                    </span>
                    <span>${material.file_exists ? 'Archivo disponible' : 'Solo embeddings'}</span>
                  </div>
                </div>

                <div class="flex gap-3">
                  <button 
                    onclick="irAPracticaConMaterial(${material.id}, '${material.filename}')"
                    class="px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold text-sm">
                    Practicar
                  </button>
                  <button 
                    onclick="verDetallesMaterial(${material.id})"
                    class="px-4 py-2 border border-[var(--secondary-color)] text-[var(--secondary-color)] rounded-lg hover:bg-[var(--base-gray)] font-semibold text-sm">
                    Ver Detalles
                  </button>
                  <button 
                    onclick="eliminarMaterialCompleto(${material.id}, '${material.filename}')" 
                    class="px-3 py-2 text-red-500 hover:text-red-700 rounded hover:bg-red-50"
                    title="Eliminar material">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </div>

            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
    } catch (error) {
      console.error('Error cargando materiales:', error);
      container.innerHTML = `
        <div class="text-center py-12 bg-red-50 rounded-lg border-2 border-red-200">
          <span class="material-symbols-outlined text-5xl text-red-500 mb-4">error</span>
          <h3 class="text-lg font-bold text-red-700 mb-2">Error al cargar materiales</h3>
          <p class="text-red-600 mb-6">
            ${error.message || 'Verifica que el backend est√© ejecut√°ndose en puerto 8000'}
          </p>
          <button 
            onclick="loadMaterialsFromBackend()" 
            class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold">
            Reintentar
          </button>
        </div>
      `;
    }
  }
  
  // Funci√≥n para eliminar material (ventana global)
  window.eliminarMaterialCompleto = async function(materialId, filename) {
    if (!confirm(`¬øEst√°s seguro de eliminar "${filename}"?\n\nEsto eliminar√°:\n- El material del backend\n- Todos los embeddings asociados\n- El archivo PDF si existe`)) {
      return;
    }
    
    try {
  const response = await fetch(`http://localhost:8000/api/materials/${materialId}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Error al eliminar material');
      }
      
      const result = await response.json();
      alert(`‚úÖ Material "${filename}" eliminado exitosamente`);
      loadMaterialsFromBackend(); // Recargar lista
      
    } catch (error) {
      console.error('Error eliminando material:', error);
      alert(`‚ùå Error al eliminar material:\n\n${error.message}`);
    }
  };
  
  window.verDetallesMaterial = function(materialId) {
    alert(`Ver detalles del material ID: ${materialId}\n\nFuncionalidad pr√≥ximamente...`);
  };
  
  window.irAPracticaConMaterial = function(materialId, materialNombre) {
    // Leer carpeta asociada al material
    const asociaciones = JSON.parse(localStorage.getItem('recuiva_material_carpetas') || '{}');
    const asociacion = asociaciones[materialId];
    
    // Construir URL simple con solo el ID del material
    // sesion-practica.html obtendr√° los detalles del backend autom√°ticamente
    let url = `sesion-practica.html?material=${materialId}`;
    
    console.log(`üéØ Redirigiendo a pr√°ctica con material ID: ${materialId}`);
    
    // Redirigir
    window.location.href = url;
  };

  // === OVERRIDE FUNCIONES EXISTENTES ===
  
  // Reemplazar la funci√≥n showBackendModal para crear sets
  window.showBackendModal = function(feature, title, description) {
    if (feature === 'create-material' || title.includes('material')) {
      createStudySetFromText();
    } else {
      alert(`${title}\n\n${description}\n\nFuncionalidad disponible en Sprint 1 como demo.`);
    }
  };

  // Mejorar funci√≥n de logout
  window.logout = function() {
    if (confirm('¬øCerrar sesi√≥n?')) {
      mockAPI.logout();
      window.location.href = '../auth/iniciar-sesion.html';
    }
  };

  // === INICIALIZACI√ìN ===
  loadMaterialsFromBackend(); // Cargar materiales reales desde backend
  // ELIMINADO: loadUserMaterials() - solo cargamos desde backend
  
  // Configurar upload de PDF
  if (uploadBtn) {
    uploadBtn.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) processPDF(file);
    });
  }
});

// Backend modal function - ACTUALIZADA CON MOCKAPI
function showBackendModal(feature, title, description) {
  // Esta funci√≥n se sobrescribe arriba en el DOMContentLoaded
}

// Logout function - ACTUALIZADA CON MOCKAPI  
function logout() {
  // Esta funci√≥n se sobrescribe arriba en el DOMContentLoaded
}

// ==========================================
// INICIALIZAR COMPONENTES HEADER/FOOTER
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
  initializeHeaderFooter('materiales');
});
</script>

<!-- Footer Container - Managed by header-footer-components.js -->
<div id="footer-container"></div>

</div>
</body>
</html>
