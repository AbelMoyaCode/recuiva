<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
  <link as="style"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <title>Gestión de Materiales - Recuiva</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/supabase-operations.js"></script>
  <script src="../assets/js/auth-guard.js"></script>
  <script src="../assets/js/header-footer-components.js"></script>
  <!-- MockAPI deshabilitado - usando Supabase -->
  <!-- <script src="../assets/js/mockApi.js"></script> -->
  <style type="text/tailwindcss">
    :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      
      .material-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
      }
      .material-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 12px -1px rgba(0, 0, 0, 0.15);
      }
      .progress-bar {
        background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        height: 8px;
        border-radius: 4px;
        transition: width 0.3s ease;
      }
      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .status-activo { background: #dcfce7; color: #166534; }
      .status-pausado { background: #fef3c7; color: #92400e; }
      .status-completado { background: #dbeafe; color: #1e40af; }
    </style>
</head>

<body class="bg-[var(--base-gray)] min-h-screen">

  <div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">
    <!-- Header Container - Managed by header-footer-components.js -->
    <div id="header-container"></div>

    <main class="container mx-auto px-4 py-8 max-w-6xl">

      <!-- Header Section -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-bold text-[var(--secondary-color)] mb-2">Gestión de Materiales</h1>
          <p class="text-[var(--text-secondary)]">Administra tus PDFs, libros y materiales de estudio</p>
        </div>
        <a href="subir-material.html"
          class="px-6 py-3 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90 font-semibold flex items-center gap-2">
          <span class="material-symbols-outlined">add</span>
          Subir Material
        </a>
      </div>

      <!-- Filtros y búsqueda -->
      <div class="bg-white rounded-xl p-6 mb-8">
        <div class="flex flex-wrap gap-4 items-center">

          <div class="flex-1 min-w-64">
            <div class="relative">
              <span
                class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--text-secondary)]">search</span>
              <input type="text" placeholder="Buscar materiales..."
                class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent">
            </div>
          </div>

          <select class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)]">
            <option>Todos los materiales</option>
            <option>PDFs</option>
            <option>Libros físicos</option>
            <option>Sin material</option>
          </select>

          <select class="px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--primary-color)]">
            <option>Todos los estados</option>
            <option>Activo</option>
            <option>Pausado</option>
            <option>Completado</option>
          </select>

          <button
            class="px-4 py-3 bg-gray-100 text-[var(--text-secondary)] rounded-lg hover:bg-gray-200 flex items-center gap-2">
            <span class="material-symbols-outlined">filter_list</span>
            Filtros
          </button>

        </div>
      </div>

      <!-- Estadísticas reales desde backend -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">

        <div class="bg-white rounded-xl p-6 text-center">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <span class="material-symbols-outlined text-blue-600">description</span>
          </div>
          <div id="total-materiales-count" class="text-3xl font-bold text-[var(--secondary-color)] mb-1">
            <span class="material-symbols-outlined animate-spin">progress_activity</span>
          </div>
          <div class="text-sm text-[var(--text-secondary)]">Total Materiales Subidos</div>
        </div>

        <div class="bg-white rounded-xl p-6 text-center">
          <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <span class="material-symbols-outlined text-green-600">folder_open</span>
          </div>
          <div id="total-chunks-count" class="text-3xl font-bold text-[var(--secondary-color)] mb-1">
            <span class="material-symbols-outlined animate-spin">progress_activity</span>
          </div>
          <div class="text-sm text-[var(--text-secondary)]">Total Chunks Procesados</div>
        </div>

      </div>

      <!-- Lista de materiales -->
      <div id="materials-container" class="space-y-4">
        <!-- Los materiales se cargarán dinámicamente aquí -->
        <div class="text-center py-12">
          <span
            class="material-symbols-outlined text-4xl text-[var(--accent-color)] animate-spin mb-4">progress_activity</span>
          <p class="text-[var(--text-secondary)]">Cargando materiales...</p>
        </div>
      </div>

      <!-- Paginación (oculta inicialmente) -->
      <div id="pagination" class="hidden flex justify-center items-center gap-4 mt-12"></div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {

          // === 1. MODAL BLOQUEANTE REUTILIZABLE (Moderno) ===
          window.modal = (() => {
            const root = document.getElementById('app-modal');
            if (!root) return { confirm: () => Promise.resolve(true), alert: () => Promise.resolve() };

            const overlay = root.children[0];
            const panel = root.children[1];
            const iconEl = document.getElementById('app-modal-icon');
            const titleEl = document.getElementById('app-modal-title');
            const msgEl = document.getElementById('app-modal-message');
            const okBtn = document.getElementById('app-modal-ok');
            const cancelBtn = document.getElementById('app-modal-cancel');
            let resolver = null, lastFocus = null;

            function open({ title, message, icon, hasCancel, okText, cancelText, isDanger }) {
              lastFocus = document.activeElement;
              iconEl.textContent = icon || 'warning';
              // Estilo rojo para peligro
              if (isDanger) {
                iconEl.parentElement.className = "size-14 rounded-full flex items-center justify-center mb-2 ring-1 ring-red-200 text-red-600 bg-red-50";
                okBtn.className = "px-5 py-2.5 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 transition-colors";
              } else {
                iconEl.parentElement.className = "size-14 rounded-full flex items-center justify-center mb-2 ring-1 ring-[var(--accent-color)] text-[var(--primary-color)] bg-[var(--base-white)]";
                okBtn.className = "px-5 py-2.5 rounded-lg bg-[var(--primary-color)] text-white font-bold hover:opacity-90 transition-opacity";
              }

              titleEl.textContent = title || '';
              titleEl.classList.toggle('hidden', !title);
              msgEl.textContent = message || '';
              okBtn.textContent = okText || 'Aceptar';
              cancelBtn.textContent = cancelText || 'Cancelar';
              cancelBtn.classList.toggle('hidden', !hasCancel);

              root.classList.remove('hidden');
              document.body.classList.add('overflow-hidden');
              requestAnimationFrame(() => {
                overlay.classList.add('opacity-100');
                panel.classList.add('opacity-100', 'scale-100');
              });
              okBtn.focus();
            }

            function close() {
              overlay.classList.remove('opacity-100');
              panel.classList.remove('opacity-100', 'scale-100');
              setTimeout(() => {
                root.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                if (lastFocus) lastFocus.focus();
              }, 150);
            }

            okBtn.onclick = () => { close(); if (resolver) resolver(true); };
            cancelBtn.onclick = () => { close(); if (resolver) resolver(false); };

            return {
              confirm({ title = 'Confirmar', message, icon = 'warning', okText = 'Sí', cancelText = 'Cancelar', isDanger = false } = {}) {
                return new Promise(res => {
                  resolver = (v) => res(!!v);
                  open({ title, message, icon, hasCancel: true, okText, cancelText, isDanger });
                });
              },
              alert({ title = 'Aviso', message, icon = 'warning', okText = 'Aceptar' } = {}) {
                return new Promise(res => {
                  resolver = () => res();
                  open({ title, message, icon, hasCancel: false, okText });
                });
              }
            };
          })();

          // === 2. FUNCIONES DE COMPATIBILIDAD ===
          window.showAdvancedModal = function (icon, title, description) {
            window.modal.alert({ title, message: description, icon });
          };
          window.showBackendModal = window.showAdvancedModal;
          window.closeAdvancedModal = function () { };

          // === 3. LOGOUT MÁS SEGURO ===
          window.logout = async function () {
            const confirmado = await window.modal.confirm({
              title: 'Cerrar sesión',
              message: '¿Estás seguro de que quieres cerrar tu sesión actual?',
              icon: 'logout',
              okText: 'Sí, salir'
            });
            if (confirmado) {
              localStorage.removeItem('recuiva_user');
              window.location.href = '../auth/iniciar-sesion.html';
            }
          };

          // === 4. LÓGICA DE MATERIALES ===
          async function cargarMateriales() {
            try {
              const materiales = await SupabaseOperations.getMaterials();
              renderizarMateriales(materiales);
            } catch (error) {
              console.error('❌ Error cargando materiales:', error);
            }
          }

          function renderizarMateriales(materials) {
            const container = document.getElementById('materials-container');
            if (!container) return;

            // Actualizar contadores
            const totalCount = materials.length;
            const totalChunks = materials.reduce((sum, m) => sum + (m.total_chunks || 0), 0);
            const totalMaterialesEl = document.getElementById('total-materiales-count');
            const totalChunksEl = document.getElementById('total-chunks-count');
            if (totalMaterialesEl) totalMaterialesEl.textContent = totalCount;
            if (totalChunksEl) totalChunksEl.textContent = totalChunks.toLocaleString();

            if (materials.length === 0) {
              container.innerHTML = `
                <div class="text-center py-12 bg-gray-50 rounded-lg">
                    <span class="material-symbols-outlined text-5xl text-orange-500 mb-4">inbox</span>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">No hay materiales aún</h3>
                    <p class="text-gray-600 mb-6">Sube tu primer PDF para empezar a estudiar con Active Recall</p>
                    <a href="subir-material.html" class="inline-block px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-semibold">
                        <span class="material-symbols-outlined align-middle mr-2">upload_file</span> Subir Material
                    </a>
                </div>`;
              return;
            }

            let html = '';
            materials.forEach(material => {
              let uploadDate = 'Fecha desconocida';
              try {
                if (material.created_at) {
                  uploadDate = new Date(material.created_at).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
                }
              } catch (e) { }

              const materialFileName = material.title || material.file_name || 'Material sin nombre';
              const fileStatus = material.processing_status === 'completed' ? 'ACTIVO' : 'PAUSADO';
              const statusClass = material.processing_status === 'completed' ? 'status-activo' : 'status-pausado';
              const pageCount = material.estimated_pages ? `${material.estimated_pages} páginas` : 'N/A páginas';

              html += `
                <div class="material-card p-6 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                            <span class="material-symbols-outlined text-red-600">picture_as_pdf</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-start justify-between mb-2">
                                <div>
                                    <h3 class="font-bold text-gray-900 text-lg">${materialFileName}</h3>
                                    <p class="text-sm text-gray-600">PDF • ${material.total_chunks || 0} chunks • ${pageCount} • Subido el ${uploadDate}</p>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">${fileStatus}</span>
                            </div>
                            <div class="flex gap-3 mt-4">
                                <a href="sesion-practica.html?material=${material.id}" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                                    <span class="material-symbols-outlined align-middle mr-1 text-sm">play_arrow</span> Iniciar Sesión
                                </a>
                                <button onclick="solicitarEliminacionMaterial('${material.id}')" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors">
                                    <span class="material-symbols-outlined align-middle mr-1 text-sm">delete</span> Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
          }

          // === 5. ELIMINAR MATERIAL (Nuevo Modal) ===
          window.solicitarEliminacionMaterial = async function (materialId) {
            const confirmado = await window.modal.confirm({
              title: '¿Eliminar material?',
              message: 'Se eliminará el PDF, los chunks y todo tu progreso relacionado. Esta acción no se puede deshacer.',
              icon: 'delete_forever',
              okText: 'Sí, eliminar',
              cancelText: 'Cancelar',
              isDanger: true
            });

            if (!confirmado) return;

            try {
              // Toast loading
              const loadingToast = document.createElement('div');
              loadingToast.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center animate-pulse';
              loadingToast.innerHTML = '<span class="material-symbols-outlined mr-2 animate-spin">refresh</span> Eliminando...';
              document.body.appendChild(loadingToast);

              const response = await fetch(`${API_CONFIG.BASE_URL}/api/materials/${materialId}`, {
                method: 'DELETE'
              });
              loadingToast.remove();

              if (!response.ok) throw new Error('Error backend');

              await window.modal.alert({ title: 'Eliminado', message: 'Material eliminado correctamente.', icon: 'check_circle' });
              await cargarMateriales();
            } catch (error) {
              console.error('❌ Error eliminando:', error);
              await window.modal.alert({ title: 'Error', message: 'No se pudo eliminar el material.', icon: 'error' });
            }
          };

          // Buscador
          const searchInput = document.querySelector('input[placeholder="Buscar materiales..."]');
          if (searchInput) {
            searchInput.addEventListener('input', (e) => {
              // TODO: Filtrado local
            });
          }

          cargarMateriales();
        });
      </script>

      <script>
        // Backend modal function - ACTUALIZADA CON MOCKAPI
        function showBackendModal(feature, title, description) {
          // Esta función se sobrescribe arriba en el DOMContentLoaded
        }

        // Logout function - ACTUALIZADA CON MOCKAPI  
        function logout() {
          // Esta función se sobrescribe arriba en el DOMContentLoaded
        }

        // ==========================================
        // INICIALIZAR COMPONENTES HEADER/FOOTER
        // ==========================================
        document.addEventListener('DOMContentLoaded', function () {
          initializeHeaderFooter('materiales');
        });
      </script>

      <!-- Modal bloqueante reutilizable de marca Recuiva -->
      <div id="app-modal" class="fixed inset-0 z-[9999] hidden">
        <div class="absolute inset-0 bg-black/40 opacity-0 transition-opacity"></div>
        <div class="relative mx-auto max-w-md w-[92%] top-1/2 -translate-y-1/2
              bg-white rounded-2xl shadow-2xl border border-[var(--accent-color)]
              p-6 opacity-0 scale-95 transition-all">
          <div class="flex flex-col items-center text-center">
            <div class="size-14 rounded-full flex items-center justify-center mb-2
                  ring-1 ring-[var(--accent-color)] text-red-500 bg-red-50">
              <span class="material-symbols-outlined text-4xl" id="app-modal-icon">warning</span>
            </div>
            <h3 id="app-modal-title" class="text-xl font-bold text-[var(--text-primary)] mb-1">Título</h3>
            <p id="app-modal-message" class="text-[var(--secondary-color)] mb-5">Mensaje…</p>
            <div class="flex gap-3 w-full justify-center">
              <button id="app-modal-cancel"
                class="px-5 py-2.5 rounded-lg border border-[var(--accent-color)]
                bg-white text-[var(--secondary-color)] font-semibold hidden hover:bg-gray-50 transition-colors">Cancelar</button>
              <button id="app-modal-ok" class="px-5 py-2.5 rounded-lg bg-[var(--primary-color)]
                text-white font-bold hover:opacity-90 transition-opacity">Aceptar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Container - Managed by header-footer-components.js -->
      <div id="footer-container"></div>

  </div>
</body>

</html>