<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
  <link as="style"
    href="https://fonts.googleapis.com/css2?display=swap&amp;family=Manrope%3Awght%40400%3B500%3B700%3B800&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900"
    onload="this.rel='stylesheet'" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <title>Recuiva - Home</title>
  <link rel="icon" type="image/x-icon" href="../assets/img/Icon-Recuiva.ico" />
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Supabase Auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../assets/js/supabase-config.js"></script>
  <script src="../assets/js/supabase-operations.js"></script>
  <script src="../assets/js/auth-guard.js"></script>
  <!-- Header/Footer Components -->
  <script src="../assets/js/header-footer-components.js"></script>
  <style type="text/tailwindcss">
    /* Filtro de seguridad: oculta cualquier toast/banner/snackbar por si acaso */
#toast-root, .toast, .notyf, .iziToast, .swal2-container.swal2-top, .banner, .snackbar { display:none !important; }

/* Estilo global para el logo Recuiva */
.recuiva-logo {
  font-family: 'Manrope', sans-serif !important;
  font-weight: 800 !important;
  font-size: 1.5rem !important;
}
      .drag-handle {
        @apply mr-2 text-gray-500 hover:text-gray-700;
        cursor: grab;
      }
      .dragging {
        opacity: .6;
      }
      .drop-line::after {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: #3b82f6;
      }
      .drop-line-above::after {
        top: 0;
      }
      .drop-line-below::after {
        bottom: 0;
      }
      .drop-inside {
        box-shadow: inset 0 0 0 2px rgba(59,130,246,.35);
        animation: wobble .28s ease-in-out;
      }
      @keyframes wobble {
        0% { transform: translateX(0); }
        25% { transform: translateX(1.5px); }
        50% { transform: translateX(0); }
        75% { transform: translateX(-1.5px); }
        100% { transform: translateX(0); }
      }
      /* Guía visual para árbol */
      .tree-guide {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 18px;
        border-left: 2px dashed #A5CDED;
        z-index: 0;
        pointer-events: none;
      }
      :root {
        --primary-color: #FF6600;
        --secondary-color: #004EAA;
        --accent-color: #A5CDED;
        --base-white: #FFFFFF;
        --base-gray: #F1F3F5;
        --text-primary: #181410;
        --text-secondary: #575757;
      }
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      }
      .menu-btn {
        cursor: pointer;
        transition: transform 0.3s ease;
      }
      .menu-btn:hover {
        transform: scale(1.1);
      }
      .mobile-menu {
        display: none;
        transition: all 0.3s ease;
      }
      .mobile-menu.active {
        display: flex !important;
      }
      #menu-btn.active .menu-icon {
        transform: rotate(180deg);
      }
      .profile-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        padding: 0.75rem 0;
        min-width: 14rem;
        z-index: 50;
        opacity: 0;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        pointer-events: none;
      }
      .profile-dropdown.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
      }
      .profile-dropdown a, .profile-dropdown button {
        transition: all 0.2s ease;
      }
      .profile-dropdown a:hover, .profile-dropdown button:hover {
        transform: translateX(4px);
      }
      .notification-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: var(--primary-color);
        color: white;
        border-radius: 9999px;
        font-size: 0.75rem;
        padding: 0.1rem 0.4rem;
        min-width: 1.2rem;
        text-align: center;
      }
      
      /* Modal de notificaciones mejorado - Estilo elegante */
      .notification-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      .notification-modal.show {
        opacity: 1;
        visibility: visible;
      }
      .notification-modal-content {
        background: white;
        border-radius: 1.5rem;
        padding: 2rem;
        max-width: 26rem;
        margin: 1rem;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        transform: scale(0.8) translateY(30px);
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .notification-modal.show .notification-modal-content {
        transform: scale(1) translateY(0);
      }
      .notification-icon-container {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        width: 4rem;
        height: 4rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 16px rgba(255, 102, 0, 0.3);
      }
      .notification-modal h3 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.75rem;
        text-align: center;
      }
      .notification-modal p {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #6b7280;
        text-align: center;
        margin-bottom: 2rem;
      }
      .modal-button {
        background: linear-gradient(135deg, #FF6600, #FF8533);
        color: white;
        border: none;
        border-radius: 0.75rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(255, 102, 0, 0.3);
        width: 100%;
      }
      .modal-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(255, 102, 0, 0.4);
      }
      /* Panel principal (marco azul + sombra sutil) */
      .onb-panel {
        @apply bg-white/90 backdrop-blur border border-blue-200 ring-1 ring-blue-100 rounded-3xl shadow-[0_10px_30px_rgba(0,91,204,0.08)];
      }

      /* Panel del entrenador (celeste) */
      .onb-coach {
        @apply bg-blue-50/70 border border-blue-200 ring-1 ring-blue-100 rounded-3xl shadow-[0_10px_25px_rgba(0,91,204,0.06)];
      }

      /* Chips de modalidad */
      .chip {
        @apply px-4 py-2 rounded-full font-semibold text-[var(--text-primary)] bg-[var(--base-gray)] hover:bg-[var(--accent-color)] focus:outline-none transition;
      }
      .chip.is-active {
        @apply bg-[var(--accent-color)] ring-2 ring-blue-200;
      }

      /* Tarjeta de fila del árbol */
      .row-card {
        @apply flex items-center justify-between bg-[var(--base-gray)] rounded-xl px-4 py-3 shadow;
      }
      /* Animación triángulo */
      .triangle-rotate {
        transition: transform 0.3s;
        display: inline-block;
      }
      .triangle-rotate.open {
        transform: rotate(180deg);
      }
      /* Animación subcarpetas */
      .subcarpetas-anim {
        transition: max-height 0.35s cubic-bezier(0.4,0,0.2,1), opacity 0.3s;
        overflow: hidden;
        opacity: 1;
        max-height: 1000px;
      }
      .subcarpetas-anim.closed {
        opacity: 0;
        max-height: 0;
      }
    </style>
</head>

<body class="bg-[var(--base-gray)]" style='font-family: Manrope, "Noto Sans", sans-serif;'>
  <!-- Modal bloqueante reutilizable de marca Recuiva -->
  <div id="app-modal" class="fixed inset-0 z-[9999] hidden">
    <div class="absolute inset-0 bg-black/40 opacity-0 transition-opacity"></div>
    <div class="relative mx-auto max-w-md w-[92%] top-1/2 -translate-y-1/2
              bg-white rounded-2xl shadow-2xl border border-[var(--accent-color)]
              p-6 opacity-0 scale-95 transition-all">
      <div class="flex flex-col items-center text-center">
        <div class="size-14 rounded-full flex items-center justify-center mb-2
                  ring-1 ring-[var(--accent-color)] text-[var(--primary-color)] bg-[var(--base-white)]">
          <span class="material-symbols-outlined text-4xl" id="app-modal-icon">warning</span>
        </div>
        <h3 id="app-modal-title" class="text-xl font-bold text-[var(--text-primary)] mb-1">Título</h3>
        <p id="app-modal-message" class="text-[var(--secondary-color)] mb-5">Mensaje…</p>
        <div class="flex gap-3 w-full justify-center">
          <button id="app-modal-cancel" class="px-5 py-2.5 rounded-lg border border-[var(--accent-color)]
                bg-white text-[var(--secondary-color)] font-semibold hidden">Cancelar</button>
          <button id="app-modal-ok" class="px-5 py-2.5 rounded-lg bg-[var(--primary-color)]
                text-white font-bold">Aceptar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal para agregar carpeta -->
  <div id="modal-agregar-carpeta"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-xs flex flex-col gap-4">
      <h2 class="text-lg font-bold text-[var(--secondary-color)]">Agregar carpeta</h2>
      <div class="flex flex-col gap-2" id="modal-form-group">
        <!-- Aquí se insertan chips solo si es raíz -->
        <div id="modal-modalidad-chips" class="flex flex-wrap gap-2"></div>
        <input id="modal-nombre-input" type="text"
          class="mt-2 px-3 py-2 rounded-lg border border-[var(--accent-color)] bg-[var(--base-gray)]"
          placeholder="Nombre" />
      </div>
      <div class="flex gap-2 justify-end mt-4">
        <button id="modal-cancelar-btn"
          class="px-4 py-2 rounded-full bg-gray-200 text-gray-700 font-semibold">Cancelar</button>
        <button id="modal-agregar-btn"
          class="px-4 py-2 rounded-full bg-[var(--primary-color)] text-white font-bold">Agregar</button>
      </div>
    </div>
  </div>
  <div class="relative flex size-full min-h-screen flex-col overflow-x-hidden">

    <!-- Header Universal -->
    <div id="header-container"></div>

    <main class="flex-grow w-full">
      <!-- Hero / Bienvenida -->
      <section id="inicio" class="bg-[var(--base-white)] py-8 md:py-16 lg:py-20 px-3 sm:px-4 md:px-6">
        <div class="container mx-auto max-w-[1100px]">
          <h1 id="titulo-bienvenida"
            class="text-center text-[28px] sm:text-[34px] leading-tight md:text-5xl lg:text-6xl font-extrabold text-[var(--text-primary)] tracking-tight min-h-[70px] sm:min-h-[80px] md:min-h-[100px] px-2">
            <!-- El texto se generará dinámicamente con efecto typing -->
          </h1>
          <!-- Onboarding + Entrenador alineados -->
          <div
            class="mt-6 sm:mt-8 md:mt-10 w-full grid grid-cols-1 md:grid-cols-[1fr_320px] gap-4 sm:gap-6 md:gap-8 items-start">
            <!-- Board principal (asistente de organización) -->
            <div
              class="bg-[var(--base-white)] rounded-2xl shadow-xl border border-[var(--accent-color)] p-4 sm:p-6 md:p-8">
              <h3 class="text-center text-lg sm:text-xl md:text-2xl font-bold text-[var(--secondary-color)]">
                Organización de Materiales
              </h3>
              <!-- input nombre (SIN MODALIDADES) -->
              <div class="mt-4 sm:mt-6 flex flex-col items-center px-2">
                <label for="modalidad-input" class="text-xs sm:text-sm text-[var(--text-secondary)] mb-2">Nombre de la
                  carpeta</label>
                <input id="modalidad-input" type="text"
                  class="w-full max-w-md text-center px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base rounded-lg border-2 border-[var(--accent-color)] bg-[var(--base-gray)] focus:border-[var(--primary-color)] focus:outline-none transition-colors"
                  placeholder="Ej: Anatomía, Endodoncia, Capítulo 1..." />
              </div>
              <!-- CTA agregar carpeta -->
              <div class="mt-4 sm:mt-5 flex justify-center px-2">
                <button type="button" id="agregar-carpeta-btn"
                  class="px-4 sm:px-6 py-2 sm:py-3 text-sm sm:text-base rounded-full bg-[var(--primary-color)] text-white font-bold flex items-center gap-2 hover:bg-opacity-90 shadow-lg hover:shadow-xl transition-all">
                  <span class="material-symbols-outlined" style="font-size:20px;">add</span>
                  <span class="material-symbols-outlined" style="font-size:20px;">folder</span>
                  <span>Agregar Carpeta</span>
                </button>
              </div>
              <!-- Árbol de carpetas -->
              <div id="carpetas-board" class="mt-5 sm:mt-7 px-2">
                <!-- se rellena por JS -->
              </div>
            </div>
            <!-- Panel del entrenador -->
            <aside class="bg-[var(--base-gray)] rounded-2xl p-4 sm:p-6 md:p-7 min-h-[320px] sm:min-h-[420px]">
              <div class="flex items-center gap-2 sm:gap-3 justify-center md:justify-start">
                <img src="../assets/img/Icon-Recuiva.png" alt="Avatar entrenador"
                  class="w-10 h-10 sm:w-12 sm:h-12 rounded-full border-2 border-[var(--secondary-color)]" />
                <span class="font-bold text-sm sm:text-base text-[var(--secondary-color)]">Entrenador</span>
              </div>
              <p id="entrenador-texto"
                class="mt-3 sm:mt-4 text-[var(--text-secondary)] text-xs sm:text-sm md:text-[15px] text-center md:text-left">

              </p>
            </aside>
          </div>
        </div>
      </section>

      <!-- Tarjetas inferiores -->
      <section class="py-8 sm:py-12 md:py-16 lg:py-20 px-3 sm:px-4 md:px-6 bg-[var(--base-gray)]">
        <div class="container mx-auto max-w-[1100px]">
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 sm:gap-6 md:gap-8">
            <!-- Última sesión -->
            <div class="bg-[var(--base-white)] p-4 sm:p-6 md:p-8 rounded-xl shadow-md hover-lift">
              <div class="flex items-center mb-3 sm:mb-4">
                <span
                  class="material-symbols-outlined text-2xl sm:text-3xl md:text-4xl text-[var(--secondary-color)] mr-2 sm:mr-3 md:mr-4">history</span>
                <h3 class="text-base sm:text-lg md:text-xl font-bold text-[var(--text-primary)]">Última sesión</h3>
              </div>
              <p id="last-session-text"
                class="text-sm sm:text-base text-[var(--text-secondary)] mb-3 sm:mb-4 line-clamp-3">Cargando...</p>
              <a id="last-session-link"
                class="text-sm sm:text-base text-[var(--primary-color)] font-bold hover:underline transition-colors cursor-pointer"
                href="#" onclick="validarYIrAPractica(event)">Continuar práctica →</a>
            </div>

            <!-- Progreso -->
            <a href="dashboard.html"
              class="bg-[var(--base-white)] p-4 sm:p-6 md:p-8 rounded-xl shadow-md hover-lift transition-all cursor-pointer block">
              <div class="flex items-center mb-3 sm:mb-4">
                <span
                  class="material-symbols-outlined text-2xl sm:text-3xl md:text-4xl text-[var(--secondary-color)] mr-2 sm:mr-3 md:mr-4">trending_up</span>
                <h3 class="text-base sm:text-lg md:text-xl font-bold text-[var(--text-primary)]">Tu progreso</h3>
              </div>
              <div class="flex justify-around text-center gap-2">
                <div>
                  <p id="progress-retention"
                    class="text-xl sm:text-2xl md:text-3xl font-bold text-[var(--primary-color)]">--</p>
                  <p class="text-[var(--text-secondary)] text-xs sm:text-sm">Retención</p>
                </div>
                <div>
                  <p id="progress-streak" class="text-xl sm:text-2xl md:text-3xl font-bold text-[var(--primary-color)]">
                    -- <span class="text-xs sm:text-sm md:text-lg">días</span></p>
                  <p class="text-[var(--text-secondary)] text-xs sm:text-sm">Racha</p>
                </div>
              </div>
            </a>

            <!-- Temas a repasar -->
            <a href="repasos.html"
              class="bg-[var(--base-white)] p-4 sm:p-6 md:p-8 rounded-xl shadow-md hover-lift transition-all cursor-pointer block sm:col-span-2 md:col-span-1">
              <div class="flex items-center mb-3 sm:mb-4">
                <span
                  class="material-symbols-outlined text-2xl sm:text-3xl md:text-4xl text-[var(--secondary-color)] mr-2 sm:mr-3 md:mr-4">psychology_alt</span>
                <h3 class="text-base sm:text-lg md:text-xl font-bold text-[var(--text-primary)]">Temas a repasar</h3>
              </div>
              <ul id="review-topics-list"
                class="space-y-1 sm:space-y-2 text-xs sm:text-sm text-[var(--text-secondary)]">
                <li>Cargando...</li>
              </ul>
              <span
                class="text-sm sm:text-base text-[var(--primary-color)] font-bold hover:underline mt-2 sm:mt-3 inline-block transition-colors">Ver
                sugerencias →</span>
            </a>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer Universal -->
    <div id="footer-container"></div>

  </div>

  <!-- Inicializar componentes al cargar -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Inicializar header y footer
      initializeHeaderFooter('inicio');

      // El resto del código JavaScript del dashboard continúa aquí...
    });
  </script>

  <script>
    // Modal bloqueante reutilizable de marca Recuiva
    window.modal = (() => {
      const root = document.getElementById('app-modal');
      const overlay = root.children[0];
      const panel = root.children[1];
      const iconEl = document.getElementById('app-modal-icon');
      const titleEl = document.getElementById('app-modal-title');
      const msgEl = document.getElementById('app-modal-message');
      const okBtn = document.getElementById('app-modal-ok');
      const cancelBtn = document.getElementById('app-modal-cancel');
      let resolver = null, lastFocus = null;
      function open({ title, message, icon, hasCancel, okText, cancelText }) {
        lastFocus = document.activeElement;
        iconEl.textContent = icon || 'warning';
        titleEl.textContent = title || '';
        titleEl.classList.toggle('hidden', !title);
        msgEl.textContent = message || '';
        okBtn.textContent = okText || 'Aceptar';
        cancelBtn.textContent = cancelText || 'Cancelar';
        cancelBtn.classList.toggle('hidden', !hasCancel);
        root.classList.remove('hidden'); document.body.classList.add('overflow-hidden');
        requestAnimationFrame(() => { overlay.classList.add('opacity-100'); panel.classList.add('opacity-100', 'scale-100'); });
        okBtn.focus();
      }
      function close() {
        overlay.classList.remove('opacity-100'); panel.classList.remove('opacity-100', 'scale-100');
        setTimeout(() => { root.classList.add('hidden'); document.body.classList.remove('overflow-hidden'); lastFocus?.focus(); }, 150);
      }
      okBtn.onclick = () => { close(); resolver?.(true); };
      cancelBtn.onclick = () => { close(); resolver?.(false); };
      overlay.onclick = (e) => e.stopPropagation();
      window.addEventListener('keydown', e => { if (!root.classList.contains('hidden')) e.preventDefault(); }, true);
      return {
        alert({ title = 'Aviso', message, icon = 'warning', okText = 'Aceptar' } = {}) {
          return new Promise(res => { resolver = () => res(); open({ title, message, icon, hasCancel: false, okText }); });
        },
        confirm({ title = 'Confirmar', message, icon = 'warning', okText = 'Sí', cancelText = 'Cancelar' } = {}) {
          return new Promise(res => { resolver = (v) => res(!!v); open({ title, message, icon, hasCancel: true, okText, cancelText }); });
        }
      };
    })();
    // Centrar texto del panel entrenador solo en móvil
    function centrarEntrenadorTexto() {
      const txt = document.getElementById('entrenador-texto');
      if (window.innerWidth < 768) {
        txt.classList.add('text-center');
      } else {
        txt.classList.remove('text-center');
      }
    }
    window.addEventListener('resize', centrarEntrenadorTexto);
    centrarEntrenadorTexto();

    // 🔥 TYPING ANIMATION PARA ENTRENADOR (2 segundos después del bienvenido)
    setTimeout(() => {
      const textoEntrenador = '"Organiza tu material creando carpetas. Sube PDFs, crea preguntas con Active Recall y practica con repetición espaciada."';
      const elemento = document.getElementById('entrenador-texto');
      let index = 0;

      function escribir() {
        if (index < textoEntrenador.length) {
          elemento.textContent += textoEntrenador.charAt(index);
          index++;
          setTimeout(escribir, 30); // Velocidad igual al bienvenido
        }
      }
      escribir();
    }, 2000);

    // === FUNCIONES MODALES DE MATERIAL (SCOPE GLOBAL) ===
    function mostrarModalMaterial(carpetaId, carpetaNombre, modalidad = '') {
      // Actualizar carpeta activa en el header
      if (typeof window.actualizarCarpetaActiva === 'function') {
        window.actualizarCarpetaActiva(carpetaNombre, modalidad);
      }

      const modalMaterial = `
    <div id="modal-material" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-carpeta-id="${carpetaId}" data-carpeta-nombre="${carpetaNombre}">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
          Agregar Material - ${carpetaNombre}
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ¿Cómo vas a estudiar este tema?
        </p>
        <div class="space-y-4">
          <button onclick="seleccionarMaterial('pdf')" 
                  class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-[var(--primary-color)]">picture_as_pdf</span>
              <div>
                <div class="font-semibold">Tengo PDF o imágenes</div>
                <div class="text-sm text-[var(--text-secondary)]">Subiré material digital</div>
              </div>
            </div>
          </button>
          <button onclick="seleccionarMaterial('fisico')" 
                  class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-[var(--primary-color)]">menu_book</span>
              <div>
                <div class="font-semibold">Solo tengo libro físico</div>
                <div class="text-sm text-[var(--text-secondary)]">Usaré mi "espejo de memoria"</div>
              </div>
            </div>
          </button>
          <button onclick="seleccionarMaterial('sin-material')" 
                  class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
            <div class="flex items-center gap-3">
              <span class="material-symbols-outlined text-[var(--primary-color)]">psychology</span>
              <div>
                <div class="font-semibold">Empezar sin material</div>
                <div class="text-sm text-[var(--text-secondary)]">Solo mis conocimientos previos</div>
              </div>
            </div>
          </button>
        </div>
        <div class="flex gap-3 mt-6">
          <button onclick="cerrarModalMaterial()" 
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalMaterial);
    }

    function seleccionarMaterial(tipo) {
      alert('¡Funcionando! Tipo: ' + tipo); // DEBUG - quitar después

      const modal = document.getElementById('modal-material');
      if (!modal) {
        alert('Modal no encontrado!');
        return;
      }

      const carpetaId = modal.dataset.carpetaId;
      const carpetaNombre = modal.dataset.carpetaNombre;

      console.log('Seleccionando material:', tipo, carpetaId, carpetaNombre);

      cerrarModalMaterial();

      if (tipo === 'pdf') {
        // Usuario tiene PDF/imágenes → ir a subir material
        window.location.href = `app/subir-material.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&tipo=pdf`;
      } else if (tipo === 'fisico') {
        // Usuario solo tiene libro físico → modal explicativo y luego a crear pregunta
        mostrarModalLibroFisico(carpetaId, carpetaNombre);
      } else {
        // Usuario no tiene material → directo a modal bienvenida
        mostrarModalBienvenida(carpetaId, carpetaNombre);
      }
    }

    function cerrarModalMaterial() {
      const modal = document.getElementById('modal-material');
      if (modal) modal.remove();
    }

    // Modal específico para libro físico
    function mostrarModalLibroFisico(carpetaId, carpetaNombre) {
      const modalLibro = `
    <div id="modal-libro-fisico" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
        <div class="text-center mb-6">
          <div class="text-6xl mb-4">📚</div>
          <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-2">
            Perfecto, usarás tu libro físico
          </h3>
          <p class="text-[var(--text-secondary)]">
            ${carpetaNombre} - Modo "Espejo de Memoria"
          </p>
        </div>
        
        <div class="bg-[var(--base-gray)] p-4 rounded-lg mb-6">
          <h4 class="font-bold text-[var(--secondary-color)] mb-2">🧠 ¿Cómo funciona el "Espejo de Memoria"?</h4>
          <ul class="text-sm text-[var(--text-secondary)] space-y-2">
            <li>• <strong>Crearás preguntas</strong> basadas en tu libro</li>
            <li>• <strong>Escribirás lo que recuerdas</strong> sin mirar el libro</li>
            <li>• <strong>Después verificarás</strong> con tu libro físico</li>
            <li>• <strong>Recuiva medirá tu evolución</strong> en cada sesión</li>
          </ul>
        </div>

        <div class="text-center">
          <p class="text-[var(--text-secondary)] mb-6">
            ¿Listo para crear tu primera pregunta de ${carpetaNombre}?
          </p>
          
          <div class="space-y-3">
            <button onclick="crearPrimeraPreguntaLibro('${carpetaId}', '${carpetaNombre}')"
                    class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
              📝 Crear Primera Pregunta
            </button>
            <button onclick="cerrarModalLibroFisico()"
                    class="w-full text-[var(--text-secondary)] py-2">
              Volver atrás
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalLibro);
    }

    function cerrarModalLibroFisico() {
      const modal = document.getElementById('modal-libro-fisico');
      if (modal) modal.remove();
    }

    function crearPrimeraPreguntaLibro(carpetaId, carpetaNombre) {
      cerrarModalLibroFisico();
      // Ir directo a crear primera pregunta para libro físico
      mostrarModalPrimeraPregunta(carpetaId, carpetaNombre, 'fisico');
    }

    // Modal para crear primera pregunta (scope global)
    function mostrarModalPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
      const modalPregunta = `
    <div id="modal-pregunta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
        <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
          Primera Pregunta - ${carpetaNombre}
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${tipoMaterial === 'fisico' ?
          '📚 Crea una pregunta basada en tu libro físico:' :
          'Crea tu primera pregunta para practicar Active Recall:'}
        </p>
        
        <div class="mb-4">
          <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
            Tu pregunta:
          </label>
          <input id="input-pregunta" type="text" 
                 class="w-full p-3 border border-[var(--accent-color)] rounded-lg" 
                 placeholder="Ej: ¿Qué es la necrosis pulpar?">
          <div class="text-sm text-[var(--text-secondary)] mt-1">
            💡 Evita preguntas sí/no. Usa: ¿qué?, ¿cómo?, ¿por qué?
          </div>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
            Tu autorrespuesta inicial ("espejo de memoria"):
          </label>
          <textarea id="input-autorrespuesta" 
                    class="w-full p-3 border border-[var(--accent-color)] rounded-lg h-24" 
                    placeholder="${tipoMaterial === 'fisico' ?
          'Escribe lo que recuerdas SIN mirar tu libro...' :
          'Escribe lo que crees recordar sobre esta pregunta...'}"></textarea>
          <div class="text-sm text-[var(--text-secondary)] mt-1">
            ${tipoMaterial === 'fisico' ?
          '📖 Después podrás verificar con tu libro físico' :
          'Esto será tu referencia base para medir tu evolución'}
          </div>
        </div>

        <div class="flex gap-3">
          <button onclick="cerrarModalPregunta()" 
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
            Cancelar
          </button>
          <button onclick="guardarPrimeraPregunta('${carpetaId}', '${carpetaNombre}', '${tipoMaterial}')" 
                  class="flex-1 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
            Crear Pregunta
          </button>
        </div>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalPregunta);

      // Focus en el input
      setTimeout(() => {
        document.getElementById('input-pregunta')?.focus();
      }, 100);
    }

    function cerrarModalPregunta() {
      const modal = document.getElementById('modal-pregunta');
      if (modal) modal.remove();
    }

    function guardarPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
      const pregunta = document.getElementById('input-pregunta')?.value.trim();
      const autorrespuesta = document.getElementById('input-autorrespuesta')?.value.trim();

      if (!pregunta) {
        alert('Por favor, escribe una pregunta');
        return;
      }

      if (!autorrespuesta) {
        alert('Por favor, escribe tu autorrespuesta inicial');
        return;
      }

      // Guardar en localStorage (simulación)
      const preguntaData = {
        id: Date.now(),
        carpetaId: carpetaId,
        carpetaNombre: carpetaNombre,
        pregunta: pregunta,
        autorrespuesta: autorrespuesta,
        tipoMaterial: tipoMaterial,
        fechaCreacion: new Date().toISOString(),
        sesiones: []
      };

      // Guardar pregunta
      const preguntas = JSON.parse(localStorage.getItem('recuiva_preguntas') || '[]');
      preguntas.push(preguntaData);
      localStorage.setItem('recuiva_preguntas', JSON.stringify(preguntas));

      cerrarModalPregunta();

      // Mostrar modal de éxito específico para libro físico
      if (tipoMaterial === 'fisico') {
        mostrarModalExitoLibro(carpetaId, carpetaNombre);
      } else {
        mostrarModalExito(carpetaId, carpetaNombre);
      }
    }

    function mostrarModalExitoLibro(carpetaId, carpetaNombre) {
      const modalExito = `
    <div id="mensaje-exito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">🎉</div>
        <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
          ¡Primera pregunta creada!
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${carpetaNombre} está listo para Active Recall con tu libro físico. 📚
        </p>
        <div class="bg-[var(--base-gray)] p-4 rounded-lg mb-6 text-left">
          <h4 class="font-bold text-[var(--secondary-color)] mb-2">📖 Recuerda:</h4>
          <p class="text-sm text-[var(--text-secondary)]">
            En cada sesión responderás primero de memoria, y después verificarás con tu libro.
          </p>
        </div>
        <div class="space-y-3">
          <button onclick="irAPractica()" 
                  class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
            🧠 Empezar Primera Sesión
          </button>
          <button onclick="cerrarModalExito()" 
                  class="w-full text-[var(--text-secondary)] py-2">
            Volver al Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalExito);
    }

    function mostrarModalExito(carpetaId, carpetaNombre) {
      const modalExito = `
    <div id="mensaje-exito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">🎉</div>
        <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
          ¡Primera pregunta creada!
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${carpetaNombre} está listo para Active Recall. ¿Empezamos a practicar?
        </p>
        <div class="space-y-3">
          <button onclick="irAPractica()" 
                  class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
            🧠 Empezar Sesión de Práctica
          </button>
          <button onclick="cerrarModalExito()" 
                  class="w-full text-[var(--text-secondary)] py-2">
            Volver al Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalExito);
    }

    function cerrarModalExito() {
      const modal = document.getElementById('mensaje-exito');
      if (modal) modal.remove();
    }

    function irAPractica() {
      window.location.href = 'app/sesion-practica.html';
    }

    function mostrarModalBienvenida(carpetaId, carpetaNombre) {
      const modalBienvenida = `
    <div id="modal-bienvenida" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
        <div class="text-6xl mb-4">🎉</div>
        <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
          ¡Perfecto!
        </h3>
        <p class="text-[var(--text-secondary)] mb-6">
          ${carpetaNombre} está listo. ¿Qué quieres hacer ahora?
        </p>
        <div class="space-y-3">
          <button onclick="iniciarSesionPractica('${carpetaId}', '${carpetaNombre}')"
                  class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
            🧠 Empezar a Practicar
          </button>
          <button onclick="verMateriales('${carpetaId}')"
                  class="w-full border border-[var(--secondary-color)] text-[var(--secondary-color)] py-3 px-6 rounded-lg font-semibold hover:bg-gray-50 transition-all">
            📚 Ver Mis Materiales
          </button>
          <button onclick="cerrarModalBienvenida()"
                  class="w-full text-[var(--text-secondary)] py-2">
            Volver al Dashboard
          </button>
        </div>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalBienvenida);
    }

    function iniciarSesionPractica(carpetaId, carpetaNombre) {
      cerrarModalBienvenida();
      window.location.href = `app/sesion-practica.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&inicio=true`;
    }

    function verMateriales(carpetaId) {
      cerrarModalBienvenida();
      window.location.href = `app/materiales.html?carpeta=${carpetaId}&vista=carpeta`;
    }

    function cerrarModalBienvenida() {
      const modal = document.getElementById('modal-bienvenida');
      if (modal) modal.remove();
    }

    // --- SISTEMA DE VALIDACIÓN DE CONFIGURACIÓN (GLOBAL) ---

    /**
     * Verifica si el usuario ha configurado carpeta, material y preguntas
     * @returns {object} { valido: boolean, razon: string }
     */
    window.validarConfiguracion = function () {
      // 1. Verificar si existe al menos una carpeta configurada
      let tieneCarpetas = false;

      // Verificar en localStorage
      const carpetasGuardadas = localStorage.getItem('recuiva_carpetas');
      if (carpetasGuardadas) {
        try {
          const parsed = JSON.parse(carpetasGuardadas);
          tieneCarpetas = parsed && parsed.length > 0;
        } catch (e) {
          tieneCarpetas = false;
        }
      }

      if (!tieneCarpetas) {
        return {
          valido: false,
          razon: 'carpeta',
          mensaje: 'Primero debes crear una carpeta (Semestre, Curso, Tema, etc.)'
        };
      }

      // 2. Verificar si tiene preguntas creadas
      const preguntas = JSON.parse(localStorage.getItem('recuiva_preguntas') || '[]');

      if (!preguntas || preguntas.length === 0) {
        return {
          valido: false,
          razon: 'preguntas',
          mensaje: 'Necesitas crear al menos una pregunta para practicar'
        };
      }

      // Todo está listo para practicar
      return {
        valido: true,
        razon: 'completo',
        mensaje: 'Configuración completa'
      };
    };

    /**
     * Muestra un modal cuando el usuario intenta acceder a práctica sin configurar
     */
    window.mostrarModalAdvertenciaPractica = function (validacion) {
      const razon = validacion?.razon || 'carpeta';

      let pasos = '';
      let titulo = '¡Espera un momento!';
      let descripcion = 'Antes de practicar, necesitas configurar tu material de estudio';

      if (razon === 'carpeta') {
        titulo = 'Configura tu primera carpeta';
        descripcion = 'Para comenzar a practicar, primero debes crear una carpeta de estudio';
        pasos = `
      <ol class="text-sm text-[var(--text-secondary)] space-y-2 ml-1">
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">1.</span>
          <span><strong>Organiza tus carpetas</strong> de estudio</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">2.</span>
          <span>Dale un <strong>nombre</strong> a tu carpeta</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">3.</span>
          <span>Haz clic en <strong>"+ Agregar carpeta"</strong></span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">4.</span>
          <span>Haz clic en <strong>"Entrar"</strong> en la carpeta creada</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">5.</span>
          <span>Selecciona tu tipo de material y crea una pregunta</span>
        </li>
      </ol>
    `;
      } else if (razon === 'preguntas') {
        titulo = 'Crea tu primera pregunta';
        descripcion = 'Ya tienes una carpeta, ahora necesitas crear al menos una pregunta para practicar';
        pasos = `
      <ol class="text-sm text-[var(--text-secondary)] space-y-2 ml-1">
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">1.</span>
          <span>Haz clic en el botón <strong>"Entrar"</strong> de tu carpeta</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">2.</span>
          <span>Selecciona tu <strong>tipo de material</strong> (PDF, libro físico, o sin material)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">3.</span>
          <span>Crea tu <strong>primera pregunta</strong> con su respuesta</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="font-bold text-[var(--primary-color)]">4.</span>
          <span>¡Listo! Ya podrás <strong>empezar a practicar</strong></span>
        </li>
      </ol>
    `;
      }

      const modalAdvertencia = `
    <div id="modal-advertencia-practica" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
      <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border border-[var(--accent-color)]">
        <div class="text-center mb-6">
          <div class="size-16 rounded-full flex items-center justify-center mx-auto mb-4
                      ring-2 ring-[var(--primary-color)] bg-orange-50">
            <span class="material-symbols-outlined text-5xl text-[var(--primary-color)]">warning</span>
          </div>
          <h3 class="text-2xl font-bold text-[var(--text-primary)] mb-2">
            ${titulo}
          </h3>
          <p class="text-[var(--text-secondary)]">
            ${descripcion}
          </p>
        </div>
        
        <div class="bg-[var(--base-gray)] p-4 rounded-xl mb-6">
          <h4 class="font-bold text-[var(--secondary-color)] mb-3 flex items-center gap-2">
            <span class="material-symbols-outlined">checklist</span>
            Pasos para comenzar:
          </h4>
          ${pasos}
        </div>

        <button onclick="cerrarModalAdvertenciaPractica()" 
                class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-bold 
                       hover:bg-opacity-90 transition-all shadow-lg">
          Entendido, voy a configurar
        </button>
      </div>
    </div>
  `;
      document.body.insertAdjacentHTML('beforeend', modalAdvertencia);
    };

    /**
     * Cierra el modal de advertencia
     */
    window.cerrarModalAdvertenciaPractica = function () {
      const modal = document.getElementById('modal-advertencia-practica');
      if (modal) modal.remove();
    };

    /**
     * Función global para validar y redirigir a práctica
     * Úsala en los enlaces: onclick="validarYIrAPractica(event)"
     */
    window.validarYIrAPractica = function (event) {
      if (event) event.preventDefault();

      const validacion = window.validarConfiguracion();
      if (!validacion.valido) {
        window.mostrarModalAdvertenciaPractica(validacion);
        return false;
      }

      window.location.href = 'app/sesion-practica.html';
      return true;
    };

    document.addEventListener('DOMContentLoaded', () => {

      // === FUNCIONES MODALES BACKEND MEJORADAS ===
      window.showBackendModal = function (icon, title, description) {
        showAdvancedModal(icon, title, description);
      };

      // Modal avanzado con mejor UX
      window.showAdvancedModal = function (icon, title, description) {
        // Crear modal si no existe
        let modal = document.getElementById('advanced-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'advanced-modal';
          modal.className = 'notification-modal';
          modal.innerHTML = `
        <div class="notification-modal-content">
          <div class="notification-icon-container">
            <span class="material-symbols-outlined text-2xl text-white" id="modal-icon">notifications</span>
          </div>
          <h3 id="modal-title">� Notificaciones</h3>
          <p id="modal-description">Sistema de notificaciones en tiempo real para repasos, recordatorios y actualizaciones de progreso. Requiere conexión con servidor. Por ahora puedes explorar la funcionalidad simulada. En la versión completa con backend, esto funcionará en tiempo real.</p>
          <button onclick="closeAdvancedModal()" class="modal-button">
            Aceptar
          </button>
        </div>
      `;
          document.body.appendChild(modal);

          // Cerrar con escape
          document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && modal.classList.contains('show')) {
              closeAdvancedModal();
            }
          });

          // Cerrar clickeando fuera
          modal.addEventListener('click', function (e) {
            if (e.target === modal) {
              closeAdvancedModal();
            }
          });
        }

        // Actualizar contenido
        const iconMap = {
          'notifications': '🔔',
          'settings': '⚙️',
          'dashboard': '📊',
          'analytics': '📈'
        };

        document.getElementById('modal-icon').textContent = icon;
        document.getElementById('modal-title').textContent = `${iconMap[icon] || '📋'} ${title}`;
        document.getElementById('modal-description').textContent = description;

        // Mostrar modal con animación
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      };

      window.closeAdvancedModal = function () {
        const modal = document.getElementById('advanced-modal');
        if (modal) {
          modal.classList.remove('show');
          document.body.style.overflow = '';
        }
      };

      // === FUNCIONES NAVEGACIÓN ===

      // Función para limpiar datos locales (reemplaza logout)
      window.limpiarDatos = function () {
        if (confirm('⚠️ ¿Estás seguro?\n\nSe borrarán todas tus carpetas, preguntas y progreso guardados.\n\nEsta acción no se puede deshacer.')) {
          localStorage.clear();
          alert('✅ Datos locales eliminados correctamente.');
          window.location.reload();
        }
      };

      // Función para mostrar configuración (placeholder)
      window.mostrarConfiguracion = function () {
        showAdvancedModal('settings', 'Configuración', 'Aquí podrás ajustar preferencias del sistema, exportar/importar datos, y personalizar tu experiencia de estudio.');
      };

      // Función para actualizar carpeta activa en el header
      window.actualizarCarpetaActiva = function (nombre, tipo) {
        const displayDesktop = document.getElementById('carpeta-activa-nombre');
        const displayMobile = document.getElementById('carpeta-activa-nombre-mobile');
        const textoCompleto = tipo ? `${nombre} (${tipo})` : nombre;

        if (displayDesktop) displayDesktop.textContent = textoCompleto;
        if (displayMobile) displayMobile.textContent = textoCompleto;

        // Guardar en localStorage para persistencia
        localStorage.setItem('recuiva_carpeta_activa', JSON.stringify({ nombre, tipo }));
      };

      // Cargar carpeta activa al iniciar
      const carpetaActiva = localStorage.getItem('recuiva_carpeta_activa');
      if (carpetaActiva) {
        try {
          const { nombre, tipo } = JSON.parse(carpetaActiva);
          window.actualizarCarpetaActiva(nombre, tipo);
        } catch (e) {
          console.log('No hay carpeta activa guardada');
        }
      }

      // === DRAG & DROP HELPERS ===
      function findNodeById(id, nodes, parent = null) {
        for (let i = 0; i < nodes.length; i++) {
          if (nodes[i].id === id) return { node: nodes[i], parent, index: i };
          if (nodes[i].subcarpetas && nodes[i].subcarpetas.length) {
            const res = findNodeById(id, nodes[i].subcarpetas, nodes[i]);
            if (res) return res;
          }
        }
        return null;
      }

      // 🔥 CONSTRUIR RUTA BREADCRUMB (camino completo desde raíz)
      function construirRutaBreadcrumb(carpetaId) {
        const ruta = [];
        function buscarRuta(id, nodes, camino = []) {
          for (const node of nodes) {
            const nuevoCamino = [...camino, node.nombre];
            if (node.id === id) {
              ruta.push(...nuevoCamino);
              return true;
            }
            if (node.subcarpetas && node.subcarpetas.length > 0) {
              if (buscarRuta(id, node.subcarpetas, nuevoCamino)) {
                return true;
              }
            }
          }
          return false;
        }
        buscarRuta(carpetaId, carpetas);
        return ruta;
      }

      function removeNode(id) {
        const found = findNodeById(id, carpetas);
        if (!found) return null;
        const { parent, index } = found;
        let arr = parent ? parent.subcarpetas : carpetas;
        const [node] = arr.splice(index, 1);
        return { node, fromParent: parent };
      }
      function insertNode(node, toParent, atIndex) {
        let arr = toParent ? toParent.subcarpetas : carpetas;
        arr.splice(atIndex, 0, node);
      }
      function moveNode(nodeId, destParentId, destIndex) {
        const removed = removeNode(nodeId);
        if (!removed) return;
        let node = removed.node;
        if (destParentId) {
          const dest = findNodeById(destParentId, carpetas);
          if (dest) {
            node.modalidad = dest.node.modalidad;
            dest.node._expand = true;
            insertNode(node, dest.node, destIndex);
          }
        } else {
          insertNode(node, null, destIndex);
        }
      }
      // --- Modal para agregar carpeta/subcarpeta ---
      function abrirModalAgregar(callback, esRaiz = false) {
        const modal = document.getElementById('modal-agregar-carpeta');
        const nombreInput = document.getElementById('modal-nombre-input');
        const agregarBtn = document.getElementById('modal-agregar-btn');
        const cancelarBtn = document.getElementById('modal-cancelar-btn');
        const chipsDiv = document.getElementById('modal-modalidad-chips');

        // Limpiar input y chips
        nombreInput.value = '';
        chipsDiv.innerHTML = '';

        // Ya no mostramos chips de modalidad - sistema simplificado

        modal.classList.remove('hidden');

        function cerrarModal() {
          modal.classList.add('hidden');
          agregarBtn.onclick = null;
          cancelarBtn.onclick = null;
        }

        agregarBtn.onclick = async () => {
          const nombre = nombreInput.value.trim();
          if (!nombre) {
            await modal.alert({ message: 'Escribe el nombre de la carpeta.' });
            return;
          }
          // Sistema simplificado - sin modalidad
          cerrarModal();
          callback({ nombre, modalidad: null });
        };
        cancelarBtn.onclick = cerrarModal;
        // Cerrar con Escape
        modal.onkeydown = (e) => {
          if (e.key === 'Escape') cerrarModal();
        };
        nombreInput.focus();
      }

      // --- Onboarding jerárquico en un solo board CON PERSISTENCIA ---
      let carpetas = [];

      // 🔥 CARGAR CARPETAS DESDE SUPABASE AL INICIO
      async function cargarCarpetasDesdeSupabase() {
        console.log('🔍 CARGANDO CARPETAS DESDE SUPABASE...');
        try {
          const folders = await SupabaseOperations.getFolders();

          // Convertir estructura de Supabase a estructura local
          carpetas = folders.map(folder => ({
            id: folder.id,
            nombre: folder.name,
            parent_id: folder.parent_folder_id,
            subcarpetas: [],
            _expand: false,
            color: folder.color,
            icon: folder.icon
          }));

          // Organizar en estructura jerárquica
          const carpetasMap = new Map();
          carpetas.forEach(c => carpetasMap.set(c.id, c));

          const raices = [];
          carpetas.forEach(c => {
            if (c.parent_id) {
              const parent = carpetasMap.get(c.parent_id);
              if (parent) {
                parent.subcarpetas.push(c);
              }
            } else {
              raices.push(c);
            }
          });

          carpetas = raices;
          console.log('� Carpetas cargadas desde Supabase:', carpetas.length);
          renderTree();
        } catch (error) {
          console.error('❌ Error al cargar carpetas:', error);
          carpetas = [];
        }
      }

      // 🔥 GUARDAR CARPETA EN SUPABASE
      async function guardarCarpetaEnSupabase(nombre, parentId = null, options = {}) {
        try {
          console.log('💾 GUARDANDO CARPETA EN SUPABASE...');
          console.log('   • Nombre:', nombre);
          console.log('   • Parent ID:', parentId);

          const folder = await SupabaseOperations.createFolder(nombre, parentId, options);
          console.log('✅ Carpeta guardada en Supabase:', folder);

          // SPRINT 2: Crear tópico asociado a la carpeta
          try {
            const token = localStorage.getItem('sb-access-token');
            const response = await fetch(`${API_BASE_URL}/api/topics`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                name: nombre,
                description: `Tópico asociado a la carpeta: ${nombre}`,
                folder_id: folder.id
              })
            });

            if (response.ok) {
              const topic = await response.json();
              console.log('✅ Tópico creado y asociado a carpeta:', topic);
              // Guardar relación carpeta-tópico en localStorage para acceso rápido
              localStorage.setItem(`folder_topic_${folder.id}`, topic.id);
            }
          } catch (topicError) {
            console.warn('⚠️ Error creando tópico (no crítico):', topicError);
            // No fallar si no se puede crear el tópico, la carpeta ya está creada
          }

          return folder;
        } catch (error) {
          console.error('❌ Error al guardar carpeta:', error);
          throw error;
        }
      }

      // Elementos
      const modalidadInput = document.getElementById('modalidad-input');

      // Helpers para IDs únicas
      function genId() {
        if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
        return 'id-' + Math.random().toString(36).substr(2, 9);
      }

      // Renderiza el árbol completo estilo Anki
      function renderTree() {
        const root = document.getElementById('carpetas-board');
        root.innerHTML = '';
        root.appendChild(renderLevel(carpetas, 0, null));
      }

      function renderLevel(level, depth, parentRef) {
        const frag = document.createDocumentFragment();
        level.forEach(carpeta => {
          frag.appendChild(buildRow(carpeta, depth, parentRef));
          if (carpeta._expand && carpeta.subcarpetas && carpeta.subcarpetas.length) {
            frag.appendChild(renderLevel(carpeta.subcarpetas, depth + 1, carpeta));
          }
        });
        return frag;
      }

      function buildRow(carpeta, depth, parentRef) {
        const fila = document.createElement('div');
        fila.className = 'flex items-center justify-between bg-[var(--base-gray)] rounded-xl px-4 py-3 shadow relative';
        fila.style.marginLeft = `${depth * 32}px`;
        fila.setAttribute('draggable', 'true');
        // Guía visual
        if (depth > 0) {
          const guia = document.createElement('div');
          guia.className = 'tree-guide';
          guia.style.left = '-18px';
          fila.appendChild(guia);
        }
        // Drag handle
        const handle = document.createElement('span');
        handle.className = 'material-symbols-outlined drag-handle select-none';
        handle.textContent = 'drag_indicator';
        handle.title = 'Arrastrar para reordenar';
        let dragFromHandle = false;
        handle.addEventListener('mousedown', () => dragFromHandle = true);
        // Triángulo (solo si hay hijos)
        const hasKids = carpeta.subcarpetas && carpeta.subcarpetas.length > 0;
        const nombreSpan = document.createElement('span');
        nombreSpan.className = 'font-bold text-[var(--secondary-color)] flex items-center';
        nombreSpan.prepend(handle);
        if (hasKids) {
          const toggle = document.createElement('button');
          toggle.className = 'px-1 py-1 mr-2 rounded-full bg-white border border-[var(--accent-color)]';
          toggle.title = carpeta._expand ? 'Colapsar' : 'Expandir';
          toggle.innerHTML = `<span class="material-symbols-outlined triangle-rotate${carpeta._expand ? ' open' : ''}" style="font-size:20px;vertical-align:middle;">expand_more</span>`;
          toggle.onclick = (e) => { e.stopPropagation(); carpeta._expand = !carpeta._expand; renderTree(); };
          toggle.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle.click(); } };
          nombreSpan.appendChild(toggle);
        }
        const folderIcon = document.createElement('span');
        folderIcon.className = 'material-symbols-outlined mr-1';
        folderIcon.style = 'font-size:22px;color:var(--secondary-color);vertical-align:middle;';
        folderIcon.textContent = 'folder';
        nombreSpan.appendChild(folderIcon);
        // etiqueta de modalidad solo en raíz
        const isRoot = !parentRef;
        const label = carpeta.nombre + (isRoot && carpeta.modalidad ? ` <span class="text-xs text-gray-500 ml-2">(${carpeta.modalidad})</span>` : '');
        nombreSpan.insertAdjacentHTML('beforeend', label);
        const acciones = document.createElement('div');
        acciones.className = 'flex gap-2';
        const entrar = document.createElement('button');
        entrar.className = 'px-4 py-2 rounded-full bg-[var(--primary-color)] text-white font-bold hover:bg-opacity-90';
        entrar.title = 'Entrar';
        entrar.textContent = 'Entrar';
        entrar.onclick = () => {
          // 🔥 GUARDAR RUTA ACTIVA (breadcrumb trail)
          const rutaCompleta = construirRutaBreadcrumb(carpeta.id);
          const rutaActiva = {
            carpetaId: carpeta.id,
            carpetaNombre: carpeta.nombre,
            carpetas: rutaCompleta,
            timestamp: new Date().toISOString()
          };
          localStorage.setItem('recuiva_active_path', JSON.stringify(rutaActiva));
          console.log('📍 Ruta activa guardada:', rutaCompleta.join(' › '));

          // 🚀 REDIRECCIÓN DIRECTA A SUBIR MATERIAL (sin modal)
          window.location.href = `subir-material.html?carpeta=${encodeURIComponent(carpeta.id)}&nombre=${encodeURIComponent(carpeta.nombre)}`;
        };
        const add = document.createElement('button');
        add.className = 'px-3 py-2 rounded-full bg-blue-100 border border-blue-300 text-[var(--secondary-color)] font-semibold flex items-center';
        add.title = 'Agregar subcarpeta';
        add.innerHTML = `<span class="material-symbols-outlined mr-1" style="font-size:20px;">add</span><span class="material-symbols-outlined" style="font-size:20px;">folder</span>`;
        add.onclick = () => {
          abrirModalAgregar(async ({ nombre }) => {
            // Crear subcarpeta en Supabase
            const newFolder = await guardarCarpetaEnSupabase(nombre, carpeta.id);

            // Actualizar estructura local
            (carpeta.subcarpetas ||= []).push({
              id: newFolder.id,
              nombre: newFolder.name,
              subcarpetas: [],
              _expand: false
            });
            carpeta._expand = true;
            renderTree();
          }, false);
        };
        const del = document.createElement('button');
        del.className = 'px-2 py-2 rounded-full bg-red-100 border border-red-300 text-red-600 font-semibold';
        del.title = 'Eliminar';
        del.innerHTML = `<span class="material-symbols-outlined" style="font-size:20px;">delete</span>`;
        del.onclick = async () => {
          if (!await modal.confirm({ title: 'Eliminar', message: '¿Seguro que quieres eliminar esta carpeta?' })) return;

          // Eliminar de Supabase
          try {
            await SupabaseOperations.deleteFolder(carpeta.id);
            console.log('✅ Carpeta eliminada de Supabase');

            // Actualizar estructura local
            if (parentRef) {
              parentRef.subcarpetas = parentRef.subcarpetas.filter(x => x !== carpeta);
            } else {
              carpetas = carpetas.filter(x => x !== carpeta);
            }
            renderTree();
          } catch (error) {
            console.error('❌ Error al eliminar carpeta:', error);
            await modal.alert({ message: 'Error al eliminar la carpeta' });
          }
        };
        acciones.append(entrar, add, del);
        fila.append(nombreSpan, acciones);

        // --- Drag & Drop events ---
        fila.addEventListener('dragstart', (e) => {
          if (!dragFromHandle) { e.preventDefault(); return; }
          dragFromHandle = false;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', carpeta.id);
          fila.classList.add('dragging');
          // Ghost
          const ghost = fila.cloneNode(true);
          ghost.style.opacity = '0.7';
          ghost.style.position = 'absolute';
          ghost.style.pointerEvents = 'none';
          document.body.appendChild(ghost);
          e.dataTransfer.setDragImage(ghost, 40, 20);
          setTimeout(() => document.body.removeChild(ghost), 0);
        });
        let dropIntent = null;
        fila.addEventListener('dragover', (e) => {
          e.preventDefault();
          const rect = fila.getBoundingClientRect();
          const y = e.clientY - rect.top;
          const x = e.clientX - rect.left;
          let intent = null;
          if (y < rect.height / 3) intent = 'above';
          else if (y > rect.height * 2 / 3) intent = 'below';
          else if (x > depth * 32 + 24) intent = 'inside';
          else intent = 'below';
          dropIntent = intent;
          fila.classList.remove('drop-line-above', 'drop-line-below', 'drop-inside');
          if (intent === 'above') fila.classList.add('drop-line', 'drop-line-above');
          else if (intent === 'below') fila.classList.add('drop-line', 'drop-line-below');
          else if (intent === 'inside') fila.classList.add('drop-inside');
        });
        fila.addEventListener('dragleave', () => {
          fila.classList.remove('drop-line', 'drop-line-above', 'drop-line-below', 'drop-inside');
        });
        fila.addEventListener('drop', async (e) => {
          e.preventDefault();
          fila.classList.remove('drop-line', 'drop-line-above', 'drop-line-below', 'drop-inside');
          const draggedId = e.dataTransfer.getData('text/plain');
          if (!draggedId || draggedId === carpeta.id) return;
          const draggedNode = findNodeById(draggedId, carpetas);
          if (!draggedNode) return;

          try {
            if (dropIntent === 'above') {
              const destParent = parentRef;
              const destIdx = destParent ? destParent.subcarpetas.indexOf(carpeta) : carpetas.indexOf(carpeta);
              moveNode(draggedId, destParent ? destParent.id : null, destIdx);
            } else if (dropIntent === 'below') {
              const destParent = parentRef;
              const destIdx = (destParent ? destParent.subcarpetas.indexOf(carpeta) : carpetas.indexOf(carpeta)) + 1;
              moveNode(draggedId, destParent ? destParent.id : null, destIdx);
            } else if (dropIntent === 'inside') {
              moveNode(draggedId, carpeta.id, carpeta.subcarpetas ? carpeta.subcarpetas.length : 0);
              // Actualizar parent_id en Supabase
              await SupabaseOperations.updateFolder(draggedId, { parent_folder_id: carpeta.id });
            }
            renderTree();
          } catch (error) {
            console.error('❌ Error al mover carpeta:', error);
          }
        });
        fila.addEventListener('dragend', () => {
          fila.classList.remove('dragging', 'drop-line', 'drop-line-above', 'drop-line-below', 'drop-inside');
        });

        return fila;
      }

      // Evento para agregar carpeta raíz (SIMPLIFICADO - sin modalidad)
      document.getElementById('agregar-carpeta-btn').addEventListener('click', async () => {
        console.log('🔵 CLICK EN BOTÓN AGREGAR CARPETA');

        const nombre = modalidadInput.value.trim();
        if (!nombre) {
          console.log('⚠️ Falta nombre de carpeta');
          modal.alert({ message: 'Escribe el nombre de la carpeta.' });
          return;
        }

        try {
          // Guardar en Supabase
          const newFolder = await guardarCarpetaEnSupabase(nombre, null);
          console.log('✅ Carpeta guardada en Supabase:', newFolder);

          // Actualizar estructura local
          const nuevaCarpeta = {
            id: newFolder.id,
            nombre: newFolder.name,
            subcarpetas: [],
            _expand: false
          };

          carpetas.push(nuevaCarpeta);
          console.log('📦 Array carpetas después de push:', carpetas);

          modalidadInput.value = '';
          renderTree();

          console.log('✅ Carpeta agregada:', nombre);
        } catch (error) {
          console.error('❌ Error al crear carpeta:', error);
          modal.alert({ message: 'Error al crear la carpeta' });
        }
      });

      // 🔥 INICIALIZAR: Cargar carpetas guardadas
      cargarCarpetasDesdeSupabase();
      renderTree();

      // --- MODAL AGREGAR MATERIAL ---
      function mostrarModalMaterial(carpetaId, carpetaNombre) {
        const modalMaterial = `
      <div id="modal-material" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-carpeta-id="${carpetaId}" data-carpeta-nombre="${carpetaNombre}">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
            Agregar Material - ${carpetaNombre}
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            ¿Cómo vas a estudiar este tema?
          </p>
          <div class="space-y-4">
            <button onclick="seleccionarMaterial('pdf')" 
                    class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[var(--primary-color)]">picture_as_pdf</span>
                <div>
                  <div class="font-semibold">Tengo PDF o imágenes</div>
                  <div class="text-sm text-[var(--text-secondary)]">Subiré material digital</div>
                </div>
              </div>
            </button>
            <button onclick="seleccionarMaterial('fisico')" 
                    class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[var(--primary-color)]">menu_book</span>
                <div>
                  <div class="font-semibold">Solo tengo libro físico</div>
                  <div class="text-sm text-[var(--text-secondary)]">Usaré mi "espejo de memoria"</div>
                </div>
              </div>
            </button>
            <button onclick="seleccionarMaterial('sin-material')" 
                    class="w-full p-4 border border-[var(--accent-color)] rounded-lg hover:bg-[var(--base-gray)] text-left transition-all hover:border-[var(--primary-color)] active:scale-95">
              <div class="flex items-center gap-3">
                <span class="material-symbols-outlined text-[var(--primary-color)]">psychology</span>
                <div>
                  <div class="font-semibold">Empezar sin material</div>
                  <div class="text-sm text-[var(--text-secondary)]">Solo mis conocimientos previos</div>
                </div>
              </div>
            </button>
          </div>
          <div class="flex gap-3 mt-6">
            <button onclick="cerrarModalMaterial()" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    `;
        document.body.insertAdjacentHTML('beforeend', modalMaterial);
      }

      function seleccionarMaterial(tipo) {
        alert('Funcionando! Tipo: ' + tipo); // DEBUG - quitar después

        const modal = document.getElementById('modal-material');
        if (!modal) {
          alert('Modal no encontrado!');
          return;
        }

        const carpetaId = modal.dataset.carpetaId;
        const carpetaNombre = modal.dataset.carpetaNombre;

        console.log('Seleccionando material:', tipo, carpetaId, carpetaNombre); // Debug

        cerrarModalMaterial();

        if (tipo === 'pdf') {
          // Ir a página de subir material con parámetros
          window.location.href = `app/subir-material.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&tipo=pdf`;
        } else if (tipo === 'fisico') {
          // Ir a página de subir material para libro físico
          window.location.href = `app/subir-material.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&tipo=fisico`;
        } else {
          // Mostrar modal de bienvenida y luego ir a sesión práctica
          mostrarModalBienvenida(carpetaId, carpetaNombre);
        }
      }

      // Modal de bienvenida mejorado
      function mostrarModalBienvenida(carpetaId, carpetaNombre) {
        const modalBienvenida = `
      <div id="modal-bienvenida" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
          <div class="text-6xl mb-4">🎉</div>
          <h3 class="text-2xl font-bold text-[var(--secondary-color)] mb-4">
            ¡Perfecto!
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            ${carpetaNombre} está listo. ¿Qué quieres hacer ahora?
          </p>
          <div class="space-y-3">
            <button onclick="iniciarSesionPractica('${carpetaId}', '${carpetaNombre}')"
                    class="w-full bg-[var(--primary-color)] text-white py-3 px-6 rounded-lg font-semibold hover:bg-opacity-90 transition-all">
              🧠 Empezar a Practicar
            </button>
            <button onclick="verMateriales('${carpetaId}')"
                    class="w-full border border-[var(--secondary-color)] text-[var(--secondary-color)] py-3 px-6 rounded-lg font-semibold hover:bg-gray-50 transition-all">
              📚 Ver Mis Materiales
            </button>
            <button onclick="cerrarModalBienvenida()"
                    class="w-full text-[var(--text-secondary)] py-2">
              Volver al Dashboard
            </button>
          </div>
        </div>
      </div>
    `;
        document.body.insertAdjacentHTML('beforeend', modalBienvenida);
      }

      function iniciarSesionPractica(carpetaId, carpetaNombre) {
        cerrarModalBienvenida();
        // Ir a página de sesión práctica con parámetros
        window.location.href = `app/sesion-practica.html?carpeta=${carpetaId}&nombre=${encodeURIComponent(carpetaNombre)}&inicio=true`;
      }

      function verMateriales(carpetaId) {
        cerrarModalBienvenida();
        // Ir a página de materiales filtrada por carpeta
        window.location.href = `app/materiales.html?carpeta=${carpetaId}&vista=carpeta`;
      }

      function cerrarModalBienvenida() {
        const modal = document.getElementById('modal-bienvenida');
        if (modal) modal.remove();
      }

      function cerrarModalMaterial() {
        const modal = document.getElementById('modal-material');
        if (modal) modal.remove();
      }

      // --- MODAL PRIMERA PREGUNTA ---
      function mostrarModalPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
        const modalPregunta = `
      <div id="modal-pregunta" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4">
          <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
            Primera Pregunta - ${carpetaNombre}
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            Crea tu primera pregunta para practicar Active Recall:
          </p>
          
          <div class="mb-4">
            <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
              Tu pregunta:
            </label>
            <input id="input-pregunta" type="text" 
                   class="w-full p-3 border border-[var(--accent-color)] rounded-lg" 
                   placeholder="Ej: ¿Qué es la necrosis pulpar?">
            <div class="text-sm text-[var(--text-secondary)] mt-1">
              💡 Evita preguntas sí/no. Usa: ¿qué?, ¿cómo?, ¿por qué?
            </div>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-semibold text-[var(--text-primary)] mb-2">
              Tu autorrespuesta inicial ("espejo de memoria"):
            </label>
            <textarea id="input-autorrespuesta" 
                      class="w-full p-3 border border-[var(--accent-color)] rounded-lg h-24" 
                      placeholder="Escribe lo que crees recordar sobre esta pregunta..."></textarea>
            <div class="text-sm text-[var(--text-secondary)] mt-1">
              Esto será tu referencia base para medir tu evolución
            </div>
          </div>

          <div class="flex gap-3">
            <button onclick="cerrarModalPregunta()" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Cancelar
            </button>
            <button onclick="guardarPrimeraPregunta('${carpetaId}', '${carpetaNombre}', '${tipoMaterial}')" 
                    class="flex-1 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
              Crear Pregunta
            </button>
          </div>
        </div>
      </div>
    `;
        document.body.insertAdjacentHTML('beforeend', modalPregunta);
        document.getElementById('input-pregunta').focus();
      }

      function guardarPrimeraPregunta(carpetaId, carpetaNombre, tipoMaterial) {
        const pregunta = document.getElementById('input-pregunta').value.trim();
        const autorrespuesta = document.getElementById('input-autorrespuesta').value.trim();

        if (!pregunta || !autorrespuesta) {
          alert('Por favor completa ambos campos');
          return;
        }

        // Guardar en localStorage (simulación)
        const dataPregunta = {
          carpetaId,
          carpetaNombre,
          pregunta,
          autorrespuesta,
          tipoMaterial,
          fechaCreacion: new Date().toISOString()
        };

        const preguntas = JSON.parse(localStorage.getItem('recuiva_preguntas') || '[]');
        preguntas.push(dataPregunta);
        localStorage.setItem('recuiva_preguntas', JSON.stringify(preguntas));

        cerrarModalPregunta();

        // Mostrar mensaje de éxito
        const mensajeExito = `
      <div id="mensaje-exito" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
          <span class="material-symbols-outlined text-4xl text-green-500 mb-4">check_circle</span>
          <h3 class="text-xl font-bold text-[var(--secondary-color)] mb-4">
            ¡Primera pregunta creada!
          </h3>
          <p class="text-[var(--text-secondary)] mb-6">
            Ya puedes empezar a practicar Active Recall con validación semántica.
          </p>
          <div class="flex gap-3">
            <button onclick="cerrarMensajeExito()" 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
              Quedarme aquí
            </button>
            <button onclick="irAPractica()" 
                    class="flex-1 px-4 py-2 bg-[var(--primary-color)] text-white rounded-lg hover:bg-opacity-90">
              Ir a Práctica
            </button>
          </div>
        </div>
      </div>
    `;
        document.body.insertAdjacentHTML('beforeend', mensajeExito);
      }

      function cerrarModalPregunta() {
        const modal = document.getElementById('modal-pregunta');
        if (modal) modal.remove();
      }

      function cerrarMensajeExito() {
        const modal = document.getElementById('mensaje-exito');
        if (modal) modal.remove();
      }

      function irAPractica() {
        // Validar antes de ir a práctica usando la función global
        const validacion = window.validarConfiguracion();
        if (!validacion.valido) {
          window.mostrarModalAdvertenciaPractica(validacion);
          return;
        }
        window.location.href = 'app/sesion-practica.html';
      }

      // --- INTEGRACIÓN CON SISTEMA EXISTENTE ---
      // Modificar función entrarCarpeta para incluir modal de material
      window.entrarCarpetaConMaterial = function (carpetaId) {
        const carpeta = findNodeById(carpetaId, carpetas);
        if (carpeta) {
          mostrarModalMaterial(carpetaId, carpeta.nombre);
        }
      };
    });

    // ==========================================
    // SINCRONIZAR CARDS CON SUPABASE
    // ==========================================
    document.addEventListener('DOMContentLoaded', async function () {
      console.log('🔄 Sincronizando cards con Supabase...');

      try {
        // Verificar autenticación
        const user = await SupabaseOperations.getCurrentUser();
        if (!user) {
          console.warn('⚠️ Usuario no autenticado, mostrando datos vacíos');
          showEmptyState();
          return;
        }

        console.log(`✅ Usuario autenticado: ${user.email}`);

        // Obtener todos los materiales del usuario
        const materials = await SupabaseOperations.getMaterials();

        if (!materials || materials.length === 0) {
          console.log('📭 Usuario sin materiales');
          showEmptyState();
          return;
        }

        console.log(`📚 ${materials.length} materiales encontrados`);

        // Obtener todas las preguntas y respuestas del usuario
        let allQuestions = [];
        let allAnswers = [];

        for (const material of materials) {
          const questions = await SupabaseOperations.getQuestionsByMaterial(material.id);

          for (const question of questions) {
            const answers = await SupabaseOperations.getAnswersByQuestion(question.id);

            if (answers.length > 0) {
              // Tomar la última respuesta (más reciente)
              const lastAnswer = answers[0];

              allQuestions.push({
                id: question.id,
                materialId: material.id,
                materialTitle: material.title,
                questionText: question.question_text,
                score: parseFloat(lastAnswer.score),
                createdAt: new Date(lastAnswer.created_at),
                answerId: lastAnswer.id
              });

              allAnswers.push(lastAnswer);
            }
          }
        }

        console.log(`❓ ${allQuestions.length} preguntas con respuestas encontradas`);

        // ====================================
        // 1️⃣ ÚLTIMA SESIÓN
        // ====================================
        await updateLastSessionCard(allQuestions);

        // ====================================
        // 2️⃣ TU PROGRESO
        // ====================================
        await updateProgressCard(allQuestions);

        // ====================================
        // 3️⃣ TEMAS A REPASAR
        // ====================================
        await updateReviewTopicsCard(allQuestions);

        console.log('✅ Sincronización de cards completada con Supabase');

      } catch (error) {
        console.error('❌ Error sincronizando cards:', error);
        showErrorState();
      }
    });

    // ====================================
    // FUNCIÓN: Actualizar card ÚLTIMA SESIÓN
    // ====================================
    async function updateLastSessionCard(questions) {
      const lastSessionText = document.getElementById('last-session-text');
      const lastSessionLink = document.getElementById('last-session-link');

      if (!questions || questions.length === 0) {
        lastSessionText.textContent = 'Aún no hay sesiones de práctica.';
        lastSessionLink.textContent = 'Empezar primera sesión →';
        lastSessionLink.href = 'app/sesion-practica.html';
        console.log('  ⚠️ Sin preguntas para última sesión');
        return;
      }

      // Ordenar por fecha más reciente
      const sortedQuestions = [...questions].sort((a, b) => b.createdAt - a.createdAt);
      const lastQuestion = sortedQuestions[0];

      const questionText = lastQuestion.questionText.substring(0, 40);
      const materialTitle = lastQuestion.materialTitle || 'Material';

      lastSessionText.innerHTML = `
    <span class="text-sm text-gray-500">${materialTitle}</span><br>
    "${questionText}..."
  `;
      lastSessionLink.href = `app/sesion-practica.html?material=${lastQuestion.materialId}`;

      console.log(`  ✓ Última sesión: "${questionText}" (${lastQuestion.materialTitle})`);
    }

    // ====================================
    // FUNCIÓN: Actualizar card TU PROGRESO
    // ====================================
    async function updateProgressCard(questions) {
      const progressRetention = document.getElementById('progress-retention');
      const progressStreak = document.getElementById('progress-streak');

      if (!questions || questions.length === 0) {
        progressRetention.innerHTML = '0<span class="text-lg">%</span>';
        progressStreak.innerHTML = '0 <span class="text-sm md:text-lg">días</span>';
        console.log('  ⚠️ Sin datos para progreso');
        return;
      }

      // 📊 RETENCIÓN: Promedio de scores
      const scores = questions.map(q => q.score).filter(s => s >= 0 && s <= 100);

      if (scores.length > 0) {
        const avgScore = Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length);
        progressRetention.innerHTML = `${avgScore}<span class="text-lg">%</span>`;
        console.log(`  ✓ Retención: ${avgScore}% (${scores.length} respuestas)`);
      } else {
        progressRetention.innerHTML = '0<span class="text-lg">%</span>';
      }

      // 🔥 RACHA: Días consecutivos
      const streak = calculateStreakFromSupabase(questions);
      progressStreak.innerHTML = `${streak} <span class="text-sm md:text-lg">días</span>`;
      console.log(`  ✓ Racha: ${streak} días`);
    }

    // ====================================
    // FUNCIÓN: Actualizar card TEMAS A REPASAR
    // ====================================
    async function updateReviewTopicsCard(questions) {
      const reviewTopicsList = document.getElementById('review-topics-list');

      if (!questions || questions.length === 0) {
        reviewTopicsList.innerHTML = '<li class="text-gray-400">Aún no hay repasos pendientes.</li>';
        console.log('  ⚠️ Sin preguntas para repasos');
        return;
      }

      // Filtrar preguntas con score < 70%
      const weakQuestions = questions.filter(q => q.score < 70);

      if (weakQuestions.length > 0) {
        // Ordenar por score más bajo primero
        weakQuestions.sort((a, b) => a.score - b.score);

        // Mostrar hasta 3 preguntas
        const topicsHTML = weakQuestions.slice(0, 3).map(q => {
          const questionText = q.questionText.substring(0, 50);
          const score = Math.round(q.score);
          const materialBadge = `<span class="text-xs text-gray-500">[${q.materialTitle}]</span>`;
          return `<li>📌 ${questionText}... <span class="font-semibold text-orange-600">(${score}%)</span> ${materialBadge}</li>`;
        }).join('');

        reviewTopicsList.innerHTML = topicsHTML;
        console.log(`  ✓ ${weakQuestions.length} temas a repasar (mostrando 3)`);
      } else {
        reviewTopicsList.innerHTML = '<li class="text-green-600 font-semibold">✨ ¡Excelente! No hay temas que necesiten repaso.</li>';
        console.log('  ✓ Sin temas débiles');
      }
    }

    // ====================================
    // FUNCIÓN: Calcular racha desde Supabase
    // ====================================
    function calculateStreakFromSupabase(questions) {
      if (!questions || questions.length === 0) return 0;

      // Ordenar por fecha descendente (más reciente primero)
      const sortedQuestions = [...questions].sort((a, b) => b.createdAt - a.createdAt);

      let streak = 0;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      let currentDate = new Date(today);

      // Crear conjunto de fechas únicas de práctica
      const practiceDates = new Set();
      sortedQuestions.forEach(q => {
        const date = new Date(q.createdAt);
        date.setHours(0, 0, 0, 0);
        practiceDates.add(date.getTime());
      });

      // Convertir a array ordenado
      const uniqueDates = Array.from(practiceDates).sort((a, b) => b - a);

      // Calcular racha
      for (const dateTimestamp of uniqueDates) {
        if (dateTimestamp === currentDate.getTime()) {
          if (streak === 0) streak = 1;
        } else if (dateTimestamp === currentDate.getTime() - 86400000) {
          streak++;
          currentDate.setDate(currentDate.getDate() - 1);
        } else {
          break;
        }
      }

      return streak;
    }

    // ====================================
    // FUNCIÓN: Mostrar estado vacío
    // ====================================
    function showEmptyState() {
      document.getElementById('last-session-text').textContent = 'Aún no hay sesiones de práctica.';
      document.getElementById('last-session-link').textContent = 'Empezar primera sesión →';
      document.getElementById('last-session-link').href = 'app/sesion-practica.html';

      document.getElementById('progress-retention').innerHTML = '0<span class="text-lg">%</span>';
      document.getElementById('progress-streak').innerHTML = '0 <span class="text-sm md:text-lg">días</span>';

      document.getElementById('review-topics-list').innerHTML = '<li class="text-gray-400">Aún no hay repasos pendientes.</li>';
    }

    // ====================================
    // FUNCIÓN: Mostrar estado de error
    // ====================================
    function showErrorState() {
      document.getElementById('last-session-text').textContent = 'Error al cargar datos.';
      document.getElementById('progress-retention').textContent = '--';
      document.getElementById('progress-streak').textContent = '--';
      document.getElementById('review-topics-list').innerHTML = '<li>Error al cargar.</li>';
    }

    // ===================================
    // 🎨 EFECTO TYPING EN TÍTULO DE BIENVENIDA
    // ===================================
    (async function initTypingEffect() {
      // SIEMPRE ejecutar la animación al cargar la página

      // Obtener el nombre del usuario desde Supabase Auth
      const user = await SupabaseOperations.getCurrentUser();

      let firstName = 'Usuario';

      if (user) {
        // Intentar obtener nombre desde metadata
        const fullName = user.user_metadata?.full_name || user.email || 'Usuario';
        firstName = fullName.split(' ')[0].split('@')[0];
      }

      // Texto completo a escribir (sin colores, se aplican después)
      const fullText = `¡Bienvenido ${firstName} a Recuiva!`;

      const titleElement = document.getElementById('titulo-bienvenida');
      let currentIndex = 0;

      // Velocidad del typing (ms por carácter) - MÁS RÁPIDO
      const typingSpeed = 50; // Más rápido y fluido

      function typeNextChar() {
        if (currentIndex < fullText.length) {
          currentIndex++;
          const currentText = fullText.substring(0, currentIndex);

          // Aplicar colores a las palabras mientras se escribe
          let displayText = currentText
            .replace('Bienvenido', '<span style="color: #004EAA;">Bienvenido</span>')
            .replace(firstName, `<span style="color: #004EAA;">${firstName}</span>`)
            .replace('Recuiva', '<span style="color: #ff6600;">Recuiva</span>');

          titleElement.innerHTML = displayText + '<span class="typing-cursor">|</span>';
          setTimeout(typeNextChar, typingSpeed);
        } else {
          // Terminar: quitar cursor
          const finalText = fullText
            .replace('Bienvenido', '<span style="color: #004EAA;">Bienvenido</span>')
            .replace(firstName, `<span style="color: #004EAA;">${firstName}</span>`)
            .replace('Recuiva', '<span style="color: #ff6600;">Recuiva</span>');

          titleElement.innerHTML = finalText;
        }
      }

      // Iniciar el efecto después de un pequeño delay
      setTimeout(typeNextChar, 300);
    })();

    // CSS para el cursor parpadeante
    const style = document.createElement('style');
    style.textContent = `
  .typing-cursor {
    display: inline-block;
    animation: blink 0.7s infinite;
    color: #004EAA;
    font-weight: bold;
  }
  
  @keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
  }
`;
    document.head.appendChild(style);
  </script>

  <!-- Modales adicionales para el onboarding completo -->

</body>

</html>